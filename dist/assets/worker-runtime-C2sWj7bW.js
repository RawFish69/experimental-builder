(function(){"use strict";const Y={legacyBaseDps:1,legacyEhp:.7,dpsProxy:1,ehpProxy:.6,speed:.4,sustain:.35,skillPointTotal:.15,reqTotalPenalty:.2};function Ge(e){return e.aggregated.hprTotal*.9+e.aggregated.mr*14+e.aggregated.ms*10+e.aggregated.ls*9}function Ue(e,t){let i=0;const{target:s}=t;return typeof s.minLegacyBaseDps=="number"&&e.derived.legacyBaseDps<s.minLegacyBaseDps&&(i+=(s.minLegacyBaseDps-e.derived.legacyBaseDps)*4),typeof s.minLegacyEhp=="number"&&e.derived.legacyEhp<s.minLegacyEhp&&(i+=(s.minLegacyEhp-e.derived.legacyEhp)*.8),typeof s.minDpsProxy=="number"&&e.derived.dpsProxy<s.minDpsProxy&&(i+=(s.minDpsProxy-e.derived.dpsProxy)*4),typeof s.minEhpProxy=="number"&&e.derived.ehpProxy<s.minEhpProxy&&(i+=(s.minEhpProxy-e.derived.ehpProxy)*1.1),typeof s.minMr=="number"&&e.aggregated.mr<s.minMr&&(i+=(s.minMr-e.aggregated.mr)*45),typeof s.minMs=="number"&&e.aggregated.ms<s.minMs&&(i+=(s.minMs-e.aggregated.ms)*35),typeof s.minSpeed=="number"&&e.aggregated.speed<s.minSpeed&&(i+=(s.minSpeed-e.aggregated.speed)*12),typeof s.minSkillPointTotal=="number"&&e.derived.skillPointTotal<s.minSkillPointTotal&&(i+=(s.minSkillPointTotal-e.derived.skillPointTotal)*15),typeof s.maxReqTotal=="number"&&e.derived.reqTotal>s.maxReqTotal&&(i+=(e.derived.reqTotal-s.maxReqTotal)*8),i}function pe(e,t,i){const s=Ge(e),n=e.derived.reqTotal*t.reqTotalPenalty,o=Ue(e,i),a={legacyBaseDps:e.derived.legacyBaseDps*t.legacyBaseDps,legacyEhp:e.derived.legacyEhp*t.legacyEhp,dpsProxy:e.derived.dpsProxy*t.dpsProxy,spellProxy:e.derived.spellProxy*t.spellProxy,meleeProxy:e.derived.meleeProxy*t.meleeProxy,ehpProxy:e.derived.ehpProxy*t.ehpProxy,speed:e.aggregated.speed*t.speed,sustain:s*t.sustain,skillPointTotal:e.derived.skillPointTotal*t.skillPointTotal,reqPenalty:n,thresholdPenalty:o};return{score:a.legacyBaseDps+a.legacyEhp+a.dpsProxy+a.spellProxy+a.meleeProxy+a.ehpProxy+a.speed+a.sustain+a.skillPointTotal-a.reqPenalty-a.thresholdPenalty,breakdown:a}}const j=["helmet","chestplate","leggings","boots","ring1","ring2","bracelet","necklace","weapon"],xe=e=>e==="ring1"||e==="ring2"?"ring":e,Ke={spear:"Warrior",dagger:"Assassin",wand:"Mage",bow:"Archer",relik:"Shaman"};function Ye(e){return Ke[e]??null}function Xe(e,t){return!t||!e.classReq?!0:e.classReq===t}const Je={slotStatus:{},warnings:{messages:[]},aggregated:{hpTotal:0,hprTotal:0,mr:0,ms:0,ls:0,speed:0,skillPoints:{str:0,dex:0,int:0,def:0,agi:0},skillReqs:{str:0,dex:0,int:0,def:0,agi:0},defenses:{e:0,t:0,w:0,f:0,a:0},offense:{baseDps:0,spellPct:0,spellRaw:0,meleePct:0,meleeRaw:0,elemDamPct:0,genericDamPct:0,offenseScore:0}},derived:{dpsProxy:0,spellProxy:0,meleeProxy:0,ehpProxy:0,reqTotal:0,skillPointTotal:0,legacyBaseDps:0,legacyEhp:0,legacyEhpNoAgi:0,skillpointFeasible:!0,assignedSkillPointsRequired:0}};function Se(e){let t=Number.isFinite(e)?e:0;if(t<=0)return 0;t>=150&&(t=150);const i=.9908;return i/(1-i)*(1-Math.pow(i,t))/100}const Qe=.867,Ze=.951,et=90;function tt(e){return Math.max(1,Math.min(106,Math.round(e||1)))*5+5}function nt(e){const t=Math.max(1,Math.min(106,Math.round(e||1)));return t>=101?200:(t-1)*2}function st(e){switch(e){case"relik":return .6;case"bow":return .7;case"wand":return .8;case"dagger":case"spear":return 1;default:return 1}}function it(e){const t=Math.max(5,e.totalHp),i=Se(e.defSkillPoints)*Qe,s=Se(e.agiSkillPoints)*Ze,o=2-st(e.weaponType),l=(100-et)/100*s+(1-s)*(1-i),f=1-i,u=t/Math.max(1e-9,l)/Math.max(1e-9,o),g=t/Math.max(1e-9,f)/Math.max(1e-9,o);return{withAgi:u,noAgi:g}}function ot(e){return[e.numeric.reqStr,e.numeric.reqDex,e.numeric.reqInt,e.numeric.reqDef,e.numeric.reqAgi]}function at(e){return[e.numeric.spStr,e.numeric.spDex,e.numeric.spInt,e.numeric.spDef,e.numeric.spAgi]}function rt(e,t){return[e[0]+t[0],e[1]+t[1],e[2]+t[2],e[3]+t[3],e[4]+t[4]]}function lt(e){return e[0]+e[1]+e[2]+e[3]+e[4]}function ve(e,t){for(let i=0;i<5;i++)if(e[i]>t[i])return!1;return!0}function ct(e,t){for(const i of e)if(ve(i.assigned,t.assigned))return;for(let i=e.length-1;i>=0;i--)ve(t.assigned,e[i].assigned)&&e.splice(i,1);e.push(t)}function dt(e,t,i={}){if(e.length===0)return{feasible:!0,assignedTotal:0,assignedByStat:[0,0,0,0,0]};const s=nt(t),n=i.extraBaseSkillPoints??[0,0,0,0,0],o=e.length,a=e.map(ot),l=e.map(at),f=1<<o,u=Array.from({length:f},()=>[0,0,0,0,0]);for(let S=1;S<f;S++){const w=S&-S,B=Math.log2(w)|0;u[S]=rt(u[S^w],l[B])}const g=new Array(f);g[0]=[{assigned:[0,0,0,0,0],assignedTotal:0}];for(let S=0;S<f;S++){const w=g[S];if(!w||w.length===0)continue;const B=u[S];for(const E of w)for(let k=0;k<o;k++){if((S&1<<k)!==0)continue;const v=[...E.assigned];let F=!0;for(let d=0;d<5;d++){const b=E.assigned[d]+B[d]+(n[d]??0),q=a[k][d];if(q>b&&(v[d]+=q-b),v[d]>100){F=!1;break}}if(!F)continue;const M=lt(v);if(M>s)continue;const r=S|1<<k,c=g[r]??=[];ct(c,{assigned:v,assignedTotal:M})}}const x=g[f-1];if(!x||x.length===0)return{feasible:!1,assignedTotal:1/0,assignedByStat:null};let p=1/0,y=null;for(const S of x)S.assignedTotal<p&&(p=S.assignedTotal,y=[...S.assigned]);return{feasible:Number.isFinite(p),assignedTotal:p,assignedByStat:Number.isFinite(p)?y:null}}function ke(e,t,i,s={}){const n=[];for(const o of j){const a=e[o];if(a==null)continue;const l=t.itemsById.get(a);l&&n.push(l)}return dt(n,i,s)}function ut(e,t){const i={};for(const s of j){const n=e.slots[s];if(n==null)continue;const o=t.itemsById.get(n);o&&(i[s]=o)}return i}function Te(e,t,i={}){const s=ut(e,t),n=structuredClone(Je),o=n.warnings.messages;let a=null;for(const _ of j){const h=s[_];if(!h)continue;_==="weapon"&&(a=h.type),n.aggregated.hpTotal+=h.numeric.hp+h.numeric.hpBonus,n.aggregated.hprTotal+=h.numeric.hprRaw+h.numeric.hprPct,n.aggregated.mr+=h.numeric.mr,n.aggregated.ms+=h.numeric.ms,n.aggregated.ls+=h.numeric.ls,n.aggregated.speed+=h.numeric.spd,n.aggregated.skillPoints.str+=h.numeric.spStr,n.aggregated.skillPoints.dex+=h.numeric.spDex,n.aggregated.skillPoints.int+=h.numeric.spInt,n.aggregated.skillPoints.def+=h.numeric.spDef,n.aggregated.skillPoints.agi+=h.numeric.spAgi,n.aggregated.skillReqs.str=Math.max(n.aggregated.skillReqs.str,h.numeric.reqStr),n.aggregated.skillReqs.dex=Math.max(n.aggregated.skillReqs.dex,h.numeric.reqDex),n.aggregated.skillReqs.int=Math.max(n.aggregated.skillReqs.int,h.numeric.reqInt),n.aggregated.skillReqs.def=Math.max(n.aggregated.skillReqs.def,h.numeric.reqDef),n.aggregated.skillReqs.agi=Math.max(n.aggregated.skillReqs.agi,h.numeric.reqAgi),n.aggregated.defenses.e+=h.numeric.eDef,n.aggregated.defenses.t+=h.numeric.tDef,n.aggregated.defenses.w+=h.numeric.wDef,n.aggregated.defenses.f+=h.numeric.fDef,n.aggregated.defenses.a+=h.numeric.aDef,n.aggregated.offense.baseDps+=h.numeric.baseDps,n.aggregated.offense.spellPct+=h.numeric.sdPct,n.aggregated.offense.spellRaw+=h.numeric.sdRaw,n.aggregated.offense.meleePct+=h.numeric.mdPct,n.aggregated.offense.meleeRaw+=h.numeric.mdRaw,n.aggregated.offense.elemDamPct+=h.numeric.eDamPct+h.numeric.tDamPct+h.numeric.wDamPct+h.numeric.fDamPct+h.numeric.aDamPct,n.aggregated.offense.genericDamPct+=h.numeric.damPct+h.numeric.rDamPct+h.numeric.nDamPct,n.aggregated.offense.offenseScore+=h.roughScoreFields.offense;const C=h.classReq,T=!C||!e.characterClass||C===e.characterClass,G=h.level<=e.level,$=h.numeric.reqStr<=100&&h.numeric.reqDex<=100&&h.numeric.reqInt<=100&&h.numeric.reqDef<=100&&h.numeric.reqAgi<=100;n.slotStatus[_]={classOk:T,levelOk:G,skillReqsMet:$}}!e.characterClass&&a&&(e.characterClass=Ye(a));for(const _ of j){const h=s[_];h&&(xe(_)!==h.category&&o.push(`${_} contains incompatible item type (${h.type}).`),h.level>e.level&&o.push(`${h.displayName} requires level ${h.level}.`),e.characterClass&&h.classReq&&h.classReq!==e.characterClass&&o.push(`${h.displayName} requires ${h.classReq}.`),(h.restricted||h.deprecated)&&o.push(`${h.displayName} is restricted/deprecated.`))}const l=n.aggregated.skillReqs.str+n.aggregated.skillReqs.dex+n.aggregated.skillReqs.int+n.aggregated.skillReqs.def+n.aggregated.skillReqs.agi,f=n.aggregated.skillPoints.str+n.aggregated.skillPoints.dex+n.aggregated.skillPoints.int+n.aggregated.skillPoints.def+n.aggregated.skillPoints.agi,u=ke(e.slots,t,e.level,i.skillpointFeasibility),{spellPct:g,spellRaw:x,meleePct:p,meleeRaw:y,baseDps:S,elemDamPct:w,genericDamPct:B}=n.aggregated.offense,E=n.aggregated.skillPoints,v=1+Se(E.str),F=(S*(1+(g+w+B)/100)+x)*v,M=(S*(1+(p+w+B)/100)+y)*v,r=M+F+n.aggregated.speed*.8,c=n.aggregated.defenses.e+n.aggregated.defenses.t+n.aggregated.defenses.w+n.aggregated.defenses.f+n.aggregated.defenses.a,d=n.aggregated.hpTotal+c*.45+n.aggregated.hprTotal*2+Math.max(0,n.aggregated.skillPoints.def)*12+Math.max(0,n.aggregated.skillPoints.agi)*10,b=n.aggregated.offense.baseDps,q=tt(e.level)+n.aggregated.hpTotal,D=it({totalHp:q,defSkillPoints:n.aggregated.skillPoints.def,agiSkillPoints:n.aggregated.skillPoints.agi,weaponType:a});return n.derived={dpsProxy:r,spellProxy:F,meleeProxy:M,ehpProxy:d,reqTotal:l,skillPointTotal:f,legacyBaseDps:b,legacyEhp:D.withAgi,legacyEhpNoAgi:D.noAgi,skillpointFeasible:u.feasible,assignedSkillPointsRequired:Number.isFinite(u.assignedTotal)?u.assignedTotal:0},u.feasible||o.push(`Skill requirements are not satisfiable at level ${e.level} (estimated assigned SP exceeds available or equip order is invalid).`),n}function ft(e,t){const i=new Map;for(const s of j){const n=e[s];if(n==null)continue;const o=t.itemSetName.get(n);o&&i.set(o,(i.get(o)??0)+1)}return i}function re(e,t,i){const s=i.itemSetName.get(e);if(!s)return!1;const n=i.setsMeta.get(s);if(!n)return!1;let o=0;for(const a of j){const l=t[a];l!=null&&i.itemSetName.get(l)===s&&o++}return n.illegalCounts.includes(o+1)}const mt=[0,0,0,0,0],gt=[1,1,1,1,1],Be=["str","dex","int","def","agi"],X=["SUPER_SLOW","VERY_SLOW","SLOW","NORMAL","FAST","VERY_FAST","SUPER_FAST"];function le(e){return e.skillpointFeasibilityMode==="guild_rainbow"?gt:mt}function J(e){return Math.round(e.numeric.atkTier||0)}function ye(e,t){switch(t){case"str":return Math.max(0,e.numeric.spStr);case"dex":return Math.max(0,e.numeric.spDex);case"int":return Math.max(0,e.numeric.spInt);case"def":return Math.max(0,e.numeric.spDef);case"agi":return Math.max(0,e.numeric.spAgi)}}function ht(e,t){switch(t){case"str":return e.numeric.reqStr;case"dex":return e.numeric.reqDex;case"int":return e.numeric.reqInt;case"def":return e.numeric.reqDef;case"agi":return e.numeric.reqAgi}}function pt(e,t){if(t.length===0)return 0;let i=0;for(const s of t)i+=ye(e,s)*10,i-=Math.max(0,ht(e,s))*.7;return i-=Math.max(0,e.roughScoreFields.reqTotal)*.12,i}function K(e){return{...e}}function xt(e,t){const i=e.weapon;if(i==null)return null;const s=t.itemsById.get(i);if(!s)return null;const n=X.indexOf(s.atkSpd);if(n<0)return null;let o=0;for(const l of j){const f=e[l];if(f==null)continue;const u=t.itemsById.get(f);u&&(o+=J(u))}const a=Math.max(0,Math.min(X.length-1,n+o));return X[a]}function be(e,t){let i=0;for(const s of j){const n=e[s];if(n==null)continue;const o=t.itemsById.get(n);o&&(i+=J(o))}return i}function St(e,t,i){if(i.weaponAttackSpeeds.length===0)return null;const s=e.weapon;if(s==null)return null;const n=t.itemsById.get(s);if(!n)return null;const o=X.indexOf(n.atkSpd);if(o<0)return null;const a=[...new Set(i.weaponAttackSpeeds.map(g=>X.indexOf(g)).filter(g=>g>=0))].sort((g,x)=>g-x);if(a.length===0)return null;const l=be(e,t),f=Math.max(0,Math.min(X.length-1,o+l));let u=0;if(!a.includes(f)){const g=a.reduce((x,p)=>Math.abs(p-f)<Math.abs(x-f)?p:x,a[0]);u=g>f?1:g<f?-1:0}return{baseSpeedIndex:o,fixedAtkTierTotal:l,allowedFinalIndices:a,allowedFinalIndexSet:new Set(a),preferredDirection:u}}function ce(e,t,i){const s=new Array(e.length+1).fill(0),n=new Array(e.length+1).fill(0);for(let o=e.length-1;o>=0;o--){const a=t.get(e[o])??[];let l=0,f=0;if(a.length>0){l=1/0,f=-1/0;for(const u of a){const g=i.itemsById.get(u.id),x=g?J(g):0;x<l&&(l=x),x>f&&(f=x)}Number.isFinite(l)||(l=0),Number.isFinite(f)||(f=0)}s[o]=s[o+1]+l,n[o]=n[o+1]+f}return{minSuffix:s,maxSuffix:n}}function kt(e,t,i,s){const n=e.fixedAtkTierTotal+t+i,o=e.fixedAtkTierTotal+t+s,a=Math.min(n,o),l=Math.max(n,o);for(let f=a;f<=l;f++){const u=Math.max(0,Math.min(X.length-1,e.baseSpeedIndex+f));if(e.allowedFinalIndexSet.has(u))return!0}return!1}function Z(e,t,i=0,s=0){if(!e||!e.preferredDirection)return 0;const n=e.fixedAtkTierTotal+(t??0),o=Math.max(0,Math.min(X.length-1,e.baseSpeedIndex+n+i)),a=Math.max(0,Math.min(X.length-1,e.baseSpeedIndex+n+s)),l=Math.min(o,a),f=Math.max(o,a);let u=1/0,g=0;for(let p=l;p<=f;p++){let y=1/0;for(const S of e.allowedFinalIndices){const w=Math.abs(S-p);w<y&&(y=w)}y<u&&(u=y),y>g&&(g=y)}if(!Number.isFinite(u)||g===0)return 0;const x=e.preferredDirection>0?l:-f;return-g*1e3-u*100+x}function Tt(e,t,i,s){const{target:n}=t,o=ue(t,{includeAttackTier:!1}),a=[];if(typeof n.minLegacyBaseDps=="number"&&e.derived.legacyBaseDps<n.minLegacyBaseDps&&a.push(`minLegacyBaseDps (${e.derived.legacyBaseDps} < ${n.minLegacyBaseDps})`),typeof n.minLegacyEhp=="number"&&e.derived.legacyEhp<n.minLegacyEhp&&a.push(`minLegacyEhp (${e.derived.legacyEhp} < ${n.minLegacyEhp})`),typeof n.minDpsProxy=="number"&&e.derived.dpsProxy<n.minDpsProxy&&a.push(`minDpsProxy (${e.derived.dpsProxy} < ${n.minDpsProxy})`),typeof n.minEhpProxy=="number"&&e.derived.ehpProxy<n.minEhpProxy&&a.push(`minEhpProxy (${e.derived.ehpProxy} < ${n.minEhpProxy})`),typeof n.minMr=="number"&&e.aggregated.mr<n.minMr&&a.push(`minMr (${e.aggregated.mr} < ${n.minMr})`),typeof n.minMs=="number"&&e.aggregated.ms<n.minMs&&a.push(`minMs (${e.aggregated.ms} < ${n.minMs})`),typeof n.minSpeed=="number"&&e.aggregated.speed<n.minSpeed&&a.push(`minSpeed (${e.aggregated.speed} < ${n.minSpeed})`),typeof n.minSkillPointTotal=="number"&&e.derived.skillPointTotal<n.minSkillPointTotal&&a.push(`minSkillPointTotal (${e.derived.skillPointTotal} < ${n.minSkillPointTotal})`),typeof n.maxReqTotal=="number"&&e.derived.reqTotal>n.maxReqTotal&&a.push(`maxReqTotal (${e.derived.reqTotal} > ${n.maxReqTotal})`),o.length>0&&i&&s)for(const l of o){const f=l.key;let u=0;for(const g of j){const x=i[g];if(x==null)continue;const p=s.itemsById.get(x);p&&(u+=p.numericIndex[f]??0)}typeof l.min=="number"&&u<l.min&&a.push(`${f} (${u} < ${l.min})`),typeof l.max=="number"&&u>l.max&&a.push(`${f} (${u} > ${l.max})`)}return a.length>0?{ok:!1,failedChecks:a}:{ok:!0}}function Pe(e,t,i,s){const n=[...new Set(i.mustIncludeIds)];for(const f of n){let u=!1;for(const g of j)if(e[g]===f){u=!0;break}if(!u)return{ok:!1,reason:"item",failedChecks:[`mustIncludeMissing (${f})`]}}for(const f of j){const u=e[f];if(u==null)continue;const g=t.itemsById.get(u);if(!g)return{ok:!1,reason:"item"};if(!Me(g,i))return{ok:!1,reason:"item"}}const o=ft(e,t);for(const[f,u]of o){const g=t.setsMeta.get(f);if(g&&g.illegalCounts.includes(u))return{ok:!1,reason:"item"}}const a=Bt({constraints:i,slots:e,catalog:t,atkTierRequirement:Oe(_e(i))});if(a.configured&&!a.ok)return{ok:!1,reason:"attackSpeed",failedChecks:a.failedChecks};const l=Tt(s,i,e,t);return l.ok?{ok:!0}:{ok:!1,reason:"thresholds",failedChecks:l.failedChecks}}function Me(e,t){return!(!t.allowRestricted&&(e.restricted||e.deprecated)||e.level>t.level||!Xe(e,t.characterClass)||t.excludedIds.includes(e.id)||t.allowedTiers.length>0&&!t.allowedTiers.includes(e.tier)||t.minPowderSlots!=null&&e.powderSlots<t.minPowderSlots||t.excludedMajorIds.length>0&&t.excludedMajorIds.some(i=>e.majorIds.includes(i)))}const Q=2.5;function De(e,t){const i={...t};return typeof e.minLegacyBaseDps=="number"&&(i.legacyBaseDps=Math.max(i.legacyBaseDps,Y.legacyBaseDps*Q)),typeof e.minLegacyEhp=="number"&&(i.legacyEhp=Math.max(i.legacyEhp,Y.legacyEhp*Q)),typeof e.minDpsProxy=="number"&&(i.dpsProxy=Math.max(i.dpsProxy,Y.dpsProxy*Q)),typeof e.minEhpProxy=="number"&&(i.ehpProxy=Math.max(i.ehpProxy,Y.ehpProxy*Q)),(typeof e.minMr=="number"||typeof e.minMs=="number")&&(i.sustain=Math.max(i.sustain,Y.sustain*Q)),typeof e.minSpeed=="number"&&(i.speed=Math.max(i.speed,Y.speed*Q)),typeof e.minSkillPointTotal=="number"&&(i.skillPointTotal=Math.max(i.skillPointTotal,Y.skillPointTotal*Q)),typeof e.maxReqTotal=="number"&&(i.reqTotalPenalty=Math.max(i.reqTotalPenalty,Y.reqTotalPenalty*Q)),(e.customNumericRanges?.length??0)>0&&(i.sustain=Math.max(i.sustain,Y.sustain*Q)),i}const yt=3,bt=2,Pt=14;function Mt(e,t){let i=e.numeric.baseDps*t.weights.legacyBaseDps+e.roughScoreFields.ehpProxy*t.weights.legacyEhp+e.roughScoreFields.offense*t.weights.dpsProxy+e.roughScoreFields.ehpProxy*t.weights.ehpProxy+e.numeric.spd*t.weights.speed+e.roughScoreFields.utility*t.weights.sustain+e.roughScoreFields.skillPointTotal*t.weights.skillPointTotal-e.roughScoreFields.reqTotal*t.weights.reqTotalPenalty;const s=t.target.customNumericRanges??[],o=s.some(a=>typeof a.min=="number")?Pt:yt;for(const a of s){const l=a.key?.trim();if(!l)continue;const f=e.numericIndex[l]??0;typeof a.min=="number"&&(i+=f*o),typeof a.max=="number"&&(i-=f*bt)}return i}function ne(e){const t=e.ring1??0,i=e.ring2??0,[s,n]=t<=i?[t,i]:[i,t];return[e.helmet??0,e.chestplate??0,e.leggings??0,e.boots??0,s,n,e.bracelet??0,e.necklace??0,e.weapon??0].join("|")}function Re(e,t,i,s=.6){const n=Math.max(1,i),o=[],a=new Set,l=Math.max(1,Math.min(n,Math.round(n*s)));let f=0,u=0;const g=x=>{const p=`${x.orderIndex}|${ne(x.slots)}`;return a.has(p)?!1:(a.add(p),o.push(x),!0)};for(;o.length<n&&(f<e.length||u<t.length);){if(o.length<l&&f<e.length){g(e[f]),f++;continue}if(u<t.length){g(t[u]),u++;continue}if(f<e.length){g(e[f]),f++;continue}break}return o}function $e(e,t){return xe(t)===e.category}function At(e,t,i){const s=K(e),n=[...new Set(i.mustIncludeIds)];for(const o of n){const a=t.itemsById.get(o);if(!a)return{slots:s,ok:!1,reasonCode:"must_include_conflict",detail:`Must-include item ${o} does not exist in catalog.`};if(!Me(a,i))return{slots:s,ok:!1,reasonCode:"must_include_conflict",detail:`Must-include item ${a.displayName} is incompatible with current hard filters (class/level/tier/exclusions).`};if(j.some(g=>s[g]===a.id))continue;const u=j.filter(g=>s[g]==null&&$e(a,g))[0];if(!u)return{slots:s,ok:!1,reasonCode:"must_include_conflict",detail:`No free ${a.category} slot available to place must-include item ${a.displayName}.`};s[u]=a.id}return{slots:s,ok:!0}}function It(e,t){const i={str:0,dex:0,int:0,def:0,agi:0};for(const n of j){const o=e[n];if(o==null)continue;const a=t.itemsById.get(o);a&&(i.str=Math.max(i.str,a.numeric.reqStr),i.dex=Math.max(i.dex,a.numeric.reqDex),i.int=Math.max(i.int,a.numeric.reqInt),i.def=Math.max(i.def,a.numeric.reqDef),i.agi=Math.max(i.agi,a.numeric.reqAgi))}const s=Be.filter(n=>i[n]>100).sort((n,o)=>i[o]-i[n]);return s.length>0?s:Be.filter(n=>i[n]>=70).sort((n,o)=>i[o]-i[n]).slice(0,2)}function qt(e,t,i){if(i.length===0)return[];const s={str:0,dex:0,int:0,def:0,agi:0};for(const n of j){const o=e[n];if(o==null)continue;const a=t.itemsById.get(o);a&&(s.str=Math.max(s.str,a.numeric.reqStr),s.dex=Math.max(s.dex,a.numeric.reqDex),s.int=Math.max(s.int,a.numeric.reqInt),s.def=Math.max(s.def,a.numeric.reqDef),s.agi=Math.max(s.agi,a.numeric.reqAgi))}return i.map(n=>Math.max(0,s[n]-100))}function Ee(e,t){return t.map(i=>ye(e,i))}function oe(e,t){if(e.length===0)return t.slice();const i=new Array(e.length);for(let s=0;s<e.length;s++)i[s]=(e[s]??0)+(t[s]??0);return i}function Ct(e,t,i){for(let s=0;s<i.length;s++)if((e[s]??0)+(t[s]??0)<i[s])return!1;return!0}function Fe(e,t){let i=0;for(let s=0;s<t.length;s++)i+=Math.max(0,t[s]-(e[s]??0));return i}function de(e,t){if(!e||t.length===0)return 0;let i=0;for(let s=0;s<t.length;s++){const n=e[s]??0,o=t[s];typeof o.min=="number"&&n<o.min&&(i+=o.min-n),typeof o.max=="number"&&n>o.max&&(i+=n-o.max)}return i}function Ne(e,t,i,s){if(s.length===0)return 0;const n=t.get(e)??[];let o=0;for(const a of n){const l=i.itemsById.get(a.id);if(!l)continue;let f=0;for(const u of s)f+=ye(l,u);f>o&&(o=f)}return o}function ue(e,t={}){const i=t.includeAttackTier??!0;return(e.target.customNumericRanges??[]).map(s=>({key:(s.key??"").trim(),min:typeof s.min=="number"?s.min:void 0,max:typeof s.max=="number"?s.max:void 0})).filter(s=>s.key&&(typeof s.min=="number"||typeof s.max=="number")).filter(s=>i||s.key!=="atkTier")}function _e(e){return ue(e,{includeAttackTier:!0}).filter(t=>t.key==="atkTier")}function Ae(e){const t=e.attackSpeedConstraintMode==="or"&&e.weaponAttackSpeeds.length>0;return ue(e,{includeAttackTier:!t})}function Oe(e){if(e.length===0)return{hasConstraint:!1,minAllowed:Number.NEGATIVE_INFINITY,maxAllowed:Number.POSITIVE_INFINITY,rows:[]};let t=Number.NEGATIVE_INFINITY,i=Number.POSITIVE_INFINITY;for(const s of e)typeof s.min=="number"&&(t=Math.max(t,s.min)),typeof s.max=="number"&&(i=Math.min(i,s.max));return{hasConstraint:!0,minAllowed:t,maxAllowed:i,rows:e}}function wt(e,t){return t.hasConstraint?e>=t.minAllowed&&e<=t.maxAllowed:!1}function vt(e,t,i,s,n){if(!e.hasConstraint)return!1;const o=t+i+Math.min(s,n),a=t+i+Math.max(s,n);return o<=e.maxAllowed&&a>=e.minAllowed}function Bt(e){const{constraints:t,slots:i,catalog:s,atkTierRequirement:n}=e,o=t.weaponAttackSpeeds.length>0,a=n.hasConstraint;if(!o&&!a)return{configured:!1,ok:!0};const l=[];let f=!1;if(o){const p=xt(i,s);f=!!(p&&t.weaponAttackSpeeds.includes(p)),f||l.push(`attackSpeed (expected ${t.weaponAttackSpeeds.join("/")} )`)}let u=!1;if(a){const p=be(i,s);if(u=wt(p,n),!u){const y=Number.isFinite(n.minAllowed)?n.minAllowed:"-inf",S=Number.isFinite(n.maxAllowed)?n.maxAllowed:"+inf";l.push(`atkTier (${p} not in [${y}, ${S}])`)}}const g=t.attackSpeedConstraintMode;return(o&&a?g==="and"?f&&u:f||u:o?f:u)?{configured:!0,ok:!0}:{configured:!0,ok:!1,failedChecks:l}}function fe(e){const{constraints:t,attackSpeedCtx:i,atkTierRequirement:s,fixedAtkTierTotal:n,partialAssignedAtkTier:o,remainingMinAtkTier:a,remainingMaxAtkTier:l}=e,f=t.weaponAttackSpeeds.length>0,u=s.hasConstraint;if(!f&&!u)return!0;const g=f?i?kt(i,o,a,l):!0:!1,x=u?vt(s,n,o,a,l):!1;return f&&u?t.attackSpeedConstraintMode==="and"?g&&x:g||x:f?g:x}function me(e,t,i){const s=t.itemsById.get(e.id);return s?s.numericIndex[i]??0:0}function ge(e,t,i){const s=i.map(()=>0);if(i.length===0)return s;for(const n of j){const o=e[n];if(o==null)continue;const a=t.itemsById.get(o);if(a)for(let l=0;l<i.length;l++)s[l]+=a.numericIndex[i[l]]??0}return s}function Ie(e){const{slotOrder:t,candidatePools:i,catalog:s,keys:n}=e,o=Array.from({length:t.length+1},()=>n.map(()=>0)),a=Array.from({length:t.length+1},()=>n.map(()=>0));if(n.length===0)return{maxSuffix:o,minSuffix:a};for(let l=t.length-1;l>=0;l--){const f=i.get(t[l])??[],u=n.map(()=>Number.NEGATIVE_INFINITY),g=n.map(()=>Number.POSITIVE_INFINITY);for(const x of f){const p=s.itemsById.get(x.id);if(p)for(let y=0;y<n.length;y++){const S=p.numericIndex[n[y]]??0;S>u[y]&&(u[y]=S),S<g[y]&&(g[y]=S)}}for(let x=0;x<n.length;x++){const p=Number.isFinite(u[x])?u[x]:0,y=Number.isFinite(g[x])?g[x]:0;o[l][x]=o[l+1][x]+p,a[l][x]=a[l+1][x]+y}}return{maxSuffix:o,minSuffix:a}}function Dt(e,t,i,s,n=[]){const o=[],a=ue(i);for(const r of t.items)$e(r,e)&&(s&&!s.has(r.id)||Me(r,i)&&o.push({id:r.id,rough:Mt(r,i),reqTotal:r.roughScoreFields.reqTotal,skillPointTotal:r.roughScoreFields.skillPointTotal,utility:r.roughScoreFields.utility+r.numeric.spd*.8,level:r.level,atkTier:J(r),spStr:r.numeric.spStr,spDex:r.numeric.spDex,spInt:r.numeric.spInt,spDef:r.numeric.spDef,spAgi:r.numeric.spAgi,supportFocus:pt(r,n)}));const l=[...o].sort((r,c)=>r.rough!==c.rough?c.rough-r.rough:r.id-c.id),f=[...o].sort((r,c)=>r.reqTotal!==c.reqTotal?r.reqTotal-c.reqTotal:r.level!==c.level?r.level-c.level:r.id-c.id),u=[...o].sort((r,c)=>r.skillPointTotal!==c.skillPointTotal?c.skillPointTotal-r.skillPointTotal:r.reqTotal!==c.reqTotal?r.reqTotal-c.reqTotal:r.id-c.id),g=[...o].sort((r,c)=>r.utility!==c.utility?c.utility-r.utility:r.reqTotal!==c.reqTotal?r.reqTotal-c.reqTotal:r.id-c.id),x=i.weaponAttackSpeeds.length>0?[...o].sort((r,c)=>{const d=Math.max(0,r.atkTier),b=Math.max(0,c.atkTier);return d!==b?b-d:r.atkTier!==c.atkTier?c.atkTier-r.atkTier:r.reqTotal!==c.reqTotal?r.reqTotal-c.reqTotal:r.skillPointTotal!==c.skillPointTotal?c.skillPointTotal-r.skillPointTotal:r.id-c.id}):[],p=n.length>0?[...o].sort((r,c)=>r.supportFocus!==c.supportFocus?c.supportFocus-r.supportFocus:r.reqTotal!==c.reqTotal?r.reqTotal-c.reqTotal:r.skillPointTotal!==c.skillPointTotal?c.skillPointTotal-r.skillPointTotal:r.id-c.id):[],y=n.map(r=>[...o].sort((c,d)=>{const b=r==="str"?c.spStr:r==="dex"?c.spDex:r==="int"?c.spInt:r==="def"?c.spDef:c.spAgi,q=r==="str"?d.spStr:r==="dex"?d.spDex:r==="int"?d.spInt:r==="def"?d.spDef:d.spAgi;return b!==q?q-b:c.reqTotal!==d.reqTotal?c.reqTotal-d.reqTotal:c.supportFocus!==d.supportFocus?d.supportFocus-c.supportFocus:c.id-d.id})),S=a.filter(r=>typeof r.min=="number").map(r=>[...o].sort((c,d)=>{const b=me(c,t,r.key),q=me(d,t,r.key);return b!==q?q-b:c.reqTotal!==d.reqTotal?c.reqTotal-d.reqTotal:c.skillPointTotal!==d.skillPointTotal?d.skillPointTotal-c.skillPointTotal:c.id-d.id})),w=a.filter(r=>typeof r.max=="number").map(r=>[...o].sort((c,d)=>{const b=me(c,t,r.key),q=me(d,t,r.key);return b!==q?b-q:c.reqTotal!==d.reqTotal?c.reqTotal-d.reqTotal:c.skillPointTotal!==d.skillPointTotal?d.skillPointTotal-c.skillPointTotal:c.id-d.id})),B=Math.max(10,i.topKPerSlot),E=Math.min(140,Math.max(40,Math.floor(B*.8))),k=Math.min(o.length,B+E+(n.length>0?Math.min(60,n.length*12):0)+Math.min(80,a.length*14)),v=new Map,F=Math.min(12,Math.floor(B*.4),l.length);for(let r=0;r<F;r++){const c=l[r];v.set(c.id,{id:c.id,rough:c.rough})}const M=[{list:l,remaining:Math.max(0,B-F),cursor:0},{list:f,remaining:Math.floor(E*.28),cursor:0},{list:u,remaining:Math.floor(E*.24),cursor:0},{list:g,remaining:Math.floor(E*.18),cursor:0}];x.length>0&&M.push({list:x,remaining:Math.max(18,Math.floor(E*.22)),cursor:0}),p.length>0&&M.push({list:p,remaining:Math.max(16,Math.floor(E*.2)),cursor:0});for(const r of y)M.push({list:r,remaining:10,cursor:0});for(const r of S)M.push({list:r,remaining:35,cursor:0});for(const r of w)M.push({list:r,remaining:20,cursor:0});for(;v.size<k;){let r=!1;for(const c of M)if(!(c.remaining<=0))for(;c.cursor<c.list.length;){const d=c.list[c.cursor++];if(!v.has(d.id)){v.set(d.id,{id:d.id,rough:d.rough}),c.remaining--,r=!0;break}}if(!r)break}if(v.size<k)for(const r of l){if(v.size>=k)break;v.has(r.id)||v.set(r.id,{id:r.id,rough:r.rough})}return[...v.values()]}function Rt(e){const t={};for(const i of j){const s=xe(i),n=new Set(e.binsByCategory[s]??[]),o=e.slots[i];o!=null&&n.add(o),t[i]=n}return t}function qe(e,t,i){if(i.length===0)return!0;const s=new Set;for(const n of j){const o=e[n];if(o==null)continue;const a=t.itemsById.get(o);if(a)for(const l of a.majorIds)i.includes(l)&&s.add(l)}return i.every(n=>s.has(n))}function je(e,t){const i=new Array(e.length+1).fill(0);for(let s=e.length-1;s>=0;s--){const n=e[s],o=t.get(n)??[];let a=0;for(const l of o)l.rough>a&&(a=l.rough);i[s]=i[s+1]+a}return i}function Le(e){const{poolSize:t,beamSize:i,remainingStages:s,processedStates:n,maxStates:o}=e;if(t<=0)return 0;const a=Math.max(0,o-n),l=Math.max(1,i*Math.max(1,s)),f=Math.floor(a/l),u=Math.max(8,Math.min(96,f));return Math.min(t,u)}function $t(e,t,i){let s=1;for(const n of e){const o=t.get(n)?.length??0;if(o===0)return 0;if(s*=o,s>i)return s}return s}function ze(e){const{beam:t,catalog:i,constraints:s,skillpointAssist:n,signal:o}=e,a=n??le(s),l=[],f=new Set,u={majorIds:0,spInvalid:0,duplicate:0,hardConstraints:0,hardAttackSpeed:0,hardThresholds:0,hardItem:0,thresholdFailureExample:void 0};for(const g of t){if(o?.aborted)throw new DOMException("Auto build cancelled","AbortError");if(!qe(g.slots,i,s.requiredMajorIds)){u.majorIds++;continue}const x=Te({slots:g.slots,level:s.level,characterClass:s.characterClass},i,{skillpointFeasibility:{extraBaseSkillPoints:a}});if(!x.derived.skillpointFeasible){u.spInvalid++;continue}const p=Pe(g.slots,i,s,x);if(!p.ok){u.hardConstraints++,p.reason==="attackSpeed"?u.hardAttackSpeed++:p.reason==="thresholds"?(u.hardThresholds++,u.thresholdFailureExample===void 0&&p.failedChecks?.length&&(u.thresholdFailureExample=p.failedChecks[0])):u.hardItem++;continue}const y=ne(g.slots);if(f.has(y)){u.duplicate++;continue}const{score:S,breakdown:w}=pe(x,s.weights,s);f.add(y),l.push({slots:K(g.slots),score:S,scoreBreakdown:w,summary:x})}return l.sort((g,x)=>{if(g.score!==x.score)return x.score-g.score;for(const p of j){const y=g.slots[p]??0,S=x.slots[p]??0;if(y!==S)return y-S}return 0}),{candidates:l,rejectStats:u}}function Et(e){const{slotOrder:t,candidatePools:i,baseSlots:s,catalog:n,constraints:o,focusStats:a,attackSpeedCtx:l,atkTierRequirement:f,fixedAtkTierTotal:u,onProgress:g,signal:x}=e,p=le(o),y=je(t,i),S=l||f.hasConstraint?ce(t,i,n):null,w=qt(s,n,a),B=Array.from({length:t.length+1},()=>a.map(()=>0));for(let d=t.length-1;d>=0;d--){const b=i.get(t[d])??[],q=a.map(()=>0);for(const D of b){const _=n.itemsById.get(D.id);if(!_)continue;const h=Ee(_,a);for(let C=0;C<h.length;C++)h[C]>q[C]&&(q[C]=h[C])}B[d]=oe(B[d+1],q)}const E=Ae(o),k=E.map(d=>d.key),v=Ie({slotOrder:t,candidatePools:i,catalog:n,keys:k}),F=ge(s,n,k);let M=[{slots:K(s),orderIndex:0,roughScore:0,optimisticBound:y[0],feasibilityAssigned:0,focusSupport:a.map(()=>0),atkTierAssigned:0,customTotals:F}],r=0,c=!1;for(let d=0;d<t.length;d++){if(x?.aborted)throw new DOMException("Auto build cancelled","AbortError");const b=t[d],q=i.get(b)??[],D=[],_=Le({poolSize:q.length,beamSize:M.length,remainingStages:t.length-d,processedStates:r,maxStates:o.maxStates});_<=0&&(c=!0);for(const $ of M){let O=0;for(const m of q){if(O>=_)break;if(r>=o.maxStates){c=!0;break}if(r++,O++,re(m.id,$.slots,n))continue;const I=K($.slots);I[b]=m.id;const A=n.itemsById.get(m.id),P=($.atkTierAssigned??0)+(A?J(A):0),R=oe($.focusSupport??a.map(()=>0),A?Ee(A,a):a.map(()=>0)),z=k.length>0?oe($.customTotals??k.map(()=>0),k.map(V=>A?A.numericIndex[V]??0:0)):void 0;if(S&&!fe({constraints:o,attackSpeedCtx:l??null,atkTierRequirement:f,fixedAtkTierTotal:u,partialAssignedAtkTier:P,remainingMinAtkTier:S.minSuffix[d+1],remainingMaxAtkTier:S.maxSuffix[d+1]})||a.length>0&&!Ct(R,B[d+1],w))continue;if(E.length>0&&z){let V=!0;for(let N=0;N<E.length;N++){const L=E[N],W=z[N];if(typeof L.min=="number"&&W+v.maxSuffix[d+1][N]<L.min){V=!1;break}if(typeof L.max=="number"&&W+v.minSuffix[d+1][N]>L.max){V=!1;break}}if(!V)continue}const H=ke(I,n,o.level,{extraBaseSkillPoints:p}),ee=$.roughScore+m.rough;D.push({slots:I,orderIndex:d+1,roughScore:ee,optimisticBound:ee+y[d+1],feasibilityAssigned:H.feasible?H.assignedTotal:1/0,focusSupport:R,atkTierAssigned:P,customTotals:z})}if(c)break}if(D.length===0)return g?.({phase:"diagnostics",processedStates:r,beamSize:M.length,totalSlots:t.length,expandedSlots:d,reasonCode:"search_pruned",detail:c?`Feasibility-first search exhausted state budget before completing slot ${b}.`:`Feasibility-first search found no branches that can still satisfy high-skill requirements by slot ${b}.`}),{beam:[],processedStates:r,stateBudgetHit:c};const h=S?S.minSuffix[d+1]:0,C=S?S.maxSuffix[d+1]:0,T=[...D].sort(($,O)=>{if(l){const A=Z(l,$.atkTierAssigned,h,C),P=Z(l,O.atkTierAssigned,h,C);if(A!==P)return P-A}if(a.length>0){const A=Fe($.focusSupport??[],w),P=Fe(O.focusSupport??[],w);if(A!==P)return A-P}const m=$.feasibilityAssigned??1/0,I=O.feasibilityAssigned??1/0;return m!==I?m-I:$.optimisticBound!==O.optimisticBound?O.optimisticBound-$.optimisticBound:$.roughScore!==O.roughScore?O.roughScore-$.roughScore:0}),G=[...D].sort(($,O)=>{const m=de($.customTotals,E),I=de(O.customTotals,E);if(m!==I)return m-I;if(l){const A=Z(l,$.atkTierAssigned,h,C),P=Z(l,O.atkTierAssigned,h,C);if(A!==P)return P-A}return O.optimisticBound-$.optimisticBound});M=Re(T,G,Math.max(40,o.beamWidth)),g?.({phase:"beam-search",processedStates:r,beamSize:M.length,totalSlots:t.length,expandedSlots:d+1,detail:`feasibility-first | branchCap=${_}${a.length>0?` | focus=${a.join("/")}`:""}${l?` | atkSpeed=${o.weaponAttackSpeeds.join("/")}`:""}`})}return{beam:M,processedStates:r,stateBudgetHit:c}}function Ft(e){const{slotOrder:t,candidatePools:i,baseSlots:s,catalog:n,constraints:o,signal:a,onProgress:l}=e,f=le(o),u=[],g=new Set;let x=0,p=0,y=0,S=0,w=0,B=0,E=0,k=0;const v=(F,M)=>{if(a?.aborted)throw new DOMException("Auto build cancelled","AbortError");if(x>o.maxStates)return;if(F>=t.length){if(!qe(M,n,o.requiredMajorIds)){p++;return}const d=Te({slots:M,level:o.level,characterClass:o.characterClass},n,{skillpointFeasibility:{extraBaseSkillPoints:f}});if(!d.derived.skillpointFeasible){y++;return}const b=Pe(M,n,o,d);if(!b.ok){w++,b.reason==="attackSpeed"?B++:b.reason==="thresholds"?E++:k++;return}const q=ne(M);if(g.has(q)){S++;return}g.add(q);const{score:D,breakdown:_}=pe(d,o.weights,o);u.push({slots:K(M),score:D,scoreBreakdown:_,summary:d});return}const r=t[F],c=i.get(r)??[];for(const d of c){if(x++,x>o.maxStates)break;re(d.id,M,n)||(M[r]=d.id,x%2e3===0&&l?.({phase:"exact-search",processedStates:x,beamSize:0,totalSlots:t.length,expandedSlots:F+1}),v(F+1,M))}M[r]=null};return v(0,K(s)),l?.({phase:"diagnostics",processedStates:x,beamSize:0,totalSlots:t.length,expandedSlots:t.length,detail:u.length>0?`Exact search produced ${u.length} valid builds. Rejected duplicates=${S}, SP-invalid=${y}, majorID=${p}, hard=${w} (speed=${B}, thresholds=${E}, item=${k}).`:`Exact search produced 0 valid builds. Rejected SP-invalid=${y}, majorID=${p}, duplicates=${S}, hard=${w} (speed=${B}, thresholds=${E}, item=${k}).`}),u.sort((F,M)=>{if(F.score!==M.score)return M.score-F.score;for(const r of j){const c=F.slots[r]??0,d=M.slots[r]??0;if(c!==d)return c-d}return 0}),u.slice(0,Math.max(1,o.topN))}function Nt(e){const{slotOrder:t,candidatePools:i,baseSlots:s,catalog:n,constraints:o,attackSpeedCtx:a,atkTierRequirement:l,fixedAtkTierTotal:f,customSpecs:u,customBounds:g,signal:x,timeCapMs:p=2e3}=e,y=le(o),S=new Map;for(const d of t){const b=i.get(d)??[];S.set(d,[...b].sort((q,D)=>q.rough!==D.rough?D.rough-q.rough:q.id-D.id))}const w=a||l.hasConstraint?ce(t,i,n):null,B=u.map(d=>d.key),E=ge(s,n,B),k=Date.now();let v=!1,F=0;const M=new Set,r=[],c=(d,b,q,D)=>{if(v)return;if(x?.aborted)throw new DOMException("Auto build cancelled","AbortError");if(Date.now()-k>=p){v=!0;return}if(r.length>=Math.max(1,o.topN))return;if(d>=t.length){if(!qe(b,n,o.requiredMajorIds))return;const C=Te({slots:b,level:o.level,characterClass:o.characterClass},n,{skillpointFeasibility:{extraBaseSkillPoints:y}});if(!C.derived.skillpointFeasible||!Pe(b,n,o,C).ok)return;const G=ne(b);if(M.has(G))return;M.add(G);const{score:$,breakdown:O}=pe(C,o.weights,o);r.push({slots:K(b),score:$,scoreBreakdown:O,summary:C});return}const _=t[d],h=S.get(_)??[];for(const C of h){if(v)break;if(F++,re(C.id,b,n))continue;const T=K(b);T[_]=C.id;const G=n.itemsById.get(C.id),$=q+(G?J(G):0);if(w&&!fe({constraints:o,attackSpeedCtx:a,atkTierRequirement:l,fixedAtkTierTotal:f,partialAssignedAtkTier:$,remainingMinAtkTier:w.minSuffix[d+1],remainingMaxAtkTier:w.maxSuffix[d+1]}))continue;const O=B.length>0?oe(D??B.map(()=>0),B.map(I=>G?G.numericIndex[I]??0:0)):void 0;if(u.length>0&&O){let I=!0;for(let A=0;A<u.length;A++){const P=u[A],R=O[A];if(typeof P.min=="number"&&R+g.maxSuffix[d+1][A]<P.min){I=!1;break}if(typeof P.max=="number"&&R+g.minSuffix[d+1][A]>P.max){I=!1;break}}if(!I)continue}ke(T,n,o.level,{extraBaseSkillPoints:y}).feasible&&c(d+1,T,$,O)}};return c(0,K(s),0,E),r.sort((d,b)=>d.score!==b.score?b.score-d.score:ne(d.slots).localeCompare(ne(b.slots))),{candidates:r.slice(0,Math.max(1,o.topN)),processedStates:F,timedOut:v}}function We(e){const{catalog:t,baseWorkbench:i,constraints:s,onProgress:n,signal:o,alreadyThresholdRescue:a}=e;if(o?.aborted)throw new DOMException("Auto build cancelled","AbortError");let l=K(i.slots);for(const m of j)s.lockedSlots[m]||(l[m]=null);const f=At(l,t,s);if(!f.ok)return n?.({phase:"diagnostics",processedStates:0,beamSize:0,totalSlots:0,expandedSlots:0,reasonCode:f.reasonCode??"must_include_conflict",detail:f.detail??"Must-include assignment failed before search started."}),[];l=f.slots;const u=It(l,t),g=j.filter(m=>l[m]==null),x=s.onlyPinnedItems?Rt(i):null,p=new Map;for(const m of g)p.set(m,Dt(m,t,s,x?.[m]??null,u));const y=St(l,t,s),S=Oe(_e(s)),w=be(l,t),B=Ae(s),E=B.some(m=>typeof m.min=="number"),k=[...g].sort((m,I)=>{if(y?.preferredDirection){const R=p.get(m)??[],z=p.get(I)??[],H=R.reduce((V,N)=>{const L=t.itemsById.get(N.id);if(!L)return V;const W=J(L),U=y.preferredDirection>0?Math.max(0,W):Math.max(0,-W);return Math.max(V,U)},0),ee=z.reduce((V,N)=>{const L=t.itemsById.get(N.id);if(!L)return V;const W=J(L),U=y.preferredDirection>0?Math.max(0,W):Math.max(0,-W);return Math.max(V,U)},0);if(H!==ee)return ee-H}if(u.length>0){const R=Ne(m,p,t,u),z=Ne(I,p,t,u);if(R!==z)return z-R}if(E){const R=["ring1","ring2","bracelet","necklace"],z=R.includes(m),H=R.includes(I);if(z!==H)return z?-1:1}const A=p.get(m)?.length??0,P=p.get(I)?.length??0;return A!==P?A-P:m.localeCompare(I)}),v=je(k,p);if(k.some(m=>(p.get(m)?.length??0)===0)){const m=k.find(I=>(p.get(I)?.length??0)===0);return n?.({phase:"diagnostics",processedStates:0,beamSize:0,totalSlots:k.length,expandedSlots:0,reasonCode:"empty_pool",detail:m?`No candidate items available for slot ${m} under current hard filters.`:"One or more slots have empty candidate pools."}),[]}if(S.hasConstraint&&S.minAllowed>S.maxAllowed)return n?.({phase:"diagnostics",processedStates:0,beamSize:0,totalSlots:k.length,expandedSlots:0,reasonCode:"unsat_attack_target",detail:`Attack target is unsatisfiable: atkTier min (${S.minAllowed}) exceeds atkTier max (${S.maxAllowed}).`}),[];if(B.length>0){const m=B.map(P=>P.key),I=Ie({slotOrder:k,candidatePools:p,catalog:t,keys:m}),A=ge(l,t,m);for(let P=0;P<B.length;P++){const R=B[P],z=A[P]+I.minSuffix[0][P],H=A[P]+I.maxSuffix[0][P];if(typeof R.min=="number"&&H<R.min)return n?.({phase:"diagnostics",processedStates:0,beamSize:0,totalSlots:k.length,expandedSlots:0,reasonCode:"unsat_threshold",detail:`Unsatisfiable threshold: ${R.key} min ${R.min} is above maximum reachable total ${H}.`}),[];if(typeof R.max=="number"&&z>R.max)return n?.({phase:"diagnostics",processedStates:0,beamSize:0,totalSlots:k.length,expandedSlots:0,reasonCode:"unsat_threshold",detail:`Unsatisfiable threshold: ${R.key} max ${R.max} is below minimum reachable total ${z}.`}),[]}}const F=y||S.hasConstraint?ce(k,p,t):null;if(F&&!fe({constraints:s,attackSpeedCtx:y??null,atkTierRequirement:S,fixedAtkTierTotal:w,partialAssignedAtkTier:0,remainingMinAtkTier:F.minSuffix[0],remainingMaxAtkTier:F.maxSuffix[0]}))return n?.({phase:"diagnostics",processedStates:0,beamSize:0,totalSlots:k.length,expandedSlots:0,reasonCode:"unsat_attack_target",detail:"Attack-speed / atkTier target cannot be reached from current candidate pools."}),[];const M=$t(k,p,s.exhaustiveStateLimit+1);if(s.useExhaustiveSmallPool&&k.length>0&&M>0&&M<=s.exhaustiveStateLimit){n?.({phase:"exact-search",processedStates:0,beamSize:0,totalSlots:k.length,expandedSlots:0});const m={...s,maxStates:Math.max(s.maxStates,s.exhaustiveStateLimit)};return Ft({slotOrder:k,candidatePools:p,baseSlots:l,catalog:t,constraints:m,signal:o,onProgress:n})}const r=Ae(s),c=r.map(m=>m.key),d=Ie({slotOrder:k,candidatePools:p,catalog:t,keys:c});let b=[{slots:l,orderIndex:0,roughScore:0,optimisticBound:v[0],atkTierAssigned:0,customTotals:ge(l,t,c)}];const q=y||S.hasConstraint?ce(k,p,t):null;let D=0,_=!1;for(let m=0;m<k.length;m++){if(o?.aborted)throw new DOMException("Auto build cancelled","AbortError");const I=k[m],A=p.get(I),P=[],R=Le({poolSize:A.length,beamSize:b.length,remainingStages:k.length-m,processedStates:D,maxStates:s.maxStates});R<=0&&(_=!0);for(const N of b){let L=0;for(const W of A){if(L>=R)break;if(D>=s.maxStates){_=!0;break}if(D++,L++,re(W.id,N.slots,t))continue;const U=K(N.slots);U[I]=W.id;const ae=N.roughScore+W.rough,te=t.itemsById.get(W.id),He=(N.atkTierAssigned??0)+(te?J(te):0),we=c.length>0?oe(N.customTotals??c.map(()=>0),c.map(se=>te?te.numericIndex[se]??0:0)):void 0;if(!(q&&!fe({constraints:s,attackSpeedCtx:y??null,atkTierRequirement:S,fixedAtkTierTotal:w,partialAssignedAtkTier:He,remainingMinAtkTier:q.minSuffix[m+1],remainingMaxAtkTier:q.maxSuffix[m+1]}))){if(r.length>0&&we){let se=!0;for(let ie=0;ie<r.length;ie++){const he=r[ie],Ve=we[ie];if(typeof he.min=="number"&&Ve+d.maxSuffix[m+1][ie]<he.min){se=!1;break}if(typeof he.max=="number"&&Ve+d.minSuffix[m+1][ie]>he.max){se=!1;break}}if(!se)continue}P.push({slots:U,orderIndex:m+1,roughScore:ae,optimisticBound:ae+v[m+1],atkTierAssigned:He,customTotals:we})}}if(_)break}if(P.length===0)return n?.({phase:"diagnostics",processedStates:D,beamSize:b.length,totalSlots:k.length,expandedSlots:m,reasonCode:"search_pruned",detail:_?`Search state budget exhausted before completing slot ${I}. Try enabling deep fallback/exact mode or reduce hard filters.`:`No expansions produced at slot ${I}.`}),[];const z=q?q.minSuffix[m+1]:0,H=q?q.maxSuffix[m+1]:0,ee=[...P].sort((N,L)=>{if(y){const W=Z(y,N.atkTierAssigned,z,H),U=Z(y,L.atkTierAssigned,z,H);if(W!==U)return U-W}return N.optimisticBound!==L.optimisticBound?L.optimisticBound-N.optimisticBound:L.roughScore-N.roughScore}),V=[...P].sort((N,L)=>{const W=de(N.customTotals,r),U=de(L.customTotals,r);if(W!==U)return W-U;if(y){const ae=Z(y,N.atkTierAssigned,z,H),te=Z(y,L.atkTierAssigned,z,H);if(ae!==te)return te-ae}return L.optimisticBound-N.optimisticBound});b=Re(ee,V,Math.max(20,s.beamWidth)),n?.({phase:"beam-search",processedStates:D,beamSize:b.length,totalSlots:k.length,expandedSlots:m+1,detail:`branchCap=${R}${y?.preferredDirection?` | atkSpeedTarget=${s.weaponAttackSpeeds.join("/")}`:""}`})}let h=b,{candidates:C,rejectStats:T}=ze({beam:b,catalog:t,constraints:s,signal:o});const G=T.thresholdFailureExample?` Example failure: ${T.thresholdFailureExample}.`:"",$=C.length>0?void 0:T.spInvalid>0&&T.hardConstraints===0?"sp_infeasible":T.hardThresholds>0?"unsat_threshold":T.hardAttackSpeed>0?"unsat_attack_target":void 0;n?.({phase:"diagnostics",processedStates:D,beamSize:b.length,totalSlots:k.length,expandedSlots:k.length,reasonCode:$,detail:C.length>0?`Final eval: ${C.length} valid builds. Rejected duplicates=${T.duplicate}, SP-invalid=${T.spInvalid}, majorID=${T.majorIds}, hard=${T.hardConstraints}.`:`Final eval found 0 valid builds. Rejected SP-invalid=${T.spInvalid}, majorID=${T.majorIds}, duplicates=${T.duplicate}, hard=${T.hardConstraints} (speed=${T.hardAttackSpeed}, thresholds=${T.hardThresholds}, item=${T.hardItem}).${G}`});const O=s.weaponAttackSpeeds.length>0||S.hasConstraint;if(C.length===0&&k.length>0&&(T.spInvalid>0||O&&T.hardAttackSpeed>0||T.hardThresholds>0)){const m=T.hardThresholds>0;n?.({phase:"diagnostics",processedStates:D,beamSize:b.length,totalSlots:k.length,expandedSlots:k.length,detail:m&&s.target.customNumericRanges?.length?"Retrying with threshold-aware rescue (advanced ID constraints + support-aware feasibility search).":T.hardAttackSpeed>0?"Retrying with feasibility-first beam search (support-aware rescue + attack target reachability).":"Retrying with feasibility-first beam search (support-aware rescue for high-skill requirements)."});const I={...s,maxStates:Math.max(s.maxStates,m?Math.min(18e6,s.maxStates*5):O?Math.min(16e6,s.maxStates*4):Math.min(8e6,s.maxStates*2)),beamWidth:Math.max(s.beamWidth,m?3600:O?3200:1800)};m&&(I.weights=De(s.target,s.weights));const A=Et({slotOrder:k,candidatePools:p,baseSlots:l,catalog:t,constraints:I,focusStats:u,attackSpeedCtx:y,atkTierRequirement:S,fixedAtkTierTotal:w,onProgress:n,signal:o});if(A.beam.length>0){h=A.beam;const P=ze({beam:A.beam,catalog:t,constraints:s,signal:o});C=P.candidates,T=P.rejectStats;const R=T.thresholdFailureExample?` Example failure: ${T.thresholdFailureExample}.`:"";n?.({phase:"diagnostics",processedStates:A.processedStates,beamSize:A.beam.length,totalSlots:k.length,expandedSlots:k.length,detail:C.length>0?`Feasibility-first eval: ${C.length} valid builds. Rejected duplicates=${T.duplicate}, SP-invalid=${T.spInvalid}, majorID=${T.majorIds}, hard=${T.hardConstraints}.`:`Feasibility-first eval still found 0 valid builds. Rejected SP-invalid=${T.spInvalid}, majorID=${T.majorIds}, duplicates=${T.duplicate}, hard=${T.hardConstraints} (speed=${T.hardAttackSpeed}, thresholds=${T.hardThresholds}, item=${T.hardItem}).${R}`})}}if(C.length===0&&T.hardThresholds>0&&!a){const m=s.target;if(typeof m.minLegacyBaseDps=="number"||typeof m.minLegacyEhp=="number"||typeof m.minDpsProxy=="number"||typeof m.minEhpProxy=="number"||typeof m.minMr=="number"||typeof m.minMs=="number"||typeof m.minSpeed=="number"||typeof m.minSkillPointTotal=="number"||typeof m.maxReqTotal=="number"||(m.customNumericRanges?.length??0)>0){n?.({phase:"diagnostics",processedStates:D,beamSize:h.length,totalSlots:k.length,expandedSlots:k.length,detail:"Retrying with threshold-biased beam search (weights tuned to target min/max)."});const A={...s,weights:De(s.target,s.weights),beamWidth:Math.max(s.beamWidth,3600),maxStates:Math.max(s.maxStates,Math.min(18e6,s.maxStates*5))},P=We({catalog:t,baseWorkbench:i,constraints:A,onProgress:n,signal:o,alreadyThresholdRescue:!0});if(P.length>0)return n?.({phase:"diagnostics",processedStates:D,beamSize:P.length,totalSlots:k.length,expandedSlots:k.length,detail:`Threshold rescue: ${P.length} valid builds.`}),P.slice(0,Math.max(1,s.topN))}}if(C.length===0&&k.length>0){n?.({phase:"diagnostics",processedStates:D,beamSize:h.length,totalSlots:k.length,expandedSlots:k.length,reasonCode:"search_pruned",detail:"Running deterministic fallback search (2s cap) before returning no candidates."});const m=Nt({slotOrder:k,candidatePools:p,baseSlots:l,catalog:t,constraints:s,attackSpeedCtx:y??null,atkTierRequirement:S,fixedAtkTierTotal:w,customSpecs:r,customBounds:d,signal:o,timeCapMs:2e3});if(m.candidates.length>0)C=m.candidates,n?.({phase:"diagnostics",processedStates:D+m.processedStates,beamSize:m.candidates.length,totalSlots:k.length,expandedSlots:k.length,detail:`Deterministic fallback recovered ${m.candidates.length} valid build(s).`});else{const I=m.timedOut?"fallback_timeout":T.spInvalid>0&&T.hardConstraints===0?"sp_infeasible":T.hardThresholds>0?"unsat_threshold":T.hardAttackSpeed>0?"unsat_attack_target":"search_pruned";n?.({phase:"diagnostics",processedStates:D+m.processedStates,beamSize:0,totalSlots:k.length,expandedSlots:k.length,reasonCode:I,detail:m.timedOut?"Deterministic fallback timed out after 2 seconds with no valid candidates.":`Deterministic fallback found 0 valid builds. Rejected SP-invalid=${T.spInvalid}, majorID=${T.majorIds}, duplicates=${T.duplicate}, hard=${T.hardConstraints} (speed=${T.hardAttackSpeed}, thresholds=${T.hardThresholds}, item=${T.hardItem}).${T.thresholdFailureExample?` Example failure: ${T.thresholdFailureExample}.`:""}`})}}return C.slice(0,Math.max(1,s.topN))}const Ce=new Map;self.onmessage=e=>{const t=e.data;if(t.type==="cancel"){Ce.get(t.requestId)?.abort();return}const i=new AbortController;Ce.set(t.requestId,i);try{const s=We({catalog:{...t.catalog,itemsById:new Map(t.catalog.itemsById),itemIdByName:new Map(t.catalog.itemIdByName),itemsByType:new Map(t.catalog.itemsByType),itemsByCategory:new Map(t.catalog.itemsByCategory)},baseWorkbench:t.baseWorkbench,constraints:t.constraints,signal:i.signal,onProgress:o=>{const a={type:"progress",requestId:t.requestId,progress:o};self.postMessage(a)}}),n={type:"result",requestId:t.requestId,candidates:s};self.postMessage(n)}catch(s){const n={type:"error",requestId:t.requestId,message:s instanceof Error?s.message:"Auto builder worker error"};self.postMessage(n)}finally{Ce.delete(t.requestId)}}})();
