(function(){"use strict";const ue=["helmet","chestplate","leggings","boots"],me=["spear","wand","dagger","bow","relik"],he=["ring","bracelet","necklace"],pe=["SLOW","NORMAL","FAST"];function V(t){const e=t.toLowerCase();return ue.includes(e)?"armor":me.includes(e)?"weapon":he.includes(e)?"accessory":"consumable"}const N=4e3,G=[0,1,1.25,1.4],F=["e","t","w","f","a"],ge=[{min:3,max:6,convert:17,defPlus:2,defMinus:1},{min:5,max:8,convert:21,defPlus:4,defMinus:2},{min:6,max:10,convert:25,defPlus:8,defMinus:3},{min:7,max:10,convert:31,defPlus:14,defMinus:5},{min:9,max:11,convert:38,defPlus:22,defMinus:9},{min:11,max:13,convert:46,defPlus:30,defMinus:13},{min:1,max:8,convert:9,defPlus:3,defMinus:1},{min:1,max:12,convert:11,defPlus:5,defMinus:1},{min:2,max:15,convert:13,defPlus:9,defMinus:2},{min:3,max:15,convert:17,defPlus:14,defMinus:4},{min:4,max:17,convert:22,defPlus:20,defMinus:7},{min:5,max:20,convert:28,defPlus:28,defMinus:10},{min:3,max:4,convert:13,defPlus:3,defMinus:1},{min:4,max:6,convert:15,defPlus:6,defMinus:1},{min:5,max:8,convert:17,defPlus:11,defMinus:2},{min:6,max:8,convert:21,defPlus:18,defMinus:4},{min:7,max:10,convert:26,defPlus:28,defMinus:7},{min:9,max:11,convert:32,defPlus:40,defMinus:10},{min:2,max:5,convert:14,defPlus:3,defMinus:1},{min:4,max:8,convert:16,defPlus:5,defMinus:2},{min:5,max:9,convert:19,defPlus:9,defMinus:3},{min:6,max:9,convert:24,defPlus:16,defMinus:5},{min:8,max:10,convert:30,defPlus:25,defMinus:9},{min:10,max:12,convert:37,defPlus:36,defMinus:13},{min:2,max:6,convert:11,defPlus:3,defMinus:1},{min:3,max:10,convert:14,defPlus:6,defMinus:2},{min:4,max:11,convert:17,defPlus:10,defMinus:3},{min:5,max:11,convert:22,defPlus:16,defMinus:5},{min:7,max:12,convert:28,defPlus:24,defMinus:9},{min:8,max:14,convert:35,defPlus:34,defMinus:13}];function Me(t){return t/6|0}function xe(t){return F[Me(t)]}function be(t){const e=[[100,100],[100,100],[100,100]];for(let n=0;n<6;n++){const i=t[n].posMods,a=Math.floor(n/2),r=n%2;if(i.above!==0)for(let s=a-1;s>=0;s--)e[s][r]+=i.above;if(i.under!==0)for(let s=a+1;s<3;s++)e[s][r]+=i.under;if(i.left!==0&&r===1&&(e[a][r-1]+=i.left),i.right!==0&&r===0&&(e[a][r+1]+=i.right),i.touching!==0)for(let s=0;s<3;s++)for(let l=0;l<2;l++)(Math.abs(s-a)===1&&l===r||s===a&&Math.abs(l-r)===1)&&(e[s][l]+=i.touching);if(i.notTouching!==0)for(let s=0;s<3;s++)for(let l=0;l<2;l++)(Math.abs(s-a)>1||Math.abs(s-a)===1&&Math.abs(l-r)===1)&&(e[s][l]+=i.notTouching)}return e.flat()}function j(t,e,n,o){const i=t.type.toLowerCase(),a=V(i);let r=!0;for(const u of n)if(u.id!==N){r=!1;break}let s=0,l=0;(a==="weapon"||a==="armor")&&(t.lvl[0]<30?s=1:t.lvl[0]<70?s=2:s=3),a==="consumable"&&(t.lvl[0]<30?l=1:t.lvl[0]<70?l=2:l=3,r&&(l=3));const g=t.materials.map(u=>u.amount),p=(G[e[0]]*g[0]+G[e[1]]*g[1])/(g[0]+g[1]);let d=[t.durability[0],t.durability[1]],m=[t.duration[0],t.duration[1]];a==="consumable"?(r&&(m=[t.basicDuration[0],t.basicDuration[1]]),m=[Math.round(m[0]*p),Math.round(m[1]*p)]):d=[Math.round(d[0]*p),Math.round(d[1]*p)];const c=t.healthOrDamage[0],f=t.healthOrDamage[1];let R=0,E=0,O="0-0",v="0-0";const q={e:0,t:0,w:0,f:0,a:0};if(a==="armor")R=Math.floor(f*p),E=Math.floor(c*p);else if(a==="weapon"){let u=2.05;o==="SLOW"?u/=1.5:o==="NORMAL"?u=1:o==="FAST"&&(u/=2.5);const M=Math.floor(Math.floor(c*p)*u),b=Math.floor(Math.floor(f*p)*u);v=`${Math.floor(M*.9)}-${Math.floor(M*1.1)}`,O=`${Math.floor(b*.9)}-${Math.floor(b*1.1)}`}else a==="consumable"&&r&&(R=Math.floor(f*p),E=Math.floor(c*p));if(a==="armor"||a==="accessory"){for(const u of n)if(u.isPowder&&u.pid!=null){const M=ge[u.pid],b=xe(u.pid),S=F[(F.indexOf(b)+4)%5];q[b]=(q[b]||0)+M.defPlus,q[S]=(q[S]||0)-M.defMinus}}const B=be(n),C=[0,0,0,0,0],$={},_={};for(let u=0;u<6;u++){const M=n[u],b=B[u]/100,S=M.itemIDs;if(a!=="consumable"){const I=["strReq","dexReq","intReq","defReq","agiReq"];for(let y=0;y<I.length;y++){const T=S[I[y]];T!==0&&(M.isPowder?C[y]+=Math.round(T):C[y]+=Math.round(T*b))}}S.dura!==0&&(d[0]+=S.dura,d[1]+=S.dura),M.consumableIDs.dura!==0&&(m[0]+=M.consumableIDs.dura,m[1]+=M.consumableIDs.dura),M.consumableIDs.charges!==0&&(l+=M.consumableIDs.charges);for(const[I,y]of Object.entries(M.ids)){if(y.max===0&&y.min===0)continue;let T=y.min,k=y.max;const w=[Math.floor(T*b),Math.floor(k*b)].sort((A,je)=>A-je);T=w[0],k=w[1],_[I]=(_[I]??0)+T,$[I]=($[I]??0)+k}}return d[0]=Math.max(1,Math.floor(d[0])),d[1]=Math.max(1,Math.floor(d[1])),r||(m[0]=Math.max(10,m[0]),m[1]=Math.max(10,m[1])),l=Math.max(l,a==="consumable"?1:0),{category:a,type:i,lvl:t.lvl[1],hp:R,hpLow:E,nDam:O,nDamLow:v,eDam:"0-0",tDam:"0-0",wDam:"0-0",fDam:"0-0",aDam:"0-0",eDef:q.e,tDef:q.t,wDef:q.w,fDef:q.f,aDef:q.a,atkSpd:o,durability:d,duration:m,charges:l,slots:s,reqs:[C[0],C[1],C[2],C[3],C[4]],effectiveness:B,maxRolls:$,minRolls:_}}function Q(t,e,n,o,i){const a={SLOW:0,NORMAL:1,FAST:2},r=[0];let s=0;function l(m,c){for(let f=0;f<c;f++){const R=m>>>f&1,E=s+f,O=E>>>5;for(;O>=r.length;)r.push(0);R&&(r[O]|=1<<(E&31))}s+=c}l(0,1),l(2,7);for(const m of t)l(m,12);l(e,12),l(n[0]-1,3),l(n[1]-1,3),i==="weapon"&&l(a[o]??0,4);const g=s%6;l(0,g===0?6:6-g);const p="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz+-";let d="";for(let m=0;m<s;m+=6){let c=0;for(let f=0;f<6;f++){const R=m+f;R<s&&(c|=(r[R>>>5]>>>(R&31)&1)<<f)}d+=p[c]}return"CR-"+d}const X=["sdPct","sdRaw","mdPct","mdRaw","damPct","poison","fDamPct","wDamPct","aDamPct","tDamPct","eDamPct","spPct1","spRaw1","spPct2","spRaw2","spPct3","spRaw3","spPct4","spRaw4","rSdRaw","critDamPct"],J=["hpBonus","hprRaw","hprPct","fDefPct","wDefPct","aDefPct","tDefPct","eDefPct"],Z=["mr","ms","ls","spd","xpb","lb","ref","thorns","spRegen","eSteal","sprint","sprintReg","jh","lq","gXp","gSpd"],ee=["str","dex","int","def","agi"];function te(t,e){let n=0;for(const o of e){const i=t.maxRolls[o]??0;i>0&&(n+=i)}return n}function Se(t,e){let n=0;for(const o of e)n+=t.maxRolls[o]??0;return n}function ye(t){let e=te(t,X);return t.category==="armor"&&(e+=t.hp*.02),e}function Pe(t){let e=te(t,J);return t.category==="armor"&&(e+=t.hp*.15),e+=Math.max(0,t.eDef)+Math.max(0,t.tDef)+Math.max(0,t.wDef)+Math.max(0,t.fDef)+Math.max(0,t.aDef),e}function Ie(t){let e=0;const n=t.maxRolls.mr??0,o=t.maxRolls.ms??0,i=t.maxRolls.ls??0,a=t.maxRolls.spd??0;e+=n*12+o*8+i*6+a*3;for(const r of Z){if(r==="mr"||r==="ms"||r==="ls"||r==="spd")continue;const s=t.maxRolls[r]??0;s>0&&(e+=s)}return e}function Re(t){return Se(t,ee)}function De(t){let e=0;for(const n of t.reqs)e+=Math.max(0,n);return e}function ne(t,e){if(e==="durability")return[t.durability[0],t.durability[1]];if(e==="duration")return[t.duration[0],t.duration[1]];const n=t.maxRolls[e]??0;return[n,n]}function we(t,e){let n=0;for(const[o,i]of Object.entries(e)){const[a,r]=ne(t,o);if(typeof i.min=="number"&&a<i.min){const s=i.min-a;n+=s*200+s*s}if(typeof i.max=="number"&&r>i.max){const s=r-i.max;n+=s*200+s*s}}return n}function oe(t,e){for(const[n,o]of Object.entries(e)){const[i,a]=ne(t,n);if(typeof o.min=="number"&&i<o.min||typeof o.max=="number"&&a>o.max)return!1}return!0}function U(t,e,n){const o=ye(t)*e.offense,i=Pe(t)*e.defense,a=Ie(t)*e.utility,r=Re(t)*e.skillPoints,s=De(t)*e.reqPenalty,l=we(t,n.target),g={offense:o,defense:i,utility:a,skillPoints:r,reqPenalty:s,thresholdPenalty:l};return{score:o+i+a+r-s-l,breakdown:g}}function W(t,e,n){let o=0;for(const[a,r]of Object.entries(t.ids)){const s=r.max;X.includes(a)&&s>0?o+=s*e.offense:J.includes(a)&&s>0?o+=s*e.defense:Z.includes(a)?a==="mr"?o+=s*12*e.utility:a==="ms"?o+=s*8*e.utility:a==="ls"?o+=s*6*e.utility:a==="spd"?o+=s*3*e.utility:s>0&&(o+=s*e.utility):ee.includes(a)&&(o+=s*e.skillPoints),n?.has(a)&&s>0&&(o+=s*50)}const i=Math.max(0,t.itemIDs.strReq)+Math.max(0,t.itemIDs.dexReq)+Math.max(0,t.itemIDs.intReq)+Math.max(0,t.itemIDs.defReq)+Math.max(0,t.itemIDs.agiReq);return o-=i*e.reqPenalty*.5,o}const P=6,ve=.65,Y=2e3,Te=36,ke=12,qe=12,se=10;function Ee(t,e,n){const o=t.recipesByType.get(e.toUpperCase());if(!o)return null;const i=`${e.charAt(0).toUpperCase()}${e.slice(1).toLowerCase()}-${n}`;return o.find(a=>a.name===i)??null}function Oe(t,e,n){const o=e.skill.toUpperCase(),i=e.lvl[1],a=new Set(n.excludedIngredients),r=[];for(const s of t.ingredients)s.id!==N&&(a.has(s.id)||s.lvl>i||s.skills.some(l=>l.toUpperCase()===o)&&r.push(s));return r}function z(t,e){return e==="durability"?t.itemIDs.dura??0:e==="duration"?t.consumableIDs.dura??0:t.ids[e]?.max??0}function Le(t){const e=t.posMods;return e.left>0||e.right>0||e.above>0||e.under>0||e.touching>0||e.notTouching>0}function ie(t){const e=t.posMods;return Math.max(0,e.left)+Math.max(0,e.right)+Math.max(0,e.above)+Math.max(0,e.under)+Math.max(0,e.touching)+Math.max(0,e.notTouching)}function re(t,e){let n=0;for(const o of e){const i=z(t,o);i>0&&(n+=i)}return n}function Ce(t,e,n){const o=new Set(n.mustIncludeIngredients),i=new Set(Object.keys(n.target)),a=i.size>0,r=e.map(d=>({ing:d,score:W(d,n.weights,a?i:void 0)}));r.sort((d,m)=>m.score-d.score);const s=n.topKPerSlot,l=new Set,g=[t.noIngredient];l.add(N);let p=0;for(const{ing:d}of r)o.has(d.id)&&!l.has(d.id)&&(l.add(d.id),g.push(d));for(const{ing:d}of r)if(!l.has(d.id)&&(l.add(d.id),g.push(d),p++,p>=s))break;if(a){const d=e.filter(c=>!l.has(c.id)).map(c=>({ing:c,tScore:Array.from(i).reduce((f,R)=>{const E=z(c,R);return E>0?f+E:f},0)})).filter(({tScore:c})=>c>0);d.sort((c,f)=>f.tScore-c.tScore);const m=Math.min(d.length,Math.max(30,Math.floor(s/2)));for(let c=0;c<m;c++){const{ing:f}=d[c];l.has(f.id)||(l.add(f.id),g.push(f))}}return g}function ae(t,e){if(e.size===0)return 0;const n=new Set(t);let o=0;for(const i of e)n.has(i)||o++;return o}function ce(t,e){const n=e.maxReqs;for(let o=0;o<5;o++){const i=n[o];if(i!=null&&Math.max(0,t.reqs[o])>i)return!1}return!0}function le(t,e){if(e.size===0)return!0;const n=new Set(t);for(const o of e)if(!n.has(o))return!1;return!0}function Ae(t,e,n,o,i,a){const r=[];for(let p=0;p<P;p++)p<e.length?r.push(n.ingredientsById.get(e[p])??n.noIngredient):r.push(n.noIngredient);const s=j(t,i,r,a),{score:l,breakdown:g}=U(s,o.weights,o);return{score:l,thresholdPenalty:g.thresholdPenalty}}function Be(t,e,n){const o=Math.floor(e/2),i=e%2,a=Math.floor(n/2),r=n%2;if(o===a&&i===r)return 0;let s=0;return r===i&&a<o&&(s+=t.above),r===i&&a>o&&(s+=t.under),o===a&&i===1&&r===0&&(s+=t.left),o===a&&i===0&&r===1&&(s+=t.right),(Math.abs(a-o)===1&&r===i||a===o&&Math.abs(r-i)===1)&&(s+=t.touching),(Math.abs(a-o)>1||Math.abs(a-o)===1&&Math.abs(r-i)===1)&&(s+=t.notTouching),s}function $e(t){const e=[];for(let n=0;n<P;n++){let o=100;for(let i=0;i<P;i++){if(i===n)continue;let a=0;for(const r of t){const s=Be(r.posMods,i,n);s>a&&(a=s)}o+=Math.max(0,a)}e[n]=Math.max(0,o)/100}return e}function fe(t,e,n){const o=z(t,e);if(o<=0)return 0;let i=0;for(const a of n){const r=Math.ceil(o*a);r>i&&(i=r)}return i}function _e(t,e,n){if(n.size>P)return`Unsatisfiable constraints: ${n.size} distinct must-include ingredients exceed ${P} slots.`;const o=new Map;for(const r of t)o.set(r.id,r);for(const r of n)if(!o.has(r))return`Unsatisfiable constraints: must-include ingredient #${r} is not eligible for this recipe/level range.`;const i=$e(t),a=Math.max(0,P-n.size);for(const[r,s]of Object.entries(e.target)){if(typeof s.min!="number"||r==="durability"||r==="duration")continue;let l=0;for(const d of t){const m=fe(d,r,i);m>l&&(l=m)}let g=0;for(const d of n){const m=o.get(d);m&&(g+=fe(m,r,i))}const p=g+a*l;if(p<s.min)return`Unsatisfiable threshold: ${r} min ${s.min} exceeds theoretical max ${p} for the current recipe/level/ingredient pool.`}return null}function Ke(t,e,n,o){const i=Object.keys(n.target),a=n.maxReqs.some(c=>c!=null),r=new Set(i),s=new Set,l=[],g=new Map;for(const c of e)g.set(c.id,c);const p=c=>{!c||s.has(c.id)||(s.add(c.id),l.push(c))};p(t.noIngredient);for(const c of o)p(g.get(c));const d=e.map(c=>({ing:c,score:re(c,i)})).filter(({score:c})=>c>0).sort((c,f)=>f.score-c.score);for(let c=0;c<Math.min(Te,d.length);c++)p(d[c].ing);const m=e.filter(Le).map(c=>({ing:c,score:ie(c)})).sort((c,f)=>f.score-c.score);for(let c=0;c<Math.min(ke,m.length);c++)p(m[c].ing);if(a){const c=e.map(f=>{const R=Math.max(0,-f.itemIDs.strReq)+Math.max(0,-f.itemIDs.dexReq)+Math.max(0,-f.itemIDs.intReq)+Math.max(0,-f.itemIDs.defReq)+Math.max(0,-f.itemIDs.agiReq);return{ing:f,reduction:R}}).filter(({reduction:f})=>f>0).sort((f,R)=>R.reduction-f.reduction);for(let f=0;f<Math.min(qe,c.length);f++)p(c[f].ing)}if(l.length<12){const c=e.map(f=>({ing:f,score:W(f,n.weights,r)})).sort((f,R)=>R.score-f.score);for(const{ing:f}of c)if(p(f),l.length>=12)break}return l}function Ne(t,e,n,o,i){for(const[a,r]of Object.entries(o.target)){if(typeof r.min!="number"||a==="durability"||a==="duration")continue;let s=0;for(const g of t){const p=n.get(g);if(!p)continue;const d=Math.max(0,z(p,a));s+=d*se}if(s+e*(i.get(a)??0)<r.min)return!1}return!0}function ze(t){const{recipe:e,catalog:n,constraints:o,category:i,matTierOptions:a,atkSpdOptions:r,mustIncludeSet:s,eligible:l,signal:g}=t,p=Date.now();let d=!1,m=0;const c=Object.keys(o.target),f=Ke(n,l,o,s);if(f.length===0)return{candidates:[],processedStates:0,timedOut:!1,detail:"Deterministic fallback had no eligible fallback ingredients to explore."};const R=new Map;for(const[x,D]of Object.entries(o.target)){if(typeof D.min!="number"||x==="durability"||x==="duration")continue;let L=0;for(const K of f){const h=Math.max(0,z(K,x));h>L&&(L=h)}R.set(x,L*se)}const E=new Map;for(const x of f){const D=Math.max(0,-x.itemIDs.strReq)+Math.max(0,-x.itemIDs.dexReq)+Math.max(0,-x.itemIDs.intReq)+Math.max(0,-x.itemIDs.defReq)+Math.max(0,-x.itemIDs.agiReq);E.set(x.id,{threshold:re(x,c),support:ie(x),reqReduce:D,rough:W(x,o.weights,new Set(c))})}const O=[...f].sort((x,D)=>{if(x.id===N&&D.id!==N)return 1;if(D.id===N&&x.id!==N)return-1;const L=s.has(x.id)?1:0,K=s.has(D.id)?1:0;if(L!==K)return K-L;const h=E.get(x.id),u=E.get(D.id);return!h||!u?0:h.threshold!==u.threshold?u.threshold-h.threshold:h.reqReduce!==u.reqReduce?u.reqReduce-h.reqReduce:h.support!==u.support?u.support-h.support:u.rough-h.rough}),v=new Map;for(const x of f)v.set(x.id,x);const q=new Map,B=()=>Date.now()-p>=Y?(d=!0,!0):!1,C=(x,D)=>{if(d)return;if(g?.aborted)throw new DOMException("Recipe solver cancelled","AbortError");if(B())return;const L=P-x;if(!(ae(D,s)>L)&&Ne(D,L,v,o,R)){if(x===P){const h=[...D];if(!le(h,s))return;const u=h.map(M=>v.get(M)??n.noIngredient);for(const M of a)for(const b of r){if(g?.aborted)throw new DOMException("Recipe solver cancelled","AbortError");if(B())return;const S=j(e,M,u,b);if(m++,!ce(S,o)||!oe(S,o.target))continue;const{score:I,breakdown:y}=U(S,o.weights,o),T=Q(h,e.id,M,b,i),k=h.join(",")+"|"+M.join(",")+"|"+b,w=q.get(k);(!w||I>w.score)&&q.set(k,{recipeId:e.id,ingredientIds:h,matTiers:M,atkSpd:b,effectiveness:S.effectiveness,stats:S,score:I,scoreBreakdown:y,hash:T})}return}for(const h of O)if(D.push(h.id),C(x+1,D),D.pop(),d)return}};C(0,[]);const $=Array.from(q.values());$.sort((x,D)=>D.score-x.score);const _=$.slice(0,o.topN);return{candidates:_,processedStates:m,timedOut:d,detail:d?`Deterministic fallback hit ${Y}ms time budget after ${m} evaluated states.`:`Deterministic fallback evaluated ${m} states and found ${_.length} threshold-satisfying candidates.`}}function de(t){const{catalog:e,constraints:n,signal:o,onProgress:i,alreadyThresholdRescue:a=!1}=t,r=Ee(e,n.recipeType,n.levelRange);if(!r)return i?.({phase:"complete",processedStates:0,beamSize:0,expandedSlots:0,totalSlots:P,detail:`No recipe found for ${n.recipeType}-${n.levelRange}.`}),[];const s=V(r.type.toLowerCase()),l=new Set(n.mustIncludeIngredients),g=Object.keys(n.target).length>0,p=Oe(e,r,n);if(p.length===0)return i?.({phase:"complete",processedStates:0,beamSize:0,expandedSlots:0,totalSlots:P,detail:"No eligible ingredients remain after recipe, level, and exclusion filters."}),[];const d=_e(p,n,l);if(d)return i?.({phase:"complete",processedStates:0,beamSize:0,expandedSlots:0,totalSlots:P,detail:d}),[];const m=Ce(e,p,n);if(m.length===0)return[];const c=n.matTiers?[n.matTiers]:[[1,1],[1,2],[1,3],[2,1],[2,2],[2,3],[3,1],[3,2],[3,3]],f=s==="weapon"?n.atkSpd?[n.atkSpd]:[...pe]:["SLOW"],R=c[c.length-1],E=f[0],O=n.beamWidth;let v=0;const q=l.size>0?1e6:0;let B=[{ingredientIds:[],score:0,thresholdPenalty:g?Number.POSITIVE_INFINITY:0,missingMust:l.size}];for(let h=0;h<P;h++){if(o?.aborted)throw new DOMException("Recipe solver cancelled","AbortError");const u=[];for(const S of B)for(const I of m){if(o?.aborted)throw new DOMException("Recipe solver cancelled","AbortError");const y=[...S.ingredientIds,I.id],T=Ae(r,y,e,n,R,E),k=ae(y,l);let w=T.score;q>0&&k===0&&(w+=q),u.push({ingredientIds:y,score:w,thresholdPenalty:T.thresholdPenalty,missingMust:k}),v++}const M=new Set,b=(S,I)=>{for(const y of S){const T=y.ingredientIds.join(",");if(!M.has(T)&&(M.add(T),I.push(y),I.length>=O))break}};if(g){const S=Math.max(1,Math.floor(O*ve)),I=Math.max(1,O-S),y=[...u].sort((w,A)=>A.score-w.score).slice(0,S),T=[...u].sort((w,A)=>w.missingMust!==A.missingMust?w.missingMust-A.missingMust:w.thresholdPenalty!==A.thresholdPenalty?w.thresholdPenalty-A.thresholdPenalty:A.score-w.score).slice(0,I),k=[];b(y,k),k.length<O&&b(T,k),k.length<O&&b(u.sort((w,A)=>A.score-w.score),k),B=k.slice(0,O)}else{const S=[];b(u.sort((I,y)=>y.score-I.score),S),B=S.slice(0,O)}i?.({phase:"beam-search",processedStates:v,beamSize:B.length,expandedSlots:h+1,totalSlots:P,detail:g?`Dual-lane prune (score + threshold) on pool=${m.length}`:`Score-lane prune on pool=${m.length}`})}i?.({phase:"material-sweep",processedStates:v,beamSize:B.length,expandedSlots:P,totalSlots:P,detail:`Sweeping ${c.length} tier combos x ${f.length} atk speeds`});const C=new Map;for(const h of B){if(o?.aborted)throw new DOMException("Recipe solver cancelled","AbortError");const u=h.ingredientIds,M=u.map(b=>e.ingredientsById.get(b)??e.noIngredient);for(const b of c)for(const S of f){const I=j(r,b,M,S),{score:y,breakdown:T}=U(I,n.weights,n),k=Q(u,r.id,b,S,s),w=u.join(",")+"|"+b.join(",")+"|"+S,A=C.get(w);(!A||y>A.score)&&C.set(w,{recipeId:r.id,ingredientIds:u,matTiers:b,atkSpd:S,effectiveness:I.effectiveness,stats:I,score:y,scoreBreakdown:T,hash:k}),v++}}const $=Array.from(C.values());$.sort((h,u)=>u.score-h.score);const _=new Set,x=[],D=[];for(const h of $)_.has(h.hash)||(_.add(h.hash),le(h.ingredientIds,l)&&ce(h.stats,n)&&(g&&oe(h.stats,n.target)?x.push(h):D.push(h)));if(g&&x.length===0&&!a){const h={...n,topKPerSlot:Math.min(400,Math.max(n.topKPerSlot*2,180)),beamWidth:Math.min(5e3,Math.max(n.beamWidth*2,1200))};if(h.topKPerSlot!==n.topKPerSlot||h.beamWidth!==n.beamWidth){i?.({phase:"threshold-rescue",processedStates:v,beamSize:B.length,expandedSlots:P,totalSlots:P,detail:`No candidates satisfied thresholds. Retrying beam with topK=${h.topKPerSlot}, beam=${h.beamWidth}.`});const b=de({catalog:e,constraints:h,signal:o,onProgress:i,alreadyThresholdRescue:!0});if(b.length>0)return b}i?.({phase:"deterministic-fallback",processedStates:v,beamSize:0,expandedSlots:P,totalSlots:P,detail:`Beam search produced no threshold-satisfying candidates. Running deterministic fallback (<=${Y}ms).`});const M=ze({recipe:r,catalog:e,constraints:n,category:s,matTierOptions:c,atkSpdOptions:f,mustIncludeSet:l,eligible:p,signal:o});return v+=M.processedStates,M.candidates.length>0?(i?.({phase:"complete",processedStates:v,beamSize:M.candidates.length,expandedSlots:P,totalSlots:P,detail:`Beam/rescue found 0 threshold-satisfying candidates. ${M.detail}`}),M.candidates):(i?.({phase:"complete",processedStates:v,beamSize:0,expandedSlots:P,totalSlots:P,detail:M.timedOut?`No valid candidates found before timeout. ${M.detail}`:`No candidates satisfy all hard thresholds. ${M.detail}`}),[])}const L=g?x.slice(0,n.topN):D.slice(0,n.topN),K=x.length;return i?.({phase:"complete",processedStates:v,beamSize:L.length,expandedSlots:P,totalSlots:P,detail:g?K>0?`Found ${L.length} candidates (${K} satisfy thresholds) from ${v} states`:`Found 0 candidates satisfying thresholds (${D.length} failed threshold checks) from ${v} states`:`Found ${L.length} candidates from ${v} states`}),L}const H=new Map;function Fe(t){return{...t,recipesById:new Map(t.recipesById),recipesByType:new Map(t.recipesByType),ingredientsById:new Map(t.ingredientsById),ingredientsBySkill:new Map(t.ingredientsBySkill),ingredientIdByName:new Map(t.ingredientIdByName)}}self.onmessage=t=>{const e=t.data;if(e.type==="cancel"){H.get(e.requestId)?.abort();return}const n=new AbortController;H.set(e.requestId,n);try{const o=Fe(e.catalog),i=de({catalog:o,constraints:e.constraints,signal:n.signal,onProgress:r=>{const s={type:"progress",requestId:e.requestId,progress:r};self.postMessage(s)}}),a={type:"result",requestId:e.requestId,candidates:i};self.postMessage(a)}catch(o){const i={type:"error",requestId:e.requestId,message:o instanceof Error?o.message:"Recipe solver worker error"};self.postMessage(i)}finally{H.delete(e.requestId)}}})();
