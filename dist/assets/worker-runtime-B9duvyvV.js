(function(){"use strict";const ue=["helmet","chestplate","leggings","boots"],me=["spear","wand","dagger","bow","relik"],he=["ring","bracelet","necklace"],pe=["SLOW","NORMAL","FAST"];function V(t){const e=t.toLowerCase();return ue.includes(e)?"armor":me.includes(e)?"weapon":he.includes(e)?"accessory":"consumable"}const N=4e3,G=[0,1,1.25,1.4],F=["e","t","w","f","a"],ge=[{min:3,max:6,convert:17,defPlus:2,defMinus:1},{min:5,max:8,convert:21,defPlus:4,defMinus:2},{min:6,max:10,convert:25,defPlus:8,defMinus:3},{min:7,max:10,convert:31,defPlus:14,defMinus:5},{min:9,max:11,convert:38,defPlus:22,defMinus:9},{min:11,max:13,convert:46,defPlus:30,defMinus:13},{min:1,max:8,convert:9,defPlus:3,defMinus:1},{min:1,max:12,convert:11,defPlus:5,defMinus:1},{min:2,max:15,convert:13,defPlus:9,defMinus:2},{min:3,max:15,convert:17,defPlus:14,defMinus:4},{min:4,max:17,convert:22,defPlus:20,defMinus:7},{min:5,max:20,convert:28,defPlus:28,defMinus:10},{min:3,max:4,convert:13,defPlus:3,defMinus:1},{min:4,max:6,convert:15,defPlus:6,defMinus:1},{min:5,max:8,convert:17,defPlus:11,defMinus:2},{min:6,max:8,convert:21,defPlus:18,defMinus:4},{min:7,max:10,convert:26,defPlus:28,defMinus:7},{min:9,max:11,convert:32,defPlus:40,defMinus:10},{min:2,max:5,convert:14,defPlus:3,defMinus:1},{min:4,max:8,convert:16,defPlus:5,defMinus:2},{min:5,max:9,convert:19,defPlus:9,defMinus:3},{min:6,max:9,convert:24,defPlus:16,defMinus:5},{min:8,max:10,convert:30,defPlus:25,defMinus:9},{min:10,max:12,convert:37,defPlus:36,defMinus:13},{min:2,max:6,convert:11,defPlus:3,defMinus:1},{min:3,max:10,convert:14,defPlus:6,defMinus:2},{min:4,max:11,convert:17,defPlus:10,defMinus:3},{min:5,max:11,convert:22,defPlus:16,defMinus:5},{min:7,max:12,convert:28,defPlus:24,defMinus:9},{min:8,max:14,convert:35,defPlus:34,defMinus:13}];function Me(t){return t/6|0}function xe(t){return F[Me(t)]}function be(t){const e=[[100,100],[100,100],[100,100]];for(let n=0;n<6;n++){const i=t[n].posMods,a=Math.floor(n/2),r=n%2;if(i.above!==0)for(let o=a-1;o>=0;o--)e[o][r]+=i.above;if(i.under!==0)for(let o=a+1;o<3;o++)e[o][r]+=i.under;if(i.left!==0&&r===1&&(e[a][r-1]+=i.left),i.right!==0&&r===0&&(e[a][r+1]+=i.right),i.touching!==0)for(let o=0;o<3;o++)for(let l=0;l<2;l++)(Math.abs(o-a)===1&&l===r||o===a&&Math.abs(l-r)===1)&&(e[o][l]+=i.touching);if(i.notTouching!==0)for(let o=0;o<3;o++)for(let l=0;l<2;l++)(Math.abs(o-a)>1||Math.abs(o-a)===1&&Math.abs(l-r)===1)&&(e[o][l]+=i.notTouching)}return e.flat()}function j(t,e,n,s){const i=t.type.toLowerCase(),a=V(i);let r=!0;for(const u of n)if(u.id!==N){r=!1;break}let o=0,l=0;(a==="weapon"||a==="armor")&&(t.lvl[0]<30?o=1:t.lvl[0]<70?o=2:o=3),a==="consumable"&&(t.lvl[0]<30?l=1:t.lvl[0]<70?l=2:l=3,r&&(l=3));const g=t.materials.map(u=>u.amount),m=(G[e[0]]*g[0]+G[e[1]]*g[1])/(g[0]+g[1]);let f=[t.durability[0],t.durability[1]],p=[t.duration[0],t.duration[1]];a==="consumable"?(r&&(p=[t.basicDuration[0],t.basicDuration[1]]),p=[Math.round(p[0]*m),Math.round(p[1]*m)]):f=[Math.round(f[0]*m),Math.round(f[1]*m)];const c=t.healthOrDamage[0],d=t.healthOrDamage[1];let k=0,A=0,B="0-0",v="0-0";const q={e:0,t:0,w:0,f:0,a:0};if(a==="armor")k=Math.floor(d*m),A=Math.floor(c*m);else if(a==="weapon"){let u=2.05;s==="SLOW"?u/=1.5:s==="NORMAL"?u=1:s==="FAST"&&(u/=2.5);const M=Math.floor(Math.floor(c*m)*u),b=Math.floor(Math.floor(d*m)*u);v=`${Math.floor(M*.9)}-${Math.floor(M*1.1)}`,B=`${Math.floor(b*.9)}-${Math.floor(b*1.1)}`}else a==="consumable"&&r&&(k=Math.floor(d*m),A=Math.floor(c*m));if(a==="armor"||a==="accessory"){for(const u of n)if(u.isPowder&&u.pid!=null){const M=ge[u.pid],b=xe(u.pid),S=F[(F.indexOf(b)+4)%5];q[b]=(q[b]||0)+M.defPlus,q[S]=(q[S]||0)-M.defMinus}}const C=be(n),O=[0,0,0,0,0],$={},_={};for(let u=0;u<6;u++){const M=n[u],b=C[u]/100,S=M.itemIDs;if(a!=="consumable"){const I=["strReq","dexReq","intReq","defReq","agiReq"];for(let y=0;y<I.length;y++){const w=S[I[y]];w!==0&&(M.isPowder?O[y]+=Math.round(w):O[y]+=Math.round(w*b))}}S.dura!==0&&(f[0]+=S.dura,f[1]+=S.dura),M.consumableIDs.dura!==0&&(p[0]+=M.consumableIDs.dura,p[1]+=M.consumableIDs.dura),M.consumableIDs.charges!==0&&(l+=M.consumableIDs.charges);for(const[I,y]of Object.entries(M.ids)){if(y.max===0&&y.min===0)continue;let w=y.min,T=y.max;const D=[Math.floor(w*b),Math.floor(T*b)].sort((L,je)=>L-je);w=D[0],T=D[1],_[I]=(_[I]??0)+w,$[I]=($[I]??0)+T}}return f[0]=Math.max(1,Math.floor(f[0])),f[1]=Math.max(1,Math.floor(f[1])),r||(p[0]=Math.max(10,p[0]),p[1]=Math.max(10,p[1])),l=Math.max(l,a==="consumable"?1:0),{category:a,type:i,lvl:t.lvl[1],hp:k,hpLow:A,nDam:B,nDamLow:v,eDam:"0-0",tDam:"0-0",wDam:"0-0",fDam:"0-0",aDam:"0-0",eDef:q.e,tDef:q.t,wDef:q.w,fDef:q.f,aDef:q.a,atkSpd:s,durability:f,duration:p,charges:l,slots:o,reqs:[O[0],O[1],O[2],O[3],O[4]],effectiveness:C,maxRolls:$,minRolls:_}}function Q(t,e,n,s,i){const a={SLOW:0,NORMAL:1,FAST:2},r=[];function o(f,p){for(let c=p-1;c>=0;c--)r.push(f>>c&1)}o(0,1),o(2,7);for(const f of t)o(f,12);o(e,12),o(n[0]-1,3),o(n[1]-1,3),i==="weapon"&&o(a[s]??0,4);const l=r.length%6;if(l!==0)for(let f=0;f<6-l;f++)r.push(0);const g="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz+-";let m="";for(let f=0;f<r.length;f+=6){let p=0;for(let c=0;c<6;c++)p=p<<1|(r[f+c]??0);m+=g[p]}return"CR-"+m}const X=["sdPct","sdRaw","mdPct","mdRaw","damPct","poison","fDamPct","wDamPct","aDamPct","tDamPct","eDamPct","spPct1","spRaw1","spPct2","spRaw2","spPct3","spRaw3","spPct4","spRaw4","rSdRaw","critDamPct"],J=["hpBonus","hprRaw","hprPct","fDefPct","wDefPct","aDefPct","tDefPct","eDefPct"],Z=["mr","ms","ls","spd","xpb","lb","ref","thorns","spRegen","eSteal","sprint","sprintReg","jh","lq","gXp","gSpd"],ee=["str","dex","int","def","agi"];function te(t,e){let n=0;for(const s of e){const i=t.maxRolls[s]??0;i>0&&(n+=i)}return n}function Se(t,e){let n=0;for(const s of e)n+=t.maxRolls[s]??0;return n}function ye(t){let e=te(t,X);return t.category==="armor"&&(e+=t.hp*.02),e}function Pe(t){let e=te(t,J);return t.category==="armor"&&(e+=t.hp*.15),e+=Math.max(0,t.eDef)+Math.max(0,t.tDef)+Math.max(0,t.wDef)+Math.max(0,t.fDef)+Math.max(0,t.aDef),e}function Ie(t){let e=0;const n=t.maxRolls.mr??0,s=t.maxRolls.ms??0,i=t.maxRolls.ls??0,a=t.maxRolls.spd??0;e+=n*12+s*8+i*6+a*3;for(const r of Z){if(r==="mr"||r==="ms"||r==="ls"||r==="spd")continue;const o=t.maxRolls[r]??0;o>0&&(e+=o)}return e}function Re(t){return Se(t,ee)}function De(t){let e=0;for(const n of t.reqs)e+=Math.max(0,n);return e}function ne(t,e){if(e==="durability")return[t.durability[0],t.durability[1]];if(e==="duration")return[t.duration[0],t.duration[1]];const n=t.maxRolls[e]??0;return[n,n]}function ve(t,e){let n=0;for(const[s,i]of Object.entries(e)){const[a,r]=ne(t,s);if(typeof i.min=="number"&&a<i.min){const o=i.min-a;n+=o*200+o*o}if(typeof i.max=="number"&&r>i.max){const o=r-i.max;n+=o*200+o*o}}return n}function oe(t,e){for(const[n,s]of Object.entries(e)){const[i,a]=ne(t,n);if(typeof s.min=="number"&&i<s.min||typeof s.max=="number"&&a>s.max)return!1}return!0}function U(t,e,n){const s=ye(t)*e.offense,i=Pe(t)*e.defense,a=Ie(t)*e.utility,r=Re(t)*e.skillPoints,o=De(t)*e.reqPenalty,l=ve(t,n.target),g={offense:s,defense:i,utility:a,skillPoints:r,reqPenalty:o,thresholdPenalty:l};return{score:s+i+a+r-o-l,breakdown:g}}function W(t,e,n){let s=0;for(const[a,r]of Object.entries(t.ids)){const o=r.max;X.includes(a)&&o>0?s+=o*e.offense:J.includes(a)&&o>0?s+=o*e.defense:Z.includes(a)?a==="mr"?s+=o*12*e.utility:a==="ms"?s+=o*8*e.utility:a==="ls"?s+=o*6*e.utility:a==="spd"?s+=o*3*e.utility:o>0&&(s+=o*e.utility):ee.includes(a)&&(s+=o*e.skillPoints),n?.has(a)&&o>0&&(s+=o*50)}const i=Math.max(0,t.itemIDs.strReq)+Math.max(0,t.itemIDs.dexReq)+Math.max(0,t.itemIDs.intReq)+Math.max(0,t.itemIDs.defReq)+Math.max(0,t.itemIDs.agiReq);return s-=i*e.reqPenalty*.5,s}const P=6,we=.65,Y=2e3,Te=36,ke=12,qe=12,se=10;function Ee(t,e,n){const s=t.recipesByType.get(e.toUpperCase());if(!s)return null;const i=`${e.charAt(0).toUpperCase()}${e.slice(1).toLowerCase()}-${n}`;return s.find(a=>a.name===i)??null}function Oe(t,e,n){const s=e.skill.toUpperCase(),i=e.lvl[1],a=new Set(n.excludedIngredients),r=[];for(const o of t.ingredients)o.id!==N&&(a.has(o.id)||o.lvl>i||o.skills.some(l=>l.toUpperCase()===s)&&r.push(o));return r}function z(t,e){return e==="durability"?t.itemIDs.dura??0:e==="duration"?t.consumableIDs.dura??0:t.ids[e]?.max??0}function Le(t){const e=t.posMods;return e.left>0||e.right>0||e.above>0||e.under>0||e.touching>0||e.notTouching>0}function ie(t){const e=t.posMods;return Math.max(0,e.left)+Math.max(0,e.right)+Math.max(0,e.above)+Math.max(0,e.under)+Math.max(0,e.touching)+Math.max(0,e.notTouching)}function re(t,e){let n=0;for(const s of e){const i=z(t,s);i>0&&(n+=i)}return n}function Ce(t,e,n){const s=new Set(n.mustIncludeIngredients),i=new Set(Object.keys(n.target)),a=i.size>0,r=e.map(f=>({ing:f,score:W(f,n.weights,a?i:void 0)}));r.sort((f,p)=>p.score-f.score);const o=n.topKPerSlot,l=new Set,g=[t.noIngredient];l.add(N);let m=0;for(const{ing:f}of r)s.has(f.id)&&!l.has(f.id)&&(l.add(f.id),g.push(f));for(const{ing:f}of r)if(!l.has(f.id)&&(l.add(f.id),g.push(f),m++,m>=o))break;if(a){const f=e.filter(c=>!l.has(c.id)).map(c=>({ing:c,tScore:Array.from(i).reduce((d,k)=>{const A=z(c,k);return A>0?d+A:d},0)})).filter(({tScore:c})=>c>0);f.sort((c,d)=>d.tScore-c.tScore);const p=Math.min(f.length,Math.max(30,Math.floor(o/2)));for(let c=0;c<p;c++){const{ing:d}=f[c];l.has(d.id)||(l.add(d.id),g.push(d))}}return g}function ae(t,e){if(e.size===0)return 0;const n=new Set(t);let s=0;for(const i of e)n.has(i)||s++;return s}function ce(t,e){const n=e.maxReqs;for(let s=0;s<5;s++){const i=n[s];if(i!=null&&Math.max(0,t.reqs[s])>i)return!1}return!0}function le(t,e){if(e.size===0)return!0;const n=new Set(t);for(const s of e)if(!n.has(s))return!1;return!0}function Ae(t,e,n,s,i,a){const r=[];for(let m=0;m<P;m++)m<e.length?r.push(n.ingredientsById.get(e[m])??n.noIngredient):r.push(n.noIngredient);const o=j(t,i,r,a),{score:l,breakdown:g}=U(o,s.weights,s);return{score:l,thresholdPenalty:g.thresholdPenalty}}function Be(t,e,n){const s=Math.floor(e/2),i=e%2,a=Math.floor(n/2),r=n%2;if(s===a&&i===r)return 0;let o=0;return r===i&&a<s&&(o+=t.above),r===i&&a>s&&(o+=t.under),s===a&&i===1&&r===0&&(o+=t.left),s===a&&i===0&&r===1&&(o+=t.right),(Math.abs(a-s)===1&&r===i||a===s&&Math.abs(r-i)===1)&&(o+=t.touching),(Math.abs(a-s)>1||Math.abs(a-s)===1&&Math.abs(r-i)===1)&&(o+=t.notTouching),o}function $e(t){const e=[];for(let n=0;n<P;n++){let s=100;for(let i=0;i<P;i++){if(i===n)continue;let a=0;for(const r of t){const o=Be(r.posMods,i,n);o>a&&(a=o)}s+=Math.max(0,a)}e[n]=Math.max(0,s)/100}return e}function fe(t,e,n){const s=z(t,e);if(s<=0)return 0;let i=0;for(const a of n){const r=Math.ceil(s*a);r>i&&(i=r)}return i}function _e(t,e,n){if(n.size>P)return`Unsatisfiable constraints: ${n.size} distinct must-include ingredients exceed ${P} slots.`;const s=new Map;for(const r of t)s.set(r.id,r);for(const r of n)if(!s.has(r))return`Unsatisfiable constraints: must-include ingredient #${r} is not eligible for this recipe/level range.`;const i=$e(t),a=Math.max(0,P-n.size);for(const[r,o]of Object.entries(e.target)){if(typeof o.min!="number"||r==="durability"||r==="duration")continue;let l=0;for(const f of t){const p=fe(f,r,i);p>l&&(l=p)}let g=0;for(const f of n){const p=s.get(f);p&&(g+=fe(p,r,i))}const m=g+a*l;if(m<o.min)return`Unsatisfiable threshold: ${r} min ${o.min} exceeds theoretical max ${m} for the current recipe/level/ingredient pool.`}return null}function Ke(t,e,n,s){const i=Object.keys(n.target),a=n.maxReqs.some(c=>c!=null),r=new Set(i),o=new Set,l=[],g=new Map;for(const c of e)g.set(c.id,c);const m=c=>{!c||o.has(c.id)||(o.add(c.id),l.push(c))};m(t.noIngredient);for(const c of s)m(g.get(c));const f=e.map(c=>({ing:c,score:re(c,i)})).filter(({score:c})=>c>0).sort((c,d)=>d.score-c.score);for(let c=0;c<Math.min(Te,f.length);c++)m(f[c].ing);const p=e.filter(Le).map(c=>({ing:c,score:ie(c)})).sort((c,d)=>d.score-c.score);for(let c=0;c<Math.min(ke,p.length);c++)m(p[c].ing);if(a){const c=e.map(d=>{const k=Math.max(0,-d.itemIDs.strReq)+Math.max(0,-d.itemIDs.dexReq)+Math.max(0,-d.itemIDs.intReq)+Math.max(0,-d.itemIDs.defReq)+Math.max(0,-d.itemIDs.agiReq);return{ing:d,reduction:k}}).filter(({reduction:d})=>d>0).sort((d,k)=>k.reduction-d.reduction);for(let d=0;d<Math.min(qe,c.length);d++)m(c[d].ing)}if(l.length<12){const c=e.map(d=>({ing:d,score:W(d,n.weights,r)})).sort((d,k)=>k.score-d.score);for(const{ing:d}of c)if(m(d),l.length>=12)break}return l}function Ne(t,e,n,s,i){for(const[a,r]of Object.entries(s.target)){if(typeof r.min!="number"||a==="durability"||a==="duration")continue;let o=0;for(const g of t){const m=n.get(g);if(!m)continue;const f=Math.max(0,z(m,a));o+=f*se}if(o+e*(i.get(a)??0)<r.min)return!1}return!0}function ze(t){const{recipe:e,catalog:n,constraints:s,category:i,matTierOptions:a,atkSpdOptions:r,mustIncludeSet:o,eligible:l,signal:g}=t,m=Date.now();let f=!1,p=0;const c=Object.keys(s.target),d=Ke(n,l,s,o);if(d.length===0)return{candidates:[],processedStates:0,timedOut:!1,detail:"Deterministic fallback had no eligible fallback ingredients to explore."};const k=new Map;for(const[x,R]of Object.entries(s.target)){if(typeof R.min!="number"||x==="durability"||x==="duration")continue;let E=0;for(const K of d){const h=Math.max(0,z(K,x));h>E&&(E=h)}k.set(x,E*se)}const A=new Map;for(const x of d){const R=Math.max(0,-x.itemIDs.strReq)+Math.max(0,-x.itemIDs.dexReq)+Math.max(0,-x.itemIDs.intReq)+Math.max(0,-x.itemIDs.defReq)+Math.max(0,-x.itemIDs.agiReq);A.set(x.id,{threshold:re(x,c),support:ie(x),reqReduce:R,rough:W(x,s.weights,new Set(c))})}const B=[...d].sort((x,R)=>{if(x.id===N&&R.id!==N)return 1;if(R.id===N&&x.id!==N)return-1;const E=o.has(x.id)?1:0,K=o.has(R.id)?1:0;if(E!==K)return K-E;const h=A.get(x.id),u=A.get(R.id);return!h||!u?0:h.threshold!==u.threshold?u.threshold-h.threshold:h.reqReduce!==u.reqReduce?u.reqReduce-h.reqReduce:h.support!==u.support?u.support-h.support:u.rough-h.rough}),v=new Map;for(const x of d)v.set(x.id,x);const q=new Map,C=()=>Date.now()-m>=Y?(f=!0,!0):!1,O=(x,R)=>{if(f)return;if(g?.aborted)throw new DOMException("Recipe solver cancelled","AbortError");if(C())return;const E=P-x;if(!(ae(R,o)>E)&&Ne(R,E,v,s,k)){if(x===P){const h=[...R];if(!le(h,o))return;const u=h.map(M=>v.get(M)??n.noIngredient);for(const M of a)for(const b of r){if(g?.aborted)throw new DOMException("Recipe solver cancelled","AbortError");if(C())return;const S=j(e,M,u,b);if(p++,!ce(S,s)||!oe(S,s.target))continue;const{score:I,breakdown:y}=U(S,s.weights,s),w=Q(h,e.id,M,b,i),T=h.join(",")+"|"+M.join(",")+"|"+b,D=q.get(T);(!D||I>D.score)&&q.set(T,{recipeId:e.id,ingredientIds:h,matTiers:M,atkSpd:b,effectiveness:S.effectiveness,stats:S,score:I,scoreBreakdown:y,hash:w})}return}for(const h of B)if(R.push(h.id),O(x+1,R),R.pop(),f)return}};O(0,[]);const $=Array.from(q.values());$.sort((x,R)=>R.score-x.score);const _=$.slice(0,s.topN);return{candidates:_,processedStates:p,timedOut:f,detail:f?`Deterministic fallback hit ${Y}ms time budget after ${p} evaluated states.`:`Deterministic fallback evaluated ${p} states and found ${_.length} threshold-satisfying candidates.`}}function de(t){const{catalog:e,constraints:n,signal:s,onProgress:i,alreadyThresholdRescue:a=!1}=t,r=Ee(e,n.recipeType,n.levelRange);if(!r)return i?.({phase:"complete",processedStates:0,beamSize:0,expandedSlots:0,totalSlots:P,detail:`No recipe found for ${n.recipeType}-${n.levelRange}.`}),[];const o=V(r.type.toLowerCase()),l=new Set(n.mustIncludeIngredients),g=Object.keys(n.target).length>0,m=Oe(e,r,n);if(m.length===0)return i?.({phase:"complete",processedStates:0,beamSize:0,expandedSlots:0,totalSlots:P,detail:"No eligible ingredients remain after recipe, level, and exclusion filters."}),[];const f=_e(m,n,l);if(f)return i?.({phase:"complete",processedStates:0,beamSize:0,expandedSlots:0,totalSlots:P,detail:f}),[];const p=Ce(e,m,n);if(p.length===0)return[];const c=n.matTiers?[n.matTiers]:[[1,1],[1,2],[1,3],[2,1],[2,2],[2,3],[3,1],[3,2],[3,3]],d=o==="weapon"?n.atkSpd?[n.atkSpd]:[...pe]:["SLOW"],k=c[c.length-1],A=d[0],B=n.beamWidth;let v=0;const q=l.size>0?1e6:0;let C=[{ingredientIds:[],score:0,thresholdPenalty:g?Number.POSITIVE_INFINITY:0,missingMust:l.size}];for(let h=0;h<P;h++){if(s?.aborted)throw new DOMException("Recipe solver cancelled","AbortError");const u=[];for(const S of C)for(const I of p){if(s?.aborted)throw new DOMException("Recipe solver cancelled","AbortError");const y=[...S.ingredientIds,I.id],w=Ae(r,y,e,n,k,A),T=ae(y,l);let D=w.score;q>0&&T===0&&(D+=q),u.push({ingredientIds:y,score:D,thresholdPenalty:w.thresholdPenalty,missingMust:T}),v++}const M=new Set,b=(S,I)=>{for(const y of S){const w=y.ingredientIds.join(",");if(!M.has(w)&&(M.add(w),I.push(y),I.length>=B))break}};if(g){const S=Math.max(1,Math.floor(B*we)),I=Math.max(1,B-S),y=[...u].sort((D,L)=>L.score-D.score).slice(0,S),w=[...u].sort((D,L)=>D.missingMust!==L.missingMust?D.missingMust-L.missingMust:D.thresholdPenalty!==L.thresholdPenalty?D.thresholdPenalty-L.thresholdPenalty:L.score-D.score).slice(0,I),T=[];b(y,T),T.length<B&&b(w,T),T.length<B&&b(u.sort((D,L)=>L.score-D.score),T),C=T.slice(0,B)}else{const S=[];b(u.sort((I,y)=>y.score-I.score),S),C=S.slice(0,B)}i?.({phase:"beam-search",processedStates:v,beamSize:C.length,expandedSlots:h+1,totalSlots:P,detail:g?`Dual-lane prune (score + threshold) on pool=${p.length}`:`Score-lane prune on pool=${p.length}`})}i?.({phase:"material-sweep",processedStates:v,beamSize:C.length,expandedSlots:P,totalSlots:P,detail:`Sweeping ${c.length} tier combos x ${d.length} atk speeds`});const O=new Map;for(const h of C){if(s?.aborted)throw new DOMException("Recipe solver cancelled","AbortError");const u=h.ingredientIds,M=u.map(b=>e.ingredientsById.get(b)??e.noIngredient);for(const b of c)for(const S of d){const I=j(r,b,M,S),{score:y,breakdown:w}=U(I,n.weights,n),T=Q(u,r.id,b,S,o),D=u.join(",")+"|"+b.join(",")+"|"+S,L=O.get(D);(!L||y>L.score)&&O.set(D,{recipeId:r.id,ingredientIds:u,matTiers:b,atkSpd:S,effectiveness:I.effectiveness,stats:I,score:y,scoreBreakdown:w,hash:T}),v++}}const $=Array.from(O.values());$.sort((h,u)=>u.score-h.score);const _=new Set,x=[],R=[];for(const h of $)_.has(h.hash)||(_.add(h.hash),le(h.ingredientIds,l)&&ce(h.stats,n)&&(g&&oe(h.stats,n.target)?x.push(h):R.push(h)));if(g&&x.length===0&&!a){const h={...n,topKPerSlot:Math.min(400,Math.max(n.topKPerSlot*2,180)),beamWidth:Math.min(5e3,Math.max(n.beamWidth*2,1200))};if(h.topKPerSlot!==n.topKPerSlot||h.beamWidth!==n.beamWidth){i?.({phase:"threshold-rescue",processedStates:v,beamSize:C.length,expandedSlots:P,totalSlots:P,detail:`No candidates satisfied thresholds. Retrying beam with topK=${h.topKPerSlot}, beam=${h.beamWidth}.`});const b=de({catalog:e,constraints:h,signal:s,onProgress:i,alreadyThresholdRescue:!0});if(b.length>0)return b}i?.({phase:"deterministic-fallback",processedStates:v,beamSize:0,expandedSlots:P,totalSlots:P,detail:`Beam search produced no threshold-satisfying candidates. Running deterministic fallback (<=${Y}ms).`});const M=ze({recipe:r,catalog:e,constraints:n,category:o,matTierOptions:c,atkSpdOptions:d,mustIncludeSet:l,eligible:m,signal:s});return v+=M.processedStates,M.candidates.length>0?(i?.({phase:"complete",processedStates:v,beamSize:M.candidates.length,expandedSlots:P,totalSlots:P,detail:`Beam/rescue found 0 threshold-satisfying candidates. ${M.detail}`}),M.candidates):(i?.({phase:"complete",processedStates:v,beamSize:0,expandedSlots:P,totalSlots:P,detail:M.timedOut?`No valid candidates found before timeout. ${M.detail}`:`No candidates satisfy all hard thresholds. ${M.detail}`}),[])}const E=g?x.slice(0,n.topN):R.slice(0,n.topN),K=x.length;return i?.({phase:"complete",processedStates:v,beamSize:E.length,expandedSlots:P,totalSlots:P,detail:g?K>0?`Found ${E.length} candidates (${K} satisfy thresholds) from ${v} states`:`Found 0 candidates satisfying thresholds (${R.length} failed threshold checks) from ${v} states`:`Found ${E.length} candidates from ${v} states`}),E}const H=new Map;function Fe(t){return{...t,recipesById:new Map(t.recipesById),recipesByType:new Map(t.recipesByType),ingredientsById:new Map(t.ingredientsById),ingredientsBySkill:new Map(t.ingredientsBySkill),ingredientIdByName:new Map(t.ingredientIdByName)}}self.onmessage=t=>{const e=t.data;if(e.type==="cancel"){H.get(e.requestId)?.abort();return}const n=new AbortController;H.set(e.requestId,n);try{const s=Fe(e.catalog),i=de({catalog:s,constraints:e.constraints,signal:n.signal,onProgress:r=>{const o={type:"progress",requestId:e.requestId,progress:r};self.postMessage(o)}}),a={type:"result",requestId:e.requestId,candidates:i};self.postMessage(a)}catch(s){const i={type:"error",requestId:e.requestId,message:s instanceof Error?s.message:"Recipe solver worker error"};self.postMessage(i)}finally{H.delete(e.requestId)}}})();
