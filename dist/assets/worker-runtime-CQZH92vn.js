(function(){"use strict";const K={legacyBaseDps:1,legacyEhp:.7,dpsProxy:1,ehpProxy:.6,speed:.4,sustain:.35,skillPointTotal:.15,reqTotalPenalty:.2};function Ke(e){return e.aggregated.hprTotal*.9+e.aggregated.mr*14+e.aggregated.ms*10+e.aggregated.ls*9}function Xe(e,t){let i=0;const{target:s}=t;return typeof s.minLegacyBaseDps=="number"&&e.derived.legacyBaseDps<s.minLegacyBaseDps&&(i+=(s.minLegacyBaseDps-e.derived.legacyBaseDps)*4),typeof s.minLegacyEhp=="number"&&e.derived.legacyEhp<s.minLegacyEhp&&(i+=(s.minLegacyEhp-e.derived.legacyEhp)*.8),typeof s.minDpsProxy=="number"&&e.derived.dpsProxy<s.minDpsProxy&&(i+=(s.minDpsProxy-e.derived.dpsProxy)*4),typeof s.minEhpProxy=="number"&&e.derived.ehpProxy<s.minEhpProxy&&(i+=(s.minEhpProxy-e.derived.ehpProxy)*1.1),typeof s.minMr=="number"&&e.aggregated.mr<s.minMr&&(i+=(s.minMr-e.aggregated.mr)*45),typeof s.minMs=="number"&&e.aggregated.ms<s.minMs&&(i+=(s.minMs-e.aggregated.ms)*35),typeof s.minSpeed=="number"&&e.aggregated.speed<s.minSpeed&&(i+=(s.minSpeed-e.aggregated.speed)*12),typeof s.minSkillPointTotal=="number"&&e.derived.skillPointTotal<s.minSkillPointTotal&&(i+=(s.minSkillPointTotal-e.derived.skillPointTotal)*15),typeof s.maxReqTotal=="number"&&e.derived.reqTotal>s.maxReqTotal&&(i+=(e.derived.reqTotal-s.maxReqTotal)*8),i}function Je(e,t){const i=t.target.customNumericRanges??[];if(i.length===0)return 0;const s=8,n=4;let o=0;for(const a of i){const r=a.key?.trim();if(!r)continue;const u=e.aggregated,c=e.derived,g=u[r]??c[r]??0;typeof a.min=="number"&&(o+=g*s),typeof a.max=="number"&&g>a.max&&(o-=(g-a.max)*n)}return o}function re(e,t,i){const s=Ke(e),n=e.derived.reqTotal*t.reqTotalPenalty,o=Xe(e,i),a=(i.target.customNumericRanges??[]).filter(p=>typeof p.min=="number").length,r=a>0?Math.max(.15,1-a*.2):1,u=Je(e,i),c={legacyBaseDps:e.derived.legacyBaseDps*t.legacyBaseDps*r,legacyEhp:e.derived.legacyEhp*t.legacyEhp*r,dpsProxy:e.derived.dpsProxy*t.dpsProxy*r,spellProxy:e.derived.spellProxy*t.spellProxy*r,meleeProxy:e.derived.meleeProxy*t.meleeProxy*r,ehpProxy:e.derived.ehpProxy*t.ehpProxy*r,speed:e.aggregated.speed*t.speed,sustain:s*t.sustain,skillPointTotal:e.derived.skillPointTotal*t.skillPointTotal,reqPenalty:n,thresholdPenalty:o};return{score:c.legacyBaseDps+c.legacyEhp+c.dpsProxy+c.spellProxy+c.meleeProxy+c.ehpProxy+c.speed+c.sustain+c.skillPointTotal+u-c.reqPenalty-c.thresholdPenalty,breakdown:c}}const j=["helmet","chestplate","leggings","boots","ring1","ring2","bracelet","necklace","weapon"],Se=e=>e==="ring1"||e==="ring2"?"ring":e,Qe={spear:"Warrior",dagger:"Assassin",wand:"Mage",bow:"Archer",relik:"Shaman"};function Ze(e){return Qe[e]??null}function et(e,t){return!t||!e.classReq?!0:e.classReq===t}const tt={slotStatus:{},warnings:{messages:[]},aggregated:{hpTotal:0,hprTotal:0,mr:0,ms:0,ls:0,speed:0,skillPoints:{str:0,dex:0,int:0,def:0,agi:0},skillReqs:{str:0,dex:0,int:0,def:0,agi:0},defenses:{e:0,t:0,w:0,f:0,a:0},offense:{baseDps:0,spellPct:0,spellRaw:0,meleePct:0,meleeRaw:0,elemDamPct:0,genericDamPct:0,offenseScore:0}},derived:{dpsProxy:0,spellProxy:0,meleeProxy:0,ehpProxy:0,reqTotal:0,skillPointTotal:0,legacyBaseDps:0,legacyEhp:0,legacyEhpNoAgi:0,skillpointFeasible:!0,assignedSkillPointsRequired:0}};function ke(e){let t=Number.isFinite(e)?e:0;if(t<=0)return 0;t>=150&&(t=150);const i=.9908;return i/(1-i)*(1-Math.pow(i,t))/100}const nt=.867,st=.951,it=90;function ot(e){return Math.max(1,Math.min(106,Math.round(e||1)))*5+5}function qe(e){const t=Math.max(1,Math.min(106,Math.round(e||1)));return t>=101?200:(t-1)*2}function at(e){switch(e){case"relik":return .6;case"bow":return .7;case"wand":return .8;case"dagger":case"spear":return 1;default:return 1}}function rt(e){const t=Math.max(5,e.totalHp),i=ke(e.defSkillPoints)*nt,s=ke(e.agiSkillPoints)*st,o=2-at(e.weaponType),r=(100-it)/100*s+(1-s)*(1-i),u=1-i,c=t/Math.max(1e-9,r)/Math.max(1e-9,o),g=t/Math.max(1e-9,u)/Math.max(1e-9,o);return{withAgi:c,noAgi:g}}function lt(e){return[e.numeric.reqStr,e.numeric.reqDex,e.numeric.reqInt,e.numeric.reqDef,e.numeric.reqAgi]}function ct(e){return[e.numeric.spStr,e.numeric.spDex,e.numeric.spInt,e.numeric.spDef,e.numeric.spAgi]}function dt(e,t){return[e[0]+t[0],e[1]+t[1],e[2]+t[2],e[3]+t[3],e[4]+t[4]]}function ut(e){return e[0]+e[1]+e[2]+e[3]+e[4]}function Be(e,t){for(let i=0;i<5;i++)if(e[i]>t[i])return!1;return!0}function ft(e,t){for(const i of e)if(Be(i.assigned,t.assigned))return;for(let i=e.length-1;i>=0;i--)Be(t.assigned,e[i].assigned)&&e.splice(i,1);e.push(t)}function mt(e,t,i={}){if(e.length===0)return{feasible:!0,assignedTotal:0,assignedByStat:[0,0,0,0,0]};const s=i.availableSkillPointsOverride??qe(t),n=i.extraBaseSkillPoints??[0,0,0,0,0],o=e.length,a=e.map(lt),r=e.map(ct),u=1<<o,c=Array.from({length:u},()=>[0,0,0,0,0]);for(let y=1;y<u;y++){const w=y&-y,B=Math.log2(w)|0;c[y]=dt(c[y^w],r[B])}const g=new Array(u);g[0]=[{assigned:[0,0,0,0,0],assignedTotal:0}];for(let y=0;y<u;y++){const w=g[y];if(!w||w.length===0)continue;const B=c[y];for(const E of w)for(let k=0;k<o;k++){if((y&1<<k)!==0)continue;const q=[...E.assigned];let R=!0;for(let S=0;S<5;S++){const M=E.assigned[S]+B[S]+(n[S]??0),C=a[k][S];if(C>M&&(q[S]+=C-M),q[S]>100){R=!1;break}}if(!R)continue;const A=y|1<<k,l=c[A];for(let S=0;S<5;S++){let M=0;const C=n[S]??0;for(let F=0;F<o;F++){if((A&1<<F)===0||a[F][S]===0)continue;const f=a[F][S]+r[F][S]-(q[S]+l[S]+C);f>M&&(M=f)}if(M>0&&(q[S]+=M,q[S]>100)){R=!1;break}}if(!R)continue;const d=ut(q);if(d>s)continue;const m=g[A]??=[];ft(m,{assigned:q,assignedTotal:d})}}const p=g[u-1];if(!p||p.length===0)return{feasible:!1,assignedTotal:1/0,assignedByStat:null};let x=1/0,b=null;for(const y of p)y.assignedTotal<x&&(x=y.assignedTotal,b=[...y.assigned]);return{feasible:Number.isFinite(x),assignedTotal:x,assignedByStat:Number.isFinite(x)?b:null}}function ye(e,t,i,s={}){const n=[];for(const o of j){const a=e[o];if(a==null)continue;const r=t.itemsById.get(a);r&&n.push(r)}return mt(n,i,s)}const gt=[1,1,1,1,1],ht=4;function Re(e,t){switch(e){case"guild_rainbow":return{extraBaseSkillPoints:gt};case"flexible_2":return{availableSkillPointsOverride:qe(t)+ht};default:return{}}}function pt(e,t){const i={};for(const s of j){const n=e.slots[s];if(n==null)continue;const o=t.itemsById.get(n);o&&(i[s]=o)}return i}function le(e,t,i={}){const s=pt(e,t),n=structuredClone(tt),o=n.warnings.messages;let a=null;for(const O of j){const f=s[O];if(!f)continue;O==="weapon"&&(a=f.type),n.aggregated.hpTotal+=f.numeric.hp+f.numeric.hpBonus,n.aggregated.hprTotal+=f.numeric.hprRaw+f.numeric.hprPct,n.aggregated.mr+=f.numeric.mr,n.aggregated.ms+=f.numeric.ms,n.aggregated.ls+=f.numeric.ls,n.aggregated.speed+=f.numeric.spd,n.aggregated.skillPoints.str+=f.numeric.spStr,n.aggregated.skillPoints.dex+=f.numeric.spDex,n.aggregated.skillPoints.int+=f.numeric.spInt,n.aggregated.skillPoints.def+=f.numeric.spDef,n.aggregated.skillPoints.agi+=f.numeric.spAgi,n.aggregated.skillReqs.str=Math.max(n.aggregated.skillReqs.str,f.numeric.reqStr),n.aggregated.skillReqs.dex=Math.max(n.aggregated.skillReqs.dex,f.numeric.reqDex),n.aggregated.skillReqs.int=Math.max(n.aggregated.skillReqs.int,f.numeric.reqInt),n.aggregated.skillReqs.def=Math.max(n.aggregated.skillReqs.def,f.numeric.reqDef),n.aggregated.skillReqs.agi=Math.max(n.aggregated.skillReqs.agi,f.numeric.reqAgi),n.aggregated.defenses.e+=f.numeric.eDef,n.aggregated.defenses.t+=f.numeric.tDef,n.aggregated.defenses.w+=f.numeric.wDef,n.aggregated.defenses.f+=f.numeric.fDef,n.aggregated.defenses.a+=f.numeric.aDef,n.aggregated.offense.baseDps+=f.numeric.baseDps,n.aggregated.offense.spellPct+=f.numeric.sdPct,n.aggregated.offense.spellRaw+=f.numeric.sdRaw,n.aggregated.offense.meleePct+=f.numeric.mdPct,n.aggregated.offense.meleeRaw+=f.numeric.mdRaw,n.aggregated.offense.elemDamPct+=f.numeric.eDamPct+f.numeric.tDamPct+f.numeric.wDamPct+f.numeric.fDamPct+f.numeric.aDamPct,n.aggregated.offense.genericDamPct+=f.numeric.damPct+f.numeric.rDamPct+f.numeric.nDamPct,n.aggregated.offense.offenseScore+=f.roughScoreFields.offense;const T=f.classReq,U=!T||!e.characterClass||T===e.characterClass,$=f.level<=e.level,N=f.numeric.reqStr<=100&&f.numeric.reqDex<=100&&f.numeric.reqInt<=100&&f.numeric.reqDef<=100&&f.numeric.reqAgi<=100;n.slotStatus[O]={classOk:U,levelOk:$,skillReqsMet:N}}!e.characterClass&&a&&(e.characterClass=Ze(a));for(const O of j){const f=s[O];f&&(Se(O)!==f.category&&o.push(`${O} contains incompatible item type (${f.type}).`),f.level>e.level&&o.push(`${f.displayName} requires level ${f.level}.`),e.characterClass&&f.classReq&&f.classReq!==e.characterClass&&o.push(`${f.displayName} requires ${f.classReq}.`),(f.restricted||f.deprecated)&&o.push(`${f.displayName} is restricted/deprecated.`))}const r=n.aggregated.skillReqs.str+n.aggregated.skillReqs.dex+n.aggregated.skillReqs.int+n.aggregated.skillReqs.def+n.aggregated.skillReqs.agi,u=n.aggregated.skillPoints.str+n.aggregated.skillPoints.dex+n.aggregated.skillPoints.int+n.aggregated.skillPoints.def+n.aggregated.skillPoints.agi,c=i.skillpointFeasibility??(i.skillpointTomeMode?Re(i.skillpointTomeMode,e.level):void 0),g=ye(e.slots,t,e.level,c),{spellPct:p,spellRaw:x,meleePct:b,meleeRaw:y,baseDps:w,elemDamPct:B,genericDamPct:E}=n.aggregated.offense,k=n.aggregated.skillPoints,R=1+ke(k.str),A=(w*(1+(p+B+E)/100)+x)*R,l=(w*(1+(b+B+E)/100)+y)*R,d=l+A+n.aggregated.speed*.8,m=n.aggregated.defenses.e+n.aggregated.defenses.t+n.aggregated.defenses.w+n.aggregated.defenses.f+n.aggregated.defenses.a,S=n.aggregated.hpTotal+m*.45+n.aggregated.hprTotal*2+Math.max(0,n.aggregated.skillPoints.def)*12+Math.max(0,n.aggregated.skillPoints.agi)*10,M=n.aggregated.offense.baseDps,C=ot(e.level)+n.aggregated.hpTotal,F=rt({totalHp:C,defSkillPoints:n.aggregated.skillPoints.def,agiSkillPoints:n.aggregated.skillPoints.agi,weaponType:a});return n.derived={dpsProxy:d,spellProxy:A,meleeProxy:l,ehpProxy:S,reqTotal:r,skillPointTotal:u,legacyBaseDps:M,legacyEhp:F.withAgi,legacyEhpNoAgi:F.noAgi,skillpointFeasible:g.feasible,assignedSkillPointsRequired:Number.isFinite(g.assignedTotal)?g.assignedTotal:0},g.feasible||o.push(`Skill requirements are not satisfiable at level ${e.level} (estimated assigned SP exceeds available or equip order is invalid).`),n}function De(e,t,i,s){if(!e.length||s<=0)return[];const n=[...e].sort((a,r)=>r.roughScore-a.roughScore).slice(0,s),o=[];for(const a of n){const r=le({slots:a.slots,level:i.level,characterClass:i.characterClass},t),{score:u,breakdown:c}=re(r,i.weights,i);o.push({slots:{...a.slots},score:u,scoreBreakdown:c,summary:r})}return o}function xt(e,t){const i=new Map;for(const s of j){const n=e[s];if(n==null)continue;const o=t.itemSetName.get(n);o&&i.set(o,(i.get(o)??0)+1)}return i}function ce(e,t,i){const s=i.itemSetName.get(e);if(!s)return!1;const n=i.setsMeta.get(s);if(!n)return!1;let o=0;for(const a of j){const r=t[a];r!=null&&i.itemSetName.get(r)===s&&o++}return n.illegalCounts.includes(o+1)}const Ee=["str","dex","int","def","agi"],X=["SUPER_SLOW","VERY_SLOW","SLOW","NORMAL","FAST","VERY_FAST","SUPER_FAST"];function de(e){return Re(e.skillpointFeasibilityMode,e.level)}function J(e){return Math.round(e.numeric.atkTier||0)}function Te(e,t){switch(t){case"str":return Math.max(0,e.numeric.spStr);case"dex":return Math.max(0,e.numeric.spDex);case"int":return Math.max(0,e.numeric.spInt);case"def":return Math.max(0,e.numeric.spDef);case"agi":return Math.max(0,e.numeric.spAgi)}}function St(e,t){switch(t){case"str":return e.numeric.reqStr;case"dex":return e.numeric.reqDex;case"int":return e.numeric.reqInt;case"def":return e.numeric.reqDef;case"agi":return e.numeric.reqAgi}}function kt(e,t){if(t.length===0)return 0;let i=0;for(const s of t)i+=Te(e,s)*10,i-=Math.max(0,St(e,s))*.7;return i-=Math.max(0,e.roughScoreFields.reqTotal)*.12,i}function Y(e){return{...e}}function yt(e,t){const i=e.weapon;if(i==null)return null;const s=t.itemsById.get(i);if(!s)return null;const n=X.indexOf(s.atkSpd);if(n<0)return null;let o=0;for(const r of j){const u=e[r];if(u==null)continue;const c=t.itemsById.get(u);c&&(o+=J(c))}const a=Math.max(0,Math.min(X.length-1,n+o));return X[a]}function be(e,t){let i=0;for(const s of j){const n=e[s];if(n==null)continue;const o=t.itemsById.get(n);o&&(i+=J(o))}return i}function Tt(e,t,i){if(i.weaponAttackSpeeds.length===0)return null;const s=e.weapon;if(s==null)return null;const n=t.itemsById.get(s);if(!n)return null;const o=X.indexOf(n.atkSpd);if(o<0)return null;const a=[...new Set(i.weaponAttackSpeeds.map(g=>X.indexOf(g)).filter(g=>g>=0))].sort((g,p)=>g-p);if(a.length===0)return null;const r=be(e,t),u=Math.max(0,Math.min(X.length-1,o+r));let c=0;if(!a.includes(u)){const g=a.reduce((p,x)=>Math.abs(x-u)<Math.abs(p-u)?x:p,a[0]);c=g>u?1:g<u?-1:0}return{baseSpeedIndex:o,fixedAtkTierTotal:r,allowedFinalIndices:a,allowedFinalIndexSet:new Set(a),preferredDirection:c}}function ue(e,t,i){const s=new Array(e.length+1).fill(0),n=new Array(e.length+1).fill(0);for(let o=e.length-1;o>=0;o--){const a=t.get(e[o])??[];let r=0,u=0;if(a.length>0){r=1/0,u=-1/0;for(const c of a){const g=i.itemsById.get(c.id),p=g?J(g):0;p<r&&(r=p),p>u&&(u=p)}Number.isFinite(r)||(r=0),Number.isFinite(u)||(u=0)}s[o]=s[o+1]+r,n[o]=n[o+1]+u}return{minSuffix:s,maxSuffix:n}}function bt(e,t,i,s){const n=e.fixedAtkTierTotal+t+i,o=e.fixedAtkTierTotal+t+s,a=Math.min(n,o),r=Math.max(n,o);for(let u=a;u<=r;u++){const c=Math.max(0,Math.min(X.length-1,e.baseSpeedIndex+u));if(e.allowedFinalIndexSet.has(c))return!0}return!1}function Z(e,t,i=0,s=0){if(!e||!e.preferredDirection)return 0;const n=e.fixedAtkTierTotal+(t??0),o=Math.max(0,Math.min(X.length-1,e.baseSpeedIndex+n+i)),a=Math.max(0,Math.min(X.length-1,e.baseSpeedIndex+n+s)),r=Math.min(o,a),u=Math.max(o,a);let c=1/0,g=0;for(let x=r;x<=u;x++){let b=1/0;for(const y of e.allowedFinalIndices){const w=Math.abs(y-x);w<b&&(b=w)}b<c&&(c=b),b>g&&(g=b)}if(!Number.isFinite(c)||g===0)return 0;const p=e.preferredDirection>0?r:-u;return-g*1e3-c*100+p}function Mt(e,t,i,s){const{target:n}=t,o=me(t,{includeAttackTier:!1}),a=[];if(typeof n.minLegacyBaseDps=="number"&&e.derived.legacyBaseDps<n.minLegacyBaseDps&&a.push(`minLegacyBaseDps (${e.derived.legacyBaseDps} < ${n.minLegacyBaseDps})`),typeof n.minLegacyEhp=="number"&&e.derived.legacyEhp<n.minLegacyEhp&&a.push(`minLegacyEhp (${e.derived.legacyEhp} < ${n.minLegacyEhp})`),typeof n.minDpsProxy=="number"&&e.derived.dpsProxy<n.minDpsProxy&&a.push(`minDpsProxy (${e.derived.dpsProxy} < ${n.minDpsProxy})`),typeof n.minEhpProxy=="number"&&e.derived.ehpProxy<n.minEhpProxy&&a.push(`minEhpProxy (${e.derived.ehpProxy} < ${n.minEhpProxy})`),typeof n.minMr=="number"&&e.aggregated.mr<n.minMr&&a.push(`minMr (${e.aggregated.mr} < ${n.minMr})`),typeof n.minMs=="number"&&e.aggregated.ms<n.minMs&&a.push(`minMs (${e.aggregated.ms} < ${n.minMs})`),typeof n.minSpeed=="number"&&e.aggregated.speed<n.minSpeed&&a.push(`minSpeed (${e.aggregated.speed} < ${n.minSpeed})`),typeof n.minSkillPointTotal=="number"&&e.derived.skillPointTotal<n.minSkillPointTotal&&a.push(`minSkillPointTotal (${e.derived.skillPointTotal} < ${n.minSkillPointTotal})`),typeof n.maxReqTotal=="number"&&e.derived.reqTotal>n.maxReqTotal&&a.push(`maxReqTotal (${e.derived.reqTotal} > ${n.maxReqTotal})`),o.length>0&&i&&s)for(const r of o){const u=r.key;let c=0;for(const g of j){const p=i[g];if(p==null)continue;const x=s.itemsById.get(p);x&&(c+=x.numericIndex[u]??0)}typeof r.min=="number"&&c<r.min&&a.push(`${u} (${c} < ${r.min})`),typeof r.max=="number"&&c>r.max&&a.push(`${u} (${c} > ${r.max})`)}return a.length>0?{ok:!1,failedChecks:a}:{ok:!0}}function Me(e,t,i,s){const n=[...new Set(i.mustIncludeIds)];for(const u of n){let c=!1;for(const g of j)if(e[g]===u){c=!0;break}if(!c)return{ok:!1,reason:"item",failedChecks:[`mustIncludeMissing (${u})`]}}for(const u of j){const c=e[u];if(c==null)continue;const g=t.itemsById.get(c);if(!g)return{ok:!1,reason:"item"};if(!Pe(g,i))return{ok:!1,reason:"item"}}const o=xt(e,t);for(const[u,c]of o){const g=t.setsMeta.get(u);if(g&&g.illegalCounts.includes(c))return{ok:!1,reason:"item"}}const a=Et({constraints:i,slots:e,catalog:t,atkTierRequirement:ze(Le(i))});if(a.configured&&!a.ok)return{ok:!1,reason:"attackSpeed",failedChecks:a.failedChecks};const r=Mt(s,i,e,t);return r.ok?{ok:!0}:{ok:!1,reason:"thresholds",failedChecks:r.failedChecks}}function Pe(e,t){return!(!t.allowRestricted&&(e.restricted||e.deprecated)||e.level>t.level||!et(e,t.characterClass)||t.excludedIds.includes(e.id)||t.allowedTiers.length>0&&!t.allowedTiers.includes(e.tier)||t.minPowderSlots!=null&&e.powderSlots<t.minPowderSlots||t.excludedMajorIds.length>0&&t.excludedMajorIds.some(i=>e.majorIds.includes(i)))}const Q=2.5;function $e(e,t){const i={...t};return typeof e.minLegacyBaseDps=="number"&&(i.legacyBaseDps=Math.max(i.legacyBaseDps,K.legacyBaseDps*Q)),typeof e.minLegacyEhp=="number"&&(i.legacyEhp=Math.max(i.legacyEhp,K.legacyEhp*Q)),typeof e.minDpsProxy=="number"&&(i.dpsProxy=Math.max(i.dpsProxy,K.dpsProxy*Q)),typeof e.minEhpProxy=="number"&&(i.ehpProxy=Math.max(i.ehpProxy,K.ehpProxy*Q)),(typeof e.minMr=="number"||typeof e.minMs=="number")&&(i.sustain=Math.max(i.sustain,K.sustain*Q)),typeof e.minSpeed=="number"&&(i.speed=Math.max(i.speed,K.speed*Q)),typeof e.minSkillPointTotal=="number"&&(i.skillPointTotal=Math.max(i.skillPointTotal,K.skillPointTotal*Q)),typeof e.maxReqTotal=="number"&&(i.reqTotalPenalty=Math.max(i.reqTotalPenalty,K.reqTotalPenalty*Q)),(e.customNumericRanges?.length??0)>0&&(i.sustain=Math.max(i.sustain,K.sustain*Q)),i}const Pt=3,At=2,It=14;function vt(e,t){const i=t.target.customNumericRanges??[],s=i.some(c=>typeof c.min=="number"),n=i.filter(c=>typeof c.min=="number").length,o=s?Math.max(.15,1-n*.2):1,a=(t.weights.legacyEhp+t.weights.ehpProxy)*o;let r=e.numeric.baseDps*t.weights.legacyBaseDps*o+e.roughScoreFields.ehpProxy*a+e.roughScoreFields.offense*t.weights.dpsProxy*o+e.numeric.spd*t.weights.speed+e.roughScoreFields.utility*t.weights.sustain+e.roughScoreFields.skillPointTotal*t.weights.skillPointTotal-e.roughScoreFields.reqTotal*t.weights.reqTotalPenalty;const u=s?It:Pt;for(const c of i){const g=c.key?.trim();if(!g)continue;const p=e.numericIndex[g]??0;typeof c.min=="number"&&(r+=p*u),typeof c.max=="number"&&(r-=p*At)}return r}function ne(e){const t=e.ring1??0,i=e.ring2??0,[s,n]=t<=i?[t,i]:[i,t];return[e.helmet??0,e.chestplate??0,e.leggings??0,e.boots??0,s,n,e.bracelet??0,e.necklace??0,e.weapon??0].join("|")}function Fe(e,t,i,s=.6){const n=Math.max(1,i),o=[],a=new Set,r=Math.max(1,Math.min(n,Math.round(n*s)));let u=0,c=0;const g=p=>{const x=`${p.orderIndex}|${ne(p.slots)}`;return a.has(x)?!1:(a.add(x),o.push(p),!0)};for(;o.length<n&&(u<e.length||c<t.length);){if(o.length<r&&u<e.length){g(e[u]),u++;continue}if(c<t.length){g(t[c]),c++;continue}if(u<e.length){g(e[u]),u++;continue}break}return o}function Ne(e,t){return Se(t)===e.category}function Ct(e,t,i){const s=Y(e),n=[...new Set(i.mustIncludeIds)];for(const o of n){const a=t.itemsById.get(o);if(!a)return{slots:s,ok:!1,reasonCode:"must_include_conflict",detail:`Must-include item ${o} does not exist in catalog.`};if(!Pe(a,i))return{slots:s,ok:!1,reasonCode:"must_include_conflict",detail:`Must-include item ${a.displayName} is incompatible with current hard filters (class/level/tier/exclusions).`};if(j.some(g=>s[g]===a.id))continue;const c=j.filter(g=>s[g]==null&&Ne(a,g))[0];if(!c)return{slots:s,ok:!1,reasonCode:"must_include_conflict",detail:`No free ${a.category} slot available to place must-include item ${a.displayName}.`};s[c]=a.id}return{slots:s,ok:!0}}function wt(e,t){const i={str:0,dex:0,int:0,def:0,agi:0};for(const n of j){const o=e[n];if(o==null)continue;const a=t.itemsById.get(o);a&&(i.str=Math.max(i.str,a.numeric.reqStr),i.dex=Math.max(i.dex,a.numeric.reqDex),i.int=Math.max(i.int,a.numeric.reqInt),i.def=Math.max(i.def,a.numeric.reqDef),i.agi=Math.max(i.agi,a.numeric.reqAgi))}const s=Ee.filter(n=>i[n]>100).sort((n,o)=>i[o]-i[n]);return s.length>0?s:Ee.filter(n=>i[n]>=70).sort((n,o)=>i[o]-i[n]).slice(0,2)}function qt(e,t,i){if(i.length===0)return[];const s={str:0,dex:0,int:0,def:0,agi:0};for(const n of j){const o=e[n];if(o==null)continue;const a=t.itemsById.get(o);a&&(s.str=Math.max(s.str,a.numeric.reqStr),s.dex=Math.max(s.dex,a.numeric.reqDex),s.int=Math.max(s.int,a.numeric.reqInt),s.def=Math.max(s.def,a.numeric.reqDef),s.agi=Math.max(s.agi,a.numeric.reqAgi))}return i.map(n=>Math.max(0,s[n]-100))}function _e(e,t){return t.map(i=>Te(e,i))}function oe(e,t){if(e.length===0)return t.slice();const i=new Array(e.length);for(let s=0;s<e.length;s++)i[s]=(e[s]??0)+(t[s]??0);return i}function Bt(e,t,i){for(let s=0;s<i.length;s++)if((e[s]??0)+(t[s]??0)<i[s])return!1;return!0}function Oe(e,t){let i=0;for(let s=0;s<t.length;s++)i+=Math.max(0,t[s]-(e[s]??0));return i}function fe(e,t){if(!e||t.length===0)return 0;let i=0;for(let s=0;s<t.length;s++){const n=e[s]??0,o=t[s];typeof o.min=="number"&&n<o.min&&(i+=o.min-n),typeof o.max=="number"&&n>o.max&&(i+=n-o.max)}return i}function je(e,t,i,s){if(s.length===0)return 0;const n=t.get(e)??[];let o=0;for(const a of n){const r=i.itemsById.get(a.id);if(!r)continue;let u=0;for(const c of s)u+=Te(r,c);u>o&&(o=u)}return o}function me(e,t={}){const i=t.includeAttackTier??!0;return(e.target.customNumericRanges??[]).map(s=>({key:(s.key??"").trim(),min:typeof s.min=="number"?s.min:void 0,max:typeof s.max=="number"?s.max:void 0})).filter(s=>s.key&&(typeof s.min=="number"||typeof s.max=="number")).filter(s=>i||s.key!=="atkTier")}function Le(e){return me(e,{includeAttackTier:!0}).filter(t=>t.key==="atkTier")}function Ae(e){const t=e.attackSpeedConstraintMode==="or"&&e.weaponAttackSpeeds.length>0;return me(e,{includeAttackTier:!t})}function ze(e){if(e.length===0)return{hasConstraint:!1,minAllowed:Number.NEGATIVE_INFINITY,maxAllowed:Number.POSITIVE_INFINITY,rows:[]};let t=Number.NEGATIVE_INFINITY,i=Number.POSITIVE_INFINITY;for(const s of e)typeof s.min=="number"&&(t=Math.max(t,s.min)),typeof s.max=="number"&&(i=Math.min(i,s.max));return{hasConstraint:!0,minAllowed:t,maxAllowed:i,rows:e}}function Rt(e,t){return t.hasConstraint?e>=t.minAllowed&&e<=t.maxAllowed:!1}function Dt(e,t,i,s,n){if(!e.hasConstraint)return!1;const o=t+i+Math.min(s,n),a=t+i+Math.max(s,n);return o<=e.maxAllowed&&a>=e.minAllowed}function Et(e){const{constraints:t,slots:i,catalog:s,atkTierRequirement:n}=e,o=t.weaponAttackSpeeds.length>0,a=n.hasConstraint;if(!o&&!a)return{configured:!1,ok:!0};const r=[];let u=!1;if(o){const x=yt(i,s);u=!!(x&&t.weaponAttackSpeeds.includes(x)),u||r.push(`attackSpeed (expected ${t.weaponAttackSpeeds.join("/")} )`)}let c=!1;if(a){const x=be(i,s);if(c=Rt(x,n),!c){const b=Number.isFinite(n.minAllowed)?n.minAllowed:"-inf",y=Number.isFinite(n.maxAllowed)?n.maxAllowed:"+inf";r.push(`atkTier (${x} not in [${b}, ${y}])`)}}const g=t.attackSpeedConstraintMode;return(o&&a?g==="and"?u&&c:u||c:o?u:c)?{configured:!0,ok:!0}:{configured:!0,ok:!1,failedChecks:r}}function ge(e){const{constraints:t,attackSpeedCtx:i,atkTierRequirement:s,fixedAtkTierTotal:n,partialAssignedAtkTier:o,remainingMinAtkTier:a,remainingMaxAtkTier:r}=e,u=t.weaponAttackSpeeds.length>0,c=s.hasConstraint;if(!u&&!c)return!0;const g=u?i?bt(i,o,a,r):!0:!1,p=c?Dt(s,n,o,a,r):!1;return u&&c?t.attackSpeedConstraintMode==="and"?g&&p:g||p:u?g:p}function he(e,t,i){const s=t.itemsById.get(e.id);return s?s.numericIndex[i]??0:0}function pe(e,t,i){const s=i.map(()=>0);if(i.length===0)return s;for(const n of j){const o=e[n];if(o==null)continue;const a=t.itemsById.get(o);if(a)for(let r=0;r<i.length;r++)s[r]+=a.numericIndex[i[r]]??0}return s}function Ie(e){const{slotOrder:t,candidatePools:i,catalog:s,keys:n}=e,o=Array.from({length:t.length+1},()=>n.map(()=>0)),a=Array.from({length:t.length+1},()=>n.map(()=>0));if(n.length===0)return{maxSuffix:o,minSuffix:a};for(let r=t.length-1;r>=0;r--){const u=i.get(t[r])??[],c=n.map(()=>Number.NEGATIVE_INFINITY),g=n.map(()=>Number.POSITIVE_INFINITY);for(const p of u){const x=s.itemsById.get(p.id);if(x)for(let b=0;b<n.length;b++){const y=x.numericIndex[n[b]]??0;y>c[b]&&(c[b]=y),y<g[b]&&(g[b]=y)}}for(let p=0;p<n.length;p++){const x=Number.isFinite(c[p])?c[p]:0,b=Number.isFinite(g[p])?g[p]:0;o[r][p]=o[r+1][p]+x,a[r][p]=a[r+1][p]+b}}return{maxSuffix:o,minSuffix:a}}function $t(e,t,i,s,n=[]){const o=[],a=me(i);for(const l of t.items)Ne(l,e)&&(s&&!s.has(l.id)||Pe(l,i)&&o.push({id:l.id,rough:vt(l,i),reqTotal:l.roughScoreFields.reqTotal,skillPointTotal:l.roughScoreFields.skillPointTotal,utility:l.roughScoreFields.utility+l.numeric.spd*.8,level:l.level,atkTier:J(l),spStr:l.numeric.spStr,spDex:l.numeric.spDex,spInt:l.numeric.spInt,spDef:l.numeric.spDef,spAgi:l.numeric.spAgi,supportFocus:kt(l,n)}));const r=[...o].sort((l,d)=>l.rough!==d.rough?d.rough-l.rough:l.id-d.id),u=[...o].sort((l,d)=>l.reqTotal!==d.reqTotal?l.reqTotal-d.reqTotal:l.level!==d.level?l.level-d.level:l.id-d.id),c=[...o].sort((l,d)=>l.skillPointTotal!==d.skillPointTotal?d.skillPointTotal-l.skillPointTotal:l.reqTotal!==d.reqTotal?l.reqTotal-d.reqTotal:l.id-d.id),g=[...o].sort((l,d)=>l.utility!==d.utility?d.utility-l.utility:l.reqTotal!==d.reqTotal?l.reqTotal-d.reqTotal:l.id-d.id),p=i.weaponAttackSpeeds.length>0?[...o].sort((l,d)=>{const m=Math.max(0,l.atkTier),S=Math.max(0,d.atkTier);return m!==S?S-m:l.atkTier!==d.atkTier?d.atkTier-l.atkTier:l.reqTotal!==d.reqTotal?l.reqTotal-d.reqTotal:l.skillPointTotal!==d.skillPointTotal?d.skillPointTotal-l.skillPointTotal:l.id-d.id}):[],x=n.length>0?[...o].sort((l,d)=>l.supportFocus!==d.supportFocus?d.supportFocus-l.supportFocus:l.reqTotal!==d.reqTotal?l.reqTotal-d.reqTotal:l.skillPointTotal!==d.skillPointTotal?d.skillPointTotal-l.skillPointTotal:l.id-d.id):[],b=n.map(l=>[...o].sort((d,m)=>{const S=l==="str"?d.spStr:l==="dex"?d.spDex:l==="int"?d.spInt:l==="def"?d.spDef:d.spAgi,M=l==="str"?m.spStr:l==="dex"?m.spDex:l==="int"?m.spInt:l==="def"?m.spDef:m.spAgi;return S!==M?M-S:d.reqTotal!==m.reqTotal?d.reqTotal-m.reqTotal:d.supportFocus!==m.supportFocus?m.supportFocus-d.supportFocus:d.id-m.id})),y=a.filter(l=>typeof l.min=="number").map(l=>[...o].sort((d,m)=>{const S=he(d,t,l.key),M=he(m,t,l.key);return S!==M?M-S:d.reqTotal!==m.reqTotal?d.reqTotal-m.reqTotal:d.skillPointTotal!==m.skillPointTotal?m.skillPointTotal-d.skillPointTotal:d.id-m.id})),w=a.filter(l=>typeof l.max=="number").map(l=>[...o].sort((d,m)=>{const S=he(d,t,l.key),M=he(m,t,l.key);return S!==M?S-M:d.reqTotal!==m.reqTotal?d.reqTotal-m.reqTotal:d.skillPointTotal!==m.skillPointTotal?m.skillPointTotal-d.skillPointTotal:d.id-m.id})),B=Math.max(10,i.topKPerSlot),E=Math.min(140,Math.max(40,Math.floor(B*.8))),k=Math.min(o.length,B+E+(n.length>0?Math.min(60,n.length*12):0)+Math.min(80,a.length*14)),q=new Map,R=Math.min(12,Math.floor(B*.4),r.length);for(let l=0;l<R;l++){const d=r[l];q.set(d.id,{id:d.id,rough:d.rough})}const A=[{list:r,remaining:Math.max(0,B-R),cursor:0},{list:u,remaining:Math.floor(E*.28),cursor:0},{list:c,remaining:Math.floor(E*.24),cursor:0},{list:g,remaining:Math.floor(E*.18),cursor:0}];p.length>0&&A.push({list:p,remaining:Math.max(18,Math.floor(E*.22)),cursor:0}),x.length>0&&A.push({list:x,remaining:Math.max(16,Math.floor(E*.2)),cursor:0});for(const l of b)A.push({list:l,remaining:10,cursor:0});for(const l of y)A.push({list:l,remaining:35,cursor:0});for(const l of w)A.push({list:l,remaining:20,cursor:0});for(;q.size<k;){let l=!1;for(const d of A)if(!(d.remaining<=0))for(;d.cursor<d.list.length;){const m=d.list[d.cursor++];if(!q.has(m.id)){q.set(m.id,{id:m.id,rough:m.rough}),d.remaining--,l=!0;break}}if(!l)break}if(q.size<k)for(const l of r){if(q.size>=k)break;q.has(l.id)||q.set(l.id,{id:l.id,rough:l.rough})}return[...q.values()]}function Ft(e){const t={};for(const i of j){const s=Se(i),n=new Set(e.binsByCategory[s]??[]),o=e.slots[i];o!=null&&n.add(o),t[i]=n}return t}function ve(e,t,i){if(i.length===0)return!0;const s=new Set;for(const n of j){const o=e[n];if(o==null)continue;const a=t.itemsById.get(o);if(a)for(const r of a.majorIds)i.includes(r)&&s.add(r)}return i.every(n=>s.has(n))}function We(e,t){const i=new Array(e.length+1).fill(0);for(let s=e.length-1;s>=0;s--){const n=e[s],o=t.get(n)??[];let a=0;for(const r of o)r.rough>a&&(a=r.rough);i[s]=i[s+1]+a}return i}function He(e){const{poolSize:t,beamSize:i,remainingStages:s,processedStates:n,maxStates:o}=e;if(t<=0)return 0;const a=Math.max(0,o-n),r=Math.max(1,i*Math.max(1,s)),u=Math.floor(a/r),c=Math.max(8,Math.min(96,u));return Math.min(t,c)}function Nt(e,t,i){let s=1;for(const n of e){const o=t.get(n)?.length??0;if(o===0)return 0;if(s*=o,s>i)return s}return s}function Ve(e){const{beam:t,catalog:i,constraints:s,skillpointFeasibilityOptions:n,signal:o}=e,a=n??de(s),r=[],u=new Set,c={majorIds:0,spInvalid:0,duplicate:0,hardConstraints:0,hardAttackSpeed:0,hardThresholds:0,hardItem:0,thresholdFailureExample:void 0};for(const g of t){if(o?.aborted)throw new DOMException("Auto build cancelled","AbortError");if(!ve(g.slots,i,s.requiredMajorIds)){c.majorIds++;continue}const p=le({slots:g.slots,level:s.level,characterClass:s.characterClass},i,{skillpointFeasibility:a});if(!p.derived.skillpointFeasible){c.spInvalid++;continue}const x=Me(g.slots,i,s,p);if(!x.ok){c.hardConstraints++,x.reason==="attackSpeed"?c.hardAttackSpeed++:x.reason==="thresholds"?(c.hardThresholds++,c.thresholdFailureExample===void 0&&x.failedChecks?.length&&(c.thresholdFailureExample=x.failedChecks[0])):c.hardItem++;continue}const b=ne(g.slots);if(u.has(b)){c.duplicate++;continue}const{score:y,breakdown:w}=re(p,s.weights,s);u.add(b),r.push({slots:Y(g.slots),score:y,scoreBreakdown:w,summary:p})}return r.sort((g,p)=>{if(g.score!==p.score)return p.score-g.score;for(const x of j){const b=g.slots[x]??0,y=p.slots[x]??0;if(b!==y)return b-y}return 0}),{candidates:r,rejectStats:c}}function _t(e){const{slotOrder:t,candidatePools:i,baseSlots:s,catalog:n,constraints:o,focusStats:a,attackSpeedCtx:r,atkTierRequirement:u,fixedAtkTierTotal:c,onProgress:g,signal:p}=e,x=de(o),b=We(t,i),y=r||u.hasConstraint?ue(t,i,n):null,w=qt(s,n,a),B=Array.from({length:t.length+1},()=>a.map(()=>0));for(let m=t.length-1;m>=0;m--){const S=i.get(t[m])??[],M=a.map(()=>0);for(const C of S){const F=n.itemsById.get(C.id);if(!F)continue;const O=_e(F,a);for(let f=0;f<O.length;f++)O[f]>M[f]&&(M[f]=O[f])}B[m]=oe(B[m+1],M)}const E=Ae(o),k=E.map(m=>m.key),q=Ie({slotOrder:t,candidatePools:i,catalog:n,keys:k}),R=pe(s,n,k);let A=[{slots:Y(s),orderIndex:0,roughScore:0,optimisticBound:b[0],feasibilityAssigned:0,focusSupport:a.map(()=>0),atkTierAssigned:0,customTotals:R}],l=0,d=!1;for(let m=0;m<t.length;m++){if(p?.aborted)throw new DOMException("Auto build cancelled","AbortError");const S=t[m],M=i.get(S)??[],C=[],F=He({poolSize:M.length,beamSize:A.length,remainingStages:t.length-m,processedStates:l,maxStates:o.maxStates});F<=0&&(d=!0);for(const $ of A){let N=0;for(const h of M){if(N>=F)break;if(l>=o.maxStates){d=!0;break}if(l++,N++,ce(h.id,$.slots,n))continue;const v=Y($.slots);v[S]=h.id;const I=n.itemsById.get(h.id),P=($.atkTierAssigned??0)+(I?J(I):0),D=oe($.focusSupport??a.map(()=>0),I?_e(I,a):a.map(()=>0)),z=k.length>0?oe($.customTotals??k.map(()=>0),k.map(V=>I?I.numericIndex[V]??0:0)):void 0;if(y&&!ge({constraints:o,attackSpeedCtx:r??null,atkTierRequirement:u,fixedAtkTierTotal:c,partialAssignedAtkTier:P,remainingMinAtkTier:y.minSuffix[m+1],remainingMaxAtkTier:y.maxSuffix[m+1]})||a.length>0&&!Bt(D,B[m+1],w))continue;if(E.length>0&&z){let V=!0;for(let _=0;_<E.length;_++){const L=E[_],W=z[_];if(typeof L.min=="number"&&W+q.maxSuffix[m+1][_]<L.min){V=!1;break}if(typeof L.max=="number"&&W+q.minSuffix[m+1][_]>L.max){V=!1;break}}if(!V)continue}const H=ye(v,n,o.level,x),ee=$.roughScore+h.rough;C.push({slots:v,orderIndex:m+1,roughScore:ee,optimisticBound:ee+b[m+1],feasibilityAssigned:H.feasible?H.assignedTotal:1/0,focusSupport:D,atkTierAssigned:P,customTotals:z})}if(d)break}if(C.length===0)return g?.({phase:"diagnostics",processedStates:l,beamSize:A.length,totalSlots:t.length,expandedSlots:m,reasonCode:"search_pruned",detail:d?`Feasibility-first search exhausted state budget before completing slot ${S}.`:`Feasibility-first search found no branches that can still satisfy high-skill requirements by slot ${S}.`}),{beam:[],processedStates:l,stateBudgetHit:d};const O=y?y.minSuffix[m+1]:0,f=y?y.maxSuffix[m+1]:0,T=[...C].sort(($,N)=>{if(r){const I=Z(r,$.atkTierAssigned,O,f),P=Z(r,N.atkTierAssigned,O,f);if(I!==P)return P-I}if(a.length>0){const I=Oe($.focusSupport??[],w),P=Oe(N.focusSupport??[],w);if(I!==P)return I-P}const h=$.feasibilityAssigned??1/0,v=N.feasibilityAssigned??1/0;return h!==v?h-v:$.optimisticBound!==N.optimisticBound?N.optimisticBound-$.optimisticBound:$.roughScore!==N.roughScore?N.roughScore-$.roughScore:0}),U=[...C].sort(($,N)=>{const h=fe($.customTotals,E),v=fe(N.customTotals,E);if(h!==v)return h-v;if(r){const I=Z(r,$.atkTierAssigned,O,f),P=Z(r,N.atkTierAssigned,O,f);if(I!==P)return P-I}return N.optimisticBound-$.optimisticBound});A=Fe(T,U,Math.max(40,o.beamWidth)),g?.({phase:"beam-search",processedStates:l,beamSize:A.length,totalSlots:t.length,expandedSlots:m+1,detail:`feasibility-first | branchCap=${F}${a.length>0?` | focus=${a.join("/")}`:""}${r?` | atkSpeed=${o.weaponAttackSpeeds.join("/")}`:""}`,previewCandidates:De(A,n,o,2)})}return{beam:A,processedStates:l,stateBudgetHit:d}}function Ot(e){const{slotOrder:t,candidatePools:i,baseSlots:s,catalog:n,constraints:o,signal:a,onProgress:r}=e,u=de(o),c=[],g=new Set;let p=0,x=0,b=0,y=0,w=0,B=0,E=0,k=0;const q=(R,A)=>{if(a?.aborted)throw new DOMException("Auto build cancelled","AbortError");if(p>o.maxStates)return;if(R>=t.length){if(!ve(A,n,o.requiredMajorIds)){x++;return}const m=le({slots:A,level:o.level,characterClass:o.characterClass},n,{skillpointFeasibility:u});if(!m.derived.skillpointFeasible){b++;return}const S=Me(A,n,o,m);if(!S.ok){w++,S.reason==="attackSpeed"?B++:S.reason==="thresholds"?E++:k++;return}const M=ne(A);if(g.has(M)){y++;return}g.add(M);const{score:C,breakdown:F}=re(m,o.weights,o);c.push({slots:Y(A),score:C,scoreBreakdown:F,summary:m});return}const l=t[R],d=i.get(l)??[];for(const m of d){if(p++,p>o.maxStates)break;ce(m.id,A,n)||(A[l]=m.id,p%2e3===0&&r?.({phase:"exact-search",processedStates:p,beamSize:0,totalSlots:t.length,expandedSlots:R+1}),q(R+1,A))}A[l]=null};return q(0,Y(s)),r?.({phase:"diagnostics",processedStates:p,beamSize:0,totalSlots:t.length,expandedSlots:t.length,detail:c.length>0?`Exact search produced ${c.length} valid builds. Rejected duplicates=${y}, SP-invalid=${b}, majorID=${x}, hard=${w} (speed=${B}, thresholds=${E}, item=${k}).`:`Exact search produced 0 valid builds. Rejected SP-invalid=${b}, majorID=${x}, duplicates=${y}, hard=${w} (speed=${B}, thresholds=${E}, item=${k}).`}),c.sort((R,A)=>{if(R.score!==A.score)return A.score-R.score;for(const l of j){const d=R.slots[l]??0,m=A.slots[l]??0;if(d!==m)return d-m}return 0}),c.slice(0,Math.max(1,o.topN))}function jt(e){const{slotOrder:t,candidatePools:i,baseSlots:s,catalog:n,constraints:o,attackSpeedCtx:a,atkTierRequirement:r,fixedAtkTierTotal:u,customSpecs:c,customBounds:g,signal:p,timeCapMs:x=2e3}=e,b=de(o),y=new Map;for(const m of t){const S=i.get(m)??[];y.set(m,[...S].sort((M,C)=>M.rough!==C.rough?C.rough-M.rough:M.id-C.id))}const w=a||r.hasConstraint?ue(t,i,n):null,B=c.map(m=>m.key),E=pe(s,n,B),k=Date.now();let q=!1,R=0;const A=new Set,l=[],d=(m,S,M,C)=>{if(q)return;if(p?.aborted)throw new DOMException("Auto build cancelled","AbortError");if(Date.now()-k>=x){q=!0;return}if(l.length>=Math.max(1,o.topN))return;if(m>=t.length){if(!ve(S,n,o.requiredMajorIds))return;const f=le({slots:S,level:o.level,characterClass:o.characterClass},n,{skillpointFeasibility:b});if(!f.derived.skillpointFeasible||!Me(S,n,o,f).ok)return;const U=ne(S);if(A.has(U))return;A.add(U);const{score:$,breakdown:N}=re(f,o.weights,o);l.push({slots:Y(S),score:$,scoreBreakdown:N,summary:f});return}const F=t[m],O=y.get(F)??[];for(const f of O){if(q)break;if(R++,ce(f.id,S,n))continue;const T=Y(S);T[F]=f.id;const U=n.itemsById.get(f.id),$=M+(U?J(U):0);if(w&&!ge({constraints:o,attackSpeedCtx:a,atkTierRequirement:r,fixedAtkTierTotal:u,partialAssignedAtkTier:$,remainingMinAtkTier:w.minSuffix[m+1],remainingMaxAtkTier:w.maxSuffix[m+1]}))continue;const N=B.length>0?oe(C??B.map(()=>0),B.map(v=>U?U.numericIndex[v]??0:0)):void 0;if(c.length>0&&N){let v=!0;for(let I=0;I<c.length;I++){const P=c[I],D=N[I];if(typeof P.min=="number"&&D+g.maxSuffix[m+1][I]<P.min){v=!1;break}if(typeof P.max=="number"&&D+g.minSuffix[m+1][I]>P.max){v=!1;break}}if(!v)continue}ye(T,n,o.level,b).feasible&&d(m+1,T,$,N)}};return d(0,Y(s),0,E),l.sort((m,S)=>m.score!==S.score?S.score-m.score:ne(m.slots).localeCompare(ne(S.slots))),{candidates:l.slice(0,Math.max(1,o.topN)),processedStates:R,timedOut:q}}function Ue(e){const{catalog:t,baseWorkbench:i,constraints:s,onProgress:n,signal:o,alreadyThresholdRescue:a}=e;if(o?.aborted)throw new DOMException("Auto build cancelled","AbortError");let r=Y(i.slots);for(const h of j)s.lockedSlots[h]||(r[h]=null);const u=Ct(r,t,s);if(!u.ok)return n?.({phase:"diagnostics",processedStates:0,beamSize:0,totalSlots:0,expandedSlots:0,reasonCode:u.reasonCode??"must_include_conflict",detail:u.detail??"Must-include assignment failed before search started."}),[];r=u.slots;const c=wt(r,t),g=j.filter(h=>r[h]==null),p=s.onlyPinnedItems?Ft(i):null,x=new Map;for(const h of g)x.set(h,$t(h,t,s,p?.[h]??null,c));const b=Tt(r,t,s),y=ze(Le(s)),w=be(r,t),B=Ae(s),E=B.some(h=>typeof h.min=="number"),k=[...g].sort((h,v)=>{if(b?.preferredDirection){const D=x.get(h)??[],z=x.get(v)??[],H=D.reduce((V,_)=>{const L=t.itemsById.get(_.id);if(!L)return V;const W=J(L),G=b.preferredDirection>0?Math.max(0,W):Math.max(0,-W);return Math.max(V,G)},0),ee=z.reduce((V,_)=>{const L=t.itemsById.get(_.id);if(!L)return V;const W=J(L),G=b.preferredDirection>0?Math.max(0,W):Math.max(0,-W);return Math.max(V,G)},0);if(H!==ee)return ee-H}if(c.length>0){const D=je(h,x,t,c),z=je(v,x,t,c);if(D!==z)return z-D}if(E){const D=["ring1","ring2","bracelet","necklace"],z=D.includes(h),H=D.includes(v);if(z!==H)return z?-1:1}const I=x.get(h)?.length??0,P=x.get(v)?.length??0;return I!==P?I-P:h.localeCompare(v)}),q=We(k,x);if(k.some(h=>(x.get(h)?.length??0)===0)){const h=k.find(v=>(x.get(v)?.length??0)===0);return n?.({phase:"diagnostics",processedStates:0,beamSize:0,totalSlots:k.length,expandedSlots:0,reasonCode:"empty_pool",detail:h?`No candidate items available for slot ${h} under current hard filters.`:"One or more slots have empty candidate pools."}),[]}if(y.hasConstraint&&y.minAllowed>y.maxAllowed)return n?.({phase:"diagnostics",processedStates:0,beamSize:0,totalSlots:k.length,expandedSlots:0,reasonCode:"unsat_attack_target",detail:`Attack target is unsatisfiable: atkTier min (${y.minAllowed}) exceeds atkTier max (${y.maxAllowed}).`}),[];if(B.length>0){const h=B.map(P=>P.key),v=Ie({slotOrder:k,candidatePools:x,catalog:t,keys:h}),I=pe(r,t,h);for(let P=0;P<B.length;P++){const D=B[P],z=I[P]+v.minSuffix[0][P],H=I[P]+v.maxSuffix[0][P];if(typeof D.min=="number"&&H<D.min)return n?.({phase:"diagnostics",processedStates:0,beamSize:0,totalSlots:k.length,expandedSlots:0,reasonCode:"unsat_threshold",detail:`Unsatisfiable threshold: ${D.key} min ${D.min} is above maximum reachable total ${H}.`}),[];if(typeof D.max=="number"&&z>D.max)return n?.({phase:"diagnostics",processedStates:0,beamSize:0,totalSlots:k.length,expandedSlots:0,reasonCode:"unsat_threshold",detail:`Unsatisfiable threshold: ${D.key} max ${D.max} is below minimum reachable total ${z}.`}),[]}}const R=b||y.hasConstraint?ue(k,x,t):null;if(R&&!ge({constraints:s,attackSpeedCtx:b??null,atkTierRequirement:y,fixedAtkTierTotal:w,partialAssignedAtkTier:0,remainingMinAtkTier:R.minSuffix[0],remainingMaxAtkTier:R.maxSuffix[0]}))return n?.({phase:"diagnostics",processedStates:0,beamSize:0,totalSlots:k.length,expandedSlots:0,reasonCode:"unsat_attack_target",detail:"Attack-speed / atkTier target cannot be reached from current candidate pools."}),[];const A=Nt(k,x,s.exhaustiveStateLimit+1);if(s.useExhaustiveSmallPool&&k.length>0&&A>0&&A<=s.exhaustiveStateLimit){n?.({phase:"exact-search",processedStates:0,beamSize:0,totalSlots:k.length,expandedSlots:0});const h={...s,maxStates:Math.max(s.maxStates,s.exhaustiveStateLimit)};return Ot({slotOrder:k,candidatePools:x,baseSlots:r,catalog:t,constraints:h,signal:o,onProgress:n})}const l=Ae(s),d=l.map(h=>h.key),m=Ie({slotOrder:k,candidatePools:x,catalog:t,keys:d});let S=[{slots:r,orderIndex:0,roughScore:0,optimisticBound:q[0],atkTierAssigned:0,customTotals:pe(r,t,d)}];const M=b||y.hasConstraint?ue(k,x,t):null;let C=0,F=!1;for(let h=0;h<k.length;h++){if(o?.aborted)throw new DOMException("Auto build cancelled","AbortError");const v=k[h],I=x.get(v),P=[],D=He({poolSize:I.length,beamSize:S.length,remainingStages:k.length-h,processedStates:C,maxStates:s.maxStates});D<=0&&(F=!0);for(const _ of S){let L=0;for(const W of I){if(L>=D)break;if(C>=s.maxStates){F=!0;break}if(C++,L++,ce(W.id,_.slots,t))continue;const G=Y(_.slots);G[v]=W.id;const ae=_.roughScore+W.rough,te=t.itemsById.get(W.id),Ge=(_.atkTierAssigned??0)+(te?J(te):0),we=d.length>0?oe(_.customTotals??d.map(()=>0),d.map(se=>te?te.numericIndex[se]??0:0)):void 0;if(!(M&&!ge({constraints:s,attackSpeedCtx:b??null,atkTierRequirement:y,fixedAtkTierTotal:w,partialAssignedAtkTier:Ge,remainingMinAtkTier:M.minSuffix[h+1],remainingMaxAtkTier:M.maxSuffix[h+1]}))){if(l.length>0&&we){let se=!0;for(let ie=0;ie<l.length;ie++){const xe=l[ie],Ye=we[ie];if(typeof xe.min=="number"&&Ye+m.maxSuffix[h+1][ie]<xe.min){se=!1;break}if(typeof xe.max=="number"&&Ye+m.minSuffix[h+1][ie]>xe.max){se=!1;break}}if(!se)continue}P.push({slots:G,orderIndex:h+1,roughScore:ae,optimisticBound:ae+q[h+1],atkTierAssigned:Ge,customTotals:we})}}if(F)break}if(P.length===0)return n?.({phase:"diagnostics",processedStates:C,beamSize:S.length,totalSlots:k.length,expandedSlots:h,reasonCode:"search_pruned",detail:F?`Search state budget exhausted before completing slot ${v}. Try enabling deep fallback/exact mode or reduce hard filters.`:`No expansions produced at slot ${v}.`}),[];const z=M?M.minSuffix[h+1]:0,H=M?M.maxSuffix[h+1]:0,ee=[...P].sort((_,L)=>{if(b){const W=Z(b,_.atkTierAssigned,z,H),G=Z(b,L.atkTierAssigned,z,H);if(W!==G)return G-W}return _.optimisticBound!==L.optimisticBound?L.optimisticBound-_.optimisticBound:L.roughScore-_.roughScore}),V=[...P].sort((_,L)=>{const W=fe(_.customTotals,l),G=fe(L.customTotals,l);if(W!==G)return W-G;if(b){const ae=Z(b,_.atkTierAssigned,z,H),te=Z(b,L.atkTierAssigned,z,H);if(ae!==te)return te-ae}return L.optimisticBound-_.optimisticBound});S=Fe(ee,V,Math.max(20,s.beamWidth)),n?.({phase:"beam-search",processedStates:C,beamSize:S.length,totalSlots:k.length,expandedSlots:h+1,detail:`branchCap=${D}${b?.preferredDirection?` | atkSpeedTarget=${s.weaponAttackSpeeds.join("/")}`:""}`,previewCandidates:De(S,t,s,2)})}let O=S,{candidates:f,rejectStats:T}=Ve({beam:S,catalog:t,constraints:s,signal:o});const U=T.thresholdFailureExample?` Example failure: ${T.thresholdFailureExample}.`:"",$=f.length>0?void 0:T.spInvalid>0&&T.hardConstraints===0?"sp_infeasible":T.hardThresholds>0?"unsat_threshold":T.hardAttackSpeed>0?"unsat_attack_target":void 0;n?.({phase:"diagnostics",processedStates:C,beamSize:S.length,totalSlots:k.length,expandedSlots:k.length,reasonCode:$,detail:f.length>0?`Final eval: ${f.length} valid builds. Rejected duplicates=${T.duplicate}, SP-invalid=${T.spInvalid}, majorID=${T.majorIds}, hard=${T.hardConstraints}.`:`Final eval found 0 valid builds. Rejected SP-invalid=${T.spInvalid}, majorID=${T.majorIds}, duplicates=${T.duplicate}, hard=${T.hardConstraints} (speed=${T.hardAttackSpeed}, thresholds=${T.hardThresholds}, item=${T.hardItem}).${U}`});const N=s.weaponAttackSpeeds.length>0||y.hasConstraint;if(f.length===0&&k.length>0&&(T.spInvalid>0||N&&T.hardAttackSpeed>0||T.hardThresholds>0)){const h=T.hardThresholds>0;n?.({phase:"diagnostics",processedStates:C,beamSize:S.length,totalSlots:k.length,expandedSlots:k.length,detail:h&&s.target.customNumericRanges?.length?"Retrying with threshold-aware rescue (advanced ID constraints + support-aware feasibility search).":T.hardAttackSpeed>0?"Retrying with feasibility-first beam search (support-aware rescue + attack target reachability).":"Retrying with feasibility-first beam search (support-aware rescue for high-skill requirements)."});const v={...s,maxStates:Math.max(s.maxStates,h?Math.min(18e6,s.maxStates*5):N?Math.min(16e6,s.maxStates*4):Math.min(8e6,s.maxStates*2)),beamWidth:Math.max(s.beamWidth,h?3600:N?3200:1800)};h&&(v.weights=$e(s.target,s.weights));const I=_t({slotOrder:k,candidatePools:x,baseSlots:r,catalog:t,constraints:v,focusStats:c,attackSpeedCtx:b,atkTierRequirement:y,fixedAtkTierTotal:w,onProgress:n,signal:o});if(I.beam.length>0){O=I.beam;const P=Ve({beam:I.beam,catalog:t,constraints:s,signal:o});f=P.candidates,T=P.rejectStats;const D=T.thresholdFailureExample?` Example failure: ${T.thresholdFailureExample}.`:"";n?.({phase:"diagnostics",processedStates:I.processedStates,beamSize:I.beam.length,totalSlots:k.length,expandedSlots:k.length,detail:f.length>0?`Feasibility-first eval: ${f.length} valid builds. Rejected duplicates=${T.duplicate}, SP-invalid=${T.spInvalid}, majorID=${T.majorIds}, hard=${T.hardConstraints}.`:`Feasibility-first eval still found 0 valid builds. Rejected SP-invalid=${T.spInvalid}, majorID=${T.majorIds}, duplicates=${T.duplicate}, hard=${T.hardConstraints} (speed=${T.hardAttackSpeed}, thresholds=${T.hardThresholds}, item=${T.hardItem}).${D}`})}}if(f.length===0&&T.hardThresholds>0&&!a){const h=s.target;if(typeof h.minLegacyBaseDps=="number"||typeof h.minLegacyEhp=="number"||typeof h.minDpsProxy=="number"||typeof h.minEhpProxy=="number"||typeof h.minMr=="number"||typeof h.minMs=="number"||typeof h.minSpeed=="number"||typeof h.minSkillPointTotal=="number"||typeof h.maxReqTotal=="number"||(h.customNumericRanges?.length??0)>0){n?.({phase:"diagnostics",processedStates:C,beamSize:O.length,totalSlots:k.length,expandedSlots:k.length,detail:"Retrying with threshold-biased beam search (weights tuned to target min/max)."});const I={...s,weights:$e(s.target,s.weights),beamWidth:Math.max(s.beamWidth,3600),maxStates:Math.max(s.maxStates,Math.min(18e6,s.maxStates*5))},P=Ue({catalog:t,baseWorkbench:i,constraints:I,onProgress:n,signal:o,alreadyThresholdRescue:!0});if(P.length>0)return n?.({phase:"diagnostics",processedStates:C,beamSize:P.length,totalSlots:k.length,expandedSlots:k.length,detail:`Threshold rescue: ${P.length} valid builds.`}),P.slice(0,Math.max(1,s.topN))}}if(f.length===0&&k.length>0){n?.({phase:"diagnostics",processedStates:C,beamSize:O.length,totalSlots:k.length,expandedSlots:k.length,reasonCode:"search_pruned",detail:"Running deterministic fallback search (2s cap) before returning no candidates."});const h=jt({slotOrder:k,candidatePools:x,baseSlots:r,catalog:t,constraints:s,attackSpeedCtx:b??null,atkTierRequirement:y,fixedAtkTierTotal:w,customSpecs:l,customBounds:m,signal:o,timeCapMs:2e3});if(h.candidates.length>0)f=h.candidates,n?.({phase:"diagnostics",processedStates:C+h.processedStates,beamSize:h.candidates.length,totalSlots:k.length,expandedSlots:k.length,detail:`Deterministic fallback recovered ${h.candidates.length} valid build(s).`});else{const v=h.timedOut?"fallback_timeout":T.spInvalid>0&&T.hardConstraints===0?"sp_infeasible":T.hardThresholds>0?"unsat_threshold":T.hardAttackSpeed>0?"unsat_attack_target":"search_pruned";n?.({phase:"diagnostics",processedStates:C+h.processedStates,beamSize:0,totalSlots:k.length,expandedSlots:k.length,reasonCode:v,detail:h.timedOut?"Deterministic fallback timed out after 2 seconds with no valid candidates.":`Deterministic fallback found 0 valid builds. Rejected SP-invalid=${T.spInvalid}, majorID=${T.majorIds}, duplicates=${T.duplicate}, hard=${T.hardConstraints} (speed=${T.hardAttackSpeed}, thresholds=${T.hardThresholds}, item=${T.hardItem}).${T.thresholdFailureExample?` Example failure: ${T.thresholdFailureExample}.`:""}`})}}return f.slice(0,Math.max(1,s.topN))}const Ce=new Map;self.onmessage=e=>{const t=e.data;if(t.type==="cancel"){Ce.get(t.requestId)?.abort();return}const i=new AbortController;Ce.set(t.requestId,i);try{const s=Ue({catalog:{...t.catalog,itemsById:new Map(t.catalog.itemsById),itemIdByName:new Map(t.catalog.itemIdByName),itemsByType:new Map(t.catalog.itemsByType),itemsByCategory:new Map(t.catalog.itemsByCategory)},baseWorkbench:t.baseWorkbench,constraints:t.constraints,signal:i.signal,onProgress:o=>{const a={type:"progress",requestId:t.requestId,progress:o};self.postMessage(a)}}),n={type:"result",requestId:t.requestId,candidates:s};self.postMessage(n)}catch(s){const n={type:"error",requestId:t.requestId,message:s instanceof Error?s.message:"Auto builder worker error"};self.postMessage(n)}finally{Ce.delete(t.requestId)}}})();
