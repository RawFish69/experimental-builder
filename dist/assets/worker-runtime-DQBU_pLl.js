(function(){"use strict";const X={legacyBaseDps:1,legacyEhp:.7,dpsProxy:1,ehpProxy:.6,speed:.4,sustain:.35,skillPointTotal:.15,reqTotalPenalty:.2};function Qe(e){return e.aggregated.hprTotal*.9+e.aggregated.mr*14+e.aggregated.ms*10+e.aggregated.ls*9}function Ze(e,t){let i=0;const{target:s}=t;return typeof s.minLegacyBaseDps=="number"&&e.derived.legacyBaseDps<s.minLegacyBaseDps&&(i+=(s.minLegacyBaseDps-e.derived.legacyBaseDps)*4),typeof s.minLegacyEhp=="number"&&e.derived.legacyEhp<s.minLegacyEhp&&(i+=(s.minLegacyEhp-e.derived.legacyEhp)*.8),typeof s.minDpsProxy=="number"&&e.derived.dpsProxy<s.minDpsProxy&&(i+=(s.minDpsProxy-e.derived.dpsProxy)*4),typeof s.minEhpProxy=="number"&&e.derived.ehpProxy<s.minEhpProxy&&(i+=(s.minEhpProxy-e.derived.ehpProxy)*1.1),typeof s.minMr=="number"&&e.aggregated.mr<s.minMr&&(i+=(s.minMr-e.aggregated.mr)*45),typeof s.minMs=="number"&&e.aggregated.ms<s.minMs&&(i+=(s.minMs-e.aggregated.ms)*35),typeof s.minSpeed=="number"&&e.aggregated.speed<s.minSpeed&&(i+=(s.minSpeed-e.aggregated.speed)*12),typeof s.minSkillPointTotal=="number"&&e.derived.skillPointTotal<s.minSkillPointTotal&&(i+=(s.minSkillPointTotal-e.derived.skillPointTotal)*15),typeof s.maxReqTotal=="number"&&e.derived.reqTotal>s.maxReqTotal&&(i+=(e.derived.reqTotal-s.maxReqTotal)*8),i}function et(e,t){const i=t.target.customNumericRanges??[];if(i.length===0)return 0;const s=8,n=4;let o=0;for(const r of i){const a=r.key?.trim();if(!a)continue;const d=e.aggregated,c=e.derived,m=d[a]??c[a]??0;typeof r.min=="number"&&(o+=m*s),typeof r.max=="number"&&m>r.max&&(o-=(m-r.max)*n)}return o}function le(e,t,i){const s=et(e,i);if(i.constraintOnlyMode){const h={legacyBaseDps:0,legacyEhp:0,dpsProxy:0,spellProxy:0,meleeProxy:0,ehpProxy:0,speed:0,sustain:0,skillPointTotal:e.derived.skillPointTotal*.01,reqPenalty:e.derived.reqTotal*.01,thresholdPenalty:0};return{score:s+h.skillPointTotal-h.reqPenalty,breakdown:h}}const n=Qe(e),o=e.derived.reqTotal*t.reqTotalPenalty,r=Ze(e,i),a=(i.target.customNumericRanges??[]).filter(h=>typeof h.min=="number").length,d=a>0?Math.max(.15,1-a*.2):1,c={legacyBaseDps:e.derived.legacyBaseDps*t.legacyBaseDps*d,legacyEhp:e.derived.legacyEhp*t.legacyEhp*d,dpsProxy:e.derived.dpsProxy*t.dpsProxy*d,spellProxy:e.derived.spellProxy*t.spellProxy*d,meleeProxy:e.derived.meleeProxy*t.meleeProxy*d,ehpProxy:e.derived.ehpProxy*t.ehpProxy*d,speed:e.aggregated.speed*t.speed,sustain:n*t.sustain,skillPointTotal:e.derived.skillPointTotal*t.skillPointTotal,reqPenalty:o,thresholdPenalty:r};return{score:c.legacyBaseDps+c.legacyEhp+c.dpsProxy+c.spellProxy+c.meleeProxy+c.ehpProxy+c.speed+c.sustain+c.skillPointTotal+s-c.reqPenalty-c.thresholdPenalty,breakdown:c}}const O=["helmet","chestplate","leggings","boots","ring1","ring2","bracelet","necklace","weapon"],Se=e=>e==="ring1"||e==="ring2"?"ring":e,tt={spear:"Warrior",dagger:"Assassin",wand:"Mage",bow:"Archer",relik:"Shaman"};function nt(e){return tt[e]??null}function st(e,t){return!t||!e.classReq?!0:e.classReq===t}const it={slotStatus:{},warnings:{messages:[]},aggregated:{hpTotal:0,hprTotal:0,mr:0,ms:0,ls:0,speed:0,skillPoints:{str:0,dex:0,int:0,def:0,agi:0},skillReqs:{str:0,dex:0,int:0,def:0,agi:0},defenses:{e:0,t:0,w:0,f:0,a:0},offense:{baseDps:0,spellPct:0,spellRaw:0,meleePct:0,meleeRaw:0,elemDamPct:0,genericDamPct:0,offenseScore:0}},derived:{dpsProxy:0,spellProxy:0,meleeProxy:0,ehpProxy:0,reqTotal:0,skillPointTotal:0,legacyBaseDps:0,legacyEhp:0,legacyEhpNoAgi:0,skillpointFeasible:!0,assignedSkillPointsRequired:0}};function ye(e){let t=Number.isFinite(e)?e:0;if(t<=0)return 0;t>=150&&(t=150);const i=.9908;return i/(1-i)*(1-Math.pow(i,t))/100}const ot=.867,rt=.951,at=90;function lt(e){return Math.max(1,Math.min(106,Math.round(e||1)))*5+5}function Be(e){const t=Math.max(1,Math.min(106,Math.round(e||1)));return t>=101?200:(t-1)*2}function ct(e){switch(e){case"relik":return .6;case"bow":return .7;case"wand":return .8;case"dagger":case"spear":return 1;default:return 1}}function dt(e){const t=Math.max(5,e.totalHp),i=ye(e.defSkillPoints)*ot,s=ye(e.agiSkillPoints)*rt,o=2-ct(e.weaponType),a=(100-at)/100*s+(1-s)*(1-i),d=1-i,c=t/Math.max(1e-9,a)/Math.max(1e-9,o),m=t/Math.max(1e-9,d)/Math.max(1e-9,o);return{withAgi:c,noAgi:m}}function ut(e){return[e.numeric.reqStr,e.numeric.reqDex,e.numeric.reqInt,e.numeric.reqDef,e.numeric.reqAgi]}function ft(e){return[e.numeric.spStr,e.numeric.spDex,e.numeric.spInt,e.numeric.spDef,e.numeric.spAgi]}function mt(e,t){return[e[0]+t[0],e[1]+t[1],e[2]+t[2],e[3]+t[3],e[4]+t[4]]}function gt(e){return e[0]+e[1]+e[2]+e[3]+e[4]}function Re(e,t){for(let i=0;i<5;i++)if(e[i]>t[i])return!1;return!0}function pt(e,t){for(const i of e)if(Re(i.assigned,t.assigned))return;for(let i=e.length-1;i>=0;i--)Re(t.assigned,e[i].assigned)&&e.splice(i,1);e.push(t)}function ht(e,t,i={}){if(e.length===0)return{feasible:!0,assignedTotal:0,assignedByStat:[0,0,0,0,0]};const s=i.availableSkillPointsOverride??Be(t),n=i.extraBaseSkillPoints??[0,0,0,0,0],o=e.length,r=e.map(ut),a=e.map(ft),d=1<<o,c=Array.from({length:d},()=>[0,0,0,0,0]);for(let S=1;S<d;S++){const B=S&-S,w=Math.log2(B)|0;c[S]=mt(c[S^B],a[w])}const m=new Array(d);m[0]=[{assigned:[0,0,0,0,0],assignedTotal:0}];for(let S=0;S<d;S++){const B=m[S];if(!B||B.length===0)continue;const w=c[S];for(const $ of B)for(let y=0;y<o;y++){if((S&1<<y)!==0)continue;const R=[...$.assigned];let E=!0;for(let k=0;k<5;k++){const M=$.assigned[k]+w[k]+(n[k]??0),q=r[y][k];if(q>M&&(R[k]+=q-M),R[k]>100){E=!1;break}}if(!E)continue;const A=S|1<<y,l=c[A];for(let k=0;k<5;k++){let M=0;const q=n[k]??0;for(let N=0;N<o;N++){if((A&1<<N)===0||r[N][k]===0)continue;const f=r[N][k]+a[N][k]-(R[k]+l[k]+q);f>M&&(M=f)}if(M>0&&(R[k]+=M,R[k]>100)){E=!1;break}}if(!E)continue;const u=gt(R);if(u>s)continue;const g=m[A]??=[];pt(g,{assigned:R,assignedTotal:u})}}const h=m[d-1];if(!h||h.length===0)return{feasible:!1,assignedTotal:1/0,assignedByStat:null};let x=1/0,b=null;for(const S of h)S.assignedTotal<x&&(x=S.assignedTotal,b=[...S.assigned]);return{feasible:Number.isFinite(x),assignedTotal:x,assignedByStat:Number.isFinite(x)?b:null}}function Te(e,t,i,s={}){const n=[];for(const o of O){const r=e[o];if(r==null)continue;const a=t.itemsById.get(r);a&&n.push(a)}return ht(n,i,s)}const xt=[1,1,1,1,1],kt=4;function De(e,t){switch(e){case"guild_rainbow":return{extraBaseSkillPoints:xt};case"flexible_2":return{availableSkillPointsOverride:Be(t)+kt};default:return{}}}function St(e,t){const i={};for(const s of O){const n=e.slots[s];if(n==null)continue;const o=t.itemsById.get(n);o&&(i[s]=o)}return i}function ce(e,t,i={}){const s=St(e,t),n=structuredClone(it),o=n.warnings.messages;let r=null;for(const _ of O){const f=s[_];if(!f)continue;_==="weapon"&&(r=f.type),n.aggregated.hpTotal+=f.numeric.hp+f.numeric.hpBonus,n.aggregated.hprTotal+=f.numeric.hprRaw+f.numeric.hprPct,n.aggregated.mr+=f.numeric.mr,n.aggregated.ms+=f.numeric.ms,n.aggregated.ls+=f.numeric.ls,n.aggregated.speed+=f.numeric.spd,n.aggregated.skillPoints.str+=f.numeric.spStr,n.aggregated.skillPoints.dex+=f.numeric.spDex,n.aggregated.skillPoints.int+=f.numeric.spInt,n.aggregated.skillPoints.def+=f.numeric.spDef,n.aggregated.skillPoints.agi+=f.numeric.spAgi,n.aggregated.skillReqs.str=Math.max(n.aggregated.skillReqs.str,f.numeric.reqStr),n.aggregated.skillReqs.dex=Math.max(n.aggregated.skillReqs.dex,f.numeric.reqDex),n.aggregated.skillReqs.int=Math.max(n.aggregated.skillReqs.int,f.numeric.reqInt),n.aggregated.skillReqs.def=Math.max(n.aggregated.skillReqs.def,f.numeric.reqDef),n.aggregated.skillReqs.agi=Math.max(n.aggregated.skillReqs.agi,f.numeric.reqAgi),n.aggregated.defenses.e+=f.numeric.eDef,n.aggregated.defenses.t+=f.numeric.tDef,n.aggregated.defenses.w+=f.numeric.wDef,n.aggregated.defenses.f+=f.numeric.fDef,n.aggregated.defenses.a+=f.numeric.aDef,n.aggregated.offense.baseDps+=f.numeric.baseDps,n.aggregated.offense.spellPct+=f.numeric.sdPct,n.aggregated.offense.spellRaw+=f.numeric.sdRaw,n.aggregated.offense.meleePct+=f.numeric.mdPct,n.aggregated.offense.meleeRaw+=f.numeric.mdRaw,n.aggregated.offense.elemDamPct+=f.numeric.eDamPct+f.numeric.tDamPct+f.numeric.wDamPct+f.numeric.fDamPct+f.numeric.aDamPct,n.aggregated.offense.genericDamPct+=f.numeric.damPct+f.numeric.rDamPct+f.numeric.nDamPct,n.aggregated.offense.offenseScore+=f.roughScoreFields.offense;const T=f.classReq,H=!T||!e.characterClass||T===e.characterClass,G=f.level<=e.level,D=f.numeric.reqStr<=100&&f.numeric.reqDex<=100&&f.numeric.reqInt<=100&&f.numeric.reqDef<=100&&f.numeric.reqAgi<=100;n.slotStatus[_]={classOk:H,levelOk:G,skillReqsMet:D}}!e.characterClass&&r&&(e.characterClass=nt(r));for(const _ of O){const f=s[_];f&&(Se(_)!==f.category&&o.push(`${_} contains incompatible item type (${f.type}).`),f.level>e.level&&o.push(`${f.displayName} requires level ${f.level}.`),e.characterClass&&f.classReq&&f.classReq!==e.characterClass&&o.push(`${f.displayName} requires ${f.classReq}.`),(f.restricted||f.deprecated)&&o.push(`${f.displayName} is restricted/deprecated.`))}const a=n.aggregated.skillReqs.str+n.aggregated.skillReqs.dex+n.aggregated.skillReqs.int+n.aggregated.skillReqs.def+n.aggregated.skillReqs.agi,d=n.aggregated.skillPoints.str+n.aggregated.skillPoints.dex+n.aggregated.skillPoints.int+n.aggregated.skillPoints.def+n.aggregated.skillPoints.agi,c=i.skillpointFeasibility??(i.skillpointTomeMode?De(i.skillpointTomeMode,e.level):void 0),m=Te(e.slots,t,e.level,c),{spellPct:h,spellRaw:x,meleePct:b,meleeRaw:S,baseDps:B,elemDamPct:w,genericDamPct:$}=n.aggregated.offense,y=n.aggregated.skillPoints,E=1+ye(y.str),A=(B*(1+(h+w+$)/100)+x)*E,l=(B*(1+(b+w+$)/100)+S)*E,u=l+A+n.aggregated.speed*.8,g=n.aggregated.defenses.e+n.aggregated.defenses.t+n.aggregated.defenses.w+n.aggregated.defenses.f+n.aggregated.defenses.a,k=n.aggregated.hpTotal+g*.45+n.aggregated.hprTotal*2+Math.max(0,n.aggregated.skillPoints.def)*12+Math.max(0,n.aggregated.skillPoints.agi)*10,M=n.aggregated.offense.baseDps,q=lt(e.level)+n.aggregated.hpTotal,N=dt({totalHp:q,defSkillPoints:n.aggregated.skillPoints.def,agiSkillPoints:n.aggregated.skillPoints.agi,weaponType:r});return n.derived={dpsProxy:u,spellProxy:A,meleeProxy:l,ehpProxy:k,reqTotal:a,skillPointTotal:d,legacyBaseDps:M,legacyEhp:N.withAgi,legacyEhpNoAgi:N.noAgi,skillpointFeasible:m.feasible,assignedSkillPointsRequired:Number.isFinite(m.assignedTotal)?m.assignedTotal:0},m.feasible||o.push(`Skill requirements are not satisfiable at level ${e.level} (estimated assigned SP exceeds available or equip order is invalid).`),n}function Ee(e,t,i,s){if(!e.length||s<=0)return[];const n=[...e].sort((r,a)=>a.roughScore-r.roughScore).slice(0,s),o=[];for(const r of n){const a=ce({slots:r.slots,level:i.level,characterClass:i.characterClass},t),{score:d,breakdown:c}=le(a,i.weights,i);o.push({slots:{...r.slots},score:d,scoreBreakdown:c,summary:a})}return o}function yt(e,t){const i=new Map;for(const s of O){const n=e[s];if(n==null)continue;const o=t.itemSetName.get(n);o&&i.set(o,(i.get(o)??0)+1)}return i}function de(e,t,i){const s=i.itemSetName.get(e);if(!s)return!1;const n=i.setsMeta.get(s);if(!n)return!1;let o=0;for(const r of O){const a=t[r];a!=null&&i.itemSetName.get(a)===s&&o++}return n.illegalCounts.includes(o+1)}const $e=["str","dex","int","def","agi"],J=["SUPER_SLOW","VERY_SLOW","SLOW","NORMAL","FAST","VERY_FAST","SUPER_FAST"];function ue(e){return De(e.skillpointFeasibilityMode,e.level)}function Q(e){return Math.round(e.numeric.atkTier||0)}function be(e,t){switch(t){case"str":return Math.max(0,e.numeric.spStr);case"dex":return Math.max(0,e.numeric.spDex);case"int":return Math.max(0,e.numeric.spInt);case"def":return Math.max(0,e.numeric.spDef);case"agi":return Math.max(0,e.numeric.spAgi)}}function Tt(e,t){switch(t){case"str":return e.numeric.reqStr;case"dex":return e.numeric.reqDex;case"int":return e.numeric.reqInt;case"def":return e.numeric.reqDef;case"agi":return e.numeric.reqAgi}}function bt(e,t){if(t.length===0)return 0;let i=0;for(const s of t)i+=be(e,s)*10,i-=Math.max(0,Tt(e,s))*.7;return i-=Math.max(0,e.roughScoreFields.reqTotal)*.12,i}function U(e){return{...e}}function Pt(e,t){const i=e.weapon;if(i==null)return null;const s=t.itemsById.get(i);if(!s)return null;const n=J.indexOf(s.atkSpd);if(n<0)return null;let o=0;for(const a of O){const d=e[a];if(d==null)continue;const c=t.itemsById.get(d);c&&(o+=Q(c))}const r=Math.max(0,Math.min(J.length-1,n+o));return J[r]}function Pe(e,t){let i=0;for(const s of O){const n=e[s];if(n==null)continue;const o=t.itemsById.get(n);o&&(i+=Q(o))}return i}function Mt(e,t,i){if(i.weaponAttackSpeeds.length===0)return null;const s=e.weapon;if(s==null)return null;const n=t.itemsById.get(s);if(!n)return null;const o=J.indexOf(n.atkSpd);if(o<0)return null;const r=[...new Set(i.weaponAttackSpeeds.map(m=>J.indexOf(m)).filter(m=>m>=0))].sort((m,h)=>m-h);if(r.length===0)return null;const a=Pe(e,t),d=Math.max(0,Math.min(J.length-1,o+a));let c=0;if(!r.includes(d)){const m=r.reduce((h,x)=>Math.abs(x-d)<Math.abs(h-d)?x:h,r[0]);c=m>d?1:m<d?-1:0}return{baseSpeedIndex:o,fixedAtkTierTotal:a,allowedFinalIndices:r,allowedFinalIndexSet:new Set(r),preferredDirection:c}}function fe(e,t,i){const s=new Array(e.length+1).fill(0),n=new Array(e.length+1).fill(0);for(let o=e.length-1;o>=0;o--){const r=t.get(e[o])??[];let a=0,d=0;if(r.length>0){a=1/0,d=-1/0;for(const c of r){const m=i.itemsById.get(c.id),h=m?Q(m):0;h<a&&(a=h),h>d&&(d=h)}Number.isFinite(a)||(a=0),Number.isFinite(d)||(d=0)}s[o]=s[o+1]+a,n[o]=n[o+1]+d}return{minSuffix:s,maxSuffix:n}}function At(e,t,i,s){const n=e.fixedAtkTierTotal+t+i,o=e.fixedAtkTierTotal+t+s,r=Math.min(n,o),a=Math.max(n,o);for(let d=r;d<=a;d++){const c=Math.max(0,Math.min(J.length-1,e.baseSpeedIndex+d));if(e.allowedFinalIndexSet.has(c))return!0}return!1}function ee(e,t,i=0,s=0,n=1){if(!e||!e.preferredDirection)return 0;const o=e.fixedAtkTierTotal+(t??0),r=Math.max(0,Math.min(J.length-1,e.baseSpeedIndex+o+i)),a=Math.max(0,Math.min(J.length-1,e.baseSpeedIndex+o+s)),d=Math.min(r,a),c=Math.max(r,a);let m=1/0,h=0;for(let b=d;b<=c;b++){let S=1/0;for(const B of e.allowedFinalIndices){const w=Math.abs(B-b);w<S&&(S=w)}S<m&&(m=S),S>h&&(h=S)}if(!Number.isFinite(m)||h===0)return 0;const x=e.preferredDirection>0?d:-c;return(-h*1e3-m*100+x)*n}function It(e,t,i,s){const{target:n}=t,o=ge(t,{includeAttackTier:!1}),r=[];if(typeof n.minLegacyBaseDps=="number"&&e.derived.legacyBaseDps<n.minLegacyBaseDps&&r.push(`minLegacyBaseDps (${e.derived.legacyBaseDps} < ${n.minLegacyBaseDps})`),typeof n.minLegacyEhp=="number"&&e.derived.legacyEhp<n.minLegacyEhp&&r.push(`minLegacyEhp (${e.derived.legacyEhp} < ${n.minLegacyEhp})`),typeof n.minDpsProxy=="number"&&e.derived.dpsProxy<n.minDpsProxy&&r.push(`minDpsProxy (${e.derived.dpsProxy} < ${n.minDpsProxy})`),typeof n.minEhpProxy=="number"&&e.derived.ehpProxy<n.minEhpProxy&&r.push(`minEhpProxy (${e.derived.ehpProxy} < ${n.minEhpProxy})`),typeof n.minMr=="number"&&e.aggregated.mr<n.minMr&&r.push(`minMr (${e.aggregated.mr} < ${n.minMr})`),typeof n.minMs=="number"&&e.aggregated.ms<n.minMs&&r.push(`minMs (${e.aggregated.ms} < ${n.minMs})`),typeof n.minSpeed=="number"&&e.aggregated.speed<n.minSpeed&&r.push(`minSpeed (${e.aggregated.speed} < ${n.minSpeed})`),typeof n.minSkillPointTotal=="number"&&e.derived.skillPointTotal<n.minSkillPointTotal&&r.push(`minSkillPointTotal (${e.derived.skillPointTotal} < ${n.minSkillPointTotal})`),typeof n.maxReqTotal=="number"&&e.derived.reqTotal>n.maxReqTotal&&r.push(`maxReqTotal (${e.derived.reqTotal} > ${n.maxReqTotal})`),o.length>0&&i&&s)for(const a of o){const d=a.key;let c=0;for(const m of O){const h=i[m];if(h==null)continue;const x=s.itemsById.get(h);x&&(c+=x.numericIndex[d]??0)}typeof a.min=="number"&&c<a.min&&r.push(`${d} (${c} < ${a.min})`),typeof a.max=="number"&&c>a.max&&r.push(`${d} (${c} > ${a.max})`)}return r.length>0?{ok:!1,failedChecks:r}:{ok:!0}}function Me(e,t,i,s){const n=[...new Set(i.mustIncludeIds)];for(const d of n){let c=!1;for(const m of O)if(e[m]===d){c=!0;break}if(!c)return{ok:!1,reason:"item",failedChecks:[`mustIncludeMissing (${d})`]}}for(const d of O){const c=e[d];if(c==null)continue;const m=t.itemsById.get(c);if(!m)return{ok:!1,reason:"item"};if(!Ae(m,i))return{ok:!1,reason:"item"}}const o=yt(e,t);for(const[d,c]of o){const m=t.setsMeta.get(d);if(m&&m.illegalCounts.includes(c))return{ok:!1,reason:"item"}}const r=$t({constraints:i,slots:e,catalog:t,atkTierRequirement:Ve(He(i))});if(r.configured&&!r.ok)return{ok:!1,reason:"attackSpeed",failedChecks:r.failedChecks};const a=It(s,i,e,t);return a.ok?{ok:!0}:{ok:!1,reason:"thresholds",failedChecks:a.failedChecks}}function Ae(e,t){return!(!t.allowRestricted&&(e.restricted||e.deprecated)||e.level>t.level||!st(e,t.characterClass)||t.excludedIds.includes(e.id)||t.allowedTiers.length>0&&!t.allowedTiers.includes(e.tier)||t.minPowderSlots!=null&&e.powderSlots<t.minPowderSlots||t.excludedMajorIds.length>0&&t.excludedMajorIds.some(i=>e.majorIds.includes(i)))}const Z=2.5;function Fe(e,t){const i={...t};return typeof e.minLegacyBaseDps=="number"&&(i.legacyBaseDps=Math.max(i.legacyBaseDps,X.legacyBaseDps*Z)),typeof e.minLegacyEhp=="number"&&(i.legacyEhp=Math.max(i.legacyEhp,X.legacyEhp*Z)),typeof e.minDpsProxy=="number"&&(i.dpsProxy=Math.max(i.dpsProxy,X.dpsProxy*Z)),typeof e.minEhpProxy=="number"&&(i.ehpProxy=Math.max(i.ehpProxy,X.ehpProxy*Z)),(typeof e.minMr=="number"||typeof e.minMs=="number")&&(i.sustain=Math.max(i.sustain,X.sustain*Z)),typeof e.minSpeed=="number"&&(i.speed=Math.max(i.speed,X.speed*Z)),typeof e.minSkillPointTotal=="number"&&(i.skillPointTotal=Math.max(i.skillPointTotal,X.skillPointTotal*Z)),typeof e.maxReqTotal=="number"&&(i.reqTotalPenalty=Math.max(i.reqTotalPenalty,X.reqTotalPenalty*Z)),(e.customNumericRanges?.length??0)>0&&(i.sustain=Math.max(i.sustain,X.sustain*Z)),i}const vt=3,Ne=2,_e=14;function qt(e,t){const i=t.target.customNumericRanges??[];if(t.constraintOnlyMode){let c=0;for(const m of i){const h=m.key?.trim();if(!h)continue;const x=e.numericIndex[h]??0;typeof m.min=="number"&&(c+=x*_e),typeof m.max=="number"&&(c-=x*Ne)}return c-=e.roughScoreFields.reqTotal*.05,c}const s=i.some(c=>typeof c.min=="number"),n=i.filter(c=>typeof c.min=="number").length,o=s?Math.max(.15,1-n*.2):1,r=(t.weights.legacyEhp+t.weights.ehpProxy)*o;let a=e.numeric.baseDps*t.weights.legacyBaseDps*o+e.roughScoreFields.ehpProxy*r+e.roughScoreFields.offense*t.weights.dpsProxy*o+e.numeric.spd*t.weights.speed+e.roughScoreFields.utility*t.weights.sustain+e.roughScoreFields.skillPointTotal*t.weights.skillPointTotal-e.roughScoreFields.reqTotal*t.weights.reqTotalPenalty;const d=s?_e:vt;for(const c of i){const m=c.key?.trim();if(!m)continue;const h=e.numericIndex[m]??0;typeof c.min=="number"&&(a+=h*d),typeof c.max=="number"&&(a-=h*Ne)}return a}function se(e){const t=e.ring1??0,i=e.ring2??0,[s,n]=t<=i?[t,i]:[i,t];return[e.helmet??0,e.chestplate??0,e.leggings??0,e.boots??0,s,n,e.bracelet??0,e.necklace??0,e.weapon??0].join("|")}function Oe(e,t,i,s=.6){const n=Math.max(1,i),o=[],r=new Set,a=Math.max(1,Math.min(n,Math.round(n*s)));let d=0,c=0;const m=h=>{const x=`${h.orderIndex}|${se(h.slots)}`;return r.has(x)?!1:(r.add(x),o.push(h),!0)};for(;o.length<n&&(d<e.length||c<t.length);){if(o.length<a&&d<e.length){m(e[d]),d++;continue}if(c<t.length){m(t[c]),c++;continue}if(d<e.length){m(e[d]),d++;continue}break}return o}function je(e,t){return Se(t)===e.category}function wt(e,t,i){const s=U(e),n=[...new Set(i.mustIncludeIds)];for(const o of n){const r=t.itemsById.get(o);if(!r)return{slots:s,ok:!1,reasonCode:"must_include_conflict",detail:`Must-include item ${o} does not exist in catalog.`};if(!Ae(r,i))return{slots:s,ok:!1,reasonCode:"must_include_conflict",detail:`Must-include item ${r.displayName} is incompatible with current hard filters (class/level/tier/exclusions).`};if(O.some(m=>s[m]===r.id))continue;const c=O.filter(m=>s[m]==null&&je(r,m))[0];if(!c)return{slots:s,ok:!1,reasonCode:"must_include_conflict",detail:`No free ${r.category} slot available to place must-include item ${r.displayName}.`};s[c]=r.id}return{slots:s,ok:!0}}function Ct(e,t){const i={str:0,dex:0,int:0,def:0,agi:0};for(const n of O){const o=e[n];if(o==null)continue;const r=t.itemsById.get(o);r&&(i.str=Math.max(i.str,r.numeric.reqStr),i.dex=Math.max(i.dex,r.numeric.reqDex),i.int=Math.max(i.int,r.numeric.reqInt),i.def=Math.max(i.def,r.numeric.reqDef),i.agi=Math.max(i.agi,r.numeric.reqAgi))}const s=$e.filter(n=>i[n]>100).sort((n,o)=>i[o]-i[n]);return s.length>0?s:$e.filter(n=>i[n]>=70).sort((n,o)=>i[o]-i[n]).slice(0,2)}function Bt(e,t,i){if(i.length===0)return[];const s={str:0,dex:0,int:0,def:0,agi:0};for(const n of O){const o=e[n];if(o==null)continue;const r=t.itemsById.get(o);r&&(s.str=Math.max(s.str,r.numeric.reqStr),s.dex=Math.max(s.dex,r.numeric.reqDex),s.int=Math.max(s.int,r.numeric.reqInt),s.def=Math.max(s.def,r.numeric.reqDef),s.agi=Math.max(s.agi,r.numeric.reqAgi))}return i.map(n=>Math.max(0,s[n]-100))}function Le(e,t){return t.map(i=>be(e,i))}function re(e,t){if(e.length===0)return t.slice();const i=new Array(e.length);for(let s=0;s<e.length;s++)i[s]=(e[s]??0)+(t[s]??0);return i}function Rt(e,t,i){for(let s=0;s<i.length;s++)if((e[s]??0)+(t[s]??0)<i[s])return!1;return!0}function ze(e,t){let i=0;for(let s=0;s<t.length;s++)i+=Math.max(0,t[s]-(e[s]??0));return i}function me(e,t){if(!e||t.length===0)return 0;let i=0;for(let s=0;s<t.length;s++){const n=e[s]??0,o=t[s];typeof o.min=="number"&&n<o.min&&(i+=o.min-n),typeof o.max=="number"&&n>o.max&&(i+=n-o.max)}return i}function We(e,t,i,s){if(s.length===0)return 0;const n=t.get(e)??[];let o=0;for(const r of n){const a=i.itemsById.get(r.id);if(!a)continue;let d=0;for(const c of s)d+=be(a,c);d>o&&(o=d)}return o}function ge(e,t={}){const i=t.includeAttackTier??!0;return(e.target.customNumericRanges??[]).map(s=>({key:(s.key??"").trim(),min:typeof s.min=="number"?s.min:void 0,max:typeof s.max=="number"?s.max:void 0})).filter(s=>s.key&&(typeof s.min=="number"||typeof s.max=="number")).filter(s=>i||s.key!=="atkTier")}function He(e){return ge(e,{includeAttackTier:!0}).filter(t=>t.key==="atkTier")}function Ie(e){const t=e.attackSpeedConstraintMode==="or"&&e.weaponAttackSpeeds.length>0;return ge(e,{includeAttackTier:!t})}function Ve(e){if(e.length===0)return{hasConstraint:!1,minAllowed:Number.NEGATIVE_INFINITY,maxAllowed:Number.POSITIVE_INFINITY,rows:[]};let t=Number.NEGATIVE_INFINITY,i=Number.POSITIVE_INFINITY;for(const s of e)typeof s.min=="number"&&(t=Math.max(t,s.min)),typeof s.max=="number"&&(i=Math.min(i,s.max));return{hasConstraint:!0,minAllowed:t,maxAllowed:i,rows:e}}function Dt(e,t){return t.hasConstraint?e>=t.minAllowed&&e<=t.maxAllowed:!1}function Et(e,t,i,s,n){if(!e.hasConstraint)return!1;const o=t+i+Math.min(s,n),r=t+i+Math.max(s,n);return o<=e.maxAllowed&&r>=e.minAllowed}function $t(e){const{constraints:t,slots:i,catalog:s,atkTierRequirement:n}=e,o=t.weaponAttackSpeeds.length>0,r=n.hasConstraint;if(!o&&!r)return{configured:!1,ok:!0};const a=[];let d=!1;if(o){const x=Pt(i,s);d=!!(x&&t.weaponAttackSpeeds.includes(x)),d||a.push(`attackSpeed (expected ${t.weaponAttackSpeeds.join("/")} )`)}let c=!1;if(r){const x=Pe(i,s);if(c=Dt(x,n),!c){const b=Number.isFinite(n.minAllowed)?n.minAllowed:"-inf",S=Number.isFinite(n.maxAllowed)?n.maxAllowed:"+inf";a.push(`atkTier (${x} not in [${b}, ${S}])`)}}const m=t.attackSpeedConstraintMode;return(o&&r?m==="and"?d&&c:d||c:o?d:c)?{configured:!0,ok:!0}:{configured:!0,ok:!1,failedChecks:a}}function pe(e){const{constraints:t,attackSpeedCtx:i,atkTierRequirement:s,fixedAtkTierTotal:n,partialAssignedAtkTier:o,remainingMinAtkTier:r,remainingMaxAtkTier:a}=e,d=t.weaponAttackSpeeds.length>0,c=s.hasConstraint;if(!d&&!c)return!0;const m=d?i?At(i,o,r,a):!0:!1,h=c?Et(s,n,o,r,a):!1;return d&&c?t.attackSpeedConstraintMode==="and"?m&&h:m||h:d?m:h}function he(e,t,i){const s=t.itemsById.get(e.id);return s?s.numericIndex[i]??0:0}function xe(e,t,i){const s=i.map(()=>0);if(i.length===0)return s;for(const n of O){const o=e[n];if(o==null)continue;const r=t.itemsById.get(o);if(r)for(let a=0;a<i.length;a++)s[a]+=r.numericIndex[i[a]]??0}return s}function ve(e){const{slotOrder:t,candidatePools:i,catalog:s,keys:n}=e,o=Array.from({length:t.length+1},()=>n.map(()=>0)),r=Array.from({length:t.length+1},()=>n.map(()=>0));if(n.length===0)return{maxSuffix:o,minSuffix:r};for(let a=t.length-1;a>=0;a--){const d=i.get(t[a])??[],c=n.map(()=>Number.NEGATIVE_INFINITY),m=n.map(()=>Number.POSITIVE_INFINITY);for(const h of d){const x=s.itemsById.get(h.id);if(x)for(let b=0;b<n.length;b++){const S=x.numericIndex[n[b]]??0;S>c[b]&&(c[b]=S),S<m[b]&&(m[b]=S)}}for(let h=0;h<n.length;h++){const x=Number.isFinite(c[h])?c[h]:0,b=Number.isFinite(m[h])?m[h]:0;o[a][h]=o[a+1][h]+x,r[a][h]=r[a+1][h]+b}}return{maxSuffix:o,minSuffix:r}}function Ft(e,t,i,s,n=[]){const o=[],r=ge(i);for(const l of t.items)je(l,e)&&(s&&!s.has(l.id)||Ae(l,i)&&o.push({id:l.id,rough:qt(l,i),reqTotal:l.roughScoreFields.reqTotal,skillPointTotal:l.roughScoreFields.skillPointTotal,utility:l.roughScoreFields.utility+l.numeric.spd*.8,level:l.level,atkTier:Q(l),spStr:l.numeric.spStr,spDex:l.numeric.spDex,spInt:l.numeric.spInt,spDef:l.numeric.spDef,spAgi:l.numeric.spAgi,supportFocus:bt(l,n)}));const a=[...o].sort((l,u)=>l.rough!==u.rough?u.rough-l.rough:l.id-u.id),d=[...o].sort((l,u)=>l.reqTotal!==u.reqTotal?l.reqTotal-u.reqTotal:l.level!==u.level?l.level-u.level:l.id-u.id),c=[...o].sort((l,u)=>l.skillPointTotal!==u.skillPointTotal?u.skillPointTotal-l.skillPointTotal:l.reqTotal!==u.reqTotal?l.reqTotal-u.reqTotal:l.id-u.id),m=[...o].sort((l,u)=>l.utility!==u.utility?u.utility-l.utility:l.reqTotal!==u.reqTotal?l.reqTotal-u.reqTotal:l.id-u.id),h=i.weaponAttackSpeeds.length>0?[...o].sort((l,u)=>{const g=Math.max(0,l.atkTier),k=Math.max(0,u.atkTier);return g!==k?k-g:l.atkTier!==u.atkTier?u.atkTier-l.atkTier:l.reqTotal!==u.reqTotal?l.reqTotal-u.reqTotal:l.skillPointTotal!==u.skillPointTotal?u.skillPointTotal-l.skillPointTotal:l.id-u.id}):[],x=n.length>0?[...o].sort((l,u)=>l.supportFocus!==u.supportFocus?u.supportFocus-l.supportFocus:l.reqTotal!==u.reqTotal?l.reqTotal-u.reqTotal:l.skillPointTotal!==u.skillPointTotal?u.skillPointTotal-l.skillPointTotal:l.id-u.id):[],b=n.map(l=>[...o].sort((u,g)=>{const k=l==="str"?u.spStr:l==="dex"?u.spDex:l==="int"?u.spInt:l==="def"?u.spDef:u.spAgi,M=l==="str"?g.spStr:l==="dex"?g.spDex:l==="int"?g.spInt:l==="def"?g.spDef:g.spAgi;return k!==M?M-k:u.reqTotal!==g.reqTotal?u.reqTotal-g.reqTotal:u.supportFocus!==g.supportFocus?g.supportFocus-u.supportFocus:u.id-g.id})),S=r.filter(l=>typeof l.min=="number").map(l=>[...o].sort((u,g)=>{const k=he(u,t,l.key),M=he(g,t,l.key);return k!==M?M-k:u.reqTotal!==g.reqTotal?u.reqTotal-g.reqTotal:u.skillPointTotal!==g.skillPointTotal?g.skillPointTotal-u.skillPointTotal:u.id-g.id})),B=r.filter(l=>typeof l.max=="number").map(l=>[...o].sort((u,g)=>{const k=he(u,t,l.key),M=he(g,t,l.key);return k!==M?k-M:u.reqTotal!==g.reqTotal?u.reqTotal-g.reqTotal:u.skillPointTotal!==g.skillPointTotal?g.skillPointTotal-u.skillPointTotal:u.id-g.id})),w=Math.max(10,i.topKPerSlot),$=Math.min(140,Math.max(40,Math.floor(w*.8))),y=Math.min(o.length,w+$+(n.length>0?Math.min(60,n.length*12):0)+Math.min(80,r.length*14)),R=new Map,E=Math.min(12,Math.floor(w*.4),a.length);for(let l=0;l<E;l++){const u=a[l];R.set(u.id,{id:u.id,rough:u.rough})}const A=[{list:a,remaining:Math.max(0,w-E),cursor:0},{list:d,remaining:Math.floor($*.28),cursor:0},{list:c,remaining:Math.floor($*.24),cursor:0},{list:m,remaining:Math.floor($*.18),cursor:0}];h.length>0&&A.push({list:h,remaining:Math.max(18,Math.floor($*.22)),cursor:0}),x.length>0&&A.push({list:x,remaining:Math.max(16,Math.floor($*.2)),cursor:0});for(const l of b)A.push({list:l,remaining:10,cursor:0});for(const l of S)A.push({list:l,remaining:35,cursor:0});for(const l of B)A.push({list:l,remaining:20,cursor:0});for(;R.size<y;){let l=!1;for(const u of A)if(!(u.remaining<=0))for(;u.cursor<u.list.length;){const g=u.list[u.cursor++];if(!R.has(g.id)){R.set(g.id,{id:g.id,rough:g.rough}),u.remaining--,l=!0;break}}if(!l)break}if(R.size<y)for(const l of a){if(R.size>=y)break;R.has(l.id)||R.set(l.id,{id:l.id,rough:l.rough})}return[...R.values()]}function Nt(e){const t={};for(const i of O){const s=Se(i),n=new Set(e.binsByCategory[s]??[]),o=e.slots[i];o!=null&&n.add(o),t[i]=n}return t}function qe(e,t,i){if(i.length===0)return!0;const s=new Set;for(const n of O){const o=e[n];if(o==null)continue;const r=t.itemsById.get(o);if(r)for(const a of r.majorIds)i.includes(a)&&s.add(a)}return i.every(n=>s.has(n))}function Ue(e,t){const i=new Array(e.length+1).fill(0);for(let s=e.length-1;s>=0;s--){const n=e[s],o=t.get(n)??[];let r=0;for(const a of o)a.rough>r&&(r=a.rough);i[s]=i[s+1]+r}return i}function Ge(e){const{poolSize:t,beamSize:i,remainingStages:s,processedStates:n,maxStates:o}=e;if(t<=0)return 0;const r=Math.max(0,o-n),a=Math.max(1,i*Math.max(1,s)),d=Math.floor(r/a),c=Math.max(8,Math.min(96,d));return Math.min(t,c)}function _t(e,t,i){let s=1;for(const n of e){const o=t.get(n)?.length??0;if(o===0)return 0;if(s*=o,s>i)return s}return s}function Ye(e){const{beam:t,catalog:i,constraints:s,skillpointFeasibilityOptions:n,signal:o}=e,r=n??ue(s),a=[],d=new Set,c={majorIds:0,spInvalid:0,duplicate:0,hardConstraints:0,hardAttackSpeed:0,hardThresholds:0,hardItem:0,thresholdFailureExample:void 0};for(const m of t){if(o?.aborted)throw new DOMException("Auto build cancelled","AbortError");if(!qe(m.slots,i,s.requiredMajorIds)){c.majorIds++;continue}const h=ce({slots:m.slots,level:s.level,characterClass:s.characterClass},i,{skillpointFeasibility:r});if(!h.derived.skillpointFeasible){c.spInvalid++;continue}const x=Me(m.slots,i,s,h);if(!x.ok){c.hardConstraints++,x.reason==="attackSpeed"?c.hardAttackSpeed++:x.reason==="thresholds"?(c.hardThresholds++,c.thresholdFailureExample===void 0&&x.failedChecks?.length&&(c.thresholdFailureExample=x.failedChecks[0])):c.hardItem++;continue}const b=se(m.slots);if(d.has(b)){c.duplicate++;continue}const{score:S,breakdown:B}=le(h,s.weights,s);d.add(b),a.push({slots:U(m.slots),score:S,scoreBreakdown:B,summary:h})}return a.sort((m,h)=>{if(m.score!==h.score)return h.score-m.score;for(const x of O){const b=m.slots[x]??0,S=h.slots[x]??0;if(b!==S)return b-S}return 0}),{candidates:a,rejectStats:c}}function Ot(e){const{slotOrder:t,candidatePools:i,baseSlots:s,catalog:n,constraints:o,focusStats:r,attackSpeedCtx:a,atkTierRequirement:d,fixedAtkTierTotal:c,onProgress:m,signal:h}=e,x=ue(o),b=Ue(t,i),S=a||d.hasConstraint?fe(t,i,n):null,B=Bt(s,n,r),w=Array.from({length:t.length+1},()=>r.map(()=>0));for(let g=t.length-1;g>=0;g--){const k=i.get(t[g])??[],M=r.map(()=>0);for(const q of k){const N=n.itemsById.get(q.id);if(!N)continue;const _=Le(N,r);for(let f=0;f<_.length;f++)_[f]>M[f]&&(M[f]=_[f])}w[g]=re(w[g+1],M)}const $=Ie(o),y=$.map(g=>g.key),R=ve({slotOrder:t,candidatePools:i,catalog:n,keys:y}),E=xe(s,n,y);let A=[{slots:U(s),orderIndex:0,roughScore:0,optimisticBound:b[0],feasibilityAssigned:0,focusSupport:r.map(()=>0),atkTierAssigned:0,customTotals:E}],l=0,u=!1;for(let g=0;g<t.length;g++){if(h?.aborted)throw new DOMException("Auto build cancelled","AbortError");const k=t[g],M=i.get(k)??[],q=[],N=Ge({poolSize:M.length,beamSize:A.length,remainingStages:t.length-g,processedStates:l,maxStates:o.maxStates});N<=0&&(u=!0);for(const D of A){let p=0;for(const I of M){if(p>=N)break;if(l>=o.maxStates){u=!0;break}if(l++,p++,de(I.id,D.slots,n))continue;const C=U(D.slots);C[k]=I.id;const P=n.itemsById.get(I.id),v=(D.atkTierAssigned??0)+(P?Q(P):0),L=re(D.focusSupport??r.map(()=>0),P?Le(P,r):r.map(()=>0)),W=y.length>0?re(D.customTotals??y.map(()=>0),y.map(V=>P?P.numericIndex[V]??0:0)):void 0;if(S&&!pe({constraints:o,attackSpeedCtx:a??null,atkTierRequirement:d,fixedAtkTierTotal:c,partialAssignedAtkTier:v,remainingMinAtkTier:S.minSuffix[g+1],remainingMaxAtkTier:S.maxSuffix[g+1]})||r.length>0&&!Rt(L,w[g+1],B))continue;if($.length>0&&W){let V=!0;for(let F=0;F<$.length;F++){const j=$[F],z=W[F];if(typeof j.min=="number"&&z+R.maxSuffix[g+1][F]<j.min){V=!1;break}if(typeof j.max=="number"&&z+R.minSuffix[g+1][F]>j.max){V=!1;break}}if(!V)continue}const Y=Te(C,n,o.level,x),K=D.roughScore+I.rough;q.push({slots:C,orderIndex:g+1,roughScore:K,optimisticBound:K+b[g+1],feasibilityAssigned:Y.feasible?Y.assignedTotal:1/0,focusSupport:L,atkTierAssigned:v,customTotals:W})}if(u)break}if(q.length===0)return m?.({phase:"diagnostics",processedStates:l,beamSize:A.length,totalSlots:t.length,expandedSlots:g,reasonCode:"search_pruned",detail:u?`Feasibility-first search exhausted state budget before completing slot ${k}.`:`Feasibility-first search found no branches that can still satisfy high-skill requirements by slot ${k}.`}),{beam:[],processedStates:l,stateBudgetHit:u};const _=S?S.minSuffix[g+1]:0,f=S?S.maxSuffix[g+1]:0,T=o.constraintOnlyMode?10:1,H=[...q].sort((D,p)=>{if(a){const P=ee(a,D.atkTierAssigned,_,f,T),v=ee(a,p.atkTierAssigned,_,f,T);if(P!==v)return v-P}if(r.length>0){const P=ze(D.focusSupport??[],B),v=ze(p.focusSupport??[],B);if(P!==v)return P-v}const I=D.feasibilityAssigned??1/0,C=p.feasibilityAssigned??1/0;return I!==C?I-C:D.optimisticBound!==p.optimisticBound?p.optimisticBound-D.optimisticBound:D.roughScore!==p.roughScore?p.roughScore-D.roughScore:0}),G=[...q].sort((D,p)=>{const I=me(D.customTotals,$),C=me(p.customTotals,$);if(I!==C)return I-C;if(a){const P=ee(a,D.atkTierAssigned,_,f,T),v=ee(a,p.atkTierAssigned,_,f,T);if(P!==v)return v-P}return p.optimisticBound-D.optimisticBound});A=Oe(H,G,Math.max(40,o.beamWidth)),m?.({phase:"beam-search",processedStates:l,beamSize:A.length,totalSlots:t.length,expandedSlots:g+1,detail:`feasibility-first | branchCap=${N}${r.length>0?` | focus=${r.join("/")}`:""}${a?` | atkSpeed=${o.weaponAttackSpeeds.join("/")}`:""}`,previewCandidates:Ee(A,n,o,2)})}return{beam:A,processedStates:l,stateBudgetHit:u}}function jt(e){const{slotOrder:t,candidatePools:i,baseSlots:s,catalog:n,constraints:o,signal:r,onProgress:a}=e,d=ue(o),c=[],m=new Set;let h=0,x=0,b=0,S=0,B=0,w=0,$=0,y=0;const R=(E,A)=>{if(r?.aborted)throw new DOMException("Auto build cancelled","AbortError");if(h>o.maxStates)return;if(E>=t.length){if(!qe(A,n,o.requiredMajorIds)){x++;return}const g=ce({slots:A,level:o.level,characterClass:o.characterClass},n,{skillpointFeasibility:d});if(!g.derived.skillpointFeasible){b++;return}const k=Me(A,n,o,g);if(!k.ok){B++,k.reason==="attackSpeed"?w++:k.reason==="thresholds"?$++:y++;return}const M=se(A);if(m.has(M)){S++;return}m.add(M);const{score:q,breakdown:N}=le(g,o.weights,o);c.push({slots:U(A),score:q,scoreBreakdown:N,summary:g});return}const l=t[E],u=i.get(l)??[];for(const g of u){if(h++,h>o.maxStates)break;de(g.id,A,n)||(A[l]=g.id,h%2e3===0&&a?.({phase:"exact-search",processedStates:h,beamSize:0,totalSlots:t.length,expandedSlots:E+1}),R(E+1,A))}A[l]=null};return R(0,U(s)),a?.({phase:"diagnostics",processedStates:h,beamSize:0,totalSlots:t.length,expandedSlots:t.length,detail:c.length>0?`Exact search produced ${c.length} valid builds. Rejected duplicates=${S}, SP-invalid=${b}, majorID=${x}, hard=${B} (speed=${w}, thresholds=${$}, item=${y}).`:`Exact search produced 0 valid builds. Rejected SP-invalid=${b}, majorID=${x}, duplicates=${S}, hard=${B} (speed=${w}, thresholds=${$}, item=${y}).`}),c.sort((E,A)=>{if(E.score!==A.score)return A.score-E.score;for(const l of O){const u=E.slots[l]??0,g=A.slots[l]??0;if(u!==g)return u-g}return 0}),c.slice(0,Math.max(1,o.topN))}function Lt(e){const{slotOrder:t,candidatePools:i,baseSlots:s,catalog:n,constraints:o,attackSpeedCtx:r,atkTierRequirement:a,fixedAtkTierTotal:d,customSpecs:c,customBounds:m,signal:h,timeCapMs:x=2e3}=e,b=ue(o),S=new Map;for(const g of t){const k=i.get(g)??[];S.set(g,[...k].sort((M,q)=>M.rough!==q.rough?q.rough-M.rough:M.id-q.id))}const B=r||a.hasConstraint?fe(t,i,n):null,w=c.map(g=>g.key),$=xe(s,n,w),y=Date.now();let R=!1,E=0;const A=new Set,l=[],u=(g,k,M,q)=>{if(R)return;if(h?.aborted)throw new DOMException("Auto build cancelled","AbortError");if(Date.now()-y>=x){R=!0;return}if(l.length>=Math.max(1,o.topN))return;if(g>=t.length){if(!qe(k,n,o.requiredMajorIds))return;const f=ce({slots:k,level:o.level,characterClass:o.characterClass},n,{skillpointFeasibility:b});if(!f.derived.skillpointFeasible||!Me(k,n,o,f).ok)return;const H=se(k);if(A.has(H))return;A.add(H);const{score:G,breakdown:D}=le(f,o.weights,o);l.push({slots:U(k),score:G,scoreBreakdown:D,summary:f});return}const N=t[g],_=S.get(N)??[];for(const f of _){if(R)break;if(E++,de(f.id,k,n))continue;const T=U(k);T[N]=f.id;const H=n.itemsById.get(f.id),G=M+(H?Q(H):0);if(B&&!pe({constraints:o,attackSpeedCtx:r,atkTierRequirement:a,fixedAtkTierTotal:d,partialAssignedAtkTier:G,remainingMinAtkTier:B.minSuffix[g+1],remainingMaxAtkTier:B.maxSuffix[g+1]}))continue;const D=w.length>0?re(q??w.map(()=>0),w.map(I=>H?H.numericIndex[I]??0:0)):void 0;if(c.length>0&&D){let I=!0;for(let C=0;C<c.length;C++){const P=c[C],v=D[C];if(typeof P.min=="number"&&v+m.maxSuffix[g+1][C]<P.min){I=!1;break}if(typeof P.max=="number"&&v+m.minSuffix[g+1][C]>P.max){I=!1;break}}if(!I)continue}Te(T,n,o.level,b).feasible&&u(g+1,T,G,D)}};return u(0,U(s),0,$),l.sort((g,k)=>g.score!==k.score?k.score-g.score:se(g.slots).localeCompare(se(k.slots))),{candidates:l.slice(0,Math.max(1,o.topN)),processedStates:E,timedOut:R}}function Ke(e){const{catalog:t,baseWorkbench:i,constraints:s,onProgress:n,signal:o,alreadyThresholdRescue:r}=e;if(o?.aborted)throw new DOMException("Auto build cancelled","AbortError");let a=U(i.slots);for(const p of O)s.lockedSlots[p]||(a[p]=null);const d=wt(a,t,s);if(!d.ok)return n?.({phase:"diagnostics",processedStates:0,beamSize:0,totalSlots:0,expandedSlots:0,reasonCode:d.reasonCode??"must_include_conflict",detail:d.detail??"Must-include assignment failed before search started."}),[];a=d.slots;const c=Ct(a,t),m=O.filter(p=>a[p]==null),h=s.onlyPinnedItems?Nt(i):null,x=new Map;for(const p of m)x.set(p,Ft(p,t,s,h?.[p]??null,c));const b=Mt(a,t,s),S=Ve(He(s)),B=Pe(a,t),w=Ie(s),$=w.some(p=>typeof p.min=="number"),y=[...m].sort((p,I)=>{if(b?.preferredDirection){const v=x.get(p)??[],L=x.get(I)??[],W=v.reduce((K,V)=>{const F=t.itemsById.get(V.id);if(!F)return K;const j=Q(F),z=b.preferredDirection>0?Math.max(0,j):Math.max(0,-j);return Math.max(K,z)},0),Y=L.reduce((K,V)=>{const F=t.itemsById.get(V.id);if(!F)return K;const j=Q(F),z=b.preferredDirection>0?Math.max(0,j):Math.max(0,-j);return Math.max(K,z)},0);if(W!==Y)return Y-W}if(c.length>0){const v=We(p,x,t,c),L=We(I,x,t,c);if(v!==L)return L-v}if($){const v=["ring1","ring2","bracelet","necklace"],L=v.includes(p),W=v.includes(I);if(L!==W)return L?-1:1}const C=x.get(p)?.length??0,P=x.get(I)?.length??0;return C!==P?C-P:p.localeCompare(I)}),R=Ue(y,x);if(y.some(p=>(x.get(p)?.length??0)===0)){const p=y.find(I=>(x.get(I)?.length??0)===0);return n?.({phase:"diagnostics",processedStates:0,beamSize:0,totalSlots:y.length,expandedSlots:0,reasonCode:"empty_pool",detail:p?`No candidate items available for slot ${p} under current hard filters.`:"One or more slots have empty candidate pools."}),[]}if(S.hasConstraint&&S.minAllowed>S.maxAllowed)return n?.({phase:"diagnostics",processedStates:0,beamSize:0,totalSlots:y.length,expandedSlots:0,reasonCode:"unsat_attack_target",detail:`Attack target is unsatisfiable: atkTier min (${S.minAllowed}) exceeds atkTier max (${S.maxAllowed}).`}),[];if(w.length>0){const p=w.map(P=>P.key),I=ve({slotOrder:y,candidatePools:x,catalog:t,keys:p}),C=xe(a,t,p);for(let P=0;P<w.length;P++){const v=w[P],L=C[P]+I.minSuffix[0][P],W=C[P]+I.maxSuffix[0][P];if(typeof v.min=="number"&&W<v.min)return n?.({phase:"diagnostics",processedStates:0,beamSize:0,totalSlots:y.length,expandedSlots:0,reasonCode:"unsat_threshold",detail:`Unsatisfiable threshold: ${v.key} min ${v.min} is above maximum reachable total ${W}.`}),[];if(typeof v.max=="number"&&L>v.max)return n?.({phase:"diagnostics",processedStates:0,beamSize:0,totalSlots:y.length,expandedSlots:0,reasonCode:"unsat_threshold",detail:`Unsatisfiable threshold: ${v.key} max ${v.max} is below minimum reachable total ${L}.`}),[]}}const E=b||S.hasConstraint?fe(y,x,t):null;if(E&&!pe({constraints:s,attackSpeedCtx:b??null,atkTierRequirement:S,fixedAtkTierTotal:B,partialAssignedAtkTier:0,remainingMinAtkTier:E.minSuffix[0],remainingMaxAtkTier:E.maxSuffix[0]}))return n?.({phase:"diagnostics",processedStates:0,beamSize:0,totalSlots:y.length,expandedSlots:0,reasonCode:"unsat_attack_target",detail:"Attack-speed / atkTier target cannot be reached from current candidate pools."}),[];const A=_t(y,x,s.exhaustiveStateLimit+1);if(s.useExhaustiveSmallPool&&y.length>0&&A>0&&A<=s.exhaustiveStateLimit){n?.({phase:"exact-search",processedStates:0,beamSize:0,totalSlots:y.length,expandedSlots:0});const p={...s,maxStates:Math.max(s.maxStates,s.exhaustiveStateLimit)};return jt({slotOrder:y,candidatePools:x,baseSlots:a,catalog:t,constraints:p,signal:o,onProgress:n})}const l=Ie(s),u=l.map(p=>p.key),g=ve({slotOrder:y,candidatePools:x,catalog:t,keys:u});let k=[{slots:a,orderIndex:0,roughScore:0,optimisticBound:R[0],atkTierAssigned:0,customTotals:xe(a,t,u)}];const M=b||S.hasConstraint?fe(y,x,t):null;let q=0,N=!1;for(let p=0;p<y.length;p++){if(o?.aborted)throw new DOMException("Auto build cancelled","AbortError");const I=y[p],C=x.get(I),P=[],v=Ge({poolSize:C.length,beamSize:k.length,remainingStages:y.length-p,processedStates:q,maxStates:s.maxStates});v<=0&&(N=!0);for(const F of k){let j=0;for(const z of C){if(j>=v)break;if(q>=s.maxStates){N=!0;break}if(q++,j++,de(z.id,F.slots,t))continue;const te=U(F.slots);te[I]=z.id;const ae=F.roughScore+z.rough,ne=t.itemsById.get(z.id),Xe=(F.atkTierAssigned??0)+(ne?Q(ne):0),Ce=u.length>0?re(F.customTotals??u.map(()=>0),u.map(ie=>ne?ne.numericIndex[ie]??0:0)):void 0;if(!(M&&!pe({constraints:s,attackSpeedCtx:b??null,atkTierRequirement:S,fixedAtkTierTotal:B,partialAssignedAtkTier:Xe,remainingMinAtkTier:M.minSuffix[p+1],remainingMaxAtkTier:M.maxSuffix[p+1]}))){if(l.length>0&&Ce){let ie=!0;for(let oe=0;oe<l.length;oe++){const ke=l[oe],Je=Ce[oe];if(typeof ke.min=="number"&&Je+g.maxSuffix[p+1][oe]<ke.min){ie=!1;break}if(typeof ke.max=="number"&&Je+g.minSuffix[p+1][oe]>ke.max){ie=!1;break}}if(!ie)continue}P.push({slots:te,orderIndex:p+1,roughScore:ae,optimisticBound:ae+R[p+1],atkTierAssigned:Xe,customTotals:Ce})}}if(N)break}if(P.length===0)return n?.({phase:"diagnostics",processedStates:q,beamSize:k.length,totalSlots:y.length,expandedSlots:p,reasonCode:"search_pruned",detail:N?`Search state budget exhausted before completing slot ${I}. Try enabling deep fallback/exact mode or reduce hard filters.`:`No expansions produced at slot ${I}.`}),[];const L=M?M.minSuffix[p+1]:0,W=M?M.maxSuffix[p+1]:0,Y=s.constraintOnlyMode?10:1,K=[...P].sort((F,j)=>{if(b){const z=ee(b,F.atkTierAssigned,L,W,Y),te=ee(b,j.atkTierAssigned,L,W,Y);if(z!==te)return te-z}return F.optimisticBound!==j.optimisticBound?j.optimisticBound-F.optimisticBound:j.roughScore-F.roughScore}),V=[...P].sort((F,j)=>{const z=me(F.customTotals,l),te=me(j.customTotals,l);if(z!==te)return z-te;if(b){const ae=ee(b,F.atkTierAssigned,L,W,Y),ne=ee(b,j.atkTierAssigned,L,W,Y);if(ae!==ne)return ne-ae}return j.optimisticBound-F.optimisticBound});k=Oe(K,V,Math.max(20,s.beamWidth)),n?.({phase:"beam-search",processedStates:q,beamSize:k.length,totalSlots:y.length,expandedSlots:p+1,detail:`branchCap=${v}${b?.preferredDirection?` | atkSpeedTarget=${s.weaponAttackSpeeds.join("/")}`:""}`,previewCandidates:Ee(k,t,s,2)})}let _=k,{candidates:f,rejectStats:T}=Ye({beam:k,catalog:t,constraints:s,signal:o});const H=T.thresholdFailureExample?` Example failure: ${T.thresholdFailureExample}.`:"",G=f.length>0?void 0:T.spInvalid>0&&T.hardConstraints===0?"sp_infeasible":T.hardThresholds>0?"unsat_threshold":T.hardAttackSpeed>0?"unsat_attack_target":void 0;n?.({phase:"diagnostics",processedStates:q,beamSize:k.length,totalSlots:y.length,expandedSlots:y.length,reasonCode:G,detail:f.length>0?`Final eval: ${f.length} valid builds. Rejected duplicates=${T.duplicate}, SP-invalid=${T.spInvalid}, majorID=${T.majorIds}, hard=${T.hardConstraints}.`:`Final eval found 0 valid builds. Rejected SP-invalid=${T.spInvalid}, majorID=${T.majorIds}, duplicates=${T.duplicate}, hard=${T.hardConstraints} (speed=${T.hardAttackSpeed}, thresholds=${T.hardThresholds}, item=${T.hardItem}).${H}`});const D=s.weaponAttackSpeeds.length>0||S.hasConstraint;if(f.length===0&&y.length>0&&(T.spInvalid>0||D&&T.hardAttackSpeed>0||T.hardThresholds>0)){const p=T.hardThresholds>0;n?.({phase:"diagnostics",processedStates:q,beamSize:k.length,totalSlots:y.length,expandedSlots:y.length,detail:p&&s.target.customNumericRanges?.length?"Retrying with threshold-aware rescue (advanced ID constraints + support-aware feasibility search).":T.hardAttackSpeed>0?"Retrying with feasibility-first beam search (support-aware rescue + attack target reachability).":"Retrying with feasibility-first beam search (support-aware rescue for high-skill requirements)."});const I={...s,maxStates:Math.max(s.maxStates,p?Math.min(18e6,s.maxStates*5):D?Math.min(16e6,s.maxStates*4):Math.min(8e6,s.maxStates*2)),beamWidth:Math.max(s.beamWidth,p?3600:D?3200:1800)};p&&(I.weights=Fe(s.target,s.weights));const C=Ot({slotOrder:y,candidatePools:x,baseSlots:a,catalog:t,constraints:I,focusStats:c,attackSpeedCtx:b,atkTierRequirement:S,fixedAtkTierTotal:B,onProgress:n,signal:o});if(C.beam.length>0){_=C.beam;const P=Ye({beam:C.beam,catalog:t,constraints:s,signal:o});f=P.candidates,T=P.rejectStats;const v=T.thresholdFailureExample?` Example failure: ${T.thresholdFailureExample}.`:"";n?.({phase:"diagnostics",processedStates:C.processedStates,beamSize:C.beam.length,totalSlots:y.length,expandedSlots:y.length,detail:f.length>0?`Feasibility-first eval: ${f.length} valid builds. Rejected duplicates=${T.duplicate}, SP-invalid=${T.spInvalid}, majorID=${T.majorIds}, hard=${T.hardConstraints}.`:`Feasibility-first eval still found 0 valid builds. Rejected SP-invalid=${T.spInvalid}, majorID=${T.majorIds}, duplicates=${T.duplicate}, hard=${T.hardConstraints} (speed=${T.hardAttackSpeed}, thresholds=${T.hardThresholds}, item=${T.hardItem}).${v}`})}}if(f.length===0&&T.hardThresholds>0&&!r){const p=s.target;if(typeof p.minLegacyBaseDps=="number"||typeof p.minLegacyEhp=="number"||typeof p.minDpsProxy=="number"||typeof p.minEhpProxy=="number"||typeof p.minMr=="number"||typeof p.minMs=="number"||typeof p.minSpeed=="number"||typeof p.minSkillPointTotal=="number"||typeof p.maxReqTotal=="number"||(p.customNumericRanges?.length??0)>0){n?.({phase:"diagnostics",processedStates:q,beamSize:_.length,totalSlots:y.length,expandedSlots:y.length,detail:"Retrying with threshold-biased beam search (weights tuned to target min/max)."});const C={...s,weights:Fe(s.target,s.weights),beamWidth:Math.max(s.beamWidth,3600),maxStates:Math.max(s.maxStates,Math.min(18e6,s.maxStates*5))},P=Ke({catalog:t,baseWorkbench:i,constraints:C,onProgress:n,signal:o,alreadyThresholdRescue:!0});if(P.length>0)return n?.({phase:"diagnostics",processedStates:q,beamSize:P.length,totalSlots:y.length,expandedSlots:y.length,detail:`Threshold rescue: ${P.length} valid builds.`}),P.slice(0,Math.max(1,s.topN))}}if(f.length===0&&y.length>0){n?.({phase:"diagnostics",processedStates:q,beamSize:_.length,totalSlots:y.length,expandedSlots:y.length,reasonCode:"search_pruned",detail:"Running deterministic fallback search (2s cap) before returning no candidates."});const p=Lt({slotOrder:y,candidatePools:x,baseSlots:a,catalog:t,constraints:s,attackSpeedCtx:b??null,atkTierRequirement:S,fixedAtkTierTotal:B,customSpecs:l,customBounds:g,signal:o,timeCapMs:2e3});if(p.candidates.length>0)f=p.candidates,n?.({phase:"diagnostics",processedStates:q+p.processedStates,beamSize:p.candidates.length,totalSlots:y.length,expandedSlots:y.length,detail:`Deterministic fallback recovered ${p.candidates.length} valid build(s).`});else{const I=p.timedOut?"fallback_timeout":T.spInvalid>0&&T.hardConstraints===0?"sp_infeasible":T.hardThresholds>0?"unsat_threshold":T.hardAttackSpeed>0?"unsat_attack_target":"search_pruned";n?.({phase:"diagnostics",processedStates:q+p.processedStates,beamSize:0,totalSlots:y.length,expandedSlots:y.length,reasonCode:I,detail:p.timedOut?"Deterministic fallback timed out after 2 seconds with no valid candidates.":`Deterministic fallback found 0 valid builds. Rejected SP-invalid=${T.spInvalid}, majorID=${T.majorIds}, duplicates=${T.duplicate}, hard=${T.hardConstraints} (speed=${T.hardAttackSpeed}, thresholds=${T.hardThresholds}, item=${T.hardItem}).${T.thresholdFailureExample?` Example failure: ${T.thresholdFailureExample}.`:""}`})}}return f.slice(0,Math.max(1,s.topN))}const we=new Map;self.onmessage=e=>{const t=e.data;if(t.type==="cancel"){we.get(t.requestId)?.abort();return}const i=new AbortController;we.set(t.requestId,i);try{const s=Ke({catalog:{...t.catalog,itemsById:new Map(t.catalog.itemsById),itemIdByName:new Map(t.catalog.itemIdByName),itemsByType:new Map(t.catalog.itemsByType),itemsByCategory:new Map(t.catalog.itemsByCategory)},baseWorkbench:t.baseWorkbench,constraints:t.constraints,signal:i.signal,onProgress:o=>{const r={type:"progress",requestId:t.requestId,progress:o};self.postMessage(r)}}),n={type:"result",requestId:t.requestId,candidates:s};self.postMessage(n)}catch(s){const n={type:"error",requestId:t.requestId,message:s instanceof Error?s.message:"Auto builder worker error"};self.postMessage(n)}finally{we.delete(t.requestId)}}})();
