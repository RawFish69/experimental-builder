(function(){"use strict";const J=["helmet","chestplate","leggings","boots"],Q=["spear","wand","dagger","bow","relik"],Z=["ring","bracelet","necklace"],ee=["SLOW","NORMAL","FAST"];function $(e){const t=e.toLowerCase();return J.includes(t)?"armor":Q.includes(t)?"weapon":Z.includes(t)?"accessory":"consumable"}const B=4e3,j=[0,1,1.25,1.4],L=["e","t","w","f","a"],te=[{min:3,max:6,convert:17,defPlus:2,defMinus:1},{min:5,max:8,convert:21,defPlus:4,defMinus:2},{min:6,max:10,convert:25,defPlus:8,defMinus:3},{min:7,max:10,convert:31,defPlus:14,defMinus:5},{min:9,max:11,convert:38,defPlus:22,defMinus:9},{min:11,max:13,convert:46,defPlus:30,defMinus:13},{min:1,max:8,convert:9,defPlus:3,defMinus:1},{min:1,max:12,convert:11,defPlus:5,defMinus:1},{min:2,max:15,convert:13,defPlus:9,defMinus:2},{min:3,max:15,convert:17,defPlus:14,defMinus:4},{min:4,max:17,convert:22,defPlus:20,defMinus:7},{min:5,max:20,convert:28,defPlus:28,defMinus:10},{min:3,max:4,convert:13,defPlus:3,defMinus:1},{min:4,max:6,convert:15,defPlus:6,defMinus:1},{min:5,max:8,convert:17,defPlus:11,defMinus:2},{min:6,max:8,convert:21,defPlus:18,defMinus:4},{min:7,max:10,convert:26,defPlus:28,defMinus:7},{min:9,max:11,convert:32,defPlus:40,defMinus:10},{min:2,max:5,convert:14,defPlus:3,defMinus:1},{min:4,max:8,convert:16,defPlus:5,defMinus:2},{min:5,max:9,convert:19,defPlus:9,defMinus:3},{min:6,max:9,convert:24,defPlus:16,defMinus:5},{min:8,max:10,convert:30,defPlus:25,defMinus:9},{min:10,max:12,convert:37,defPlus:36,defMinus:13},{min:2,max:6,convert:11,defPlus:3,defMinus:1},{min:3,max:10,convert:14,defPlus:6,defMinus:2},{min:4,max:11,convert:17,defPlus:10,defMinus:3},{min:5,max:11,convert:22,defPlus:16,defMinus:5},{min:7,max:12,convert:28,defPlus:24,defMinus:9},{min:8,max:14,convert:35,defPlus:34,defMinus:13}];function ne(e){return e/6|0}function oe(e){return L[ne(e)]}function se(e){const t=[[100,100],[100,100],[100,100]];for(let o=0;o<6;o++){const i=e[o].posMods,s=Math.floor(o/2),a=o%2;if(i.above!==0)for(let n=s-1;n>=0;n--)t[n][a]+=i.above;if(i.under!==0)for(let n=s+1;n<3;n++)t[n][a]+=i.under;if(i.left!==0&&a===1&&(t[s][a-1]+=i.left),i.right!==0&&a===0&&(t[s][a+1]+=i.right),i.touching!==0)for(let n=0;n<3;n++)for(let c=0;c<2;c++)(Math.abs(n-s)===1&&c===a||n===s&&Math.abs(c-a)===1)&&(t[n][c]+=i.touching);if(i.notTouching!==0)for(let n=0;n<3;n++)for(let c=0;c<2;c++)(Math.abs(n-s)>1||Math.abs(n-s)===1&&Math.abs(c-a)===1)&&(t[n][c]+=i.notTouching)}return t.flat()}function K(e,t,o,r){const i=e.type.toLowerCase(),s=$(i);let a=!0;for(const f of o)if(f.id!==B){a=!1;break}let n=0,c=0;(s==="weapon"||s==="armor")&&(e.lvl[0]<30?n=1:e.lvl[0]<70?n=2:n=3),s==="consumable"&&(e.lvl[0]<30?c=1:e.lvl[0]<70?c=2:c=3,a&&(c=3));const h=e.materials.map(f=>f.amount),M=(j[t[0]]*h[0]+j[t[1]]*h[1])/(h[0]+h[1]);let u=[e.durability[0],e.durability[1]],d=[e.duration[0],e.duration[1]];s==="consumable"?(a&&(d=[e.basicDuration[0],e.basicDuration[1]]),d=[Math.round(d[0]*M),Math.round(d[1]*M)]):u=[Math.round(u[0]*M),Math.round(u[1]*M)];const m=e.healthOrDamage[0],b=e.healthOrDamage[1];let l=0,R=0,g="0-0",P="0-0";const v={e:0,t:0,w:0,f:0,a:0};if(s==="armor")l=Math.floor(b*M),R=Math.floor(m*M);else if(s==="weapon"){let f=2.05;r==="SLOW"?f/=1.5:r==="NORMAL"?f=1:r==="FAST"&&(f/=2.5);const p=Math.floor(Math.floor(m*M)*f),S=Math.floor(Math.floor(b*M)*f);P=`${Math.floor(p*.9)}-${Math.floor(p*1.1)}`,g=`${Math.floor(S*.9)}-${Math.floor(S*1.1)}`}else s==="consumable"&&a&&(l=Math.floor(b*M),R=Math.floor(m*M));if(s==="armor"||s==="accessory"){for(const f of o)if(f.isPowder&&f.pid!=null){const p=te[f.pid],S=oe(f.pid),T=L[(L.indexOf(S)+4)%5];v[S]=(v[S]||0)+p.defPlus,v[T]=(v[T]||0)-p.defMinus}}const w=se(o),k=[0,0,0,0,0],A={},C={};for(let f=0;f<6;f++){const p=o[f],S=w[f]/100,T=p.itemIDs;if(s!=="consumable"){const O=["strReq","dexReq","intReq","defReq","agiReq"];for(let I=0;I<O.length;I++){const q=T[O[I]];q!==0&&(p.isPowder?k[I]+=Math.round(q):k[I]+=Math.round(q*S))}}T.dura!==0&&(u[0]+=T.dura,u[1]+=T.dura),p.consumableIDs.dura!==0&&(d[0]+=p.consumableIDs.dura,d[1]+=p.consumableIDs.dura),p.consumableIDs.charges!==0&&(c+=p.consumableIDs.charges);for(const[O,I]of Object.entries(p.ids)){if(I.max===0&&I.min===0)continue;let q=I.min,N=I.max;const X=[Math.floor(q*S),Math.floor(N*S)].sort((ye,Se)=>ye-Se);q=X[0],N=X[1],C[O]=(C[O]??0)+q,A[O]=(A[O]??0)+N}}return u[0]=Math.max(1,Math.floor(u[0])),u[1]=Math.max(1,Math.floor(u[1])),a||(d[0]=Math.max(10,d[0]),d[1]=Math.max(10,d[1])),c=Math.max(c,s==="consumable"?1:0),{category:s,type:i,lvl:e.lvl[1],hp:l,hpLow:R,nDam:g,nDamLow:P,eDam:"0-0",tDam:"0-0",wDam:"0-0",fDam:"0-0",aDam:"0-0",eDef:v.e,tDef:v.t,wDef:v.w,fDef:v.f,aDef:v.a,atkSpd:r,durability:u,duration:d,charges:c,slots:n,reqs:[k[0],k[1],k[2],k[3],k[4]],effectiveness:w,maxRolls:A,minRolls:C}}function re(e,t,o,r,i){const s={SLOW:0,NORMAL:1,FAST:2},a=[];function n(u,d){for(let m=d-1;m>=0;m--)a.push(u>>m&1)}n(0,1),n(2,7);for(const u of e)n(u,12);n(t,12),n(o[0]-1,3),n(o[1]-1,3),i==="weapon"&&n(s[r]??0,4);const c=a.length%6;if(c!==0)for(let u=0;u<6-c;u++)a.push(0);const h="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz+-";let M="";for(let u=0;u<a.length;u+=6){let d=0;for(let m=0;m<6;m++)d=d<<1|(a[u+m]??0);M+=h[d]}return"CR-"+M}const F=["sdPct","sdRaw","mdPct","mdRaw","damPct","poison","fDamPct","wDamPct","aDamPct","tDamPct","eDamPct","spPct1","spRaw1","spPct2","spRaw2","spPct3","spRaw3","spPct4","spRaw4","rSdRaw","critDamPct"],Y=["hpBonus","hprRaw","hprPct","fDefPct","wDefPct","aDefPct","tDefPct","eDefPct"],W=["mr","ms","ls","spd","xpb","lb","ref","thorns","spRegen","eSteal","sprint","sprintReg","jh","lq","gXp","gSpd"],U=["str","dex","int","def","agi"];function H(e,t){let o=0;for(const r of t){const i=e.maxRolls[r]??0;i>0&&(o+=i)}return o}function ie(e,t){let o=0;for(const r of t)o+=e.maxRolls[r]??0;return o}function ae(e){let t=H(e,F);return e.category==="armor"&&(t+=e.hp*.02),t}function le(e){let t=H(e,Y);return e.category==="armor"&&(t+=e.hp*.15),t+=Math.max(0,e.eDef)+Math.max(0,e.tDef)+Math.max(0,e.wDef)+Math.max(0,e.fDef)+Math.max(0,e.aDef),t}function ce(e){let t=0;const o=e.maxRolls.mr??0,r=e.maxRolls.ms??0,i=e.maxRolls.ls??0,s=e.maxRolls.spd??0;t+=o*12+r*8+i*6+s*3;for(const a of W){if(a==="mr"||a==="ms"||a==="ls"||a==="spd")continue;const n=e.maxRolls[a]??0;n>0&&(t+=n)}return t}function fe(e){return ie(e,U)}function de(e){let t=0;for(const o of e.reqs)t+=Math.max(0,o);return t}function z(e,t){if(t==="durability")return[e.durability[0],e.durability[1]];if(t==="duration")return[e.duration[0],e.duration[1]];const o=e.maxRolls[t]??0;return[o,o]}function ue(e,t){let o=0;for(const[r,i]of Object.entries(t)){const[s,a]=z(e,r);if(typeof i.min=="number"&&s<i.min){const n=i.min-s;o+=n*200+n*n}if(typeof i.max=="number"&&a>i.max){const n=a-i.max;o+=n*200+n*n}}return o}function me(e,t){for(const[o,r]of Object.entries(t)){const[i,s]=z(e,o);if(typeof r.min=="number"&&i<r.min||typeof r.max=="number"&&s>r.max)return!1}return!0}function G(e,t,o){const r=ae(e)*t.offense,i=le(e)*t.defense,s=ce(e)*t.utility,a=fe(e)*t.skillPoints,n=de(e)*t.reqPenalty,c=ue(e,o.target),h={offense:r,defense:i,utility:s,skillPoints:a,reqPenalty:n,thresholdPenalty:c};return{score:r+i+s+a-n-c,breakdown:h}}function he(e,t,o){let r=0;for(const[s,a]of Object.entries(e.ids)){const n=a.max;F.includes(s)&&n>0?r+=n*t.offense:Y.includes(s)&&n>0?r+=n*t.defense:W.includes(s)?s==="mr"?r+=n*12*t.utility:s==="ms"?r+=n*8*t.utility:s==="ls"?r+=n*6*t.utility:s==="spd"?r+=n*3*t.utility:n>0&&(r+=n*t.utility):U.includes(s)&&(r+=n*t.skillPoints),o?.has(s)&&n>0&&(r+=n*50)}const i=Math.max(0,e.itemIDs.strReq)+Math.max(0,e.itemIDs.dexReq)+Math.max(0,e.itemIDs.intReq)+Math.max(0,e.itemIDs.defReq)+Math.max(0,e.itemIDs.agiReq);return r-=i*t.reqPenalty*.5,r}function pe(e,t,o){const r=e.recipesByType.get(t.toUpperCase());if(!r)return null;const i=`${t.charAt(0).toUpperCase()}${t.slice(1).toLowerCase()}-${o}`;return r.find(s=>s.name===i)??null}function Me(e,t,o){const r=t.skill.toUpperCase(),i=t.lvl[1],s=new Set(o.excludedIngredients),a=new Set(o.mustIncludeIngredients),n=new Set(Object.keys(o.target)),c=n.size>0,h=[];for(const l of e.ingredients)l.id===B||s.has(l.id)||!a.has(l.id)&&(!l.skills.some(P=>P.toUpperCase()===r)||l.lvl>i)||h.push(l);const M=h.map(l=>({ing:l,score:he(l,o.weights,c?n:void 0)}));M.sort((l,R)=>R.score-l.score);const u=o.topKPerSlot,d=new Set,m=[e.noIngredient];d.add(B);let b=0;for(const{ing:l}of M)a.has(l.id)&&!d.has(l.id)&&(d.add(l.id),m.push(l));for(const{ing:l}of M)if(!d.has(l.id)&&(d.add(l.id),m.push(l),b++,b>=u))break;if(c){const l=h.filter(g=>!d.has(g.id)).map(g=>{let P=0;for(const v of n){const w=g.ids[v]?.max??0;w>0&&(P+=w)}return{ing:g,tScore:P}}).filter(({tScore:g})=>g>0);l.sort((g,P)=>P.tScore-g.tScore);const R=Math.min(l.length,Math.max(30,Math.floor(u/2)));for(let g=0;g<R;g++){const{ing:P}=l[g];d.has(P.id)||(d.add(P.id),m.push(P))}}return m}function ge(e,t,o,r,i,s){const a=[];for(let h=0;h<6;h++)h<t.length?a.push(o.ingredientsById.get(t[h])??o.noIngredient):a.push(o.noIngredient);const n=K(e,i,a,s),{score:c}=G(n,r.weights,r);return c}function xe(e){const{catalog:t,constraints:o,signal:r,onProgress:i}=e,s=pe(t,o.recipeType,o.levelRange);if(!s)return[];const a=$(s.type.toLowerCase()),n=Me(t,s,o);if(n.length===0)return[];const c=o.matTiers?[o.matTiers]:[[1,1],[1,2],[1,3],[2,1],[2,2],[2,3],[3,1],[3,2],[3,3]],h=a==="weapon"?o.atkSpd?[o.atkSpd]:[...ee]:["SLOW"],M=c[c.length-1],u=h[0],d=o.beamWidth,m=6;let b=0,l=[{ingredientIds:[],score:0}];for(let x=0;x<m;x++){if(r?.aborted)throw new DOMException("Recipe solver cancelled","AbortError");const D=[];for(const y of l)for(const f of n){if(r?.aborted)throw new DOMException("Recipe solver cancelled","AbortError");const p=[...y.ingredientIds,f.id],S=ge(s,p,t,o,M,u);D.push({ingredientIds:p,score:S}),b++}D.sort((y,f)=>f.score-y.score),l=D.slice(0,d);const E=new Set;l=l.filter(y=>{const f=y.ingredientIds.join(",");return E.has(f)?!1:(E.add(f),!0)}),i?.({phase:"beam-search",processedStates:b,beamSize:l.length,expandedSlots:x+1,totalSlots:m})}i?.({phase:"material-sweep",processedStates:b,beamSize:l.length,expandedSlots:m,totalSlots:m,detail:`Sweeping ${c.length} tier combos Ã— ${h.length} atk speeds`});const R=new Map;for(const x of l){if(r?.aborted)throw new DOMException("Recipe solver cancelled","AbortError");const D=x.ingredientIds,E=D.map(y=>t.ingredientsById.get(y)??t.noIngredient);for(const y of c)for(const f of h){const p=K(s,y,E,f),{score:S,breakdown:T}=G(p,o.weights,o),O=re(D,s.id,y,f,a),I=D.join(",")+"|"+y.join(",")+"|"+f,q=R.get(I);(!q||S>q.score)&&R.set(I,{recipeId:s.id,ingredientIds:D,matTiers:y,atkSpd:f,effectiveness:p.effectiveness,stats:p,score:S,scoreBreakdown:T,hash:O}),b++}}const g=Array.from(R.values());g.sort((x,D)=>D.score-x.score);const P=Object.keys(o.target).length>0,v=new Set,w=[],k=[];function A(x){const D=o.maxReqs;for(let E=0;E<5;E++){const y=D[E];if(y!=null&&Math.max(0,x.reqs[E])>y)return!1}return!0}for(const x of g)v.has(x.hash)||(v.add(x.hash),A(x.stats)&&(P&&me(x.stats,o.target)?w.push(x):k.push(x)));const C=w.length>0?w.slice(0,o.topN):k.slice(0,o.topN),V=w.length;return i?.({phase:"complete",processedStates:b,beamSize:C.length,expandedSlots:m,totalSlots:m,detail:P?`Found ${C.length} candidates (${V} satisfy thresholds) from ${b} states`:`Found ${C.length} candidates from ${b} states`}),C}const _=new Map;function Pe(e){return{...e,recipesById:new Map(e.recipesById),recipesByType:new Map(e.recipesByType),ingredientsById:new Map(e.ingredientsById),ingredientsBySkill:new Map(e.ingredientsBySkill),ingredientIdByName:new Map(e.ingredientIdByName)}}self.onmessage=e=>{const t=e.data;if(t.type==="cancel"){_.get(t.requestId)?.abort();return}const o=new AbortController;_.set(t.requestId,o);try{const r=Pe(t.catalog),i=xe({catalog:r,constraints:t.constraints,signal:o.signal,onProgress:a=>{const n={type:"progress",requestId:t.requestId,progress:a};self.postMessage(n)}}),s={type:"result",requestId:t.requestId,candidates:i};self.postMessage(s)}catch(r){const i={type:"error",requestId:t.requestId,message:r instanceof Error?r.message:"Recipe solver worker error"};self.postMessage(i)}finally{_.delete(t.requestId)}}})();
