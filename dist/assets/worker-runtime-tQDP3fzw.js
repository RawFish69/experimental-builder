(function(){"use strict";const Q=["helmet","chestplate","leggings","boots"],Z=["spear","wand","dagger","bow","relik"],ee=["ring","bracelet","necklace"],te=["SLOW","NORMAL","FAST"];function $(e){const t=e.toLowerCase();return Q.includes(t)?"armor":Z.includes(t)?"weapon":ee.includes(t)?"accessory":"consumable"}const L=4e3,j=[0,1,1.25,1.4],_=["e","t","w","f","a"],ne=[{min:3,max:6,convert:17,defPlus:2,defMinus:1},{min:5,max:8,convert:21,defPlus:4,defMinus:2},{min:6,max:10,convert:25,defPlus:8,defMinus:3},{min:7,max:10,convert:31,defPlus:14,defMinus:5},{min:9,max:11,convert:38,defPlus:22,defMinus:9},{min:11,max:13,convert:46,defPlus:30,defMinus:13},{min:1,max:8,convert:9,defPlus:3,defMinus:1},{min:1,max:12,convert:11,defPlus:5,defMinus:1},{min:2,max:15,convert:13,defPlus:9,defMinus:2},{min:3,max:15,convert:17,defPlus:14,defMinus:4},{min:4,max:17,convert:22,defPlus:20,defMinus:7},{min:5,max:20,convert:28,defPlus:28,defMinus:10},{min:3,max:4,convert:13,defPlus:3,defMinus:1},{min:4,max:6,convert:15,defPlus:6,defMinus:1},{min:5,max:8,convert:17,defPlus:11,defMinus:2},{min:6,max:8,convert:21,defPlus:18,defMinus:4},{min:7,max:10,convert:26,defPlus:28,defMinus:7},{min:9,max:11,convert:32,defPlus:40,defMinus:10},{min:2,max:5,convert:14,defPlus:3,defMinus:1},{min:4,max:8,convert:16,defPlus:5,defMinus:2},{min:5,max:9,convert:19,defPlus:9,defMinus:3},{min:6,max:9,convert:24,defPlus:16,defMinus:5},{min:8,max:10,convert:30,defPlus:25,defMinus:9},{min:10,max:12,convert:37,defPlus:36,defMinus:13},{min:2,max:6,convert:11,defPlus:3,defMinus:1},{min:3,max:10,convert:14,defPlus:6,defMinus:2},{min:4,max:11,convert:17,defPlus:10,defMinus:3},{min:5,max:11,convert:22,defPlus:16,defMinus:5},{min:7,max:12,convert:28,defPlus:24,defMinus:9},{min:8,max:14,convert:35,defPlus:34,defMinus:13}];function se(e){return e/6|0}function oe(e){return _[se(e)]}function re(e){const t=[[100,100],[100,100],[100,100]];for(let s=0;s<6;s++){const i=e[s].posMods,o=Math.floor(s/2),a=s%2;if(i.above!==0)for(let n=o-1;n>=0;n--)t[n][a]+=i.above;if(i.under!==0)for(let n=o+1;n<3;n++)t[n][a]+=i.under;if(i.left!==0&&a===1&&(t[o][a-1]+=i.left),i.right!==0&&a===0&&(t[o][a+1]+=i.right),i.touching!==0)for(let n=0;n<3;n++)for(let l=0;l<2;l++)(Math.abs(n-o)===1&&l===a||n===o&&Math.abs(l-a)===1)&&(t[n][l]+=i.touching);if(i.notTouching!==0)for(let n=0;n<3;n++)for(let l=0;l<2;l++)(Math.abs(n-o)>1||Math.abs(n-o)===1&&Math.abs(l-a)===1)&&(t[n][l]+=i.notTouching)}return t.flat()}function K(e,t,s,r){const i=e.type.toLowerCase(),o=$(i);let a=!0;for(const f of s)if(f.id!==L){a=!1;break}let n=0,l=0;(o==="weapon"||o==="armor")&&(e.lvl[0]<30?n=1:e.lvl[0]<70?n=2:n=3),o==="consumable"&&(e.lvl[0]<30?l=1:e.lvl[0]<70?l=2:l=3,a&&(l=3));const g=e.materials.map(f=>f.amount),x=(j[t[0]]*g[0]+j[t[1]]*g[1])/(g[0]+g[1]);let u=[e.durability[0],e.durability[1]],d=[e.duration[0],e.duration[1]];o==="consumable"?(a&&(d=[e.basicDuration[0],e.basicDuration[1]]),d=[Math.round(d[0]*x),Math.round(d[1]*x)]):u=[Math.round(u[0]*x),Math.round(u[1]*x)];const M=e.healthOrDamage[0],I=e.healthOrDamage[1];let c=0,w=0,p="0-0",S="0-0";const D={e:0,t:0,w:0,f:0,a:0};if(o==="armor")c=Math.floor(I*x),w=Math.floor(M*x);else if(o==="weapon"){let f=2.05;r==="SLOW"?f/=1.5:r==="NORMAL"?f=1:r==="FAST"&&(f/=2.5);const m=Math.floor(Math.floor(M*x)*f),h=Math.floor(Math.floor(I*x)*f);S=`${Math.floor(m*.9)}-${Math.floor(m*1.1)}`,p=`${Math.floor(h*.9)}-${Math.floor(h*1.1)}`}else o==="consumable"&&a&&(c=Math.floor(I*x),w=Math.floor(M*x));if(o==="armor"||o==="accessory"){for(const f of s)if(f.isPowder&&f.pid!=null){const m=ne[f.pid],h=oe(f.pid),y=_[(_.indexOf(h)+4)%5];D[h]=(D[h]||0)+m.defPlus,D[y]=(D[y]||0)-m.defMinus}}const E=re(s),R=[0,0,0,0,0],q={},O={};for(let f=0;f<6;f++){const m=s[f],h=E[f]/100,y=m.itemIDs;if(o!=="consumable"){const v=["strReq","dexReq","intReq","defReq","agiReq"];for(let b=0;b<v.length;b++){const k=y[v[b]];k!==0&&(m.isPowder?R[b]+=Math.round(k):R[b]+=Math.round(k*h))}}y.dura!==0&&(u[0]+=y.dura,u[1]+=y.dura),m.consumableIDs.dura!==0&&(d[0]+=m.consumableIDs.dura,d[1]+=m.consumableIDs.dura),m.consumableIDs.charges!==0&&(l+=m.consumableIDs.charges);for(const[v,b]of Object.entries(m.ids)){if(b.max===0&&b.min===0)continue;let k=b.min,T=b.max;const C=[Math.floor(k*h),Math.floor(T*h)].sort((B,Se)=>B-Se);k=C[0],T=C[1],O[v]=(O[v]??0)+k,q[v]=(q[v]??0)+T}}return u[0]=Math.max(1,Math.floor(u[0])),u[1]=Math.max(1,Math.floor(u[1])),a||(d[0]=Math.max(10,d[0]),d[1]=Math.max(10,d[1])),l=Math.max(l,o==="consumable"?1:0),{category:o,type:i,lvl:e.lvl[1],hp:c,hpLow:w,nDam:p,nDamLow:S,eDam:"0-0",tDam:"0-0",wDam:"0-0",fDam:"0-0",aDam:"0-0",eDef:D.e,tDef:D.t,wDef:D.w,fDef:D.f,aDef:D.a,atkSpd:r,durability:u,duration:d,charges:l,slots:n,reqs:[R[0],R[1],R[2],R[3],R[4]],effectiveness:E,maxRolls:q,minRolls:O}}function ie(e,t,s,r,i){const o={SLOW:0,NORMAL:1,FAST:2},a=[];function n(u,d){for(let M=d-1;M>=0;M--)a.push(u>>M&1)}n(0,1),n(2,7);for(const u of e)n(u,12);n(t,12),n(s[0]-1,3),n(s[1]-1,3),i==="weapon"&&n(o[r]??0,4);const l=a.length%6;if(l!==0)for(let u=0;u<6-l;u++)a.push(0);const g="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz+-";let x="";for(let u=0;u<a.length;u+=6){let d=0;for(let M=0;M<6;M++)d=d<<1|(a[u+M]??0);x+=g[d]}return"CR-"+x}const F=["sdPct","sdRaw","mdPct","mdRaw","damPct","poison","fDamPct","wDamPct","aDamPct","tDamPct","eDamPct","spPct1","spRaw1","spPct2","spRaw2","spPct3","spRaw3","spPct4","spRaw4","rSdRaw","critDamPct"],Y=["hpBonus","hprRaw","hprPct","fDefPct","wDefPct","aDefPct","tDefPct","eDefPct"],W=["mr","ms","ls","spd","xpb","lb","ref","thorns","spRegen","eSteal","sprint","sprintReg","jh","lq","gXp","gSpd"],z=["str","dex","int","def","agi"];function U(e,t){let s=0;for(const r of t){const i=e.maxRolls[r]??0;i>0&&(s+=i)}return s}function ae(e,t){let s=0;for(const r of t)s+=e.maxRolls[r]??0;return s}function le(e){let t=U(e,F);return e.category==="armor"&&(t+=e.hp*.02),t}function ce(e){let t=U(e,Y);return e.category==="armor"&&(t+=e.hp*.15),t+=Math.max(0,e.eDef)+Math.max(0,e.tDef)+Math.max(0,e.wDef)+Math.max(0,e.fDef)+Math.max(0,e.aDef),t}function fe(e){let t=0;const s=e.maxRolls.mr??0,r=e.maxRolls.ms??0,i=e.maxRolls.ls??0,o=e.maxRolls.spd??0;t+=s*12+r*8+i*6+o*3;for(const a of W){if(a==="mr"||a==="ms"||a==="ls"||a==="spd")continue;const n=e.maxRolls[a]??0;n>0&&(t+=n)}return t}function de(e){return ae(e,z)}function ue(e){let t=0;for(const s of e.reqs)t+=Math.max(0,s);return t}function H(e,t){if(t==="durability")return[e.durability[0],e.durability[1]];if(t==="duration")return[e.duration[0],e.duration[1]];const s=e.maxRolls[t]??0;return[s,s]}function me(e,t){let s=0;for(const[r,i]of Object.entries(t)){const[o,a]=H(e,r);if(typeof i.min=="number"&&o<i.min){const n=i.min-o;s+=n*200+n*n}if(typeof i.max=="number"&&a>i.max){const n=a-i.max;s+=n*200+n*n}}return s}function he(e,t){for(const[s,r]of Object.entries(t)){const[i,o]=H(e,s);if(typeof r.min=="number"&&i<r.min||typeof r.max=="number"&&o>r.max)return!1}return!0}function G(e,t,s){const r=le(e)*t.offense,i=ce(e)*t.defense,o=fe(e)*t.utility,a=de(e)*t.skillPoints,n=ue(e)*t.reqPenalty,l=me(e,s.target),g={offense:r,defense:i,utility:o,skillPoints:a,reqPenalty:n,thresholdPenalty:l};return{score:r+i+o+a-n-l,breakdown:g}}function pe(e,t,s){let r=0;for(const[o,a]of Object.entries(e.ids)){const n=a.max;F.includes(o)&&n>0?r+=n*t.offense:Y.includes(o)&&n>0?r+=n*t.defense:W.includes(o)?o==="mr"?r+=n*12*t.utility:o==="ms"?r+=n*8*t.utility:o==="ls"?r+=n*6*t.utility:o==="spd"?r+=n*3*t.utility:n>0&&(r+=n*t.utility):z.includes(o)&&(r+=n*t.skillPoints),s?.has(o)&&n>0&&(r+=n*50)}const i=Math.max(0,e.itemIDs.strReq)+Math.max(0,e.itemIDs.dexReq)+Math.max(0,e.itemIDs.intReq)+Math.max(0,e.itemIDs.defReq)+Math.max(0,e.itemIDs.agiReq);return r-=i*t.reqPenalty*.5,r}function Me(e,t,s){const r=e.recipesByType.get(t.toUpperCase());if(!r)return null;const i=`${t.charAt(0).toUpperCase()}${t.slice(1).toLowerCase()}-${s}`;return r.find(o=>o.name===i)??null}function ge(e,t,s){const r=t.skill.toUpperCase(),i=t.lvl[1],o=new Set(s.excludedIngredients),a=new Set(s.mustIncludeIngredients),n=new Set(Object.keys(s.target)),l=n.size>0,g=[];for(const c of e.ingredients)c.id===L||o.has(c.id)||!a.has(c.id)&&(!c.skills.some(S=>S.toUpperCase()===r)||c.lvl>i)||g.push(c);const x=g.map(c=>({ing:c,score:pe(c,s.weights,l?n:void 0)}));x.sort((c,w)=>w.score-c.score);const u=s.topKPerSlot,d=new Set,M=[e.noIngredient];d.add(L);let I=0;for(const{ing:c}of x)a.has(c.id)&&!d.has(c.id)&&(d.add(c.id),M.push(c));for(const{ing:c}of x)if(!d.has(c.id)&&(d.add(c.id),M.push(c),I++,I>=u))break;if(l){const c=g.filter(p=>!d.has(p.id)).map(p=>{let S=0;for(const D of n){const E=p.ids[D]?.max??0;E>0&&(S+=E)}return{ing:p,tScore:S}}).filter(({tScore:p})=>p>0);c.sort((p,S)=>S.tScore-p.tScore);const w=Math.min(c.length,Math.max(30,Math.floor(u/2)));for(let p=0;p<w;p++){const{ing:S}=c[p];d.has(S.id)||(d.add(S.id),M.push(S))}}return M}function xe(e,t,s,r,i,o){const a=[];for(let g=0;g<6;g++)g<t.length?a.push(s.ingredientsById.get(t[g])??s.noIngredient):a.push(s.noIngredient);const n=K(e,i,a,o),{score:l}=G(n,r.weights,r);return l}function Pe(e){const{catalog:t,constraints:s,signal:r,onProgress:i}=e,o=Me(t,s.recipeType,s.levelRange);if(!o)return[];const a=$(o.type.toLowerCase()),n=ge(t,o,s);if(n.length===0)return[];const l=s.matTiers?[s.matTiers]:[[1,1],[1,2],[1,3],[2,1],[2,2],[2,3],[3,1],[3,2],[3,3]],g=a==="weapon"?s.atkSpd?[s.atkSpd]:[...te]:["SLOW"],x=l[l.length-1],u=g[0],d=s.beamWidth,M=6;let I=0;const c=new Set(s.mustIncludeIngredients),w=c.size>0?1e6:0;let p=[{ingredientIds:[],score:0}];for(let P=0;P<M;P++){if(r?.aborted)throw new DOMException("Recipe solver cancelled","AbortError");const f=[];for(const h of p)for(const y of n){if(r?.aborted)throw new DOMException("Recipe solver cancelled","AbortError");const v=[...h.ingredientIds,y.id];let b=xe(o,v,t,s,x,u);w>0&&c.size>0&&[...c].every(T=>v.includes(T))&&(b+=w),f.push({ingredientIds:v,score:b}),I++}f.sort((h,y)=>y.score-h.score),p=f.slice(0,d);const m=new Set;p=p.filter(h=>{const y=h.ingredientIds.join(",");return m.has(y)?!1:(m.add(y),!0)}),i?.({phase:"beam-search",processedStates:I,beamSize:p.length,expandedSlots:P+1,totalSlots:M})}i?.({phase:"material-sweep",processedStates:I,beamSize:p.length,expandedSlots:M,totalSlots:M,detail:`Sweeping ${l.length} tier combos Ã— ${g.length} atk speeds`});const S=new Map;for(const P of p){if(r?.aborted)throw new DOMException("Recipe solver cancelled","AbortError");const f=P.ingredientIds,m=f.map(h=>t.ingredientsById.get(h)??t.noIngredient);for(const h of l)for(const y of g){const v=K(o,h,m,y),{score:b,breakdown:k}=G(v,s.weights,s),T=ie(f,o.id,h,y,a),C=f.join(",")+"|"+h.join(",")+"|"+y,B=S.get(C);(!B||b>B.score)&&S.set(C,{recipeId:o.id,ingredientIds:f,matTiers:h,atkSpd:y,effectiveness:v.effectiveness,stats:v,score:b,scoreBreakdown:k,hash:T}),I++}}const D=Array.from(S.values());D.sort((P,f)=>f.score-P.score);const E=Object.keys(s.target).length>0,R=new Set,q=[],O=[];function V(P){const f=s.maxReqs;for(let m=0;m<5;m++){const h=f[m];if(h!=null&&Math.max(0,P.reqs[m])>h)return!1}return!0}function X(P){if(c.size===0)return!0;const f=new Set(P);for(const m of c)if(!f.has(m))return!1;return!0}for(const P of D)R.has(P.hash)||(R.add(P.hash),X(P.ingredientIds)&&V(P.stats)&&(E&&he(P.stats,s.target)?q.push(P):O.push(P)));const A=q.length>0?q.slice(0,s.topN):O.slice(0,s.topN),J=q.length;return i?.({phase:"complete",processedStates:I,beamSize:A.length,expandedSlots:M,totalSlots:M,detail:E?`Found ${A.length} candidates (${J} satisfy thresholds) from ${I} states`:`Found ${A.length} candidates from ${I} states`}),A}const N=new Map;function ye(e){return{...e,recipesById:new Map(e.recipesById),recipesByType:new Map(e.recipesByType),ingredientsById:new Map(e.ingredientsById),ingredientsBySkill:new Map(e.ingredientsBySkill),ingredientIdByName:new Map(e.ingredientIdByName)}}self.onmessage=e=>{const t=e.data;if(t.type==="cancel"){N.get(t.requestId)?.abort();return}const s=new AbortController;N.set(t.requestId,s);try{const r=ye(t.catalog),i=Pe({catalog:r,constraints:t.constraints,signal:s.signal,onProgress:a=>{const n={type:"progress",requestId:t.requestId,progress:a};self.postMessage(n)}}),o={type:"result",requestId:t.requestId,candidates:i};self.postMessage(o)}catch(r){const i={type:"error",requestId:t.requestId,message:r instanceof Error?r.message:"Recipe solver worker error"};self.postMessage(i)}finally{N.delete(t.requestId)}}})();
