(function(){"use strict";const ee=["helmet","chestplate","leggings","boots"],te=["spear","wand","dagger","bow","relik"],ne=["ring","bracelet","necklace"],se=["SLOW","NORMAL","FAST"];function W(e){const t=e.toLowerCase();return ee.includes(t)?"armor":te.includes(t)?"weapon":ne.includes(t)?"accessory":"consumable"}const K=4e3,j=[0,1,1.25,1.4],_=["e","t","w","f","a"],oe=[{min:3,max:6,convert:17,defPlus:2,defMinus:1},{min:5,max:8,convert:21,defPlus:4,defMinus:2},{min:6,max:10,convert:25,defPlus:8,defMinus:3},{min:7,max:10,convert:31,defPlus:14,defMinus:5},{min:9,max:11,convert:38,defPlus:22,defMinus:9},{min:11,max:13,convert:46,defPlus:30,defMinus:13},{min:1,max:8,convert:9,defPlus:3,defMinus:1},{min:1,max:12,convert:11,defPlus:5,defMinus:1},{min:2,max:15,convert:13,defPlus:9,defMinus:2},{min:3,max:15,convert:17,defPlus:14,defMinus:4},{min:4,max:17,convert:22,defPlus:20,defMinus:7},{min:5,max:20,convert:28,defPlus:28,defMinus:10},{min:3,max:4,convert:13,defPlus:3,defMinus:1},{min:4,max:6,convert:15,defPlus:6,defMinus:1},{min:5,max:8,convert:17,defPlus:11,defMinus:2},{min:6,max:8,convert:21,defPlus:18,defMinus:4},{min:7,max:10,convert:26,defPlus:28,defMinus:7},{min:9,max:11,convert:32,defPlus:40,defMinus:10},{min:2,max:5,convert:14,defPlus:3,defMinus:1},{min:4,max:8,convert:16,defPlus:5,defMinus:2},{min:5,max:9,convert:19,defPlus:9,defMinus:3},{min:6,max:9,convert:24,defPlus:16,defMinus:5},{min:8,max:10,convert:30,defPlus:25,defMinus:9},{min:10,max:12,convert:37,defPlus:36,defMinus:13},{min:2,max:6,convert:11,defPlus:3,defMinus:1},{min:3,max:10,convert:14,defPlus:6,defMinus:2},{min:4,max:11,convert:17,defPlus:10,defMinus:3},{min:5,max:11,convert:22,defPlus:16,defMinus:5},{min:7,max:12,convert:28,defPlus:24,defMinus:9},{min:8,max:14,convert:35,defPlus:34,defMinus:13}];function re(e){return e/6|0}function ie(e){return _[re(e)]}function ae(e){const t=[[100,100],[100,100],[100,100]];for(let n=0;n<6;n++){const i=e[n].posMods,r=Math.floor(n/2),a=n%2;if(i.above!==0)for(let s=r-1;s>=0;s--)t[s][a]+=i.above;if(i.under!==0)for(let s=r+1;s<3;s++)t[s][a]+=i.under;if(i.left!==0&&a===1&&(t[r][a-1]+=i.left),i.right!==0&&a===0&&(t[r][a+1]+=i.right),i.touching!==0)for(let s=0;s<3;s++)for(let f=0;f<2;f++)(Math.abs(s-r)===1&&f===a||s===r&&Math.abs(f-a)===1)&&(t[s][f]+=i.touching);if(i.notTouching!==0)for(let s=0;s<3;s++)for(let f=0;f<2;f++)(Math.abs(s-r)>1||Math.abs(s-r)===1&&Math.abs(f-a)===1)&&(t[s][f]+=i.notTouching)}return t.flat()}function F(e,t,n,o){const i=e.type.toLowerCase(),r=W(i);let a=!0;for(const l of n)if(l.id!==K){a=!1;break}let s=0,f=0;(r==="weapon"||r==="armor")&&(e.lvl[0]<30?s=1:e.lvl[0]<70?s=2:s=3),r==="consumable"&&(e.lvl[0]<30?f=1:e.lvl[0]<70?f=2:f=3,a&&(f=3));const M=e.materials.map(l=>l.amount),g=(j[t[0]]*M[0]+j[t[1]]*M[1])/(M[0]+M[1]);let m=[e.durability[0],e.durability[1]],u=[e.duration[0],e.duration[1]];r==="consumable"?(a&&(u=[e.basicDuration[0],e.basicDuration[1]]),u=[Math.round(u[0]*g),Math.round(u[1]*g)]):m=[Math.round(m[0]*g),Math.round(m[1]*g)];const y=e.healthOrDamage[0],v=e.healthOrDamage[1];let c=0,I=0,x="0-0",P="0-0";const D={e:0,t:0,w:0,f:0,a:0};if(r==="armor")c=Math.floor(v*g),I=Math.floor(y*g);else if(r==="weapon"){let l=2.05;o==="SLOW"?l/=1.5:o==="NORMAL"?l=1:o==="FAST"&&(l/=2.5);const d=Math.floor(Math.floor(y*g)*l),h=Math.floor(Math.floor(v*g)*l);P=`${Math.floor(d*.9)}-${Math.floor(d*1.1)}`,x=`${Math.floor(h*.9)}-${Math.floor(h*1.1)}`}else r==="consumable"&&a&&(c=Math.floor(v*g),I=Math.floor(y*g));if(r==="armor"||r==="accessory"){for(const l of n)if(l.isPowder&&l.pid!=null){const d=oe[l.pid],h=ie(l.pid),p=_[(_.indexOf(h)+4)%5];D[h]=(D[h]||0)+d.defPlus,D[p]=(D[p]||0)-d.defMinus}}const k=ae(n),R=[0,0,0,0,0],T={},E={};for(let l=0;l<6;l++){const d=n[l],h=k[l]/100,p=d.itemIDs;if(r!=="consumable"){const S=["strReq","dexReq","intReq","defReq","agiReq"];for(let b=0;b<S.length;b++){const w=p[S[b]];w!==0&&(d.isPowder?R[b]+=Math.round(w):R[b]+=Math.round(w*h))}}p.dura!==0&&(m[0]+=p.dura,m[1]+=p.dura),d.consumableIDs.dura!==0&&(u[0]+=d.consumableIDs.dura,u[1]+=d.consumableIDs.dura),d.consumableIDs.charges!==0&&(f+=d.consumableIDs.charges);for(const[S,b]of Object.entries(d.ids)){if(b.max===0&&b.min===0)continue;let w=b.min,q=b.max;const O=[Math.floor(w*h),Math.floor(q*h)].sort((B,L)=>B-L);w=O[0],q=O[1],E[S]=(E[S]??0)+w,T[S]=(T[S]??0)+q}}return m[0]=Math.max(1,Math.floor(m[0])),m[1]=Math.max(1,Math.floor(m[1])),a||(u[0]=Math.max(10,u[0]),u[1]=Math.max(10,u[1])),f=Math.max(f,r==="consumable"?1:0),{category:r,type:i,lvl:e.lvl[1],hp:c,hpLow:I,nDam:x,nDamLow:P,eDam:"0-0",tDam:"0-0",wDam:"0-0",fDam:"0-0",aDam:"0-0",eDef:D.e,tDef:D.t,wDef:D.w,fDef:D.f,aDef:D.a,atkSpd:o,durability:m,duration:u,charges:f,slots:s,reqs:[R[0],R[1],R[2],R[3],R[4]],effectiveness:k,maxRolls:T,minRolls:E}}function le(e,t,n,o,i){const r={SLOW:0,NORMAL:1,FAST:2},a=[];function s(m,u){for(let y=u-1;y>=0;y--)a.push(m>>y&1)}s(0,1),s(2,7);for(const m of e)s(m,12);s(t,12),s(n[0]-1,3),s(n[1]-1,3),i==="weapon"&&s(r[o]??0,4);const f=a.length%6;if(f!==0)for(let m=0;m<6-f;m++)a.push(0);const M="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz+-";let g="";for(let m=0;m<a.length;m+=6){let u=0;for(let y=0;y<6;y++)u=u<<1|(a[m+y]??0);g+=M[u]}return"CR-"+g}const Y=["sdPct","sdRaw","mdPct","mdRaw","damPct","poison","fDamPct","wDamPct","aDamPct","tDamPct","eDamPct","spPct1","spRaw1","spPct2","spRaw2","spPct3","spRaw3","spPct4","spRaw4","rSdRaw","critDamPct"],z=["hpBonus","hprRaw","hprPct","fDefPct","wDefPct","aDefPct","tDefPct","eDefPct"],U=["mr","ms","ls","spd","xpb","lb","ref","thorns","spRegen","eSteal","sprint","sprintReg","jh","lq","gXp","gSpd"],H=["str","dex","int","def","agi"];function G(e,t){let n=0;for(const o of t){const i=e.maxRolls[o]??0;i>0&&(n+=i)}return n}function ce(e,t){let n=0;for(const o of t)n+=e.maxRolls[o]??0;return n}function fe(e){let t=G(e,Y);return e.category==="armor"&&(t+=e.hp*.02),t}function de(e){let t=G(e,z);return e.category==="armor"&&(t+=e.hp*.15),t+=Math.max(0,e.eDef)+Math.max(0,e.tDef)+Math.max(0,e.wDef)+Math.max(0,e.fDef)+Math.max(0,e.aDef),t}function ue(e){let t=0;const n=e.maxRolls.mr??0,o=e.maxRolls.ms??0,i=e.maxRolls.ls??0,r=e.maxRolls.spd??0;t+=n*12+o*8+i*6+r*3;for(const a of U){if(a==="mr"||a==="ms"||a==="ls"||a==="spd")continue;const s=e.maxRolls[a]??0;s>0&&(t+=s)}return t}function me(e){return ce(e,H)}function he(e){let t=0;for(const n of e.reqs)t+=Math.max(0,n);return t}function V(e,t){if(t==="durability")return[e.durability[0],e.durability[1]];if(t==="duration")return[e.duration[0],e.duration[1]];const n=e.maxRolls[t]??0;return[n,n]}function pe(e,t){let n=0;for(const[o,i]of Object.entries(t)){const[r,a]=V(e,o);if(typeof i.min=="number"&&r<i.min){const s=i.min-r;n+=s*200+s*s}if(typeof i.max=="number"&&a>i.max){const s=a-i.max;n+=s*200+s*s}}return n}function Me(e,t){for(const[n,o]of Object.entries(t)){const[i,r]=V(e,n);if(typeof o.min=="number"&&i<o.min||typeof o.max=="number"&&r>o.max)return!1}return!0}function X(e,t,n){const o=fe(e)*t.offense,i=de(e)*t.defense,r=ue(e)*t.utility,a=me(e)*t.skillPoints,s=he(e)*t.reqPenalty,f=pe(e,n.target),M={offense:o,defense:i,utility:r,skillPoints:a,reqPenalty:s,thresholdPenalty:f};return{score:o+i+r+a-s-f,breakdown:M}}function ge(e,t,n){let o=0;for(const[r,a]of Object.entries(e.ids)){const s=a.max;Y.includes(r)&&s>0?o+=s*t.offense:z.includes(r)&&s>0?o+=s*t.defense:U.includes(r)?r==="mr"?o+=s*12*t.utility:r==="ms"?o+=s*8*t.utility:r==="ls"?o+=s*6*t.utility:r==="spd"?o+=s*3*t.utility:s>0&&(o+=s*t.utility):H.includes(r)&&(o+=s*t.skillPoints),n?.has(r)&&s>0&&(o+=s*50)}const i=Math.max(0,e.itemIDs.strReq)+Math.max(0,e.itemIDs.dexReq)+Math.max(0,e.itemIDs.intReq)+Math.max(0,e.itemIDs.defReq)+Math.max(0,e.itemIDs.agiReq);return o-=i*t.reqPenalty*.5,o}function xe(e,t,n){const o=e.recipesByType.get(t.toUpperCase());if(!o)return null;const i=`${t.charAt(0).toUpperCase()}${t.slice(1).toLowerCase()}-${n}`;return o.find(r=>r.name===i)??null}function Pe(e,t,n){const o=t.skill.toUpperCase(),i=t.lvl[1],r=new Set(n.excludedIngredients),a=new Set(n.mustIncludeIngredients),s=new Set(Object.keys(n.target)),f=s.size>0,M=[];for(const c of e.ingredients)c.id===K||r.has(c.id)||!c.skills.some(x=>x.toUpperCase()===o)||c.lvl>i||M.push(c);const g=M.map(c=>({ing:c,score:ge(c,n.weights,f?s:void 0)}));g.sort((c,I)=>I.score-c.score);const m=n.topKPerSlot,u=new Set,y=[e.noIngredient];u.add(K);let v=0;for(const{ing:c}of g)a.has(c.id)&&!u.has(c.id)&&(u.add(c.id),y.push(c));for(const{ing:c}of g)if(!u.has(c.id)&&(u.add(c.id),y.push(c),v++,v>=m))break;if(f){const c=M.filter(x=>!u.has(x.id)).map(x=>{let P=0;for(const D of s){const k=x.ids[D]?.max??0;k>0&&(P+=k)}return{ing:x,tScore:P}}).filter(({tScore:x})=>x>0);c.sort((x,P)=>P.tScore-x.tScore);const I=Math.min(c.length,Math.max(30,Math.floor(m/2)));for(let x=0;x<I;x++){const{ing:P}=c[x];u.has(P.id)||(u.add(P.id),y.push(P))}}return y}function Se(e,t,n,o,i,r){const a=[];for(let M=0;M<6;M++)M<t.length?a.push(n.ingredientsById.get(t[M])??n.noIngredient):a.push(n.noIngredient);const s=F(e,i,a,r),{score:f}=X(s,o.weights,o);return f}function J(e){const{catalog:t,constraints:n,signal:o,onProgress:i,alreadyThresholdRescue:r=!1}=e,a=xe(t,n.recipeType,n.levelRange);if(!a)return[];const s=W(a.type.toLowerCase()),f=Pe(t,a,n);if(f.length===0)return[];const M=n.matTiers?[n.matTiers]:[[1,1],[1,2],[1,3],[2,1],[2,2],[2,3],[3,1],[3,2],[3,3]],g=s==="weapon"?n.atkSpd?[n.atkSpd]:[...se]:["SLOW"],m=M[M.length-1],u=g[0],y=n.beamWidth,v=6;let c=0;const I=new Set(n.mustIncludeIngredients),x=I.size>0?1e6:0;let P=[{ingredientIds:[],score:0}];for(let l=0;l<v;l++){if(o?.aborted)throw new DOMException("Recipe solver cancelled","AbortError");const d=[];for(const p of P)for(const S of f){if(o?.aborted)throw new DOMException("Recipe solver cancelled","AbortError");const b=[...p.ingredientIds,S.id];let w=Se(a,b,t,n,m,u);x>0&&I.size>0&&[...I].every(O=>b.includes(O))&&(w+=x),d.push({ingredientIds:b,score:w}),c++}d.sort((p,S)=>S.score-p.score),P=d.slice(0,y);const h=new Set;P=P.filter(p=>{const S=p.ingredientIds.join(",");return h.has(S)?!1:(h.add(S),!0)}),i?.({phase:"beam-search",processedStates:c,beamSize:P.length,expandedSlots:l+1,totalSlots:v})}i?.({phase:"material-sweep",processedStates:c,beamSize:P.length,expandedSlots:v,totalSlots:v,detail:`Sweeping ${M.length} tier combos Ã— ${g.length} atk speeds`});const D=new Map;for(const l of P){if(o?.aborted)throw new DOMException("Recipe solver cancelled","AbortError");const d=l.ingredientIds,h=d.map(p=>t.ingredientsById.get(p)??t.noIngredient);for(const p of M)for(const S of g){const b=F(a,p,h,S),{score:w,breakdown:q}=X(b,n.weights,n),O=le(d,a.id,p,S,s),B=d.join(",")+"|"+p.join(",")+"|"+S,L=D.get(B);(!L||w>L.score)&&D.set(B,{recipeId:a.id,ingredientIds:d,matTiers:p,atkSpd:S,effectiveness:b.effectiveness,stats:b,score:w,scoreBreakdown:q,hash:O}),c++}}const k=Array.from(D.values());k.sort((l,d)=>d.score-l.score);const R=Object.keys(n.target).length>0,T=new Set,E=[],A=[];function Q(l){const d=n.maxReqs;for(let h=0;h<5;h++){const p=d[h];if(p!=null&&Math.max(0,l.reqs[h])>p)return!1}return!0}function Z(l){if(I.size===0)return!0;const d=new Set(l);for(const h of I)if(!d.has(h))return!1;return!0}for(const l of k)T.has(l.hash)||(T.add(l.hash),Z(l.ingredientIds)&&Q(l.stats)&&(R&&Me(l.stats,n.target)?E.push(l):A.push(l)));if(R&&E.length===0&&!r){const l={...n,topKPerSlot:Math.min(400,Math.max(n.topKPerSlot*2,180)),beamWidth:Math.min(5e3,Math.max(n.beamWidth*2,1200))};if(l.topKPerSlot!==n.topKPerSlot||l.beamWidth!==n.beamWidth){i?.({phase:"threshold-rescue",processedStates:c,beamSize:P.length,expandedSlots:v,totalSlots:v,detail:`No candidates satisfied thresholds. Retrying with topK=${l.topKPerSlot}, beam=${l.beamWidth}.`});const h=J({catalog:t,constraints:l,signal:o,onProgress:i,alreadyThresholdRescue:!0});if(h.length>0)return h}}const C=R?E.slice(0,n.topN):A.slice(0,n.topN),$=E.length;return i?.({phase:"complete",processedStates:c,beamSize:C.length,expandedSlots:v,totalSlots:v,detail:R?$>0?`Found ${C.length} candidates (${$} satisfy thresholds) from ${c} states`:`Found 0 candidates satisfying thresholds (${A.length} failed threshold checks) from ${c} states`:`Found ${C.length} candidates from ${c} states`}),C}const N=new Map;function ye(e){return{...e,recipesById:new Map(e.recipesById),recipesByType:new Map(e.recipesByType),ingredientsById:new Map(e.ingredientsById),ingredientsBySkill:new Map(e.ingredientsBySkill),ingredientIdByName:new Map(e.ingredientIdByName)}}self.onmessage=e=>{const t=e.data;if(t.type==="cancel"){N.get(t.requestId)?.abort();return}const n=new AbortController;N.set(t.requestId,n);try{const o=ye(t.catalog),i=J({catalog:o,constraints:t.constraints,signal:n.signal,onProgress:a=>{const s={type:"progress",requestId:t.requestId,progress:a};self.postMessage(s)}}),r={type:"result",requestId:t.requestId,candidates:i};self.postMessage(r)}catch(o){const i={type:"error",requestId:t.requestId,message:o instanceof Error?o.message:"Recipe solver worker error"};self.postMessage(i)}finally{N.delete(t.requestId)}}})();
