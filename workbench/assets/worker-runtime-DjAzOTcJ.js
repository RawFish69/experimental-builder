(function(){"use strict";function J(t){return t.aggregated.hprTotal*.9+t.aggregated.mr*14+t.aggregated.ms*10+t.aggregated.ls*9}function Q(t,s){let n=0;const{target:e}=s;return typeof e.minLegacyBaseDps=="number"&&t.derived.legacyBaseDps<e.minLegacyBaseDps&&(n+=(e.minLegacyBaseDps-t.derived.legacyBaseDps)*4),typeof e.minLegacyEhp=="number"&&t.derived.legacyEhp<e.minLegacyEhp&&(n+=(e.minLegacyEhp-t.derived.legacyEhp)*.8),typeof e.minDpsProxy=="number"&&t.derived.dpsProxy<e.minDpsProxy&&(n+=(e.minDpsProxy-t.derived.dpsProxy)*4),typeof e.minEhpProxy=="number"&&t.derived.ehpProxy<e.minEhpProxy&&(n+=(e.minEhpProxy-t.derived.ehpProxy)*1.1),typeof e.minMr=="number"&&t.aggregated.mr<e.minMr&&(n+=(e.minMr-t.aggregated.mr)*45),typeof e.minMs=="number"&&t.aggregated.ms<e.minMs&&(n+=(e.minMs-t.aggregated.ms)*35),typeof e.minSpeed=="number"&&t.aggregated.speed<e.minSpeed&&(n+=(e.minSpeed-t.aggregated.speed)*12),typeof e.minSkillPointTotal=="number"&&t.derived.skillPointTotal<e.minSkillPointTotal&&(n+=(e.minSkillPointTotal-t.derived.skillPointTotal)*15),typeof e.maxReqTotal=="number"&&t.derived.reqTotal>e.maxReqTotal&&(n+=(t.derived.reqTotal-e.maxReqTotal)*8),n}function F(t,s,n){const e=J(t),c=t.derived.reqTotal*s.reqTotalPenalty,a=Q(t,n),i={legacyBaseDps:t.derived.legacyBaseDps*s.legacyBaseDps,legacyEhp:t.derived.legacyEhp*s.legacyEhp,dpsProxy:t.derived.dpsProxy*s.dpsProxy,ehpProxy:t.derived.ehpProxy*s.ehpProxy,speed:t.aggregated.speed*s.speed,sustain:e*s.sustain,skillPointTotal:t.derived.skillPointTotal*s.skillPointTotal,reqPenalty:c,thresholdPenalty:a};return{score:i.legacyBaseDps+i.legacyEhp+i.dpsProxy+i.ehpProxy+i.speed+i.sustain+i.skillPointTotal-i.reqPenalty-i.thresholdPenalty,breakdown:i}}const T=["helmet","chestplate","leggings","boots","ring1","ring2","bracelet","necklace","weapon"],D=t=>t==="ring1"||t==="ring2"?"ring":t,X={spear:"Warrior",dagger:"Assassin",wand:"Mage",bow:"Archer",relik:"Shaman"};function Z(t){return X[t]??null}function ee(t,s){return!s||!t.classReq?!0:t.classReq===s}const te={slotStatus:{},warnings:{messages:[]},aggregated:{hpTotal:0,hprTotal:0,mr:0,ms:0,ls:0,speed:0,skillPoints:{str:0,dex:0,int:0,def:0,agi:0},skillReqs:{str:0,dex:0,int:0,def:0,agi:0},defenses:{e:0,t:0,w:0,f:0,a:0},offense:{baseDps:0,spellPct:0,spellRaw:0,meleePct:0,meleeRaw:0,offenseScore:0}},derived:{dpsProxy:0,ehpProxy:0,reqTotal:0,skillPointTotal:0,legacyBaseDps:0,legacyEhp:0,legacyEhpNoAgi:0,skillpointFeasible:!0,assignedSkillPointsRequired:0}};function E(t){let s=Number.isFinite(t)?t:0;if(s<=0)return 0;s>=150&&(s=150);const n=.9908;return n/(1-n)*(1-Math.pow(n,s))/100}const se=.867,ne=.951,oe=90;function re(t){return Math.max(1,Math.min(106,Math.round(t||1)))*5+5}function ie(t){const s=Math.max(1,Math.min(106,Math.round(t||1)));return s>=101?200:(s-1)*2}function ae(t){switch(t){case"relik":return .6;case"bow":return .7;case"wand":return .8;case"dagger":case"spear":return 1;default:return 1}}function le(t){const s=Math.max(5,t.totalHp),n=E(t.defSkillPoints)*se,e=E(t.agiSkillPoints)*ne,a=2-ae(t.weaponType),h=(100-oe)/100*e+(1-e)*(1-n),f=1-n,S=s/Math.max(1e-9,h)/Math.max(1e-9,a),p=s/Math.max(1e-9,f)/Math.max(1e-9,a);return{withAgi:S,noAgi:p}}function ce(t){return[t.numeric.reqStr,t.numeric.reqDex,t.numeric.reqInt,t.numeric.reqDef,t.numeric.reqAgi]}function de(t){return[t.numeric.spStr,t.numeric.spDex,t.numeric.spInt,t.numeric.spDef,t.numeric.spAgi]}function ge(t,s){return[t[0]+s[0],t[1]+s[1],t[2]+s[2],t[3]+s[3],t[4]+s[4]]}function ue(t){return t[0]+t[1]+t[2]+t[3]+t[4]}function C(t,s){for(let n=0;n<5;n++)if(t[n]>s[n])return!1;return!0}function fe(t,s){for(const n of t)if(C(n.assigned,s.assigned))return;for(let n=t.length-1;n>=0;n--)C(s.assigned,t[n].assigned)&&t.splice(n,1);t.push(s)}function pe(t,s){if(t.length===0)return{feasible:!0,assignedTotal:0};const n=ie(s),e=t.length,c=t.map(ce),a=t.map(de),i=1<<e,h=Array.from({length:i},()=>[0,0,0,0,0]);for(let g=1;g<i;g++){const x=g&-g,P=Math.log2(x)|0;h[g]=ge(h[g^x],a[P])}const f=new Array(i);f[0]=[{assigned:[0,0,0,0,0],assignedTotal:0}];for(let g=0;g<i;g++){const x=f[g];if(!x||x.length===0)continue;const P=h[g];for(const q of x)for(let d=0;d<e;d++){if((g&1<<d)!==0)continue;const l=[...q.assigned];let y=!0;for(let m=0;m<5;m++){const b=q.assigned[m]+P[m],M=c[d][m];if(M>b&&(l[m]+=M-b),l[m]>100){y=!1;break}}if(!y)continue;const r=ue(l);if(r>n)continue;const o=g|1<<d,u=f[o]??=[];fe(u,{assigned:l,assignedTotal:r})}}const S=f[i-1];if(!S||S.length===0)return{feasible:!1,assignedTotal:1/0};let p=1/0;for(const g of S)g.assignedTotal<p&&(p=g.assignedTotal);return{feasible:Number.isFinite(p),assignedTotal:p}}function $(t,s,n){const e=[];for(const c of T){const a=t[c];if(a==null)continue;const i=s.itemsById.get(a);i&&e.push(i)}return pe(e,n)}function he(t,s){const n={};for(const e of T){const c=t.slots[e];if(c==null)continue;const a=s.itemsById.get(c);a&&(n[e]=a)}return n}function j(t,s){const n=he(t,s),e=structuredClone(te),c=e.warnings.messages;let a=null;for(const d of T){const l=n[d];if(!l)continue;d==="weapon"&&(a=l.type),e.aggregated.hpTotal+=l.numeric.hp+l.numeric.hpBonus,e.aggregated.hprTotal+=l.numeric.hprRaw+l.numeric.hprPct,e.aggregated.mr+=l.numeric.mr,e.aggregated.ms+=l.numeric.ms,e.aggregated.ls+=l.numeric.ls,e.aggregated.speed+=l.numeric.spd,e.aggregated.skillPoints.str+=l.numeric.spStr,e.aggregated.skillPoints.dex+=l.numeric.spDex,e.aggregated.skillPoints.int+=l.numeric.spInt,e.aggregated.skillPoints.def+=l.numeric.spDef,e.aggregated.skillPoints.agi+=l.numeric.spAgi,e.aggregated.skillReqs.str=Math.max(e.aggregated.skillReqs.str,l.numeric.reqStr),e.aggregated.skillReqs.dex=Math.max(e.aggregated.skillReqs.dex,l.numeric.reqDex),e.aggregated.skillReqs.int=Math.max(e.aggregated.skillReqs.int,l.numeric.reqInt),e.aggregated.skillReqs.def=Math.max(e.aggregated.skillReqs.def,l.numeric.reqDef),e.aggregated.skillReqs.agi=Math.max(e.aggregated.skillReqs.agi,l.numeric.reqAgi),e.aggregated.defenses.e+=l.numeric.eDef,e.aggregated.defenses.t+=l.numeric.tDef,e.aggregated.defenses.w+=l.numeric.wDef,e.aggregated.defenses.f+=l.numeric.fDef,e.aggregated.defenses.a+=l.numeric.aDef,e.aggregated.offense.baseDps+=l.numeric.baseDps,e.aggregated.offense.spellPct+=l.numeric.sdPct,e.aggregated.offense.spellRaw+=l.numeric.sdRaw,e.aggregated.offense.meleePct+=l.numeric.mdPct,e.aggregated.offense.meleeRaw+=l.numeric.mdRaw,e.aggregated.offense.offenseScore+=l.roughScoreFields.offense;const y=l.classReq,r=!y||!t.characterClass||y===t.characterClass,o=l.level<=t.level,u=l.numeric.reqStr<=100&&l.numeric.reqDex<=100&&l.numeric.reqInt<=100&&l.numeric.reqDef<=100&&l.numeric.reqAgi<=100;e.slotStatus[d]={classOk:r,levelOk:o,skillReqsMet:u}}!t.characterClass&&a&&(t.characterClass=Z(a));for(const d of T){const l=n[d];l&&(D(d)!==l.category&&c.push(`${d} contains incompatible item type (${l.type}).`),l.level>t.level&&c.push(`${l.displayName} requires level ${l.level}.`),t.characterClass&&l.classReq&&l.classReq!==t.characterClass&&c.push(`${l.displayName} requires ${l.classReq}.`),(l.restricted||l.deprecated)&&c.push(`${l.displayName} is restricted/deprecated.`))}const i=e.aggregated.skillReqs.str+e.aggregated.skillReqs.dex+e.aggregated.skillReqs.int+e.aggregated.skillReqs.def+e.aggregated.skillReqs.agi,h=e.aggregated.skillPoints.str+e.aggregated.skillPoints.dex+e.aggregated.skillPoints.int+e.aggregated.skillPoints.def+e.aggregated.skillPoints.agi,f=$(t.slots,s,t.level),S=e.aggregated.offense.baseDps+e.aggregated.offense.spellPct*1.3+e.aggregated.offense.spellRaw*.12+e.aggregated.offense.meleePct*1.1+e.aggregated.offense.meleeRaw*.12+e.aggregated.speed*.8,p=e.aggregated.defenses.e+e.aggregated.defenses.t+e.aggregated.defenses.w+e.aggregated.defenses.f+e.aggregated.defenses.a,g=e.aggregated.hpTotal+p*.45+e.aggregated.hprTotal*2+Math.max(0,e.aggregated.skillPoints.def)*12+Math.max(0,e.aggregated.skillPoints.agi)*10,x=e.aggregated.offense.baseDps,P=re(t.level)+e.aggregated.hpTotal,q=le({totalHp:P,defSkillPoints:e.aggregated.skillPoints.def,agiSkillPoints:e.aggregated.skillPoints.agi,weaponType:a});return e.derived={dpsProxy:S,ehpProxy:g,reqTotal:i,skillPointTotal:h,legacyBaseDps:x,legacyEhp:q.withAgi,legacyEhpNoAgi:q.noAgi,skillpointFeasible:f.feasible,assignedSkillPointsRequired:Number.isFinite(f.assignedTotal)?f.assignedTotal:0},f.feasible||c.push(`Skill requirements are not satisfiable at level ${t.level} (estimated assigned SP exceeds available or equip order is invalid).`),e}const N=["str","dex","int","def","agi"];function A(t,s){switch(s){case"str":return Math.max(0,t.numeric.spStr);case"dex":return Math.max(0,t.numeric.spDex);case"int":return Math.max(0,t.numeric.spInt);case"def":return Math.max(0,t.numeric.spDef);case"agi":return Math.max(0,t.numeric.spAgi)}}function me(t,s){switch(s){case"str":return t.numeric.reqStr;case"dex":return t.numeric.reqDex;case"int":return t.numeric.reqInt;case"def":return t.numeric.reqDef;case"agi":return t.numeric.reqAgi}}function Se(t,s){if(s.length===0)return 0;let n=0;for(const e of s)n+=A(t,e)*10,n-=Math.max(0,me(t,e))*.7;return n-=Math.max(0,t.roughScoreFields.reqTotal)*.12,n}function I(t){return{...t}}function xe(t,s){return!(!s.allowRestricted&&(t.restricted||t.deprecated)||t.level>s.level||!ee(t,s.characterClass)||s.excludedIds.includes(t.id)||s.allowedTiers.length>0&&!s.allowedTiers.includes(t.tier)||s.minPowderSlots!=null&&t.powderSlots<s.minPowderSlots||s.excludedMajorIds.length>0&&s.excludedMajorIds.some(n=>t.majorIds.includes(n))||t.category==="weapon"&&s.weaponAttackSpeeds.length>0&&!s.weaponAttackSpeeds.includes(t.atkSpd))}function ye(t,s){return t.numeric.baseDps*s.weights.legacyBaseDps+t.roughScoreFields.ehpProxy*s.weights.legacyEhp+t.roughScoreFields.offense*s.weights.dpsProxy+t.roughScoreFields.ehpProxy*s.weights.ehpProxy+t.numeric.spd*s.weights.speed+t.roughScoreFields.utility*s.weights.sustain+t.roughScoreFields.skillPointTotal*s.weights.skillPointTotal-t.roughScoreFields.reqTotal*s.weights.reqTotalPenalty}function z(t){const s=t.ring1??0,n=t.ring2??0,[e,c]=s<=n?[s,n]:[n,s];return[t.helmet??0,t.chestplate??0,t.leggings??0,t.boots??0,e,c,t.bracelet??0,t.necklace??0,t.weapon??0].join("|")}function L(t,s){return D(s)===t.category}function qe(t,s,n){const e=I(t),c=new Set(T.filter(a=>e[a]!=null));for(const a of n.mustIncludeIds){const i=s.itemsById.get(a);if(!i)continue;const f=T.filter(S=>!c.has(S)&&L(i,S))[0];f&&(e[f]=i.id,c.add(f))}return e}function Pe(t,s){const n={str:0,dex:0,int:0,def:0,agi:0};for(const c of T){const a=t[c];if(a==null)continue;const i=s.itemsById.get(a);i&&(n.str=Math.max(n.str,i.numeric.reqStr),n.dex=Math.max(n.dex,i.numeric.reqDex),n.int=Math.max(n.int,i.numeric.reqInt),n.def=Math.max(n.def,i.numeric.reqDef),n.agi=Math.max(n.agi,i.numeric.reqAgi))}const e=N.filter(c=>n[c]>100).sort((c,a)=>n[a]-n[c]);return e.length>0?e:N.filter(c=>n[c]>=70).sort((c,a)=>n[a]-n[c]).slice(0,2)}function be(t,s,n){if(n.length===0)return[];const e={str:0,dex:0,int:0,def:0,agi:0};for(const c of T){const a=t[c];if(a==null)continue;const i=s.itemsById.get(a);i&&(e.str=Math.max(e.str,i.numeric.reqStr),e.dex=Math.max(e.dex,i.numeric.reqDex),e.int=Math.max(e.int,i.numeric.reqInt),e.def=Math.max(e.def,i.numeric.reqDef),e.agi=Math.max(e.agi,i.numeric.reqAgi))}return n.map(c=>Math.max(0,e[c]-100))}function O(t,s){return s.map(n=>A(t,n))}function W(t,s){if(t.length===0)return s.slice();const n=new Array(t.length);for(let e=0;e<t.length;e++)n[e]=(t[e]??0)+(s[e]??0);return n}function Me(t,s,n){for(let e=0;e<n.length;e++)if((t[e]??0)+(s[e]??0)<n[e])return!1;return!0}function _(t,s){let n=0;for(let e=0;e<s.length;e++)n+=Math.max(0,s[e]-(t[e]??0));return n}function H(t,s,n,e){if(e.length===0)return 0;const c=s.get(t)??[];let a=0;for(const i of c){const h=n.itemsById.get(i.id);if(!h)continue;let f=0;for(const S of e)f+=A(h,S);f>a&&(a=f)}return a}function ke(t,s,n,e,c=[]){const a=[];for(const r of s.items)L(r,t)&&(e&&!e.has(r.id)||xe(r,n)&&a.push({id:r.id,rough:ye(r,n),reqTotal:r.roughScoreFields.reqTotal,skillPointTotal:r.roughScoreFields.skillPointTotal,utility:r.roughScoreFields.utility+r.numeric.spd*.8,level:r.level,spStr:r.numeric.spStr,spDex:r.numeric.spDex,spInt:r.numeric.spInt,spDef:r.numeric.spDef,spAgi:r.numeric.spAgi,supportFocus:Se(r,c)}));const i=[...a].sort((r,o)=>r.rough!==o.rough?o.rough-r.rough:r.id-o.id),h=[...a].sort((r,o)=>r.reqTotal!==o.reqTotal?r.reqTotal-o.reqTotal:r.level!==o.level?r.level-o.level:r.id-o.id),f=[...a].sort((r,o)=>r.skillPointTotal!==o.skillPointTotal?o.skillPointTotal-r.skillPointTotal:r.reqTotal!==o.reqTotal?r.reqTotal-o.reqTotal:r.id-o.id),S=[...a].sort((r,o)=>r.utility!==o.utility?o.utility-r.utility:r.reqTotal!==o.reqTotal?r.reqTotal-o.reqTotal:r.id-o.id),p=c.length>0?[...a].sort((r,o)=>r.supportFocus!==o.supportFocus?o.supportFocus-r.supportFocus:r.reqTotal!==o.reqTotal?r.reqTotal-o.reqTotal:r.skillPointTotal!==o.skillPointTotal?o.skillPointTotal-r.skillPointTotal:r.id-o.id):[],g=c.map(r=>[...a].sort((o,u)=>{const m=r==="str"?o.spStr:r==="dex"?o.spDex:r==="int"?o.spInt:r==="def"?o.spDef:o.spAgi,b=r==="str"?u.spStr:r==="dex"?u.spDex:r==="int"?u.spInt:r==="def"?u.spDef:u.spAgi;return m!==b?b-m:o.reqTotal!==u.reqTotal?o.reqTotal-u.reqTotal:o.supportFocus!==u.supportFocus?u.supportFocus-o.supportFocus:o.id-u.id})),x=Math.max(10,n.topKPerSlot),P=Math.min(140,Math.max(40,Math.floor(x*.8))),q=Math.min(a.length,x+P+(c.length>0?Math.min(60,c.length*12):0)),d=new Map,l=Math.min(12,Math.floor(x*.4),i.length);for(let r=0;r<l;r++){const o=i[r];d.set(o.id,{id:o.id,rough:o.rough})}const y=[{list:i,remaining:Math.max(0,x-l),cursor:0},{list:h,remaining:Math.floor(P*.28),cursor:0},{list:f,remaining:Math.floor(P*.24),cursor:0},{list:S,remaining:Math.floor(P*.18),cursor:0}];p.length>0&&y.push({list:p,remaining:Math.max(16,Math.floor(P*.2)),cursor:0});for(const r of g)y.push({list:r,remaining:10,cursor:0});for(;d.size<q;){let r=!1;for(const o of y)if(!(o.remaining<=0))for(;o.cursor<o.list.length;){const u=o.list[o.cursor++];if(!d.has(u.id)){d.set(u.id,{id:u.id,rough:u.rough}),o.remaining--,r=!0;break}}if(!r)break}if(d.size<q)for(const r of i){if(d.size>=q)break;d.has(r.id)||d.set(r.id,{id:r.id,rough:r.rough})}return[...d.values()]}function Te(t){const s={};for(const n of T){const e=D(n),c=new Set(t.binsByCategory[e]??[]),a=t.slots[n];a!=null&&c.add(a),s[n]=c}return s}function K(t,s,n){if(n.length===0)return!0;const e=new Set;for(const c of T){const a=t[c];if(a==null)continue;const i=s.itemsById.get(a);if(i)for(const h of i.majorIds)n.includes(h)&&e.add(h)}return n.every(c=>e.has(c))}function V(t,s){const n=new Array(t.length+1).fill(0);for(let e=t.length-1;e>=0;e--){const c=t[e],a=s.get(c)??[];let i=0;for(const h of a)h.rough>i&&(i=h.rough);n[e]=n[e+1]+i}return n}function Y(t){const{poolSize:s,beamSize:n,remainingStages:e,processedStates:c,maxStates:a}=t;if(s<=0)return 0;const i=Math.max(0,a-c),h=Math.max(1,n*Math.max(1,e)),f=Math.floor(i/h),S=Math.max(8,Math.min(64,f));return Math.min(s,S)}function ve(t,s,n){let e=1;for(const c of t){const a=s.get(c)?.length??0;if(a===0)return 0;if(e*=a,e>n)return e}return e}function U(t){const{beam:s,catalog:n,constraints:e,signal:c}=t,a=[],i=new Set,h={majorIds:0,spInvalid:0,duplicate:0};for(const f of s){if(c?.aborted)throw new DOMException("Auto build cancelled","AbortError");if(!K(f.slots,n,e.requiredMajorIds)){h.majorIds++;continue}const S=j({slots:f.slots,level:e.level,characterClass:e.characterClass},n);if(!S.derived.skillpointFeasible){h.spInvalid++;continue}const p=z(f.slots);if(i.has(p)){h.duplicate++;continue}const{score:g,breakdown:x}=F(S,e.weights,e);i.add(p),a.push({slots:I(f.slots),score:g,scoreBreakdown:x,summary:S})}return a.sort((f,S)=>{if(f.score!==S.score)return S.score-f.score;for(const p of T){const g=f.slots[p]??0,x=S.slots[p]??0;if(g!==x)return g-x}return 0}),{candidates:a,rejectStats:h}}function Ie(t){const{slotOrder:s,candidatePools:n,baseSlots:e,catalog:c,constraints:a,focusStats:i,onProgress:h,signal:f}=t,S=V(s,n),p=be(e,c,i),g=Array.from({length:s.length+1},()=>i.map(()=>0));for(let d=s.length-1;d>=0;d--){const l=n.get(s[d])??[],y=i.map(()=>0);for(const r of l){const o=c.itemsById.get(r.id);if(!o)continue;const u=O(o,i);for(let m=0;m<u.length;m++)u[m]>y[m]&&(y[m]=u[m])}g[d]=W(g[d+1],y)}let x=[{slots:I(e),orderIndex:0,roughScore:0,optimisticBound:S[0],feasibilityAssigned:0,focusSupport:i.map(()=>0)}],P=0,q=!1;for(let d=0;d<s.length;d++){if(f?.aborted)throw new DOMException("Auto build cancelled","AbortError");const l=s[d],y=n.get(l)??[],r=[],o=Y({poolSize:y.length,beamSize:x.length,remainingStages:s.length-d,processedStates:P,maxStates:a.maxStates});o<=0&&(q=!0);for(const u of x){let m=0;for(const b of y){if(m>=o)break;if(P>=a.maxStates){q=!0;break}P++,m++;const M=I(u.slots);M[l]=b.id;const k=c.itemsById.get(b.id),v=W(u.focusSupport??i.map(()=>0),k?O(k,i):i.map(()=>0));if(i.length>0&&!Me(v,g[d+1],p))continue;const w=$(M,c,a.level),B=u.roughScore+b.rough;r.push({slots:M,orderIndex:d+1,roughScore:B,optimisticBound:B+S[d+1],feasibilityAssigned:w.feasible?w.assignedTotal:1/0,focusSupport:v})}if(q)break}if(r.length===0)return h?.({phase:"diagnostics",processedStates:P,beamSize:x.length,totalSlots:s.length,expandedSlots:d,detail:q?`Feasibility-first search exhausted state budget before completing slot ${l}.`:`Feasibility-first search found no branches that can still satisfy high-skill requirements by slot ${l}.`}),{beam:[],processedStates:P,stateBudgetHit:q};r.sort((u,m)=>{if(i.length>0){const k=_(u.focusSupport??[],p),v=_(m.focusSupport??[],p);if(k!==v)return k-v}const b=u.feasibilityAssigned??1/0,M=m.feasibilityAssigned??1/0;return b!==M?b-M:u.optimisticBound!==m.optimisticBound?m.optimisticBound-u.optimisticBound:u.roughScore!==m.roughScore?m.roughScore-u.roughScore:0}),x=r.slice(0,Math.max(40,a.beamWidth)),h?.({phase:"beam-search",processedStates:P,beamSize:x.length,totalSlots:s.length,expandedSlots:d+1,detail:`feasibility-first | branchCap=${o}${i.length>0?` | focus=${i.join("/")}`:""}`})}return{beam:x,processedStates:P,stateBudgetHit:q}}function we(t){const{slotOrder:s,candidatePools:n,baseSlots:e,catalog:c,constraints:a,signal:i,onProgress:h}=t,f=[],S=new Set;let p=0,g=0,x=0,P=0;const q=(d,l)=>{if(i?.aborted)throw new DOMException("Auto build cancelled","AbortError");if(p>a.maxStates)return;if(d>=s.length){if(!K(l,c,a.requiredMajorIds)){g++;return}const o=j({slots:l,level:a.level,characterClass:a.characterClass},c);if(!o.derived.skillpointFeasible){x++;return}const u=z(l);if(S.has(u)){P++;return}S.add(u);const{score:m,breakdown:b}=F(o,a.weights,a);f.push({slots:I(l),score:m,scoreBreakdown:b,summary:o});return}const y=s[d],r=n.get(y)??[];for(const o of r){if(p++,p>a.maxStates)break;l[y]=o.id,p%2e3===0&&h?.({phase:"exact-search",processedStates:p,beamSize:0,totalSlots:s.length,expandedSlots:d+1}),q(d+1,l)}l[y]=null};return q(0,I(e)),h?.({phase:"diagnostics",processedStates:p,beamSize:0,totalSlots:s.length,expandedSlots:s.length,detail:f.length>0?`Exact search produced ${f.length} valid builds. Rejected duplicates=${P}, SP-invalid=${x}, majorID=${g}.`:`Exact search produced 0 valid builds. Rejected SP-invalid=${x}, majorID=${g}, duplicates=${P}.`}),f.sort((d,l)=>{if(d.score!==l.score)return l.score-d.score;for(const y of T){const r=d.slots[y]??0,o=l.slots[y]??0;if(r!==o)return r-o}return 0}),f.slice(0,Math.max(1,a.topN))}function Be(t){const{catalog:s,baseWorkbench:n,constraints:e,onProgress:c,signal:a}=t;if(a?.aborted)throw new DOMException("Auto build cancelled","AbortError");let i=I(n.slots);for(const o of T)e.lockedSlots[o]||(i[o]=null);i=qe(i,s,e);const h=Pe(i,s),f=T.filter(o=>i[o]==null),S=e.onlyPinnedItems?Te(n):null,p=new Map;for(const o of f)p.set(o,ke(o,s,e,S?.[o]??null,h));const g=[...f].sort((o,u)=>{if(h.length>0){const M=H(o,p,s,h),k=H(u,p,s,h);if(M!==k)return k-M}const m=p.get(o)?.length??0,b=p.get(u)?.length??0;return m!==b?m-b:o.localeCompare(u)}),x=V(g,p);if(g.some(o=>(p.get(o)?.length??0)===0)){const o=g.find(u=>(p.get(u)?.length??0)===0);return c?.({phase:"diagnostics",processedStates:0,beamSize:0,totalSlots:g.length,expandedSlots:0,detail:o?`No candidate items available for slot ${o} under current hard filters.`:"One or more slots have empty candidate pools."}),[]}const P=ve(g,p,e.exhaustiveStateLimit+1);if(e.useExhaustiveSmallPool&&g.length>0&&P>0&&P<=e.exhaustiveStateLimit){c?.({phase:"exact-search",processedStates:0,beamSize:0,totalSlots:g.length,expandedSlots:0});const o={...e,maxStates:Math.max(e.maxStates,e.exhaustiveStateLimit)};return we({slotOrder:g,candidatePools:p,baseSlots:i,catalog:s,constraints:o,signal:a,onProgress:c})}let q=[{slots:i,orderIndex:0,roughScore:0,optimisticBound:x[0]}],d=0,l=!1;for(let o=0;o<g.length;o++){if(a?.aborted)throw new DOMException("Auto build cancelled","AbortError");const u=g[o],m=p.get(u),b=[],M=Y({poolSize:m.length,beamSize:q.length,remainingStages:g.length-o,processedStates:d,maxStates:e.maxStates});M<=0&&(l=!0);for(const k of q){let v=0;for(const w of m){if(v>=M)break;if(d>=e.maxStates){l=!0;break}d++,v++;const B=I(k.slots);B[u]=w.id;const G=k.roughScore+w.rough;b.push({slots:B,orderIndex:o+1,roughScore:G,optimisticBound:G+x[o+1]})}if(l)break}if(b.length===0)return c?.({phase:"diagnostics",processedStates:d,beamSize:q.length,totalSlots:g.length,expandedSlots:o,detail:l?`Search state budget exhausted before completing slot ${u}. Try enabling deep fallback/exact mode or reduce hard filters.`:`No expansions produced at slot ${u}.`}),[];b.sort((k,v)=>k.optimisticBound!==v.optimisticBound?v.optimisticBound-k.optimisticBound:v.roughScore-k.roughScore),q=b.slice(0,Math.max(20,e.beamWidth)),c?.({phase:"beam-search",processedStates:d,beamSize:q.length,totalSlots:g.length,expandedSlots:o+1,detail:`branchCap=${M}`})}let{candidates:y,rejectStats:r}=U({beam:q,catalog:s,constraints:e,signal:a});if(c?.({phase:"diagnostics",processedStates:d,beamSize:q.length,totalSlots:g.length,expandedSlots:g.length,detail:y.length>0?`Final eval: ${y.length} valid builds. Rejected duplicates=${r.duplicate}, SP-invalid=${r.spInvalid}, majorID=${r.majorIds}.`:`Final eval found 0 valid builds. Rejected SP-invalid=${r.spInvalid}, majorID=${r.majorIds}, duplicates=${r.duplicate}.`}),y.length===0&&r.spInvalid>0&&g.length>0){c?.({phase:"diagnostics",processedStates:d,beamSize:q.length,totalSlots:g.length,expandedSlots:g.length,detail:"Retrying with feasibility-first beam search (support-aware rescue for high-skill requirements)."});const o=Ie({slotOrder:g,candidatePools:p,baseSlots:i,catalog:s,constraints:{...e,maxStates:Math.max(e.maxStates,Math.min(8e6,e.maxStates*2)),beamWidth:Math.max(e.beamWidth,1800)},focusStats:h,onProgress:c,signal:a});if(o.beam.length>0){const u=U({beam:o.beam,catalog:s,constraints:e,signal:a});y=u.candidates,r=u.rejectStats,c?.({phase:"diagnostics",processedStates:o.processedStates,beamSize:o.beam.length,totalSlots:g.length,expandedSlots:g.length,detail:y.length>0?`Feasibility-first eval: ${y.length} valid builds. Rejected duplicates=${r.duplicate}, SP-invalid=${r.spInvalid}, majorID=${r.majorIds}.`:`Feasibility-first eval still found 0 valid builds. Rejected SP-invalid=${r.spInvalid}, majorID=${r.majorIds}, duplicates=${r.duplicate}.`})}}return y.slice(0,Math.max(1,e.topN))}const R=new Map;self.onmessage=t=>{const s=t.data;if(s.type==="cancel"){R.get(s.requestId)?.abort();return}const n=new AbortController;R.set(s.requestId,n);try{const e=Be({catalog:{...s.catalog,itemsById:new Map(s.catalog.itemsById),itemIdByName:new Map(s.catalog.itemIdByName),itemsByType:new Map(s.catalog.itemsByType),itemsByCategory:new Map(s.catalog.itemsByCategory)},baseWorkbench:s.baseWorkbench,constraints:s.constraints,signal:n.signal,onProgress:a=>{const i={type:"progress",requestId:s.requestId,progress:a};self.postMessage(i)}}),c={type:"result",requestId:s.requestId,candidates:e};self.postMessage(c)}catch(e){const c={type:"error",requestId:s.requestId,message:e instanceof Error?e.message:"Auto builder worker error"};self.postMessage(c)}finally{R.delete(s.requestId)}}})();
