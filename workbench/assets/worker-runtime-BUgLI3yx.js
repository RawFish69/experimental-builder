(function(){"use strict";function Z(e){return e.aggregated.hprTotal*.9+e.aggregated.mr*14+e.aggregated.ms*10+e.aggregated.ls*9}function ee(e,n){let s=0;const{target:t}=n;return typeof t.minLegacyBaseDps=="number"&&e.derived.legacyBaseDps<t.minLegacyBaseDps&&(s+=(t.minLegacyBaseDps-e.derived.legacyBaseDps)*4),typeof t.minLegacyEhp=="number"&&e.derived.legacyEhp<t.minLegacyEhp&&(s+=(t.minLegacyEhp-e.derived.legacyEhp)*.8),typeof t.minDpsProxy=="number"&&e.derived.dpsProxy<t.minDpsProxy&&(s+=(t.minDpsProxy-e.derived.dpsProxy)*4),typeof t.minEhpProxy=="number"&&e.derived.ehpProxy<t.minEhpProxy&&(s+=(t.minEhpProxy-e.derived.ehpProxy)*1.1),typeof t.minMr=="number"&&e.aggregated.mr<t.minMr&&(s+=(t.minMr-e.aggregated.mr)*45),typeof t.minMs=="number"&&e.aggregated.ms<t.minMs&&(s+=(t.minMs-e.aggregated.ms)*35),typeof t.minSpeed=="number"&&e.aggregated.speed<t.minSpeed&&(s+=(t.minSpeed-e.aggregated.speed)*12),typeof t.minSkillPointTotal=="number"&&e.derived.skillPointTotal<t.minSkillPointTotal&&(s+=(t.minSkillPointTotal-e.derived.skillPointTotal)*15),typeof t.maxReqTotal=="number"&&e.derived.reqTotal>t.maxReqTotal&&(s+=(e.derived.reqTotal-t.maxReqTotal)*8),s}function F(e,n,s){const t=Z(e),l=e.derived.reqTotal*n.reqTotalPenalty,i=ee(e,s),a={legacyBaseDps:e.derived.legacyBaseDps*n.legacyBaseDps,legacyEhp:e.derived.legacyEhp*n.legacyEhp,dpsProxy:e.derived.dpsProxy*n.dpsProxy,ehpProxy:e.derived.ehpProxy*n.ehpProxy,speed:e.aggregated.speed*n.speed,sustain:t*n.sustain,skillPointTotal:e.derived.skillPointTotal*n.skillPointTotal,reqPenalty:l,thresholdPenalty:i};return{score:a.legacyBaseDps+a.legacyEhp+a.dpsProxy+a.ehpProxy+a.speed+a.sustain+a.skillPointTotal-a.reqPenalty-a.thresholdPenalty,breakdown:a}}const k=["helmet","chestplate","leggings","boots","ring1","ring2","bracelet","necklace","weapon"],D=e=>e==="ring1"||e==="ring2"?"ring":e,te={spear:"Warrior",dagger:"Assassin",wand:"Mage",bow:"Archer",relik:"Shaman"};function ne(e){return te[e]??null}function se(e,n){return!n||!e.classReq?!0:e.classReq===n}const re={slotStatus:{},warnings:{messages:[]},aggregated:{hpTotal:0,hprTotal:0,mr:0,ms:0,ls:0,speed:0,skillPoints:{str:0,dex:0,int:0,def:0,agi:0},skillReqs:{str:0,dex:0,int:0,def:0,agi:0},defenses:{e:0,t:0,w:0,f:0,a:0},offense:{baseDps:0,spellPct:0,spellRaw:0,meleePct:0,meleeRaw:0,offenseScore:0}},derived:{dpsProxy:0,ehpProxy:0,reqTotal:0,skillPointTotal:0,legacyBaseDps:0,legacyEhp:0,legacyEhpNoAgi:0,skillpointFeasible:!0,assignedSkillPointsRequired:0}};function C(e){let n=Number.isFinite(e)?e:0;if(n<=0)return 0;n>=150&&(n=150);const s=.9908;return s/(1-s)*(1-Math.pow(s,n))/100}const oe=.867,ie=.951,ae=90;function le(e){return Math.max(1,Math.min(106,Math.round(e||1)))*5+5}function ce(e){const n=Math.max(1,Math.min(106,Math.round(e||1)));return n>=101?200:(n-1)*2}function de(e){switch(e){case"relik":return .6;case"bow":return .7;case"wand":return .8;case"dagger":case"spear":return 1;default:return 1}}function ue(e){const n=Math.max(5,e.totalHp),s=C(e.defSkillPoints)*oe,t=C(e.agiSkillPoints)*ie,i=2-de(e.weaponType),p=(100-ae)/100*t+(1-t)*(1-s),f=1-s,S=n/Math.max(1e-9,p)/Math.max(1e-9,i),h=n/Math.max(1e-9,f)/Math.max(1e-9,i);return{withAgi:S,noAgi:h}}function ge(e){return[e.numeric.reqStr,e.numeric.reqDex,e.numeric.reqInt,e.numeric.reqDef,e.numeric.reqAgi]}function fe(e){return[e.numeric.spStr,e.numeric.spDex,e.numeric.spInt,e.numeric.spDef,e.numeric.spAgi]}function pe(e,n){return[e[0]+n[0],e[1]+n[1],e[2]+n[2],e[3]+n[3],e[4]+n[4]]}function he(e){return e[0]+e[1]+e[2]+e[3]+e[4]}function $(e,n){for(let s=0;s<5;s++)if(e[s]>n[s])return!1;return!0}function me(e,n){for(const s of e)if($(s.assigned,n.assigned))return;for(let s=e.length-1;s>=0;s--)$(n.assigned,e[s].assigned)&&e.splice(s,1);e.push(n)}function Se(e,n){if(e.length===0)return{feasible:!0,assignedTotal:0};const s=ce(n),t=e.length,l=e.map(ge),i=e.map(fe),a=1<<t,p=Array.from({length:a},()=>[0,0,0,0,0]);for(let u=1;u<a;u++){const y=u&-u,b=Math.log2(y)|0;p[u]=pe(p[u^y],i[b])}const f=new Array(a);f[0]=[{assigned:[0,0,0,0,0],assignedTotal:0}];for(let u=0;u<a;u++){const y=f[u];if(!y||y.length===0)continue;const b=p[u];for(const P of y)for(let g=0;g<t;g++){if((u&1<<g)!==0)continue;const c=[...P.assigned];let m=!0;for(let x=0;x<5;x++){const q=P.assigned[x]+b[x],M=l[g][x];if(M>q&&(c[x]+=M-q),c[x]>100){m=!1;break}}if(!m)continue;const r=he(c);if(r>s)continue;const o=u|1<<g,d=f[o]??=[];me(d,{assigned:c,assignedTotal:r})}}const S=f[a-1];if(!S||S.length===0)return{feasible:!1,assignedTotal:1/0};let h=1/0;for(const u of S)u.assignedTotal<h&&(h=u.assignedTotal);return{feasible:Number.isFinite(h),assignedTotal:h}}function j(e,n,s){const t=[];for(const l of k){const i=e[l];if(i==null)continue;const a=n.itemsById.get(i);a&&t.push(a)}return Se(t,s)}function xe(e,n){const s={};for(const t of k){const l=e.slots[t];if(l==null)continue;const i=n.itemsById.get(l);i&&(s[t]=i)}return s}function L(e,n){const s=xe(e,n),t=structuredClone(re),l=t.warnings.messages;let i=null;for(const g of k){const c=s[g];if(!c)continue;g==="weapon"&&(i=c.type),t.aggregated.hpTotal+=c.numeric.hp+c.numeric.hpBonus,t.aggregated.hprTotal+=c.numeric.hprRaw+c.numeric.hprPct,t.aggregated.mr+=c.numeric.mr,t.aggregated.ms+=c.numeric.ms,t.aggregated.ls+=c.numeric.ls,t.aggregated.speed+=c.numeric.spd,t.aggregated.skillPoints.str+=c.numeric.spStr,t.aggregated.skillPoints.dex+=c.numeric.spDex,t.aggregated.skillPoints.int+=c.numeric.spInt,t.aggregated.skillPoints.def+=c.numeric.spDef,t.aggregated.skillPoints.agi+=c.numeric.spAgi,t.aggregated.skillReqs.str=Math.max(t.aggregated.skillReqs.str,c.numeric.reqStr),t.aggregated.skillReqs.dex=Math.max(t.aggregated.skillReqs.dex,c.numeric.reqDex),t.aggregated.skillReqs.int=Math.max(t.aggregated.skillReqs.int,c.numeric.reqInt),t.aggregated.skillReqs.def=Math.max(t.aggregated.skillReqs.def,c.numeric.reqDef),t.aggregated.skillReqs.agi=Math.max(t.aggregated.skillReqs.agi,c.numeric.reqAgi),t.aggregated.defenses.e+=c.numeric.eDef,t.aggregated.defenses.t+=c.numeric.tDef,t.aggregated.defenses.w+=c.numeric.wDef,t.aggregated.defenses.f+=c.numeric.fDef,t.aggregated.defenses.a+=c.numeric.aDef,t.aggregated.offense.baseDps+=c.numeric.baseDps,t.aggregated.offense.spellPct+=c.numeric.sdPct,t.aggregated.offense.spellRaw+=c.numeric.sdRaw,t.aggregated.offense.meleePct+=c.numeric.mdPct,t.aggregated.offense.meleeRaw+=c.numeric.mdRaw,t.aggregated.offense.offenseScore+=c.roughScoreFields.offense;const m=c.classReq,r=!m||!e.characterClass||m===e.characterClass,o=c.level<=e.level,d=c.numeric.reqStr<=100&&c.numeric.reqDex<=100&&c.numeric.reqInt<=100&&c.numeric.reqDef<=100&&c.numeric.reqAgi<=100;t.slotStatus[g]={classOk:r,levelOk:o,skillReqsMet:d}}!e.characterClass&&i&&(e.characterClass=ne(i));for(const g of k){const c=s[g];c&&(D(g)!==c.category&&l.push(`${g} contains incompatible item type (${c.type}).`),c.level>e.level&&l.push(`${c.displayName} requires level ${c.level}.`),e.characterClass&&c.classReq&&c.classReq!==e.characterClass&&l.push(`${c.displayName} requires ${c.classReq}.`),(c.restricted||c.deprecated)&&l.push(`${c.displayName} is restricted/deprecated.`))}const a=t.aggregated.skillReqs.str+t.aggregated.skillReqs.dex+t.aggregated.skillReqs.int+t.aggregated.skillReqs.def+t.aggregated.skillReqs.agi,p=t.aggregated.skillPoints.str+t.aggregated.skillPoints.dex+t.aggregated.skillPoints.int+t.aggregated.skillPoints.def+t.aggregated.skillPoints.agi,f=j(e.slots,n,e.level),S=t.aggregated.offense.baseDps+t.aggregated.offense.spellPct*1.3+t.aggregated.offense.spellRaw*.12+t.aggregated.offense.meleePct*1.1+t.aggregated.offense.meleeRaw*.12+t.aggregated.speed*.8,h=t.aggregated.defenses.e+t.aggregated.defenses.t+t.aggregated.defenses.w+t.aggregated.defenses.f+t.aggregated.defenses.a,u=t.aggregated.hpTotal+h*.45+t.aggregated.hprTotal*2+Math.max(0,t.aggregated.skillPoints.def)*12+Math.max(0,t.aggregated.skillPoints.agi)*10,y=t.aggregated.offense.baseDps,b=le(e.level)+t.aggregated.hpTotal,P=ue({totalHp:b,defSkillPoints:t.aggregated.skillPoints.def,agiSkillPoints:t.aggregated.skillPoints.agi,weaponType:i});return t.derived={dpsProxy:S,ehpProxy:u,reqTotal:a,skillPointTotal:p,legacyBaseDps:y,legacyEhp:P.withAgi,legacyEhpNoAgi:P.noAgi,skillpointFeasible:f.feasible,assignedSkillPointsRequired:Number.isFinite(f.assignedTotal)?f.assignedTotal:0},f.feasible||l.push(`Skill requirements are not satisfiable at level ${e.level} (estimated assigned SP exceeds available or equip order is invalid).`),t}const N=["str","dex","int","def","agi"],A=["SUPER_SLOW","VERY_SLOW","SLOW","NORMAL","FAST","VERY_FAST","SUPER_FAST"];function R(e,n){switch(n){case"str":return Math.max(0,e.numeric.spStr);case"dex":return Math.max(0,e.numeric.spDex);case"int":return Math.max(0,e.numeric.spInt);case"def":return Math.max(0,e.numeric.spDef);case"agi":return Math.max(0,e.numeric.spAgi)}}function ye(e,n){switch(n){case"str":return e.numeric.reqStr;case"dex":return e.numeric.reqDex;case"int":return e.numeric.reqInt;case"def":return e.numeric.reqDef;case"agi":return e.numeric.reqAgi}}function Pe(e,n){if(n.length===0)return 0;let s=0;for(const t of n)s+=R(e,t)*10,s-=Math.max(0,ye(e,t))*.7;return s-=Math.max(0,e.roughScoreFields.reqTotal)*.12,s}function I(e){return{...e}}function be(e,n){const s=e.weapon;if(s==null)return null;const t=n.itemsById.get(s);if(!t)return null;const l=A.indexOf(t.atkSpd);if(l<0)return null;let i=0;for(const p of k){const f=e[p];if(f==null)continue;const S=n.itemsById.get(f);S&&(i+=Math.round(S.numeric.atkTier||0))}const a=Math.max(0,Math.min(A.length-1,l+i));return A[a]}function qe(e,n){const{target:s}=n;return!(typeof s.minLegacyBaseDps=="number"&&e.derived.legacyBaseDps<s.minLegacyBaseDps||typeof s.minLegacyEhp=="number"&&e.derived.legacyEhp<s.minLegacyEhp||typeof s.minDpsProxy=="number"&&e.derived.dpsProxy<s.minDpsProxy||typeof s.minEhpProxy=="number"&&e.derived.ehpProxy<s.minEhpProxy||typeof s.minMr=="number"&&e.aggregated.mr<s.minMr||typeof s.minMs=="number"&&e.aggregated.ms<s.minMs||typeof s.minSpeed=="number"&&e.aggregated.speed<s.minSpeed||typeof s.minSkillPointTotal=="number"&&e.derived.skillPointTotal<s.minSkillPointTotal||typeof s.maxReqTotal=="number"&&e.derived.reqTotal>s.maxReqTotal)}function z(e,n,s,t){for(const l of k){const i=e[l];if(i==null)continue;const a=n.itemsById.get(i);if(!a||!O(a,s))return!1}if(s.weaponAttackSpeeds.length>0){const l=be(e,n);if(!l||!s.weaponAttackSpeeds.includes(l))return!1}return qe(t,s)}function O(e,n){return!(!n.allowRestricted&&(e.restricted||e.deprecated)||e.level>n.level||!se(e,n.characterClass)||n.excludedIds.includes(e.id)||n.allowedTiers.length>0&&!n.allowedTiers.includes(e.tier)||n.minPowderSlots!=null&&e.powderSlots<n.minPowderSlots||n.excludedMajorIds.length>0&&n.excludedMajorIds.some(s=>e.majorIds.includes(s)))}function Me(e,n){return e.numeric.baseDps*n.weights.legacyBaseDps+e.roughScoreFields.ehpProxy*n.weights.legacyEhp+e.roughScoreFields.offense*n.weights.dpsProxy+e.roughScoreFields.ehpProxy*n.weights.ehpProxy+e.numeric.spd*n.weights.speed+e.roughScoreFields.utility*n.weights.sustain+e.roughScoreFields.skillPointTotal*n.weights.skillPointTotal-e.roughScoreFields.reqTotal*n.weights.reqTotalPenalty}function _(e){const n=e.ring1??0,s=e.ring2??0,[t,l]=n<=s?[n,s]:[s,n];return[e.helmet??0,e.chestplate??0,e.leggings??0,e.boots??0,t,l,e.bracelet??0,e.necklace??0,e.weapon??0].join("|")}function W(e,n){return D(n)===e.category}function ke(e,n,s){const t=I(e),l=new Set(k.filter(i=>t[i]!=null));for(const i of s.mustIncludeIds){const a=n.itemsById.get(i);if(!a)continue;const f=k.filter(S=>!l.has(S)&&W(a,S))[0];f&&(t[f]=a.id,l.add(f))}return t}function Te(e,n){const s={str:0,dex:0,int:0,def:0,agi:0};for(const l of k){const i=e[l];if(i==null)continue;const a=n.itemsById.get(i);a&&(s.str=Math.max(s.str,a.numeric.reqStr),s.dex=Math.max(s.dex,a.numeric.reqDex),s.int=Math.max(s.int,a.numeric.reqInt),s.def=Math.max(s.def,a.numeric.reqDef),s.agi=Math.max(s.agi,a.numeric.reqAgi))}const t=N.filter(l=>s[l]>100).sort((l,i)=>s[i]-s[l]);return t.length>0?t:N.filter(l=>s[l]>=70).sort((l,i)=>s[i]-s[l]).slice(0,2)}function ve(e,n,s){if(s.length===0)return[];const t={str:0,dex:0,int:0,def:0,agi:0};for(const l of k){const i=e[l];if(i==null)continue;const a=n.itemsById.get(i);a&&(t.str=Math.max(t.str,a.numeric.reqStr),t.dex=Math.max(t.dex,a.numeric.reqDex),t.int=Math.max(t.int,a.numeric.reqInt),t.def=Math.max(t.def,a.numeric.reqDef),t.agi=Math.max(t.agi,a.numeric.reqAgi))}return s.map(l=>Math.max(0,t[l]-100))}function H(e,n){return n.map(s=>R(e,s))}function V(e,n){if(e.length===0)return n.slice();const s=new Array(e.length);for(let t=0;t<e.length;t++)s[t]=(e[t]??0)+(n[t]??0);return s}function Ie(e,n,s){for(let t=0;t<s.length;t++)if((e[t]??0)+(n[t]??0)<s[t])return!1;return!0}function Y(e,n){let s=0;for(let t=0;t<n.length;t++)s+=Math.max(0,n[t]-(e[t]??0));return s}function K(e,n,s,t){if(t.length===0)return 0;const l=n.get(e)??[];let i=0;for(const a of l){const p=s.itemsById.get(a.id);if(!p)continue;let f=0;for(const S of t)f+=R(p,S);f>i&&(i=f)}return i}function we(e,n,s,t,l=[]){const i=[];for(const r of n.items)W(r,e)&&(t&&!t.has(r.id)||O(r,s)&&i.push({id:r.id,rough:Me(r,s),reqTotal:r.roughScoreFields.reqTotal,skillPointTotal:r.roughScoreFields.skillPointTotal,utility:r.roughScoreFields.utility+r.numeric.spd*.8,level:r.level,spStr:r.numeric.spStr,spDex:r.numeric.spDex,spInt:r.numeric.spInt,spDef:r.numeric.spDef,spAgi:r.numeric.spAgi,supportFocus:Pe(r,l)}));const a=[...i].sort((r,o)=>r.rough!==o.rough?o.rough-r.rough:r.id-o.id),p=[...i].sort((r,o)=>r.reqTotal!==o.reqTotal?r.reqTotal-o.reqTotal:r.level!==o.level?r.level-o.level:r.id-o.id),f=[...i].sort((r,o)=>r.skillPointTotal!==o.skillPointTotal?o.skillPointTotal-r.skillPointTotal:r.reqTotal!==o.reqTotal?r.reqTotal-o.reqTotal:r.id-o.id),S=[...i].sort((r,o)=>r.utility!==o.utility?o.utility-r.utility:r.reqTotal!==o.reqTotal?r.reqTotal-o.reqTotal:r.id-o.id),h=l.length>0?[...i].sort((r,o)=>r.supportFocus!==o.supportFocus?o.supportFocus-r.supportFocus:r.reqTotal!==o.reqTotal?r.reqTotal-o.reqTotal:r.skillPointTotal!==o.skillPointTotal?o.skillPointTotal-r.skillPointTotal:r.id-o.id):[],u=l.map(r=>[...i].sort((o,d)=>{const x=r==="str"?o.spStr:r==="dex"?o.spDex:r==="int"?o.spInt:r==="def"?o.spDef:o.spAgi,q=r==="str"?d.spStr:r==="dex"?d.spDex:r==="int"?d.spInt:r==="def"?d.spDef:d.spAgi;return x!==q?q-x:o.reqTotal!==d.reqTotal?o.reqTotal-d.reqTotal:o.supportFocus!==d.supportFocus?d.supportFocus-o.supportFocus:o.id-d.id})),y=Math.max(10,s.topKPerSlot),b=Math.min(140,Math.max(40,Math.floor(y*.8))),P=Math.min(i.length,y+b+(l.length>0?Math.min(60,l.length*12):0)),g=new Map,c=Math.min(12,Math.floor(y*.4),a.length);for(let r=0;r<c;r++){const o=a[r];g.set(o.id,{id:o.id,rough:o.rough})}const m=[{list:a,remaining:Math.max(0,y-c),cursor:0},{list:p,remaining:Math.floor(b*.28),cursor:0},{list:f,remaining:Math.floor(b*.24),cursor:0},{list:S,remaining:Math.floor(b*.18),cursor:0}];h.length>0&&m.push({list:h,remaining:Math.max(16,Math.floor(b*.2)),cursor:0});for(const r of u)m.push({list:r,remaining:10,cursor:0});for(;g.size<P;){let r=!1;for(const o of m)if(!(o.remaining<=0))for(;o.cursor<o.list.length;){const d=o.list[o.cursor++];if(!g.has(d.id)){g.set(d.id,{id:d.id,rough:d.rough}),o.remaining--,r=!0;break}}if(!r)break}if(g.size<P)for(const r of a){if(g.size>=P)break;g.has(r.id)||g.set(r.id,{id:r.id,rough:r.rough})}return[...g.values()]}function Be(e){const n={};for(const s of k){const t=D(s),l=new Set(e.binsByCategory[t]??[]),i=e.slots[s];i!=null&&l.add(i),n[s]=l}return n}function U(e,n,s){if(s.length===0)return!0;const t=new Set;for(const l of k){const i=e[l];if(i==null)continue;const a=n.itemsById.get(i);if(a)for(const p of a.majorIds)s.includes(p)&&t.add(p)}return s.every(l=>t.has(l))}function G(e,n){const s=new Array(e.length+1).fill(0);for(let t=e.length-1;t>=0;t--){const l=e[t],i=n.get(l)??[];let a=0;for(const p of i)p.rough>a&&(a=p.rough);s[t]=s[t+1]+a}return s}function J(e){const{poolSize:n,beamSize:s,remainingStages:t,processedStates:l,maxStates:i}=e;if(n<=0)return 0;const a=Math.max(0,i-l),p=Math.max(1,s*Math.max(1,t)),f=Math.floor(a/p),S=Math.max(8,Math.min(64,f));return Math.min(n,S)}function De(e,n,s){let t=1;for(const l of e){const i=n.get(l)?.length??0;if(i===0)return 0;if(t*=i,t>s)return t}return t}function Q(e){const{beam:n,catalog:s,constraints:t,signal:l}=e,i=[],a=new Set,p={majorIds:0,spInvalid:0,duplicate:0,hardConstraints:0};for(const f of n){if(l?.aborted)throw new DOMException("Auto build cancelled","AbortError");if(!U(f.slots,s,t.requiredMajorIds)){p.majorIds++;continue}const S=L({slots:f.slots,level:t.level,characterClass:t.characterClass},s);if(!S.derived.skillpointFeasible){p.spInvalid++;continue}if(!z(f.slots,s,t,S)){p.hardConstraints++;continue}const h=_(f.slots);if(a.has(h)){p.duplicate++;continue}const{score:u,breakdown:y}=F(S,t.weights,t);a.add(h),i.push({slots:I(f.slots),score:u,scoreBreakdown:y,summary:S})}return i.sort((f,S)=>{if(f.score!==S.score)return S.score-f.score;for(const h of k){const u=f.slots[h]??0,y=S.slots[h]??0;if(u!==y)return u-y}return 0}),{candidates:i,rejectStats:p}}function Ae(e){const{slotOrder:n,candidatePools:s,baseSlots:t,catalog:l,constraints:i,focusStats:a,onProgress:p,signal:f}=e,S=G(n,s),h=ve(t,l,a),u=Array.from({length:n.length+1},()=>a.map(()=>0));for(let g=n.length-1;g>=0;g--){const c=s.get(n[g])??[],m=a.map(()=>0);for(const r of c){const o=l.itemsById.get(r.id);if(!o)continue;const d=H(o,a);for(let x=0;x<d.length;x++)d[x]>m[x]&&(m[x]=d[x])}u[g]=V(u[g+1],m)}let y=[{slots:I(t),orderIndex:0,roughScore:0,optimisticBound:S[0],feasibilityAssigned:0,focusSupport:a.map(()=>0)}],b=0,P=!1;for(let g=0;g<n.length;g++){if(f?.aborted)throw new DOMException("Auto build cancelled","AbortError");const c=n[g],m=s.get(c)??[],r=[],o=J({poolSize:m.length,beamSize:y.length,remainingStages:n.length-g,processedStates:b,maxStates:i.maxStates});o<=0&&(P=!0);for(const d of y){let x=0;for(const q of m){if(x>=o)break;if(b>=i.maxStates){P=!0;break}b++,x++;const M=I(d.slots);M[c]=q.id;const T=l.itemsById.get(q.id),v=V(d.focusSupport??a.map(()=>0),T?H(T,a):a.map(()=>0));if(a.length>0&&!Ie(v,u[g+1],h))continue;const w=j(M,l,i.level),B=d.roughScore+q.rough;r.push({slots:M,orderIndex:g+1,roughScore:B,optimisticBound:B+S[g+1],feasibilityAssigned:w.feasible?w.assignedTotal:1/0,focusSupport:v})}if(P)break}if(r.length===0)return p?.({phase:"diagnostics",processedStates:b,beamSize:y.length,totalSlots:n.length,expandedSlots:g,detail:P?`Feasibility-first search exhausted state budget before completing slot ${c}.`:`Feasibility-first search found no branches that can still satisfy high-skill requirements by slot ${c}.`}),{beam:[],processedStates:b,stateBudgetHit:P};r.sort((d,x)=>{if(a.length>0){const T=Y(d.focusSupport??[],h),v=Y(x.focusSupport??[],h);if(T!==v)return T-v}const q=d.feasibilityAssigned??1/0,M=x.feasibilityAssigned??1/0;return q!==M?q-M:d.optimisticBound!==x.optimisticBound?x.optimisticBound-d.optimisticBound:d.roughScore!==x.roughScore?x.roughScore-d.roughScore:0}),y=r.slice(0,Math.max(40,i.beamWidth)),p?.({phase:"beam-search",processedStates:b,beamSize:y.length,totalSlots:n.length,expandedSlots:g+1,detail:`feasibility-first | branchCap=${o}${a.length>0?` | focus=${a.join("/")}`:""}`})}return{beam:y,processedStates:b,stateBudgetHit:P}}function Re(e){const{slotOrder:n,candidatePools:s,baseSlots:t,catalog:l,constraints:i,signal:a,onProgress:p}=e,f=[],S=new Set;let h=0,u=0,y=0,b=0,P=0;const g=(c,m)=>{if(a?.aborted)throw new DOMException("Auto build cancelled","AbortError");if(h>i.maxStates)return;if(c>=n.length){if(!U(m,l,i.requiredMajorIds)){u++;return}const d=L({slots:m,level:i.level,characterClass:i.characterClass},l);if(!d.derived.skillpointFeasible){y++;return}if(!z(m,l,i,d)){P++;return}const x=_(m);if(S.has(x)){b++;return}S.add(x);const{score:q,breakdown:M}=F(d,i.weights,i);f.push({slots:I(m),score:q,scoreBreakdown:M,summary:d});return}const r=n[c],o=s.get(r)??[];for(const d of o){if(h++,h>i.maxStates)break;m[r]=d.id,h%2e3===0&&p?.({phase:"exact-search",processedStates:h,beamSize:0,totalSlots:n.length,expandedSlots:c+1}),g(c+1,m)}m[r]=null};return g(0,I(t)),p?.({phase:"diagnostics",processedStates:h,beamSize:0,totalSlots:n.length,expandedSlots:n.length,detail:f.length>0?`Exact search produced ${f.length} valid builds. Rejected duplicates=${b}, SP-invalid=${y}, majorID=${u}, hard=${P}.`:`Exact search produced 0 valid builds. Rejected SP-invalid=${y}, majorID=${u}, duplicates=${b}, hard=${P}.`}),f.sort((c,m)=>{if(c.score!==m.score)return m.score-c.score;for(const r of k){const o=c.slots[r]??0,d=m.slots[r]??0;if(o!==d)return o-d}return 0}),f.slice(0,Math.max(1,i.topN))}function Ee(e){const{catalog:n,baseWorkbench:s,constraints:t,onProgress:l,signal:i}=e;if(i?.aborted)throw new DOMException("Auto build cancelled","AbortError");let a=I(s.slots);for(const o of k)t.lockedSlots[o]||(a[o]=null);a=ke(a,n,t);const p=Te(a,n),f=k.filter(o=>a[o]==null),S=t.onlyPinnedItems?Be(s):null,h=new Map;for(const o of f)h.set(o,we(o,n,t,S?.[o]??null,p));const u=[...f].sort((o,d)=>{if(p.length>0){const M=K(o,h,n,p),T=K(d,h,n,p);if(M!==T)return T-M}const x=h.get(o)?.length??0,q=h.get(d)?.length??0;return x!==q?x-q:o.localeCompare(d)}),y=G(u,h);if(u.some(o=>(h.get(o)?.length??0)===0)){const o=u.find(d=>(h.get(d)?.length??0)===0);return l?.({phase:"diagnostics",processedStates:0,beamSize:0,totalSlots:u.length,expandedSlots:0,detail:o?`No candidate items available for slot ${o} under current hard filters.`:"One or more slots have empty candidate pools."}),[]}const b=De(u,h,t.exhaustiveStateLimit+1);if(t.useExhaustiveSmallPool&&u.length>0&&b>0&&b<=t.exhaustiveStateLimit){l?.({phase:"exact-search",processedStates:0,beamSize:0,totalSlots:u.length,expandedSlots:0});const o={...t,maxStates:Math.max(t.maxStates,t.exhaustiveStateLimit)};return Re({slotOrder:u,candidatePools:h,baseSlots:a,catalog:n,constraints:o,signal:i,onProgress:l})}let P=[{slots:a,orderIndex:0,roughScore:0,optimisticBound:y[0]}],g=0,c=!1;for(let o=0;o<u.length;o++){if(i?.aborted)throw new DOMException("Auto build cancelled","AbortError");const d=u[o],x=h.get(d),q=[],M=J({poolSize:x.length,beamSize:P.length,remainingStages:u.length-o,processedStates:g,maxStates:t.maxStates});M<=0&&(c=!0);for(const T of P){let v=0;for(const w of x){if(v>=M)break;if(g>=t.maxStates){c=!0;break}g++,v++;const B=I(T.slots);B[d]=w.id;const X=T.roughScore+w.rough;q.push({slots:B,orderIndex:o+1,roughScore:X,optimisticBound:X+y[o+1]})}if(c)break}if(q.length===0)return l?.({phase:"diagnostics",processedStates:g,beamSize:P.length,totalSlots:u.length,expandedSlots:o,detail:c?`Search state budget exhausted before completing slot ${d}. Try enabling deep fallback/exact mode or reduce hard filters.`:`No expansions produced at slot ${d}.`}),[];q.sort((T,v)=>T.optimisticBound!==v.optimisticBound?v.optimisticBound-T.optimisticBound:v.roughScore-T.roughScore),P=q.slice(0,Math.max(20,t.beamWidth)),l?.({phase:"beam-search",processedStates:g,beamSize:P.length,totalSlots:u.length,expandedSlots:o+1,detail:`branchCap=${M}`})}let{candidates:m,rejectStats:r}=Q({beam:P,catalog:n,constraints:t,signal:i});if(l?.({phase:"diagnostics",processedStates:g,beamSize:P.length,totalSlots:u.length,expandedSlots:u.length,detail:m.length>0?`Final eval: ${m.length} valid builds. Rejected duplicates=${r.duplicate}, SP-invalid=${r.spInvalid}, majorID=${r.majorIds}, hard=${r.hardConstraints}.`:`Final eval found 0 valid builds. Rejected SP-invalid=${r.spInvalid}, majorID=${r.majorIds}, duplicates=${r.duplicate}, hard=${r.hardConstraints}.`}),m.length===0&&r.spInvalid>0&&u.length>0){l?.({phase:"diagnostics",processedStates:g,beamSize:P.length,totalSlots:u.length,expandedSlots:u.length,detail:"Retrying with feasibility-first beam search (support-aware rescue for high-skill requirements)."});const o=Ae({slotOrder:u,candidatePools:h,baseSlots:a,catalog:n,constraints:{...t,maxStates:Math.max(t.maxStates,Math.min(8e6,t.maxStates*2)),beamWidth:Math.max(t.beamWidth,1800)},focusStats:p,onProgress:l,signal:i});if(o.beam.length>0){const d=Q({beam:o.beam,catalog:n,constraints:t,signal:i});m=d.candidates,r=d.rejectStats,l?.({phase:"diagnostics",processedStates:o.processedStates,beamSize:o.beam.length,totalSlots:u.length,expandedSlots:u.length,detail:m.length>0?`Feasibility-first eval: ${m.length} valid builds. Rejected duplicates=${r.duplicate}, SP-invalid=${r.spInvalid}, majorID=${r.majorIds}, hard=${r.hardConstraints}.`:`Feasibility-first eval still found 0 valid builds. Rejected SP-invalid=${r.spInvalid}, majorID=${r.majorIds}, duplicates=${r.duplicate}, hard=${r.hardConstraints}.`})}}return m.slice(0,Math.max(1,t.topN))}const E=new Map;self.onmessage=e=>{const n=e.data;if(n.type==="cancel"){E.get(n.requestId)?.abort();return}const s=new AbortController;E.set(n.requestId,s);try{const t=Ee({catalog:{...n.catalog,itemsById:new Map(n.catalog.itemsById),itemIdByName:new Map(n.catalog.itemIdByName),itemsByType:new Map(n.catalog.itemsByType),itemsByCategory:new Map(n.catalog.itemsByCategory)},baseWorkbench:n.baseWorkbench,constraints:n.constraints,signal:s.signal,onProgress:i=>{const a={type:"progress",requestId:n.requestId,progress:i};self.postMessage(a)}}),l={type:"result",requestId:n.requestId,candidates:t};self.postMessage(l)}catch(t){const l={type:"error",requestId:n.requestId,message:t instanceof Error?t.message:"Auto builder worker error"};self.postMessage(l)}finally{E.delete(n.requestId)}}})();
