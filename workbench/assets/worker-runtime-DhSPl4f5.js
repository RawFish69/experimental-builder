(function(){"use strict";const J=["helmet","chestplate","leggings","boots"],Q=["spear","wand","dagger","bow","relik"],Z=["ring","bracelet","necklace"],ee=["SLOW","NORMAL","FAST"];function j(e){const t=e.toLowerCase();return J.includes(t)?"armor":Q.includes(t)?"weapon":Z.includes(t)?"accessory":"consumable"}const L=4e3,K=[0,1,1.25,1.4],_=["e","t","w","f","a"],te=[{min:3,max:6,convert:17,defPlus:2,defMinus:1},{min:5,max:8,convert:21,defPlus:4,defMinus:2},{min:6,max:10,convert:25,defPlus:8,defMinus:3},{min:7,max:10,convert:31,defPlus:14,defMinus:5},{min:9,max:11,convert:38,defPlus:22,defMinus:9},{min:11,max:13,convert:46,defPlus:30,defMinus:13},{min:1,max:8,convert:9,defPlus:3,defMinus:1},{min:1,max:12,convert:11,defPlus:5,defMinus:1},{min:2,max:15,convert:13,defPlus:9,defMinus:2},{min:3,max:15,convert:17,defPlus:14,defMinus:4},{min:4,max:17,convert:22,defPlus:20,defMinus:7},{min:5,max:20,convert:28,defPlus:28,defMinus:10},{min:3,max:4,convert:13,defPlus:3,defMinus:1},{min:4,max:6,convert:15,defPlus:6,defMinus:1},{min:5,max:8,convert:17,defPlus:11,defMinus:2},{min:6,max:8,convert:21,defPlus:18,defMinus:4},{min:7,max:10,convert:26,defPlus:28,defMinus:7},{min:9,max:11,convert:32,defPlus:40,defMinus:10},{min:2,max:5,convert:14,defPlus:3,defMinus:1},{min:4,max:8,convert:16,defPlus:5,defMinus:2},{min:5,max:9,convert:19,defPlus:9,defMinus:3},{min:6,max:9,convert:24,defPlus:16,defMinus:5},{min:8,max:10,convert:30,defPlus:25,defMinus:9},{min:10,max:12,convert:37,defPlus:36,defMinus:13},{min:2,max:6,convert:11,defPlus:3,defMinus:1},{min:3,max:10,convert:14,defPlus:6,defMinus:2},{min:4,max:11,convert:17,defPlus:10,defMinus:3},{min:5,max:11,convert:22,defPlus:16,defMinus:5},{min:7,max:12,convert:28,defPlus:24,defMinus:9},{min:8,max:14,convert:35,defPlus:34,defMinus:13}];function ne(e){return e/6|0}function oe(e){return _[ne(e)]}function se(e){const t=[[100,100],[100,100],[100,100]];for(let o=0;o<6;o++){const i=e[o].posMods,s=Math.floor(o/2),a=o%2;if(i.above!==0)for(let n=s-1;n>=0;n--)t[n][a]+=i.above;if(i.under!==0)for(let n=s+1;n<3;n++)t[n][a]+=i.under;if(i.left!==0&&a===1&&(t[s][a-1]+=i.left),i.right!==0&&a===0&&(t[s][a+1]+=i.right),i.touching!==0)for(let n=0;n<3;n++)for(let c=0;c<2;c++)(Math.abs(n-s)===1&&c===a||n===s&&Math.abs(c-a)===1)&&(t[n][c]+=i.touching);if(i.notTouching!==0)for(let n=0;n<3;n++)for(let c=0;c<2;c++)(Math.abs(n-s)>1||Math.abs(n-s)===1&&Math.abs(c-a)===1)&&(t[n][c]+=i.notTouching)}return t.flat()}function F(e,t,o,r){const i=e.type.toLowerCase(),s=j(i);let a=!0;for(const u of o)if(u.id!==L){a=!1;break}let n=0,c=0;(s==="weapon"||s==="armor")&&(e.lvl[0]<30?n=1:e.lvl[0]<70?n=2:n=3),s==="consumable"&&(e.lvl[0]<30?c=1:e.lvl[0]<70?c=2:c=3,a&&(c=3));const h=e.materials.map(u=>u.amount),p=(K[t[0]]*h[0]+K[t[1]]*h[1])/(h[0]+h[1]);let d=[e.durability[0],e.durability[1]],f=[e.duration[0],e.duration[1]];s==="consumable"?(a&&(f=[e.basicDuration[0],e.basicDuration[1]]),f=[Math.round(f[0]*p),Math.round(f[1]*p)]):d=[Math.round(d[0]*p),Math.round(d[1]*p)];const m=e.healthOrDamage[0],P=e.healthOrDamage[1];let l=0,D=0,M="0-0",x="0-0";const y={e:0,t:0,w:0,f:0,a:0};if(s==="armor")l=Math.floor(P*p),D=Math.floor(m*p);else if(s==="weapon"){let u=2.05;r==="SLOW"?u/=1.5:r==="NORMAL"?u=1:r==="FAST"&&(u/=2.5);const g=Math.floor(Math.floor(m*p)*u),w=Math.floor(Math.floor(P*p)*u);x=`${Math.floor(g*.9)}-${Math.floor(g*1.1)}`,M=`${Math.floor(w*.9)}-${Math.floor(w*1.1)}`}else s==="consumable"&&a&&(l=Math.floor(P*p),D=Math.floor(m*p));if(s==="armor"||s==="accessory"){for(const u of o)if(u.isPowder&&u.pid!=null){const g=te[u.pid],w=oe(u.pid),O=_[(_.indexOf(w)+4)%5];y[w]=(y[w]||0)+g.defPlus,y[O]=(y[O]||0)-g.defMinus}}const k=se(o),E=[0,0,0,0,0],q={},A={};for(let u=0;u<6;u++){const g=o[u],w=k[u]/100,O=g.itemIDs;if(s!=="consumable"){const T=["strReq","dexReq","intReq","defReq","agiReq"];for(let v=0;v<T.length;v++){const C=O[T[v]];C!==0&&(g.isPowder?E[v]+=Math.round(C):E[v]+=Math.round(C*w))}}O.dura!==0&&(d[0]+=O.dura,d[1]+=O.dura),g.consumableIDs.dura!==0&&(f[0]+=g.consumableIDs.dura,f[1]+=g.consumableIDs.dura),g.consumableIDs.charges!==0&&(c+=g.consumableIDs.charges);for(const[T,v]of Object.entries(g.ids)){if(v.max===0&&v.min===0)continue;let C=v.min,$=v.max;const X=[Math.floor(C*w),Math.floor($*w)].sort((ye,Se)=>ye-Se);C=X[0],$=X[1],A[T]=(A[T]??0)+C,q[T]=(q[T]??0)+$}}return d[0]=Math.max(1,Math.floor(d[0])),d[1]=Math.max(1,Math.floor(d[1])),a||(f[0]=Math.max(10,f[0]),f[1]=Math.max(10,f[1])),c=Math.max(c,s==="consumable"?1:0),{category:s,type:i,lvl:e.lvl[1],hp:l,hpLow:D,nDam:M,nDamLow:x,eDam:"0-0",tDam:"0-0",wDam:"0-0",fDam:"0-0",aDam:"0-0",eDef:y.e,tDef:y.t,wDef:y.w,fDef:y.f,aDef:y.a,atkSpd:r,durability:d,duration:f,charges:c,slots:n,reqs:[E[0],E[1],E[2],E[3],E[4]],effectiveness:k,maxRolls:q,minRolls:A}}function re(e,t,o,r,i){const s={SLOW:0,NORMAL:1,FAST:2},a=[];function n(d,f){for(let m=f-1;m>=0;m--)a.push(d>>m&1)}n(0,1),n(2,7);for(const d of e)n(d,12);n(t,12),n(o[0]-1,3),n(o[1]-1,3),i==="weapon"&&n(s[r]??0,4);const c=a.length%6;if(c!==0)for(let d=0;d<6-c;d++)a.push(0);const h="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz+-";let p="";for(let d=0;d<a.length;d+=6){let f=0;for(let m=0;m<6;m++)f=f<<1|(a[d+m]??0);p+=h[f]}return"CR-"+p}const Y=["sdPct","sdRaw","mdPct","mdRaw","damPct","poison","fDamPct","wDamPct","aDamPct","tDamPct","eDamPct","spPct1","spRaw1","spPct2","spRaw2","spPct3","spRaw3","spPct4","spRaw4","rSdRaw","critDamPct"],W=["hpBonus","hprRaw","hprPct","fDefPct","wDefPct","aDefPct","tDefPct","eDefPct"],U=["mr","ms","ls","spd","xpb","lb","ref","thorns","spRegen","eSteal","sprint","sprintReg","jh","lq","gXp","gSpd"],H=["str","dex","int","def","agi"];function z(e,t){let o=0;for(const r of t){const i=e.maxRolls[r]??0;i>0&&(o+=i)}return o}function ie(e,t){let o=0;for(const r of t)o+=e.maxRolls[r]??0;return o}function ae(e){let t=z(e,Y);return e.category==="armor"&&(t+=e.hp*.02),t}function le(e){let t=z(e,W);return e.category==="armor"&&(t+=e.hp*.15),t+=Math.max(0,e.eDef)+Math.max(0,e.tDef)+Math.max(0,e.wDef)+Math.max(0,e.fDef)+Math.max(0,e.aDef),t}function ce(e){let t=0;const o=e.maxRolls.mr??0,r=e.maxRolls.ms??0,i=e.maxRolls.ls??0,s=e.maxRolls.spd??0;t+=o*12+r*8+i*6+s*3;for(const a of U){if(a==="mr"||a==="ms"||a==="ls"||a==="spd")continue;const n=e.maxRolls[a]??0;n>0&&(t+=n)}return t}function fe(e){return ie(e,H)}function de(e){let t=0;for(const o of e.reqs)t+=Math.max(0,o);return t}function G(e,t){if(t==="durability")return[e.durability[0],e.durability[1]];if(t==="duration")return[e.duration[0],e.duration[1]];const o=e.maxRolls[t]??0;return[o,o]}function ue(e,t){let o=0;for(const[r,i]of Object.entries(t)){const[s,a]=G(e,r);if(typeof i.min=="number"&&s<i.min){const n=i.min-s;o+=n*200+n*n}if(typeof i.max=="number"&&a>i.max){const n=a-i.max;o+=n*200+n*n}}return o}function me(e,t){for(const[o,r]of Object.entries(t)){const[i,s]=G(e,o);if(typeof r.min=="number"&&i<r.min||typeof r.max=="number"&&s>r.max)return!1}return!0}function V(e,t,o){const r=ae(e)*t.offense,i=le(e)*t.defense,s=ce(e)*t.utility,a=fe(e)*t.skillPoints,n=de(e)*t.reqPenalty,c=ue(e,o.target),h={offense:r,defense:i,utility:s,skillPoints:a,reqPenalty:n,thresholdPenalty:c};return{score:r+i+s+a-n-c,breakdown:h}}function he(e,t,o){let r=0;for(const[s,a]of Object.entries(e.ids)){const n=a.max;Y.includes(s)&&n>0?r+=n*t.offense:W.includes(s)&&n>0?r+=n*t.defense:U.includes(s)?s==="mr"?r+=n*12*t.utility:s==="ms"?r+=n*8*t.utility:s==="ls"?r+=n*6*t.utility:s==="spd"?r+=n*3*t.utility:n>0&&(r+=n*t.utility):H.includes(s)&&(r+=n*t.skillPoints),o?.has(s)&&n>0&&(r+=n*50)}const i=Math.max(0,e.itemIDs.strReq)+Math.max(0,e.itemIDs.dexReq)+Math.max(0,e.itemIDs.intReq)+Math.max(0,e.itemIDs.defReq)+Math.max(0,e.itemIDs.agiReq);return r-=i*t.reqPenalty*.5,r}function pe(e,t,o){const r=e.recipesByType.get(t.toUpperCase());if(!r)return null;const i=`${t.charAt(0).toUpperCase()}${t.slice(1).toLowerCase()}-${o}`;return r.find(s=>s.name===i)??null}function Me(e,t,o){const r=t.skill.toUpperCase(),i=t.lvl[1],s=new Set(o.excludedIngredients),a=new Set(o.mustIncludeIngredients),n=new Set(Object.keys(o.target)),c=n.size>0,h=[];for(const l of e.ingredients)l.id===L||s.has(l.id)||!a.has(l.id)&&(!l.skills.some(x=>x.toUpperCase()===r)||l.lvl>i)||h.push(l);const p=h.map(l=>({ing:l,score:he(l,o.weights,c?n:void 0)}));p.sort((l,D)=>D.score-l.score);const d=o.topKPerSlot,f=new Set,m=[e.noIngredient];f.add(L);let P=0;for(const{ing:l}of p)a.has(l.id)&&!f.has(l.id)&&(f.add(l.id),m.push(l));for(const{ing:l}of p)if(!f.has(l.id)&&(f.add(l.id),m.push(l),P++,P>=d))break;if(c){const l=h.filter(M=>!f.has(M.id)).map(M=>{let x=0;for(const y of n){const k=M.ids[y]?.max??0;k>0&&(x+=k)}return{ing:M,tScore:x}}).filter(({tScore:M})=>M>0);l.sort((M,x)=>x.tScore-M.tScore);const D=Math.min(l.length,Math.max(30,Math.floor(d/2)));for(let M=0;M<D;M++){const{ing:x}=l[M];f.has(x.id)||(f.add(x.id),m.push(x))}}return m}function ge(e,t,o,r,i,s){const a=[];for(let h=0;h<6;h++)h<t.length?a.push(o.ingredientsById.get(t[h])??o.noIngredient):a.push(o.noIngredient);const n=F(e,i,a,s),{score:c}=V(n,r.weights,r);return c}function xe(e){const{catalog:t,constraints:o,signal:r,onProgress:i}=e,s=pe(t,o.recipeType,o.levelRange);if(!s)return[];const a=j(s.type.toLowerCase()),n=Me(t,s,o);if(n.length===0)return[];const c=o.matTiers?[o.matTiers]:[[1,1],[1,2],[1,3],[2,1],[2,2],[2,3],[3,1],[3,2],[3,3]],h=a==="weapon"?o.atkSpd?[o.atkSpd]:[...ee]:["SLOW"],p=c[c.length-1],d=h[0],f=o.beamWidth,m=6;let P=0,l=[{ingredientIds:[],score:0}];for(let S=0;S<m;S++){if(r?.aborted)throw new DOMException("Recipe solver cancelled","AbortError");const R=[];for(const b of l)for(const I of n){if(r?.aborted)throw new DOMException("Recipe solver cancelled","AbortError");const u=[...b.ingredientIds,I.id],g=ge(s,u,t,o,p,d);R.push({ingredientIds:u,score:g}),P++}R.sort((b,I)=>I.score-b.score),l=R.slice(0,f);const B=new Set;l=l.filter(b=>{const I=b.ingredientIds.join(",");return B.has(I)?!1:(B.add(I),!0)}),i?.({phase:"beam-search",processedStates:P,beamSize:l.length,expandedSlots:S+1,totalSlots:m})}i?.({phase:"material-sweep",processedStates:P,beamSize:l.length,expandedSlots:m,totalSlots:m,detail:`Sweeping ${c.length} tier combos Ã— ${h.length} atk speeds`});const D=new Map;for(const S of l){if(r?.aborted)throw new DOMException("Recipe solver cancelled","AbortError");const R=S.ingredientIds,B=R.map(b=>t.ingredientsById.get(b)??t.noIngredient);for(const b of c)for(const I of h){const u=F(s,b,B,I),{score:g,breakdown:w}=V(u,o.weights,o),O=re(R,s.id,b,I,a),T=R.join(",")+"|"+b.join(",")+"|"+I,v=D.get(T);(!v||g>v.score)&&D.set(T,{recipeId:s.id,ingredientIds:R,matTiers:b,atkSpd:I,effectiveness:u.effectiveness,stats:u,score:g,scoreBreakdown:w,hash:O}),P++}}const M=Array.from(D.values());M.sort((S,R)=>R.score-S.score);const x=Object.keys(o.target).length>0,y=new Set,k=[],E=[];for(const S of M)y.has(S.hash)||(y.add(S.hash),x&&me(S.stats,o.target)?k.push(S):E.push(S));const q=k.length>0?k.slice(0,o.topN):E.slice(0,o.topN),A=k.length;return i?.({phase:"complete",processedStates:P,beamSize:q.length,expandedSlots:m,totalSlots:m,detail:x?`Found ${q.length} candidates (${A} satisfy thresholds) from ${P} states`:`Found ${q.length} candidates from ${P} states`}),q}const N=new Map;function Pe(e){return{...e,recipesById:new Map(e.recipesById),recipesByType:new Map(e.recipesByType),ingredientsById:new Map(e.ingredientsById),ingredientsBySkill:new Map(e.ingredientsBySkill),ingredientIdByName:new Map(e.ingredientIdByName)}}self.onmessage=e=>{const t=e.data;if(t.type==="cancel"){N.get(t.requestId)?.abort();return}const o=new AbortController;N.set(t.requestId,o);try{const r=Pe(t.catalog),i=xe({catalog:r,constraints:t.constraints,signal:o.signal,onProgress:a=>{const n={type:"progress",requestId:t.requestId,progress:a};self.postMessage(n)}}),s={type:"result",requestId:t.requestId,candidates:i};self.postMessage(s)}catch(r){const i={type:"error",requestId:t.requestId,message:r instanceof Error?r.message:"Recipe solver worker error"};self.postMessage(i)}finally{N.delete(t.requestId)}}})();
