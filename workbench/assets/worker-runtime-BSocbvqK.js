(function(){"use strict";function ge(e){return e.aggregated.hprTotal*.9+e.aggregated.mr*14+e.aggregated.ms*10+e.aggregated.ls*9}function fe(e,t){let i=0;const{target:s}=t;return typeof s.minLegacyBaseDps=="number"&&e.derived.legacyBaseDps<s.minLegacyBaseDps&&(i+=(s.minLegacyBaseDps-e.derived.legacyBaseDps)*4),typeof s.minLegacyEhp=="number"&&e.derived.legacyEhp<s.minLegacyEhp&&(i+=(s.minLegacyEhp-e.derived.legacyEhp)*.8),typeof s.minDpsProxy=="number"&&e.derived.dpsProxy<s.minDpsProxy&&(i+=(s.minDpsProxy-e.derived.dpsProxy)*4),typeof s.minEhpProxy=="number"&&e.derived.ehpProxy<s.minEhpProxy&&(i+=(s.minEhpProxy-e.derived.ehpProxy)*1.1),typeof s.minMr=="number"&&e.aggregated.mr<s.minMr&&(i+=(s.minMr-e.aggregated.mr)*45),typeof s.minMs=="number"&&e.aggregated.ms<s.minMs&&(i+=(s.minMs-e.aggregated.ms)*35),typeof s.minSpeed=="number"&&e.aggregated.speed<s.minSpeed&&(i+=(s.minSpeed-e.aggregated.speed)*12),typeof s.minSkillPointTotal=="number"&&e.derived.skillPointTotal<s.minSkillPointTotal&&(i+=(s.minSkillPointTotal-e.derived.skillPointTotal)*15),typeof s.maxReqTotal=="number"&&e.derived.reqTotal>s.maxReqTotal&&(i+=(e.derived.reqTotal-s.maxReqTotal)*8),i}function K(e,t,i){const s=ge(e),n=e.derived.reqTotal*t.reqTotalPenalty,o=fe(e,i),l={legacyBaseDps:e.derived.legacyBaseDps*t.legacyBaseDps,legacyEhp:e.derived.legacyEhp*t.legacyEhp,dpsProxy:e.derived.dpsProxy*t.dpsProxy,ehpProxy:e.derived.ehpProxy*t.ehpProxy,speed:e.aggregated.speed*t.speed,sustain:s*t.sustain,skillPointTotal:e.derived.skillPointTotal*t.skillPointTotal,reqPenalty:n,thresholdPenalty:o};return{score:l.legacyBaseDps+l.legacyEhp+l.dpsProxy+l.ehpProxy+l.speed+l.sustain+l.skillPointTotal-l.reqPenalty-l.thresholdPenalty,breakdown:l}}const v=["helmet","chestplate","leggings","boots","ring1","ring2","bracelet","necklace","weapon"],O=e=>e==="ring1"||e==="ring2"?"ring":e,pe={spear:"Warrior",dagger:"Assassin",wand:"Mage",bow:"Archer",relik:"Shaman"};function he(e){return pe[e]??null}function me(e,t){return!t||!e.classReq?!0:e.classReq===t}const Se={slotStatus:{},warnings:{messages:[]},aggregated:{hpTotal:0,hprTotal:0,mr:0,ms:0,ls:0,speed:0,skillPoints:{str:0,dex:0,int:0,def:0,agi:0},skillReqs:{str:0,dex:0,int:0,def:0,agi:0},defenses:{e:0,t:0,w:0,f:0,a:0},offense:{baseDps:0,spellPct:0,spellRaw:0,meleePct:0,meleeRaw:0,offenseScore:0}},derived:{dpsProxy:0,ehpProxy:0,reqTotal:0,skillPointTotal:0,legacyBaseDps:0,legacyEhp:0,legacyEhpNoAgi:0,skillpointFeasible:!0,assignedSkillPointsRequired:0}};function Y(e){let t=Number.isFinite(e)?e:0;if(t<=0)return 0;t>=150&&(t=150);const i=.9908;return i/(1-i)*(1-Math.pow(i,t))/100}const xe=.867,ke=.951,ye=90;function Te(e){return Math.max(1,Math.min(106,Math.round(e||1)))*5+5}function Me(e){const t=Math.max(1,Math.min(106,Math.round(e||1)));return t>=101?200:(t-1)*2}function be(e){switch(e){case"relik":return .6;case"bow":return .7;case"wand":return .8;case"dagger":case"spear":return 1;default:return 1}}function Pe(e){const t=Math.max(5,e.totalHp),i=Y(e.defSkillPoints)*xe,s=Y(e.agiSkillPoints)*ke,o=2-be(e.weaponType),u=(100-ye)/100*s+(1-s)*(1-i),g=1-i,m=t/Math.max(1e-9,u)/Math.max(1e-9,o),f=t/Math.max(1e-9,g)/Math.max(1e-9,o);return{withAgi:m,noAgi:f}}function qe(e){return[e.numeric.reqStr,e.numeric.reqDex,e.numeric.reqInt,e.numeric.reqDef,e.numeric.reqAgi]}function Ie(e){return[e.numeric.spStr,e.numeric.spDex,e.numeric.spInt,e.numeric.spDef,e.numeric.spAgi]}function Ae(e,t){return[e[0]+t[0],e[1]+t[1],e[2]+t[2],e[3]+t[3],e[4]+t[4]]}function ve(e){return e[0]+e[1]+e[2]+e[3]+e[4]}function U(e,t){for(let i=0;i<5;i++)if(e[i]>t[i])return!1;return!0}function we(e,t){for(const i of e)if(U(i.assigned,t.assigned))return;for(let i=e.length-1;i>=0;i--)U(t.assigned,e[i].assigned)&&e.splice(i,1);e.push(t)}function Be(e,t,i={}){if(e.length===0)return{feasible:!0,assignedTotal:0,assignedByStat:[0,0,0,0,0]};const s=Me(t),n=i.extraBaseSkillPoints??[0,0,0,0,0],o=e.length,l=e.map(qe),u=e.map(Ie),g=1<<o,m=Array.from({length:g},()=>[0,0,0,0,0]);for(let x=1;x<g;x++){const T=x&-x,b=Math.log2(T)|0;m[x]=Ae(m[x^T],u[b])}const f=new Array(g);f[0]=[{assigned:[0,0,0,0,0],assignedTotal:0}];for(let x=0;x<g;x++){const T=f[x];if(!T||T.length===0)continue;const b=m[x];for(const c of T)for(let I=0;I<o;I++){if((x&1<<I)!==0)continue;const k=[...c.assigned];let y=!0;for(let d=0;d<5;d++){const M=c.assigned[d]+b[d]+(n[d]??0),q=l[I][d];if(q>M&&(k[d]+=q-M),k[d]>100){y=!1;break}}if(!y)continue;const p=ve(k);if(p>s)continue;const r=x|1<<I,a=f[r]??=[];we(a,{assigned:k,assignedTotal:p})}}const S=f[g-1];if(!S||S.length===0)return{feasible:!1,assignedTotal:1/0,assignedByStat:null};let h=1/0,P=null;for(const x of S)x.assignedTotal<h&&(h=x.assignedTotal,P=[...x.assigned]);return{feasible:Number.isFinite(h),assignedTotal:h,assignedByStat:Number.isFinite(h)?P:null}}function G(e,t,i,s={}){const n=[];for(const o of v){const l=e[o];if(l==null)continue;const u=t.itemsById.get(l);u&&n.push(u)}return Be(n,i,s)}function De(e,t){const i={};for(const s of v){const n=e.slots[s];if(n==null)continue;const o=t.itemsById.get(n);o&&(i[s]=o)}return i}function J(e,t,i={}){const s=De(e,t),n=structuredClone(Se),o=n.warnings.messages;let l=null;for(const b of v){const c=s[b];if(!c)continue;b==="weapon"&&(l=c.type),n.aggregated.hpTotal+=c.numeric.hp+c.numeric.hpBonus,n.aggregated.hprTotal+=c.numeric.hprRaw+c.numeric.hprPct,n.aggregated.mr+=c.numeric.mr,n.aggregated.ms+=c.numeric.ms,n.aggregated.ls+=c.numeric.ls,n.aggregated.speed+=c.numeric.spd,n.aggregated.skillPoints.str+=c.numeric.spStr,n.aggregated.skillPoints.dex+=c.numeric.spDex,n.aggregated.skillPoints.int+=c.numeric.spInt,n.aggregated.skillPoints.def+=c.numeric.spDef,n.aggregated.skillPoints.agi+=c.numeric.spAgi,n.aggregated.skillReqs.str=Math.max(n.aggregated.skillReqs.str,c.numeric.reqStr),n.aggregated.skillReqs.dex=Math.max(n.aggregated.skillReqs.dex,c.numeric.reqDex),n.aggregated.skillReqs.int=Math.max(n.aggregated.skillReqs.int,c.numeric.reqInt),n.aggregated.skillReqs.def=Math.max(n.aggregated.skillReqs.def,c.numeric.reqDef),n.aggregated.skillReqs.agi=Math.max(n.aggregated.skillReqs.agi,c.numeric.reqAgi),n.aggregated.defenses.e+=c.numeric.eDef,n.aggregated.defenses.t+=c.numeric.tDef,n.aggregated.defenses.w+=c.numeric.wDef,n.aggregated.defenses.f+=c.numeric.fDef,n.aggregated.defenses.a+=c.numeric.aDef,n.aggregated.offense.baseDps+=c.numeric.baseDps,n.aggregated.offense.spellPct+=c.numeric.sdPct,n.aggregated.offense.spellRaw+=c.numeric.sdRaw,n.aggregated.offense.meleePct+=c.numeric.mdPct,n.aggregated.offense.meleeRaw+=c.numeric.mdRaw,n.aggregated.offense.offenseScore+=c.roughScoreFields.offense;const I=c.classReq,k=!I||!e.characterClass||I===e.characterClass,y=c.level<=e.level,p=c.numeric.reqStr<=100&&c.numeric.reqDex<=100&&c.numeric.reqInt<=100&&c.numeric.reqDef<=100&&c.numeric.reqAgi<=100;n.slotStatus[b]={classOk:k,levelOk:y,skillReqsMet:p}}!e.characterClass&&l&&(e.characterClass=he(l));for(const b of v){const c=s[b];c&&(O(b)!==c.category&&o.push(`${b} contains incompatible item type (${c.type}).`),c.level>e.level&&o.push(`${c.displayName} requires level ${c.level}.`),e.characterClass&&c.classReq&&c.classReq!==e.characterClass&&o.push(`${c.displayName} requires ${c.classReq}.`),(c.restricted||c.deprecated)&&o.push(`${c.displayName} is restricted/deprecated.`))}const u=n.aggregated.skillReqs.str+n.aggregated.skillReqs.dex+n.aggregated.skillReqs.int+n.aggregated.skillReqs.def+n.aggregated.skillReqs.agi,g=n.aggregated.skillPoints.str+n.aggregated.skillPoints.dex+n.aggregated.skillPoints.int+n.aggregated.skillPoints.def+n.aggregated.skillPoints.agi,m=G(e.slots,t,e.level,i.skillpointFeasibility),f=n.aggregated.offense.baseDps+n.aggregated.offense.spellPct*1.3+n.aggregated.offense.spellRaw*.12+n.aggregated.offense.meleePct*1.1+n.aggregated.offense.meleeRaw*.12+n.aggregated.speed*.8,S=n.aggregated.defenses.e+n.aggregated.defenses.t+n.aggregated.defenses.w+n.aggregated.defenses.f+n.aggregated.defenses.a,h=n.aggregated.hpTotal+S*.45+n.aggregated.hprTotal*2+Math.max(0,n.aggregated.skillPoints.def)*12+Math.max(0,n.aggregated.skillPoints.agi)*10,P=n.aggregated.offense.baseDps,x=Te(e.level)+n.aggregated.hpTotal,T=Pe({totalHp:x,defSkillPoints:n.aggregated.skillPoints.def,agiSkillPoints:n.aggregated.skillPoints.agi,weaponType:l});return n.derived={dpsProxy:f,ehpProxy:h,reqTotal:u,skillPointTotal:g,legacyBaseDps:P,legacyEhp:T.withAgi,legacyEhpNoAgi:T.noAgi,skillpointFeasible:m.feasible,assignedSkillPointsRequired:Number.isFinite(m.assignedTotal)?m.assignedTotal:0},m.feasible||o.push(`Skill requirements are not satisfiable at level ${e.level} (estimated assigned SP exceeds available or equip order is invalid).`),n}const _=[[10,10,10,10,10],[20,20,20,20,20],[30,30,30,30,30]],Q=["str","dex","int","def","agi"],$=["SUPER_SLOW","VERY_SLOW","SLOW","NORMAL","FAST","VERY_FAST","SUPER_FAST"];function E(e){return Math.round(e.numeric.atkTier||0)}function W(e,t){switch(t){case"str":return Math.max(0,e.numeric.spStr);case"dex":return Math.max(0,e.numeric.spDex);case"int":return Math.max(0,e.numeric.spInt);case"def":return Math.max(0,e.numeric.spDef);case"agi":return Math.max(0,e.numeric.spAgi)}}function Re(e,t){switch(t){case"str":return e.numeric.reqStr;case"dex":return e.numeric.reqDex;case"int":return e.numeric.reqInt;case"def":return e.numeric.reqDef;case"agi":return e.numeric.reqAgi}}function Fe(e,t){if(t.length===0)return 0;let i=0;for(const s of t)i+=W(e,s)*10,i-=Math.max(0,Re(e,s))*.7;return i-=Math.max(0,e.roughScoreFields.reqTotal)*.12,i}function C(e){return{...e}}function $e(e,t){const i=e.weapon;if(i==null)return null;const s=t.itemsById.get(i);if(!s)return null;const n=$.indexOf(s.atkSpd);if(n<0)return null;let o=0;for(const u of v){const g=e[u];if(g==null)continue;const m=t.itemsById.get(g);m&&(o+=E(m))}const l=Math.max(0,Math.min($.length-1,n+o));return $[l]}function Ee(e,t){let i=0;for(const s of v){const n=e[s];if(n==null)continue;const o=t.itemsById.get(n);o&&(i+=E(o))}return i}function Ce(e,t,i){if(i.weaponAttackSpeeds.length===0)return null;const s=e.weapon;if(s==null)return null;const n=t.itemsById.get(s);if(!n)return null;const o=$.indexOf(n.atkSpd);if(o<0)return null;const l=[...new Set(i.weaponAttackSpeeds.map(f=>$.indexOf(f)).filter(f=>f>=0))].sort((f,S)=>f-S);if(l.length===0)return null;const u=Ee(e,t),g=Math.max(0,Math.min($.length-1,o+u));let m=0;if(!l.includes(g)){const f=l.reduce((S,h)=>Math.abs(h-g)<Math.abs(S-g)?h:S,l[0]);m=f>g?1:f<g?-1:0}return{baseSpeedIndex:o,fixedAtkTierTotal:u,allowedFinalIndices:l,allowedFinalIndexSet:new Set(l),preferredDirection:m}}function X(e,t,i){const s=new Array(e.length+1).fill(0),n=new Array(e.length+1).fill(0);for(let o=e.length-1;o>=0;o--){const l=t.get(e[o])??[];let u=0,g=0;if(l.length>0){u=1/0,g=-1/0;for(const m of l){const f=i.itemsById.get(m.id),S=f?E(f):0;S<u&&(u=S),S>g&&(g=S)}Number.isFinite(u)||(u=0),Number.isFinite(g)||(g=0)}s[o]=s[o+1]+u,n[o]=n[o+1]+g}return{minSuffix:s,maxSuffix:n}}function Z(e,t,i,s){const n=e.fixedAtkTierTotal+t+i,o=e.fixedAtkTierTotal+t+s,l=Math.min(n,o),u=Math.max(n,o);for(let g=l;g<=u;g++){const m=Math.max(0,Math.min($.length-1,e.baseSpeedIndex+g));if(e.allowedFinalIndexSet.has(m))return!0}return!1}function L(e,t,i=0,s=0){if(!e||!e.preferredDirection)return 0;const n=e.fixedAtkTierTotal+(t??0),o=Math.max(0,Math.min($.length-1,e.baseSpeedIndex+n+i)),l=Math.max(0,Math.min($.length-1,e.baseSpeedIndex+n+s)),u=Math.min(o,l),g=Math.max(o,l);let m=1/0,f=0;for(let h=u;h<=g;h++){let P=1/0;for(const x of e.allowedFinalIndices){const T=Math.abs(x-h);T<P&&(P=T)}P<m&&(m=P),P>f&&(f=P)}if(!Number.isFinite(m)||f===0)return 0;const S=e.preferredDirection>0?u:-g;return-f*1e3-m*100+S}function je(e,t,i,s){const{target:n}=t;if(typeof n.minLegacyBaseDps=="number"&&e.derived.legacyBaseDps<n.minLegacyBaseDps||typeof n.minLegacyEhp=="number"&&e.derived.legacyEhp<n.minLegacyEhp||typeof n.minDpsProxy=="number"&&e.derived.dpsProxy<n.minDpsProxy||typeof n.minEhpProxy=="number"&&e.derived.ehpProxy<n.minEhpProxy||typeof n.minMr=="number"&&e.aggregated.mr<n.minMr||typeof n.minMs=="number"&&e.aggregated.ms<n.minMs||typeof n.minSpeed=="number"&&e.aggregated.speed<n.minSpeed||typeof n.minSkillPointTotal=="number"&&e.derived.skillPointTotal<n.minSkillPointTotal||typeof n.maxReqTotal=="number"&&e.derived.reqTotal>n.maxReqTotal)return!1;if((n.customNumericRanges?.length??0)>0&&i&&s)for(const o of n.customNumericRanges??[]){const l=o.key?.trim();if(!l)continue;let u=0;for(const g of v){const m=i[g];if(m==null)continue;const f=s.itemsById.get(m);f&&(u+=f.numericIndex[l]??0)}if(typeof o.min=="number"&&u<o.min||typeof o.max=="number"&&u>o.max)return!1}return!0}function ee(e,t,i,s){for(const n of v){const o=e[n];if(o==null)continue;const l=t.itemsById.get(o);if(!l)return{ok:!1,reason:"item"};if(!te(l,i))return{ok:!1,reason:"item"}}if(i.weaponAttackSpeeds.length>0){const n=$e(e,t);if(!n||!i.weaponAttackSpeeds.includes(n))return{ok:!1,reason:"attackSpeed"}}return je(s,i,e,t)?{ok:!0}:{ok:!1,reason:"thresholds"}}function te(e,t){return!(!t.allowRestricted&&(e.restricted||e.deprecated)||e.level>t.level||!me(e,t.characterClass)||t.excludedIds.includes(e.id)||t.allowedTiers.length>0&&!t.allowedTiers.includes(e.tier)||t.minPowderSlots!=null&&e.powderSlots<t.minPowderSlots||t.excludedMajorIds.length>0&&t.excludedMajorIds.some(i=>e.majorIds.includes(i)))}function Ne(e,t){return e.numeric.baseDps*t.weights.legacyBaseDps+e.roughScoreFields.ehpProxy*t.weights.legacyEhp+e.roughScoreFields.offense*t.weights.dpsProxy+e.roughScoreFields.ehpProxy*t.weights.ehpProxy+e.numeric.spd*t.weights.speed+e.roughScoreFields.utility*t.weights.sustain+e.roughScoreFields.skillPointTotal*t.weights.skillPointTotal-e.roughScoreFields.reqTotal*t.weights.reqTotalPenalty}function ne(e){const t=e.ring1??0,i=e.ring2??0,[s,n]=t<=i?[t,i]:[i,t];return[e.helmet??0,e.chestplate??0,e.leggings??0,e.boots??0,s,n,e.bracelet??0,e.necklace??0,e.weapon??0].join("|")}function se(e,t){return O(t)===e.category}function Le(e,t,i){const s=C(e),n=new Set(v.filter(o=>s[o]!=null));for(const o of i.mustIncludeIds){const l=t.itemsById.get(o);if(!l)continue;const g=v.filter(m=>!n.has(m)&&se(l,m))[0];g&&(s[g]=l.id,n.add(g))}return s}function ze(e,t){const i={str:0,dex:0,int:0,def:0,agi:0};for(const n of v){const o=e[n];if(o==null)continue;const l=t.itemsById.get(o);l&&(i.str=Math.max(i.str,l.numeric.reqStr),i.dex=Math.max(i.dex,l.numeric.reqDex),i.int=Math.max(i.int,l.numeric.reqInt),i.def=Math.max(i.def,l.numeric.reqDef),i.agi=Math.max(i.agi,l.numeric.reqAgi))}const s=Q.filter(n=>i[n]>100).sort((n,o)=>i[o]-i[n]);return s.length>0?s:Q.filter(n=>i[n]>=70).sort((n,o)=>i[o]-i[n]).slice(0,2)}function Oe(e,t,i){if(i.length===0)return[];const s={str:0,dex:0,int:0,def:0,agi:0};for(const n of v){const o=e[n];if(o==null)continue;const l=t.itemsById.get(o);l&&(s.str=Math.max(s.str,l.numeric.reqStr),s.dex=Math.max(s.dex,l.numeric.reqDex),s.int=Math.max(s.int,l.numeric.reqInt),s.def=Math.max(s.def,l.numeric.reqDef),s.agi=Math.max(s.agi,l.numeric.reqAgi))}return i.map(n=>Math.max(0,s[n]-100))}function ie(e,t){return t.map(i=>W(e,i))}function re(e,t){if(e.length===0)return t.slice();const i=new Array(e.length);for(let s=0;s<e.length;s++)i[s]=(e[s]??0)+(t[s]??0);return i}function _e(e,t,i){for(let s=0;s<i.length;s++)if((e[s]??0)+(t[s]??0)<i[s])return!1;return!0}function oe(e,t){let i=0;for(let s=0;s<t.length;s++)i+=Math.max(0,t[s]-(e[s]??0));return i}function ae(e,t,i,s){if(s.length===0)return 0;const n=t.get(e)??[];let o=0;for(const l of n){const u=i.itemsById.get(l.id);if(!u)continue;let g=0;for(const m of s)g+=W(u,m);g>o&&(o=g)}return o}function We(e){return(e.target.customNumericRanges??[]).map(t=>({key:(t.key??"").trim(),min:typeof t.min=="number"?t.min:void 0,max:typeof t.max=="number"?t.max:void 0})).filter(t=>t.key&&(typeof t.min=="number"||typeof t.max=="number"))}function z(e,t,i){const s=t.itemsById.get(e.id);return s?s.numericIndex[i]??0:0}function He(e,t,i,s,n=[]){const o=[],l=We(i);for(const r of t.items)se(r,e)&&(s&&!s.has(r.id)||te(r,i)&&o.push({id:r.id,rough:Ne(r,i),reqTotal:r.roughScoreFields.reqTotal,skillPointTotal:r.roughScoreFields.skillPointTotal,utility:r.roughScoreFields.utility+r.numeric.spd*.8,level:r.level,atkTier:E(r),spStr:r.numeric.spStr,spDex:r.numeric.spDex,spInt:r.numeric.spInt,spDef:r.numeric.spDef,spAgi:r.numeric.spAgi,supportFocus:Fe(r,n)}));const u=[...o].sort((r,a)=>r.rough!==a.rough?a.rough-r.rough:r.id-a.id),g=[...o].sort((r,a)=>r.reqTotal!==a.reqTotal?r.reqTotal-a.reqTotal:r.level!==a.level?r.level-a.level:r.id-a.id),m=[...o].sort((r,a)=>r.skillPointTotal!==a.skillPointTotal?a.skillPointTotal-r.skillPointTotal:r.reqTotal!==a.reqTotal?r.reqTotal-a.reqTotal:r.id-a.id),f=[...o].sort((r,a)=>r.utility!==a.utility?a.utility-r.utility:r.reqTotal!==a.reqTotal?r.reqTotal-a.reqTotal:r.id-a.id),S=i.weaponAttackSpeeds.length>0?[...o].sort((r,a)=>{const d=Math.max(0,r.atkTier),M=Math.max(0,a.atkTier);return d!==M?M-d:r.atkTier!==a.atkTier?a.atkTier-r.atkTier:r.reqTotal!==a.reqTotal?r.reqTotal-a.reqTotal:r.skillPointTotal!==a.skillPointTotal?a.skillPointTotal-r.skillPointTotal:r.id-a.id}):[],h=n.length>0?[...o].sort((r,a)=>r.supportFocus!==a.supportFocus?a.supportFocus-r.supportFocus:r.reqTotal!==a.reqTotal?r.reqTotal-a.reqTotal:r.skillPointTotal!==a.skillPointTotal?a.skillPointTotal-r.skillPointTotal:r.id-a.id):[],P=n.map(r=>[...o].sort((a,d)=>{const M=r==="str"?a.spStr:r==="dex"?a.spDex:r==="int"?a.spInt:r==="def"?a.spDef:a.spAgi,q=r==="str"?d.spStr:r==="dex"?d.spDex:r==="int"?d.spInt:r==="def"?d.spDef:d.spAgi;return M!==q?q-M:a.reqTotal!==d.reqTotal?a.reqTotal-d.reqTotal:a.supportFocus!==d.supportFocus?d.supportFocus-a.supportFocus:a.id-d.id})),x=l.filter(r=>typeof r.min=="number").map(r=>[...o].sort((a,d)=>{const M=z(a,t,r.key),q=z(d,t,r.key);return M!==q?q-M:a.reqTotal!==d.reqTotal?a.reqTotal-d.reqTotal:a.skillPointTotal!==d.skillPointTotal?d.skillPointTotal-a.skillPointTotal:a.id-d.id})),T=l.filter(r=>typeof r.max=="number").map(r=>[...o].sort((a,d)=>{const M=z(a,t,r.key),q=z(d,t,r.key);return M!==q?M-q:a.reqTotal!==d.reqTotal?a.reqTotal-d.reqTotal:a.skillPointTotal!==d.skillPointTotal?d.skillPointTotal-a.skillPointTotal:a.id-d.id})),b=Math.max(10,i.topKPerSlot),c=Math.min(140,Math.max(40,Math.floor(b*.8))),I=Math.min(o.length,b+c+(n.length>0?Math.min(60,n.length*12):0)+Math.min(80,l.length*14)),k=new Map,y=Math.min(12,Math.floor(b*.4),u.length);for(let r=0;r<y;r++){const a=u[r];k.set(a.id,{id:a.id,rough:a.rough})}const p=[{list:u,remaining:Math.max(0,b-y),cursor:0},{list:g,remaining:Math.floor(c*.28),cursor:0},{list:m,remaining:Math.floor(c*.24),cursor:0},{list:f,remaining:Math.floor(c*.18),cursor:0}];S.length>0&&p.push({list:S,remaining:Math.max(18,Math.floor(c*.22)),cursor:0}),h.length>0&&p.push({list:h,remaining:Math.max(16,Math.floor(c*.2)),cursor:0});for(const r of P)p.push({list:r,remaining:10,cursor:0});for(const r of x)p.push({list:r,remaining:12,cursor:0});for(const r of T)p.push({list:r,remaining:8,cursor:0});for(;k.size<I;){let r=!1;for(const a of p)if(!(a.remaining<=0))for(;a.cursor<a.list.length;){const d=a.list[a.cursor++];if(!k.has(d.id)){k.set(d.id,{id:d.id,rough:d.rough}),a.remaining--,r=!0;break}}if(!r)break}if(k.size<I)for(const r of u){if(k.size>=I)break;k.has(r.id)||k.set(r.id,{id:r.id,rough:r.rough})}return[...k.values()]}function Ve(e){const t={};for(const i of v){const s=O(i),n=new Set(e.binsByCategory[s]??[]),o=e.slots[i];o!=null&&n.add(o),t[i]=n}return t}function le(e,t,i){if(i.length===0)return!0;const s=new Set;for(const n of v){const o=e[n];if(o==null)continue;const l=t.itemsById.get(o);if(l)for(const u of l.majorIds)i.includes(u)&&s.add(u)}return i.every(n=>s.has(n))}function ce(e,t){const i=new Array(e.length+1).fill(0);for(let s=e.length-1;s>=0;s--){const n=e[s],o=t.get(n)??[];let l=0;for(const u of o)u.rough>l&&(l=u.rough);i[s]=i[s+1]+l}return i}function de(e){const{poolSize:t,beamSize:i,remainingStages:s,processedStates:n,maxStates:o}=e;if(t<=0)return 0;const l=Math.max(0,o-n),u=Math.max(1,i*Math.max(1,s)),g=Math.floor(l/u),m=Math.max(8,Math.min(96,g));return Math.min(t,m)}function Ke(e,t,i){let s=1;for(const n of e){const o=t.get(n)?.length??0;if(o===0)return 0;if(s*=o,s>i)return s}return s}function H(e){const{beam:t,catalog:i,constraints:s,skillpointAssist:n,signal:o}=e,l=[],u=new Set,g={majorIds:0,spInvalid:0,duplicate:0,hardConstraints:0,hardAttackSpeed:0,hardThresholds:0,hardItem:0};for(const m of t){if(o?.aborted)throw new DOMException("Auto build cancelled","AbortError");if(!le(m.slots,i,s.requiredMajorIds)){g.majorIds++;continue}const f=J({slots:m.slots,level:s.level,characterClass:s.characterClass},i,n?{skillpointFeasibility:{extraBaseSkillPoints:n}}:void 0);if(!f.derived.skillpointFeasible){g.spInvalid++;continue}const S=ee(m.slots,i,s,f);if(!S.ok){g.hardConstraints++,S.reason==="attackSpeed"?g.hardAttackSpeed++:S.reason==="thresholds"?g.hardThresholds++:g.hardItem++;continue}const h=ne(m.slots);if(u.has(h)){g.duplicate++;continue}const{score:P,breakdown:x}=K(f,s.weights,s);u.add(h),l.push({slots:C(m.slots),score:P,scoreBreakdown:x,summary:f})}return l.sort((m,f)=>{if(m.score!==f.score)return f.score-m.score;for(const S of v){const h=m.slots[S]??0,P=f.slots[S]??0;if(h!==P)return h-P}return 0}),{candidates:l,rejectStats:g}}function Ye(e){const{slotOrder:t,candidatePools:i,baseSlots:s,catalog:n,constraints:o,focusStats:l,attackSpeedCtx:u,onProgress:g,signal:m}=e,f=ce(t,i),S=u?X(t,i,n):null,h=Oe(s,n,l),P=Array.from({length:t.length+1},()=>l.map(()=>0));for(let c=t.length-1;c>=0;c--){const I=i.get(t[c])??[],k=l.map(()=>0);for(const y of I){const p=n.itemsById.get(y.id);if(!p)continue;const r=ie(p,l);for(let a=0;a<r.length;a++)r[a]>k[a]&&(k[a]=r[a])}P[c]=re(P[c+1],k)}let x=[{slots:C(s),orderIndex:0,roughScore:0,optimisticBound:f[0],feasibilityAssigned:0,focusSupport:l.map(()=>0),atkTierAssigned:0}],T=0,b=!1;for(let c=0;c<t.length;c++){if(m?.aborted)throw new DOMException("Auto build cancelled","AbortError");const I=t[c],k=i.get(I)??[],y=[],p=de({poolSize:k.length,beamSize:x.length,remainingStages:t.length-c,processedStates:T,maxStates:o.maxStates});p<=0&&(b=!0);for(const d of x){let M=0;for(const q of k){if(M>=p)break;if(T>=o.maxStates){b=!0;break}T++,M++;const w=C(d.slots);w[I]=q.id;const B=n.itemsById.get(q.id),A=(d.atkTierAssigned??0)+(B?E(B):0),D=re(d.focusSupport??l.map(()=>0),B?ie(B,l):l.map(()=>0));if(u&&S&&!Z(u,A,S.minSuffix[c+1],S.maxSuffix[c+1])||l.length>0&&!_e(D,P[c+1],h))continue;const F=G(w,n,o.level),R=d.roughScore+q.rough;y.push({slots:w,orderIndex:c+1,roughScore:R,optimisticBound:R+f[c+1],feasibilityAssigned:F.feasible?F.assignedTotal:1/0,focusSupport:D,atkTierAssigned:A})}if(b)break}if(y.length===0)return g?.({phase:"diagnostics",processedStates:T,beamSize:x.length,totalSlots:t.length,expandedSlots:c,detail:b?`Feasibility-first search exhausted state budget before completing slot ${I}.`:`Feasibility-first search found no branches that can still satisfy high-skill requirements by slot ${I}.`}),{beam:[],processedStates:T,stateBudgetHit:b};const r=S?S.minSuffix[c+1]:0,a=S?S.maxSuffix[c+1]:0;y.sort((d,M)=>{if(u){const B=L(u,d.atkTierAssigned,r,a),A=L(u,M.atkTierAssigned,r,a);if(B!==A)return A-B}if(l.length>0){const B=oe(d.focusSupport??[],h),A=oe(M.focusSupport??[],h);if(B!==A)return B-A}const q=d.feasibilityAssigned??1/0,w=M.feasibilityAssigned??1/0;return q!==w?q-w:d.optimisticBound!==M.optimisticBound?M.optimisticBound-d.optimisticBound:d.roughScore!==M.roughScore?M.roughScore-d.roughScore:0}),x=y.slice(0,Math.max(40,o.beamWidth)),g?.({phase:"beam-search",processedStates:T,beamSize:x.length,totalSlots:t.length,expandedSlots:c+1,detail:`feasibility-first | branchCap=${p}${l.length>0?` | focus=${l.join("/")}`:""}${u?` | atkSpeed=${o.weaponAttackSpeeds.join("/")}`:""}`})}return{beam:x,processedStates:T,stateBudgetHit:b}}function Ue(e){const{slotOrder:t,candidatePools:i,baseSlots:s,catalog:n,constraints:o,signal:l,onProgress:u}=e,g=[],m=new Set;let f=0,S=0,h=0,P=0,x=0,T=0,b=0,c=0;const I=(k,y)=>{if(l?.aborted)throw new DOMException("Auto build cancelled","AbortError");if(f>o.maxStates)return;if(k>=t.length){if(!le(y,n,o.requiredMajorIds)){S++;return}const a=J({slots:y,level:o.level,characterClass:o.characterClass},n);if(!a.derived.skillpointFeasible){h++;return}const d=ee(y,n,o,a);if(!d.ok){x++,d.reason==="attackSpeed"?T++:d.reason==="thresholds"?b++:c++;return}const M=ne(y);if(m.has(M)){P++;return}m.add(M);const{score:q,breakdown:w}=K(a,o.weights,o);g.push({slots:C(y),score:q,scoreBreakdown:w,summary:a});return}const p=t[k],r=i.get(p)??[];for(const a of r){if(f++,f>o.maxStates)break;y[p]=a.id,f%2e3===0&&u?.({phase:"exact-search",processedStates:f,beamSize:0,totalSlots:t.length,expandedSlots:k+1}),I(k+1,y)}y[p]=null};return I(0,C(s)),u?.({phase:"diagnostics",processedStates:f,beamSize:0,totalSlots:t.length,expandedSlots:t.length,detail:g.length>0?`Exact search produced ${g.length} valid builds. Rejected duplicates=${P}, SP-invalid=${h}, majorID=${S}, hard=${x} (speed=${T}, thresholds=${b}, item=${c}).`:`Exact search produced 0 valid builds. Rejected SP-invalid=${h}, majorID=${S}, duplicates=${P}, hard=${x} (speed=${T}, thresholds=${b}, item=${c}).`}),g.sort((k,y)=>{if(k.score!==y.score)return y.score-k.score;for(const p of v){const r=k.slots[p]??0,a=y.slots[p]??0;if(r!==a)return r-a}return 0}),g.slice(0,Math.max(1,o.topN))}function Ge(e){const{catalog:t,baseWorkbench:i,constraints:s,onProgress:n,signal:o}=e;if(o?.aborted)throw new DOMException("Auto build cancelled","AbortError");let l=C(i.slots);for(const r of v)s.lockedSlots[r]||(l[r]=null);l=Le(l,t,s);const u=ze(l,t),g=v.filter(r=>l[r]==null),m=s.onlyPinnedItems?Ve(i):null,f=new Map;for(const r of g)f.set(r,He(r,t,s,m?.[r]??null,u));const S=Ce(l,t,s),h=[...g].sort((r,a)=>{if(S?.preferredDirection){const q=f.get(r)??[],w=f.get(a)??[],B=q.reduce((D,F)=>{const R=t.itemsById.get(F.id);if(!R)return D;const j=E(R),N=S.preferredDirection>0?Math.max(0,j):Math.max(0,-j);return Math.max(D,N)},0),A=w.reduce((D,F)=>{const R=t.itemsById.get(F.id);if(!R)return D;const j=E(R),N=S.preferredDirection>0?Math.max(0,j):Math.max(0,-j);return Math.max(D,N)},0);if(B!==A)return A-B}if(u.length>0){const q=ae(r,f,t,u),w=ae(a,f,t,u);if(q!==w)return w-q}const d=f.get(r)?.length??0,M=f.get(a)?.length??0;return d!==M?d-M:r.localeCompare(a)}),P=ce(h,f);if(h.some(r=>(f.get(r)?.length??0)===0)){const r=h.find(a=>(f.get(a)?.length??0)===0);return n?.({phase:"diagnostics",processedStates:0,beamSize:0,totalSlots:h.length,expandedSlots:0,detail:r?`No candidate items available for slot ${r} under current hard filters.`:"One or more slots have empty candidate pools."}),[]}const x=Ke(h,f,s.exhaustiveStateLimit+1);if(s.useExhaustiveSmallPool&&h.length>0&&x>0&&x<=s.exhaustiveStateLimit){n?.({phase:"exact-search",processedStates:0,beamSize:0,totalSlots:h.length,expandedSlots:0});const r={...s,maxStates:Math.max(s.maxStates,s.exhaustiveStateLimit)};return Ue({slotOrder:h,candidatePools:f,baseSlots:l,catalog:t,constraints:r,signal:o,onProgress:n})}let T=[{slots:l,orderIndex:0,roughScore:0,optimisticBound:P[0],atkTierAssigned:0}];const b=S?X(h,f,t):null;let c=0,I=!1;for(let r=0;r<h.length;r++){if(o?.aborted)throw new DOMException("Auto build cancelled","AbortError");const a=h[r],d=f.get(a),M=[],q=de({poolSize:d.length,beamSize:T.length,remainingStages:h.length-r,processedStates:c,maxStates:s.maxStates});q<=0&&(I=!0);for(const A of T){let D=0;for(const F of d){if(D>=q)break;if(c>=s.maxStates){I=!0;break}c++,D++;const R=C(A.slots);R[a]=F.id;const j=A.roughScore+F.rough,N=t.itemsById.get(F.id),ue=(A.atkTierAssigned??0)+(N?E(N):0);S&&b&&!Z(S,ue,b.minSuffix[r+1],b.maxSuffix[r+1])||M.push({slots:R,orderIndex:r+1,roughScore:j,optimisticBound:j+P[r+1],atkTierAssigned:ue})}if(I)break}if(M.length===0)return n?.({phase:"diagnostics",processedStates:c,beamSize:T.length,totalSlots:h.length,expandedSlots:r,detail:I?`Search state budget exhausted before completing slot ${a}. Try enabling deep fallback/exact mode or reduce hard filters.`:`No expansions produced at slot ${a}.`}),[];const w=b?b.minSuffix[r+1]:0,B=b?b.maxSuffix[r+1]:0;M.sort((A,D)=>{if(S){const F=L(S,A.atkTierAssigned,w,B),R=L(S,D.atkTierAssigned,w,B);if(F!==R)return R-F}return A.optimisticBound!==D.optimisticBound?D.optimisticBound-A.optimisticBound:D.roughScore-A.roughScore}),T=M.slice(0,Math.max(20,s.beamWidth)),n?.({phase:"beam-search",processedStates:c,beamSize:T.length,totalSlots:h.length,expandedSlots:r+1,detail:`branchCap=${q}${S?.preferredDirection?` | atkSpeedTarget=${s.weaponAttackSpeeds.join("/")}`:""}`})}let k=T,{candidates:y,rejectStats:p}=H({beam:T,catalog:t,constraints:s,signal:o});if(n?.({phase:"diagnostics",processedStates:c,beamSize:T.length,totalSlots:h.length,expandedSlots:h.length,detail:y.length>0?`Final eval: ${y.length} valid builds. Rejected duplicates=${p.duplicate}, SP-invalid=${p.spInvalid}, majorID=${p.majorIds}, hard=${p.hardConstraints}.`:`Final eval found 0 valid builds. Rejected SP-invalid=${p.spInvalid}, majorID=${p.majorIds}, duplicates=${p.duplicate}, hard=${p.hardConstraints} (speed=${p.hardAttackSpeed}, thresholds=${p.hardThresholds}, item=${p.hardItem}).`}),y.length===0&&h.length>0&&(p.spInvalid>0||s.weaponAttackSpeeds.length>0&&p.hardAttackSpeed>0||p.hardThresholds>0)){const r=p.hardThresholds>0;n?.({phase:"diagnostics",processedStates:c,beamSize:T.length,totalSlots:h.length,expandedSlots:h.length,detail:r&&s.target.customNumericRanges?.length?"Retrying with threshold-aware rescue (advanced ID constraints + support-aware feasibility search).":p.hardAttackSpeed>0?"Retrying with feasibility-first beam search (support-aware rescue + attack-speed target reachability).":"Retrying with feasibility-first beam search (support-aware rescue for high-skill requirements)."});const a=Ye({slotOrder:h,candidatePools:f,baseSlots:l,catalog:t,constraints:{...s,maxStates:Math.max(s.maxStates,r?Math.min(18e6,s.maxStates*5):s.weaponAttackSpeeds.length>0?Math.min(16e6,s.maxStates*4):Math.min(8e6,s.maxStates*2)),beamWidth:Math.max(s.beamWidth,r?3600:s.weaponAttackSpeeds.length>0?3200:1800)},focusStats:u,attackSpeedCtx:S,onProgress:n,signal:o});if(a.beam.length>0){k=a.beam;const d=H({beam:a.beam,catalog:t,constraints:s,signal:o});y=d.candidates,p=d.rejectStats,n?.({phase:"diagnostics",processedStates:a.processedStates,beamSize:a.beam.length,totalSlots:h.length,expandedSlots:h.length,detail:y.length>0?`Feasibility-first eval: ${y.length} valid builds. Rejected duplicates=${p.duplicate}, SP-invalid=${p.spInvalid}, majorID=${p.majorIds}, hard=${p.hardConstraints}.`:`Feasibility-first eval still found 0 valid builds. Rejected SP-invalid=${p.spInvalid}, majorID=${p.majorIds}, duplicates=${p.duplicate}, hard=${p.hardConstraints} (speed=${p.hardAttackSpeed}, thresholds=${p.hardThresholds}, item=${p.hardItem}).`})}}if(y.length===0&&p.spInvalid>0&&p.hardConstraints===0){let r=!1;for(const a of _){n?.({phase:"diagnostics",processedStates:c,beamSize:k.length,totalSlots:h.length,expandedSlots:h.length,detail:`Retrying final evaluation with tome-assisted SP feasibility (+${a[0]} per stat).`});const d=H({beam:k,catalog:t,constraints:s,skillpointAssist:a,signal:o});if(d.candidates.length>0){y=d.candidates,p=d.rejectStats,r=!0,n?.({phase:"diagnostics",processedStates:c,beamSize:k.length,totalSlots:h.length,expandedSlots:h.length,detail:`Tome-assisted final eval recovered ${y.length} valid builds (+${a[0]} per stat feasibility assist).`});break}p=d.rejectStats}r||n?.({phase:"diagnostics",processedStates:c,beamSize:k.length,totalSlots:h.length,expandedSlots:h.length,detail:`Tome-assisted final eval still found 0 valid builds after +${_[_.length-1][0]} per stat assist. Rejected SP-invalid=${p.spInvalid}, majorID=${p.majorIds}, duplicates=${p.duplicate}, hard=${p.hardConstraints} (speed=${p.hardAttackSpeed}, thresholds=${p.hardThresholds}, item=${p.hardItem}).`})}return y.slice(0,Math.max(1,s.topN))}const V=new Map;self.onmessage=e=>{const t=e.data;if(t.type==="cancel"){V.get(t.requestId)?.abort();return}const i=new AbortController;V.set(t.requestId,i);try{const s=Ge({catalog:{...t.catalog,itemsById:new Map(t.catalog.itemsById),itemIdByName:new Map(t.catalog.itemIdByName),itemsByType:new Map(t.catalog.itemsByType),itemsByCategory:new Map(t.catalog.itemsByCategory)},baseWorkbench:t.baseWorkbench,constraints:t.constraints,signal:i.signal,onProgress:o=>{const l={type:"progress",requestId:t.requestId,progress:o};self.postMessage(l)}}),n={type:"result",requestId:t.requestId,candidates:s};self.postMessage(n)}catch(s){const n={type:"error",requestId:t.requestId,message:s instanceof Error?s.message:"Auto builder worker error"};self.postMessage(n)}finally{V.delete(t.requestId)}}})();
