(function(){"use strict";const W={legacyBaseDps:1,legacyEhp:.7,dpsProxy:1,ehpProxy:.6,speed:.4,sustain:.35,skillPointTotal:.15,reqTotalPenalty:.2};function Ee(e){return e.aggregated.hprTotal*.9+e.aggregated.mr*14+e.aggregated.ms*10+e.aggregated.ls*9}function $e(e,t){let i=0;const{target:s}=t;return typeof s.minLegacyBaseDps=="number"&&e.derived.legacyBaseDps<s.minLegacyBaseDps&&(i+=(s.minLegacyBaseDps-e.derived.legacyBaseDps)*4),typeof s.minLegacyEhp=="number"&&e.derived.legacyEhp<s.minLegacyEhp&&(i+=(s.minLegacyEhp-e.derived.legacyEhp)*.8),typeof s.minDpsProxy=="number"&&e.derived.dpsProxy<s.minDpsProxy&&(i+=(s.minDpsProxy-e.derived.dpsProxy)*4),typeof s.minEhpProxy=="number"&&e.derived.ehpProxy<s.minEhpProxy&&(i+=(s.minEhpProxy-e.derived.ehpProxy)*1.1),typeof s.minMr=="number"&&e.aggregated.mr<s.minMr&&(i+=(s.minMr-e.aggregated.mr)*45),typeof s.minMs=="number"&&e.aggregated.ms<s.minMs&&(i+=(s.minMs-e.aggregated.ms)*35),typeof s.minSpeed=="number"&&e.aggregated.speed<s.minSpeed&&(i+=(s.minSpeed-e.aggregated.speed)*12),typeof s.minSkillPointTotal=="number"&&e.derived.skillPointTotal<s.minSkillPointTotal&&(i+=(s.minSkillPointTotal-e.derived.skillPointTotal)*15),typeof s.maxReqTotal=="number"&&e.derived.reqTotal>s.maxReqTotal&&(i+=(e.derived.reqTotal-s.maxReqTotal)*8),i}function ce(e,t,i){const s=Ee(e),n=e.derived.reqTotal*t.reqTotalPenalty,o=$e(e,i),a={legacyBaseDps:e.derived.legacyBaseDps*t.legacyBaseDps,legacyEhp:e.derived.legacyEhp*t.legacyEhp,dpsProxy:e.derived.dpsProxy*t.dpsProxy,spellProxy:e.derived.spellProxy*t.spellProxy,meleeProxy:e.derived.meleeProxy*t.meleeProxy,ehpProxy:e.derived.ehpProxy*t.ehpProxy,speed:e.aggregated.speed*t.speed,sustain:s*t.sustain,skillPointTotal:e.derived.skillPointTotal*t.skillPointTotal,reqPenalty:n,thresholdPenalty:o};return{score:a.legacyBaseDps+a.legacyEhp+a.dpsProxy+a.spellProxy+a.meleeProxy+a.ehpProxy+a.speed+a.sustain+a.skillPointTotal-a.reqPenalty-a.thresholdPenalty,breakdown:a}}const E=["helmet","chestplate","leggings","boots","ring1","ring2","bracelet","necklace","weapon"],te=e=>e==="ring1"||e==="ring2"?"ring":e,Re={spear:"Warrior",dagger:"Assassin",wand:"Mage",bow:"Archer",relik:"Shaman"};function Fe(e){return Re[e]??null}function Ce(e,t){return!t||!e.classReq?!0:e.classReq===t}const Ne={slotStatus:{},warnings:{messages:[]},aggregated:{hpTotal:0,hprTotal:0,mr:0,ms:0,ls:0,speed:0,skillPoints:{str:0,dex:0,int:0,def:0,agi:0},skillReqs:{str:0,dex:0,int:0,def:0,agi:0},defenses:{e:0,t:0,w:0,f:0,a:0},offense:{baseDps:0,spellPct:0,spellRaw:0,meleePct:0,meleeRaw:0,elemDamPct:0,genericDamPct:0,offenseScore:0}},derived:{dpsProxy:0,spellProxy:0,meleeProxy:0,ehpProxy:0,reqTotal:0,skillPointTotal:0,legacyBaseDps:0,legacyEhp:0,legacyEhpNoAgi:0,skillpointFeasible:!0,assignedSkillPointsRequired:0}};function ne(e){let t=Number.isFinite(e)?e:0;if(t<=0)return 0;t>=150&&(t=150);const i=.9908;return i/(1-i)*(1-Math.pow(i,t))/100}const je=.867,Le=.951,_e=90;function Oe(e){return Math.max(1,Math.min(106,Math.round(e||1)))*5+5}function ze(e){const t=Math.max(1,Math.min(106,Math.round(e||1)));return t>=101?200:(t-1)*2}function We(e){switch(e){case"relik":return .6;case"bow":return .7;case"wand":return .8;case"dagger":case"spear":return 1;default:return 1}}function He(e){const t=Math.max(5,e.totalHp),i=ne(e.defSkillPoints)*je,s=ne(e.agiSkillPoints)*Le,o=2-We(e.weaponType),d=(100-_e)/100*s+(1-s)*(1-i),u=1-i,m=t/Math.max(1e-9,d)/Math.max(1e-9,o),x=t/Math.max(1e-9,u)/Math.max(1e-9,o);return{withAgi:m,noAgi:x}}function Ge(e){return[e.numeric.reqStr,e.numeric.reqDex,e.numeric.reqInt,e.numeric.reqDef,e.numeric.reqAgi]}function Ve(e){return[e.numeric.spStr,e.numeric.spDex,e.numeric.spInt,e.numeric.spDef,e.numeric.spAgi]}function Ue(e,t){return[e[0]+t[0],e[1]+t[1],e[2]+t[2],e[3]+t[3],e[4]+t[4]]}function Ke(e){return e[0]+e[1]+e[2]+e[3]+e[4]}function de(e,t){for(let i=0;i<5;i++)if(e[i]>t[i])return!1;return!0}function Ye(e,t){for(const i of e)if(de(i.assigned,t.assigned))return;for(let i=e.length-1;i>=0;i--)de(t.assigned,e[i].assigned)&&e.splice(i,1);e.push(t)}function Xe(e,t,i={}){if(e.length===0)return{feasible:!0,assignedTotal:0,assignedByStat:[0,0,0,0,0]};const s=ze(t),n=i.extraBaseSkillPoints??[0,0,0,0,0],o=e.length,a=e.map(Ge),d=e.map(Ve),u=1<<o,m=Array.from({length:u},()=>[0,0,0,0,0]);for(let k=1;k<u;k++){const h=k&-k,$=Math.log2(h)|0;m[k]=Ue(m[k^h],d[$])}const x=new Array(u);x[0]=[{assigned:[0,0,0,0,0],assignedTotal:0}];for(let k=0;k<u;k++){const h=x[k];if(!h||h.length===0)continue;const $=m[k];for(const R of h)for(let D=0;D<o;D++){if((k&1<<D)!==0)continue;const T=[...R.assigned];let I=!0;for(let p=0;p<5;p++){const M=R.assigned[p]+$[p]+(n[p]??0),b=a[D][p];if(b>M&&(T[p]+=b-M),T[p]>100){I=!1;break}}if(!I)continue;const S=Ke(T);if(S>s)continue;const l=k|1<<D,c=x[l]??=[];Ye(c,{assigned:T,assignedTotal:S})}}const f=x[u-1];if(!f||f.length===0)return{feasible:!1,assignedTotal:1/0,assignedByStat:null};let y=1/0,P=null;for(const k of f)k.assignedTotal<y&&(y=k.assignedTotal,P=[...k.assigned]);return{feasible:Number.isFinite(y),assignedTotal:y,assignedByStat:Number.isFinite(y)?P:null}}function ue(e,t,i,s={}){const n=[];for(const o of E){const a=e[o];if(a==null)continue;const d=t.itemsById.get(a);d&&n.push(d)}return Xe(n,i,s)}function Je(e,t){const i={};for(const s of E){const n=e.slots[s];if(n==null)continue;const o=t.itemsById.get(n);o&&(i[s]=o)}return i}function fe(e,t,i={}){const s=Je(e,t),n=structuredClone(Ne),o=n.warnings.messages;let a=null;for(const w of E){const r=s[w];if(!r)continue;w==="weapon"&&(a=r.type),n.aggregated.hpTotal+=r.numeric.hp+r.numeric.hpBonus,n.aggregated.hprTotal+=r.numeric.hprRaw+r.numeric.hprPct,n.aggregated.mr+=r.numeric.mr,n.aggregated.ms+=r.numeric.ms,n.aggregated.ls+=r.numeric.ls,n.aggregated.speed+=r.numeric.spd,n.aggregated.skillPoints.str+=r.numeric.spStr,n.aggregated.skillPoints.dex+=r.numeric.spDex,n.aggregated.skillPoints.int+=r.numeric.spInt,n.aggregated.skillPoints.def+=r.numeric.spDef,n.aggregated.skillPoints.agi+=r.numeric.spAgi,n.aggregated.skillReqs.str=Math.max(n.aggregated.skillReqs.str,r.numeric.reqStr),n.aggregated.skillReqs.dex=Math.max(n.aggregated.skillReqs.dex,r.numeric.reqDex),n.aggregated.skillReqs.int=Math.max(n.aggregated.skillReqs.int,r.numeric.reqInt),n.aggregated.skillReqs.def=Math.max(n.aggregated.skillReqs.def,r.numeric.reqDef),n.aggregated.skillReqs.agi=Math.max(n.aggregated.skillReqs.agi,r.numeric.reqAgi),n.aggregated.defenses.e+=r.numeric.eDef,n.aggregated.defenses.t+=r.numeric.tDef,n.aggregated.defenses.w+=r.numeric.wDef,n.aggregated.defenses.f+=r.numeric.fDef,n.aggregated.defenses.a+=r.numeric.aDef,n.aggregated.offense.baseDps+=r.numeric.baseDps,n.aggregated.offense.spellPct+=r.numeric.sdPct,n.aggregated.offense.spellRaw+=r.numeric.sdRaw,n.aggregated.offense.meleePct+=r.numeric.mdPct,n.aggregated.offense.meleeRaw+=r.numeric.mdRaw,n.aggregated.offense.elemDamPct+=r.numeric.eDamPct+r.numeric.tDamPct+r.numeric.wDamPct+r.numeric.fDamPct+r.numeric.aDamPct,n.aggregated.offense.genericDamPct+=r.numeric.damPct+r.numeric.rDamPct+r.numeric.nDamPct,n.aggregated.offense.offenseScore+=r.roughScoreFields.offense;const q=r.classReq,A=!q||!e.characterClass||q===e.characterClass,v=r.level<=e.level,B=r.numeric.reqStr<=100&&r.numeric.reqDex<=100&&r.numeric.reqInt<=100&&r.numeric.reqDef<=100&&r.numeric.reqAgi<=100;n.slotStatus[w]={classOk:A,levelOk:v,skillReqsMet:B}}!e.characterClass&&a&&(e.characterClass=Fe(a));for(const w of E){const r=s[w];r&&(te(w)!==r.category&&o.push(`${w} contains incompatible item type (${r.type}).`),r.level>e.level&&o.push(`${r.displayName} requires level ${r.level}.`),e.characterClass&&r.classReq&&r.classReq!==e.characterClass&&o.push(`${r.displayName} requires ${r.classReq}.`),(r.restricted||r.deprecated)&&o.push(`${r.displayName} is restricted/deprecated.`))}const d=n.aggregated.skillReqs.str+n.aggregated.skillReqs.dex+n.aggregated.skillReqs.int+n.aggregated.skillReqs.def+n.aggregated.skillReqs.agi,u=n.aggregated.skillPoints.str+n.aggregated.skillPoints.dex+n.aggregated.skillPoints.int+n.aggregated.skillPoints.def+n.aggregated.skillPoints.agi,m=ue(e.slots,t,e.level,i.skillpointFeasibility),{spellPct:x,spellRaw:f,meleePct:y,meleeRaw:P,baseDps:k,elemDamPct:h,genericDamPct:$}=n.aggregated.offense,R=n.aggregated.skillPoints,T=1+ne(R.str),I=(k*(1+(x+h+$)/100)+f)*T,S=(k*(1+(y+h+$)/100)+P)*T,l=S+I+n.aggregated.speed*.8,c=n.aggregated.defenses.e+n.aggregated.defenses.t+n.aggregated.defenses.w+n.aggregated.defenses.f+n.aggregated.defenses.a,p=n.aggregated.hpTotal+c*.45+n.aggregated.hprTotal*2+Math.max(0,n.aggregated.skillPoints.def)*12+Math.max(0,n.aggregated.skillPoints.agi)*10,M=n.aggregated.offense.baseDps,b=Oe(e.level)+n.aggregated.hpTotal,g=He({totalHp:b,defSkillPoints:n.aggregated.skillPoints.def,agiSkillPoints:n.aggregated.skillPoints.agi,weaponType:a});return n.derived={dpsProxy:l,spellProxy:I,meleeProxy:S,ehpProxy:p,reqTotal:d,skillPointTotal:u,legacyBaseDps:M,legacyEhp:g.withAgi,legacyEhpNoAgi:g.noAgi,skillpointFeasible:m.feasible,assignedSkillPointsRequired:Number.isFinite(m.assignedTotal)?m.assignedTotal:0},m.feasible||o.push(`Skill requirements are not satisfiable at level ${e.level} (estimated assigned SP exceeds available or equip order is invalid).`),n}function Qe(e,t){const i=new Map;for(const s of E){const n=e[s];if(n==null)continue;const o=t.itemSetName.get(n);o&&i.set(o,(i.get(o)??0)+1)}return i}function se(e,t,i){const s=i.itemSetName.get(e);if(!s)return!1;const n=i.setsMeta.get(s);if(!n)return!1;let o=0;for(const a of E){const d=t[a];d!=null&&i.itemSetName.get(d)===s&&o++}return n.illegalCounts.includes(o+1)}const ie=[[10,10,10,10,10],[20,20,20,20,20],[30,30,30,30,30]],ge=["str","dex","int","def","agi"],H=["SUPER_SLOW","VERY_SLOW","SLOW","NORMAL","FAST","VERY_FAST","SUPER_FAST"];function V(e){return Math.round(e.numeric.atkTier||0)}function oe(e,t){switch(t){case"str":return Math.max(0,e.numeric.spStr);case"dex":return Math.max(0,e.numeric.spDex);case"int":return Math.max(0,e.numeric.spInt);case"def":return Math.max(0,e.numeric.spDef);case"agi":return Math.max(0,e.numeric.spAgi)}}function Ze(e,t){switch(t){case"str":return e.numeric.reqStr;case"dex":return e.numeric.reqDex;case"int":return e.numeric.reqInt;case"def":return e.numeric.reqDef;case"agi":return e.numeric.reqAgi}}function et(e,t){if(t.length===0)return 0;let i=0;for(const s of t)i+=oe(e,s)*10,i-=Math.max(0,Ze(e,s))*.7;return i-=Math.max(0,e.roughScoreFields.reqTotal)*.12,i}function U(e){return{...e}}function tt(e,t){const i=e.weapon;if(i==null)return null;const s=t.itemsById.get(i);if(!s)return null;const n=H.indexOf(s.atkSpd);if(n<0)return null;let o=0;for(const d of E){const u=e[d];if(u==null)continue;const m=t.itemsById.get(u);m&&(o+=V(m))}const a=Math.max(0,Math.min(H.length-1,n+o));return H[a]}function nt(e,t){let i=0;for(const s of E){const n=e[s];if(n==null)continue;const o=t.itemsById.get(n);o&&(i+=V(o))}return i}function st(e,t,i){if(i.weaponAttackSpeeds.length===0)return null;const s=e.weapon;if(s==null)return null;const n=t.itemsById.get(s);if(!n)return null;const o=H.indexOf(n.atkSpd);if(o<0)return null;const a=[...new Set(i.weaponAttackSpeeds.map(x=>H.indexOf(x)).filter(x=>x>=0))].sort((x,f)=>x-f);if(a.length===0)return null;const d=nt(e,t),u=Math.max(0,Math.min(H.length-1,o+d));let m=0;if(!a.includes(u)){const x=a.reduce((f,y)=>Math.abs(y-u)<Math.abs(f-u)?y:f,a[0]);m=x>u?1:x<u?-1:0}return{baseSpeedIndex:o,fixedAtkTierTotal:d,allowedFinalIndices:a,allowedFinalIndexSet:new Set(a),preferredDirection:m}}function me(e,t,i){const s=new Array(e.length+1).fill(0),n=new Array(e.length+1).fill(0);for(let o=e.length-1;o>=0;o--){const a=t.get(e[o])??[];let d=0,u=0;if(a.length>0){d=1/0,u=-1/0;for(const m of a){const x=i.itemsById.get(m.id),f=x?V(x):0;f<d&&(d=f),f>u&&(u=f)}Number.isFinite(d)||(d=0),Number.isFinite(u)||(u=0)}s[o]=s[o+1]+d,n[o]=n[o+1]+u}return{minSuffix:s,maxSuffix:n}}function pe(e,t,i,s){const n=e.fixedAtkTierTotal+t+i,o=e.fixedAtkTierTotal+t+s,a=Math.min(n,o),d=Math.max(n,o);for(let u=a;u<=d;u++){const m=Math.max(0,Math.min(H.length-1,e.baseSpeedIndex+u));if(e.allowedFinalIndexSet.has(m))return!0}return!1}function X(e,t,i=0,s=0){if(!e||!e.preferredDirection)return 0;const n=e.fixedAtkTierTotal+(t??0),o=Math.max(0,Math.min(H.length-1,e.baseSpeedIndex+n+i)),a=Math.max(0,Math.min(H.length-1,e.baseSpeedIndex+n+s)),d=Math.min(o,a),u=Math.max(o,a);let m=1/0,x=0;for(let y=d;y<=u;y++){let P=1/0;for(const k of e.allowedFinalIndices){const h=Math.abs(k-y);h<P&&(P=h)}P<m&&(m=P),P>x&&(x=P)}if(!Number.isFinite(m)||x===0)return 0;const f=e.preferredDirection>0?d:-u;return-x*1e3-m*100+f}function it(e,t,i,s){const{target:n}=t,o=[];if(typeof n.minLegacyBaseDps=="number"&&e.derived.legacyBaseDps<n.minLegacyBaseDps&&o.push(`minLegacyBaseDps (${e.derived.legacyBaseDps} < ${n.minLegacyBaseDps})`),typeof n.minLegacyEhp=="number"&&e.derived.legacyEhp<n.minLegacyEhp&&o.push(`minLegacyEhp (${e.derived.legacyEhp} < ${n.minLegacyEhp})`),typeof n.minDpsProxy=="number"&&e.derived.dpsProxy<n.minDpsProxy&&o.push(`minDpsProxy (${e.derived.dpsProxy} < ${n.minDpsProxy})`),typeof n.minEhpProxy=="number"&&e.derived.ehpProxy<n.minEhpProxy&&o.push(`minEhpProxy (${e.derived.ehpProxy} < ${n.minEhpProxy})`),typeof n.minMr=="number"&&e.aggregated.mr<n.minMr&&o.push(`minMr (${e.aggregated.mr} < ${n.minMr})`),typeof n.minMs=="number"&&e.aggregated.ms<n.minMs&&o.push(`minMs (${e.aggregated.ms} < ${n.minMs})`),typeof n.minSpeed=="number"&&e.aggregated.speed<n.minSpeed&&o.push(`minSpeed (${e.aggregated.speed} < ${n.minSpeed})`),typeof n.minSkillPointTotal=="number"&&e.derived.skillPointTotal<n.minSkillPointTotal&&o.push(`minSkillPointTotal (${e.derived.skillPointTotal} < ${n.minSkillPointTotal})`),typeof n.maxReqTotal=="number"&&e.derived.reqTotal>n.maxReqTotal&&o.push(`maxReqTotal (${e.derived.reqTotal} > ${n.maxReqTotal})`),(n.customNumericRanges?.length??0)>0&&i&&s)for(const a of n.customNumericRanges??[]){const d=a.key?.trim();if(!d)continue;let u=0;for(const m of E){const x=i[m];if(x==null)continue;const f=s.itemsById.get(x);f&&(u+=f.numericIndex[d]??0)}typeof a.min=="number"&&u<a.min&&o.push(`${d} (${u} < ${a.min})`),typeof a.max=="number"&&u>a.max&&o.push(`${d} (${u} > ${a.max})`)}return o.length>0?{ok:!1,failedChecks:o}:{ok:!0}}function he(e,t,i,s){for(const a of E){const d=e[a];if(d==null)continue;const u=t.itemsById.get(d);if(!u)return{ok:!1,reason:"item"};if(!xe(u,i))return{ok:!1,reason:"item"}}const n=Qe(e,t);for(const[a,d]of n){const u=t.setsMeta.get(a);if(u&&u.illegalCounts.includes(d))return{ok:!1,reason:"item"}}if(i.weaponAttackSpeeds.length>0){const a=tt(e,t);if(!a||!i.weaponAttackSpeeds.includes(a))return{ok:!1,reason:"attackSpeed"}}const o=it(s,i,e,t);return o.ok?{ok:!0}:{ok:!1,reason:"thresholds",failedChecks:o.failedChecks}}function xe(e,t){return!(!t.allowRestricted&&(e.restricted||e.deprecated)||e.level>t.level||!Ce(e,t.characterClass)||t.excludedIds.includes(e.id)||t.allowedTiers.length>0&&!t.allowedTiers.includes(e.tier)||t.minPowderSlots!=null&&e.powderSlots<t.minPowderSlots||t.excludedMajorIds.length>0&&t.excludedMajorIds.some(i=>e.majorIds.includes(i)))}const G=2.5;function Se(e,t){const i={...t};return typeof e.minLegacyBaseDps=="number"&&(i.legacyBaseDps=Math.max(i.legacyBaseDps,W.legacyBaseDps*G)),typeof e.minLegacyEhp=="number"&&(i.legacyEhp=Math.max(i.legacyEhp,W.legacyEhp*G)),typeof e.minDpsProxy=="number"&&(i.dpsProxy=Math.max(i.dpsProxy,W.dpsProxy*G)),typeof e.minEhpProxy=="number"&&(i.ehpProxy=Math.max(i.ehpProxy,W.ehpProxy*G)),(typeof e.minMr=="number"||typeof e.minMs=="number")&&(i.sustain=Math.max(i.sustain,W.sustain*G)),typeof e.minSpeed=="number"&&(i.speed=Math.max(i.speed,W.speed*G)),typeof e.minSkillPointTotal=="number"&&(i.skillPointTotal=Math.max(i.skillPointTotal,W.skillPointTotal*G)),typeof e.maxReqTotal=="number"&&(i.reqTotalPenalty=Math.max(i.reqTotalPenalty,W.reqTotalPenalty*G)),(e.customNumericRanges?.length??0)>0&&(i.sustain=Math.max(i.sustain,W.sustain*G)),i}const ot=3,rt=2,at=14;function lt(e,t){let i=e.numeric.baseDps*t.weights.legacyBaseDps+e.roughScoreFields.ehpProxy*t.weights.legacyEhp+e.roughScoreFields.offense*t.weights.dpsProxy+e.roughScoreFields.ehpProxy*t.weights.ehpProxy+e.numeric.spd*t.weights.speed+e.roughScoreFields.utility*t.weights.sustain+e.roughScoreFields.skillPointTotal*t.weights.skillPointTotal-e.roughScoreFields.reqTotal*t.weights.reqTotalPenalty;const s=t.target.customNumericRanges??[],o=s.some(a=>typeof a.min=="number")?at:ot;for(const a of s){const d=a.key?.trim();if(!d)continue;const u=e.numericIndex[d]??0;typeof a.min=="number"&&(i+=u*o),typeof a.max=="number"&&(i-=u*rt)}return i}function ye(e){const t=e.ring1??0,i=e.ring2??0,[s,n]=t<=i?[t,i]:[i,t];return[e.helmet??0,e.chestplate??0,e.leggings??0,e.boots??0,s,n,e.bracelet??0,e.necklace??0,e.weapon??0].join("|")}function ke(e,t){return te(t)===e.category}function ct(e,t,i){const s=U(e),n=new Set(E.filter(o=>s[o]!=null));for(const o of i.mustIncludeIds){const a=t.itemsById.get(o);if(!a)continue;const u=E.filter(m=>!n.has(m)&&ke(a,m))[0];u&&(s[u]=a.id,n.add(u))}return s}function dt(e,t){const i={str:0,dex:0,int:0,def:0,agi:0};for(const n of E){const o=e[n];if(o==null)continue;const a=t.itemsById.get(o);a&&(i.str=Math.max(i.str,a.numeric.reqStr),i.dex=Math.max(i.dex,a.numeric.reqDex),i.int=Math.max(i.int,a.numeric.reqInt),i.def=Math.max(i.def,a.numeric.reqDef),i.agi=Math.max(i.agi,a.numeric.reqAgi))}const s=ge.filter(n=>i[n]>100).sort((n,o)=>i[o]-i[n]);return s.length>0?s:ge.filter(n=>i[n]>=70).sort((n,o)=>i[o]-i[n]).slice(0,2)}function ut(e,t,i){if(i.length===0)return[];const s={str:0,dex:0,int:0,def:0,agi:0};for(const n of E){const o=e[n];if(o==null)continue;const a=t.itemsById.get(o);a&&(s.str=Math.max(s.str,a.numeric.reqStr),s.dex=Math.max(s.dex,a.numeric.reqDex),s.int=Math.max(s.int,a.numeric.reqInt),s.def=Math.max(s.def,a.numeric.reqDef),s.agi=Math.max(s.agi,a.numeric.reqAgi))}return i.map(n=>Math.max(0,s[n]-100))}function Te(e,t){return t.map(i=>oe(e,i))}function J(e,t){if(e.length===0)return t.slice();const i=new Array(e.length);for(let s=0;s<e.length;s++)i[s]=(e[s]??0)+(t[s]??0);return i}function ft(e,t,i){for(let s=0;s<i.length;s++)if((e[s]??0)+(t[s]??0)<i[s])return!1;return!0}function Pe(e,t){let i=0;for(let s=0;s<t.length;s++)i+=Math.max(0,t[s]-(e[s]??0));return i}function be(e,t,i,s){if(s.length===0)return 0;const n=t.get(e)??[];let o=0;for(const a of n){const d=i.itemsById.get(a.id);if(!d)continue;let u=0;for(const m of s)u+=oe(d,m);u>o&&(o=u)}return o}function Q(e){return(e.target.customNumericRanges??[]).map(t=>({key:(t.key??"").trim(),min:typeof t.min=="number"?t.min:void 0,max:typeof t.max=="number"?t.max:void 0})).filter(t=>t.key&&(typeof t.min=="number"||typeof t.max=="number"))}function Z(e,t,i){const s=t.itemsById.get(e.id);return s?s.numericIndex[i]??0:0}function Me(e,t,i){const s=i.map(()=>0);if(i.length===0)return s;for(const n of E){const o=e[n];if(o==null)continue;const a=t.itemsById.get(o);if(a)for(let d=0;d<i.length;d++)s[d]+=a.numericIndex[i[d]]??0}return s}function Ie(e){const{slotOrder:t,candidatePools:i,catalog:s,keys:n}=e,o=Array.from({length:t.length+1},()=>n.map(()=>0)),a=Array.from({length:t.length+1},()=>n.map(()=>0));if(n.length===0)return{maxSuffix:o,minSuffix:a};for(let d=t.length-1;d>=0;d--){const u=i.get(t[d])??[],m=n.map(()=>Number.NEGATIVE_INFINITY),x=n.map(()=>Number.POSITIVE_INFINITY);for(const f of u){const y=s.itemsById.get(f.id);if(y)for(let P=0;P<n.length;P++){const k=y.numericIndex[n[P]]??0;k>m[P]&&(m[P]=k),k<x[P]&&(x[P]=k)}}for(let f=0;f<n.length;f++){const y=Number.isFinite(m[f])?m[f]:0,P=Number.isFinite(x[f])?x[f]:0;o[d][f]=o[d+1][f]+y,a[d][f]=a[d+1][f]+P}}return{maxSuffix:o,minSuffix:a}}function gt(e,t,i,s,n=[]){const o=[],a=Q(i);for(const l of t.items)ke(l,e)&&(s&&!s.has(l.id)||xe(l,i)&&o.push({id:l.id,rough:lt(l,i),reqTotal:l.roughScoreFields.reqTotal,skillPointTotal:l.roughScoreFields.skillPointTotal,utility:l.roughScoreFields.utility+l.numeric.spd*.8,level:l.level,atkTier:V(l),spStr:l.numeric.spStr,spDex:l.numeric.spDex,spInt:l.numeric.spInt,spDef:l.numeric.spDef,spAgi:l.numeric.spAgi,supportFocus:et(l,n)}));const d=[...o].sort((l,c)=>l.rough!==c.rough?c.rough-l.rough:l.id-c.id),u=[...o].sort((l,c)=>l.reqTotal!==c.reqTotal?l.reqTotal-c.reqTotal:l.level!==c.level?l.level-c.level:l.id-c.id),m=[...o].sort((l,c)=>l.skillPointTotal!==c.skillPointTotal?c.skillPointTotal-l.skillPointTotal:l.reqTotal!==c.reqTotal?l.reqTotal-c.reqTotal:l.id-c.id),x=[...o].sort((l,c)=>l.utility!==c.utility?c.utility-l.utility:l.reqTotal!==c.reqTotal?l.reqTotal-c.reqTotal:l.id-c.id),f=i.weaponAttackSpeeds.length>0?[...o].sort((l,c)=>{const p=Math.max(0,l.atkTier),M=Math.max(0,c.atkTier);return p!==M?M-p:l.atkTier!==c.atkTier?c.atkTier-l.atkTier:l.reqTotal!==c.reqTotal?l.reqTotal-c.reqTotal:l.skillPointTotal!==c.skillPointTotal?c.skillPointTotal-l.skillPointTotal:l.id-c.id}):[],y=n.length>0?[...o].sort((l,c)=>l.supportFocus!==c.supportFocus?c.supportFocus-l.supportFocus:l.reqTotal!==c.reqTotal?l.reqTotal-c.reqTotal:l.skillPointTotal!==c.skillPointTotal?c.skillPointTotal-l.skillPointTotal:l.id-c.id):[],P=n.map(l=>[...o].sort((c,p)=>{const M=l==="str"?c.spStr:l==="dex"?c.spDex:l==="int"?c.spInt:l==="def"?c.spDef:c.spAgi,b=l==="str"?p.spStr:l==="dex"?p.spDex:l==="int"?p.spInt:l==="def"?p.spDef:p.spAgi;return M!==b?b-M:c.reqTotal!==p.reqTotal?c.reqTotal-p.reqTotal:c.supportFocus!==p.supportFocus?p.supportFocus-c.supportFocus:c.id-p.id})),k=a.filter(l=>typeof l.min=="number").map(l=>[...o].sort((c,p)=>{const M=Z(c,t,l.key),b=Z(p,t,l.key);return M!==b?b-M:c.reqTotal!==p.reqTotal?c.reqTotal-p.reqTotal:c.skillPointTotal!==p.skillPointTotal?p.skillPointTotal-c.skillPointTotal:c.id-p.id})),h=a.filter(l=>typeof l.max=="number").map(l=>[...o].sort((c,p)=>{const M=Z(c,t,l.key),b=Z(p,t,l.key);return M!==b?M-b:c.reqTotal!==p.reqTotal?c.reqTotal-p.reqTotal:c.skillPointTotal!==p.skillPointTotal?p.skillPointTotal-c.skillPointTotal:c.id-p.id})),$=Math.max(10,i.topKPerSlot),R=Math.min(140,Math.max(40,Math.floor($*.8))),D=Math.min(o.length,$+R+(n.length>0?Math.min(60,n.length*12):0)+Math.min(80,a.length*14)),T=new Map,I=Math.min(12,Math.floor($*.4),d.length);for(let l=0;l<I;l++){const c=d[l];T.set(c.id,{id:c.id,rough:c.rough})}const S=[{list:d,remaining:Math.max(0,$-I),cursor:0},{list:u,remaining:Math.floor(R*.28),cursor:0},{list:m,remaining:Math.floor(R*.24),cursor:0},{list:x,remaining:Math.floor(R*.18),cursor:0}];f.length>0&&S.push({list:f,remaining:Math.max(18,Math.floor(R*.22)),cursor:0}),y.length>0&&S.push({list:y,remaining:Math.max(16,Math.floor(R*.2)),cursor:0});for(const l of P)S.push({list:l,remaining:10,cursor:0});for(const l of k)S.push({list:l,remaining:35,cursor:0});for(const l of h)S.push({list:l,remaining:20,cursor:0});for(;T.size<D;){let l=!1;for(const c of S)if(!(c.remaining<=0))for(;c.cursor<c.list.length;){const p=c.list[c.cursor++];if(!T.has(p.id)){T.set(p.id,{id:p.id,rough:p.rough}),c.remaining--,l=!0;break}}if(!l)break}if(T.size<D)for(const l of d){if(T.size>=D)break;T.has(l.id)||T.set(l.id,{id:l.id,rough:l.rough})}return[...T.values()]}function mt(e){const t={};for(const i of E){const s=te(i),n=new Set(e.binsByCategory[s]??[]),o=e.slots[i];o!=null&&n.add(o),t[i]=n}return t}function qe(e,t,i){if(i.length===0)return!0;const s=new Set;for(const n of E){const o=e[n];if(o==null)continue;const a=t.itemsById.get(o);if(a)for(const d of a.majorIds)i.includes(d)&&s.add(d)}return i.every(n=>s.has(n))}function ve(e,t){const i=new Array(e.length+1).fill(0);for(let s=e.length-1;s>=0;s--){const n=e[s],o=t.get(n)??[];let a=0;for(const d of o)d.rough>a&&(a=d.rough);i[s]=i[s+1]+a}return i}function Ae(e){const{poolSize:t,beamSize:i,remainingStages:s,processedStates:n,maxStates:o}=e;if(t<=0)return 0;const a=Math.max(0,o-n),d=Math.max(1,i*Math.max(1,s)),u=Math.floor(a/d),m=Math.max(8,Math.min(96,u));return Math.min(t,m)}function pt(e,t,i){let s=1;for(const n of e){const o=t.get(n)?.length??0;if(o===0)return 0;if(s*=o,s>i)return s}return s}function re(e){const{beam:t,catalog:i,constraints:s,skillpointAssist:n,signal:o}=e,a=[],d=new Set,u={majorIds:0,spInvalid:0,duplicate:0,hardConstraints:0,hardAttackSpeed:0,hardThresholds:0,hardItem:0,thresholdFailureExample:void 0};for(const m of t){if(o?.aborted)throw new DOMException("Auto build cancelled","AbortError");if(!qe(m.slots,i,s.requiredMajorIds)){u.majorIds++;continue}const x=fe({slots:m.slots,level:s.level,characterClass:s.characterClass},i,n?{skillpointFeasibility:{extraBaseSkillPoints:n}}:void 0);if(!x.derived.skillpointFeasible){u.spInvalid++;continue}const f=he(m.slots,i,s,x);if(!f.ok){u.hardConstraints++,f.reason==="attackSpeed"?u.hardAttackSpeed++:f.reason==="thresholds"?(u.hardThresholds++,u.thresholdFailureExample===void 0&&f.failedChecks?.length&&(u.thresholdFailureExample=f.failedChecks[0])):u.hardItem++;continue}const y=ye(m.slots);if(d.has(y)){u.duplicate++;continue}const{score:P,breakdown:k}=ce(x,s.weights,s);d.add(y),a.push({slots:U(m.slots),score:P,scoreBreakdown:k,summary:x})}return a.sort((m,x)=>{if(m.score!==x.score)return x.score-m.score;for(const f of E){const y=m.slots[f]??0,P=x.slots[f]??0;if(y!==P)return y-P}return 0}),{candidates:a,rejectStats:u}}function ht(e){const{slotOrder:t,candidatePools:i,baseSlots:s,catalog:n,constraints:o,focusStats:a,attackSpeedCtx:d,onProgress:u,signal:m}=e,x=ve(t,i),f=d?me(t,i,n):null,y=ut(s,n,a),P=Array.from({length:t.length+1},()=>a.map(()=>0));for(let S=t.length-1;S>=0;S--){const l=i.get(t[S])??[],c=a.map(()=>0);for(const p of l){const M=n.itemsById.get(p.id);if(!M)continue;const b=Te(M,a);for(let g=0;g<b.length;g++)b[g]>c[g]&&(c[g]=b[g])}P[S]=J(P[S+1],c)}const k=Q(o),h=k.map(S=>S.key),$=Ie({slotOrder:t,candidatePools:i,catalog:n,keys:h}),R=Me(s,n,h);let D=[{slots:U(s),orderIndex:0,roughScore:0,optimisticBound:x[0],feasibilityAssigned:0,focusSupport:a.map(()=>0),atkTierAssigned:0,customTotals:R}],T=0,I=!1;for(let S=0;S<t.length;S++){if(m?.aborted)throw new DOMException("Auto build cancelled","AbortError");const l=t[S],c=i.get(l)??[],p=[],M=Ae({poolSize:c.length,beamSize:D.length,remainingStages:t.length-S,processedStates:T,maxStates:o.maxStates});M<=0&&(I=!0);for(const w of D){let r=0;for(const q of c){if(r>=M)break;if(T>=o.maxStates){I=!0;break}if(T++,r++,se(q.id,w.slots,n))continue;const A=U(w.slots);A[l]=q.id;const v=n.itemsById.get(q.id),B=(w.atkTierAssigned??0)+(v?V(v):0),L=J(w.focusSupport??a.map(()=>0),v?Te(v,a):a.map(()=>0)),O=h.length>0?J(w.customTotals??h.map(()=>0),h.map(C=>v?v.numericIndex[C]??0:0)):void 0;if(d&&f&&!pe(d,B,f.minSuffix[S+1],f.maxSuffix[S+1])||a.length>0&&!ft(L,P[S+1],y))continue;if(k.length>0&&O){let C=!0;for(let F=0;F<k.length;F++){const _=k[F],z=O[F];if(typeof _.min=="number"&&z+$.maxSuffix[S+1][F]<_.min){C=!1;break}if(typeof _.max=="number"&&z+$.minSuffix[S+1][F]>_.max){C=!1;break}}if(!C)continue}const N=ue(A,n,o.level),j=w.roughScore+q.rough;p.push({slots:A,orderIndex:S+1,roughScore:j,optimisticBound:j+x[S+1],feasibilityAssigned:N.feasible?N.assignedTotal:1/0,focusSupport:L,atkTierAssigned:B,customTotals:O})}if(I)break}if(p.length===0)return u?.({phase:"diagnostics",processedStates:T,beamSize:D.length,totalSlots:t.length,expandedSlots:S,detail:I?`Feasibility-first search exhausted state budget before completing slot ${l}.`:`Feasibility-first search found no branches that can still satisfy high-skill requirements by slot ${l}.`}),{beam:[],processedStates:T,stateBudgetHit:I};const b=f?f.minSuffix[S+1]:0,g=f?f.maxSuffix[S+1]:0;p.sort((w,r)=>{if(d){const v=X(d,w.atkTierAssigned,b,g),B=X(d,r.atkTierAssigned,b,g);if(v!==B)return B-v}if(a.length>0){const v=Pe(w.focusSupport??[],y),B=Pe(r.focusSupport??[],y);if(v!==B)return v-B}const q=w.feasibilityAssigned??1/0,A=r.feasibilityAssigned??1/0;return q!==A?q-A:w.optimisticBound!==r.optimisticBound?r.optimisticBound-w.optimisticBound:w.roughScore!==r.roughScore?r.roughScore-w.roughScore:0}),D=p.slice(0,Math.max(40,o.beamWidth)),u?.({phase:"beam-search",processedStates:T,beamSize:D.length,totalSlots:t.length,expandedSlots:S+1,detail:`feasibility-first | branchCap=${M}${a.length>0?` | focus=${a.join("/")}`:""}${d?` | atkSpeed=${o.weaponAttackSpeeds.join("/")}`:""}`})}return{beam:D,processedStates:T,stateBudgetHit:I}}function xt(e){const{slotOrder:t,candidatePools:i,baseSlots:s,catalog:n,constraints:o,signal:a,onProgress:d}=e,u=[],m=new Set;let x=0,f=0,y=0,P=0,k=0,h=0,$=0,R=0;const D=(T,I)=>{if(a?.aborted)throw new DOMException("Auto build cancelled","AbortError");if(x>o.maxStates)return;if(T>=t.length){if(!qe(I,n,o.requiredMajorIds)){f++;return}const c=fe({slots:I,level:o.level,characterClass:o.characterClass},n);if(!c.derived.skillpointFeasible){y++;return}const p=he(I,n,o,c);if(!p.ok){k++,p.reason==="attackSpeed"?h++:p.reason==="thresholds"?$++:R++;return}const M=ye(I);if(m.has(M)){P++;return}m.add(M);const{score:b,breakdown:g}=ce(c,o.weights,o);u.push({slots:U(I),score:b,scoreBreakdown:g,summary:c});return}const S=t[T],l=i.get(S)??[];for(const c of l){if(x++,x>o.maxStates)break;se(c.id,I,n)||(I[S]=c.id,x%2e3===0&&d?.({phase:"exact-search",processedStates:x,beamSize:0,totalSlots:t.length,expandedSlots:T+1}),D(T+1,I))}I[S]=null};return D(0,U(s)),d?.({phase:"diagnostics",processedStates:x,beamSize:0,totalSlots:t.length,expandedSlots:t.length,detail:u.length>0?`Exact search produced ${u.length} valid builds. Rejected duplicates=${P}, SP-invalid=${y}, majorID=${f}, hard=${k} (speed=${h}, thresholds=${$}, item=${R}).`:`Exact search produced 0 valid builds. Rejected SP-invalid=${y}, majorID=${f}, duplicates=${P}, hard=${k} (speed=${h}, thresholds=${$}, item=${R}).`}),u.sort((T,I)=>{if(T.score!==I.score)return I.score-T.score;for(const S of E){const l=T.slots[S]??0,c=I.slots[S]??0;if(l!==c)return l-c}return 0}),u.slice(0,Math.max(1,o.topN))}function De(e){const{catalog:t,baseWorkbench:i,constraints:s,onProgress:n,signal:o,alreadyThresholdRescue:a}=e;if(o?.aborted)throw new DOMException("Auto build cancelled","AbortError");let d=U(i.slots);for(const r of E)s.lockedSlots[r]||(d[r]=null);d=ct(d,t,s);const u=dt(d,t),m=E.filter(r=>d[r]==null),x=s.onlyPinnedItems?mt(i):null,f=new Map;for(const r of m)f.set(r,gt(r,t,s,x?.[r]??null,u));const y=st(d,t,s),k=Q(s).some(r=>typeof r.min=="number"),h=[...m].sort((r,q)=>{if(y?.preferredDirection){const B=f.get(r)??[],L=f.get(q)??[],O=B.reduce((j,C)=>{const F=t.itemsById.get(C.id);if(!F)return j;const _=V(F),z=y.preferredDirection>0?Math.max(0,_):Math.max(0,-_);return Math.max(j,z)},0),N=L.reduce((j,C)=>{const F=t.itemsById.get(C.id);if(!F)return j;const _=V(F),z=y.preferredDirection>0?Math.max(0,_):Math.max(0,-_);return Math.max(j,z)},0);if(O!==N)return N-O}if(u.length>0){const B=be(r,f,t,u),L=be(q,f,t,u);if(B!==L)return L-B}if(k){const B=["ring1","ring2","bracelet","necklace"],L=B.includes(r),O=B.includes(q);if(L!==O)return L?-1:1}const A=f.get(r)?.length??0,v=f.get(q)?.length??0;return A!==v?A-v:r.localeCompare(q)}),$=ve(h,f);if(h.some(r=>(f.get(r)?.length??0)===0)){const r=h.find(q=>(f.get(q)?.length??0)===0);return n?.({phase:"diagnostics",processedStates:0,beamSize:0,totalSlots:h.length,expandedSlots:0,detail:r?`No candidate items available for slot ${r} under current hard filters.`:"One or more slots have empty candidate pools."}),[]}const R=pt(h,f,s.exhaustiveStateLimit+1);if(s.useExhaustiveSmallPool&&h.length>0&&R>0&&R<=s.exhaustiveStateLimit){n?.({phase:"exact-search",processedStates:0,beamSize:0,totalSlots:h.length,expandedSlots:0});const r={...s,maxStates:Math.max(s.maxStates,s.exhaustiveStateLimit)};return xt({slotOrder:h,candidatePools:f,baseSlots:d,catalog:t,constraints:r,signal:o,onProgress:n})}const D=Q(s),T=D.map(r=>r.key),I=Ie({slotOrder:h,candidatePools:f,catalog:t,keys:T});let S=[{slots:d,orderIndex:0,roughScore:0,optimisticBound:$[0],atkTierAssigned:0,customTotals:Me(d,t,T)}];const l=y?me(h,f,t):null;let c=0,p=!1;for(let r=0;r<h.length;r++){if(o?.aborted)throw new DOMException("Auto build cancelled","AbortError");const q=h[r],A=f.get(q),v=[],B=Ae({poolSize:A.length,beamSize:S.length,remainingStages:h.length-r,processedStates:c,maxStates:s.maxStates});B<=0&&(p=!0);for(const N of S){let j=0;for(const C of A){if(j>=B)break;if(c>=s.maxStates){p=!0;break}if(c++,j++,se(C.id,N.slots,t))continue;const F=U(N.slots);F[q]=C.id;const _=N.roughScore+C.rough,z=t.itemsById.get(C.id),we=(N.atkTierAssigned??0)+(z?V(z):0),le=T.length>0?J(N.customTotals??T.map(()=>0),T.map(Y=>z?z.numericIndex[Y]??0:0)):void 0;if(!(y&&l&&!pe(y,we,l.minSuffix[r+1],l.maxSuffix[r+1]))){if(D.length>0&&le){let Y=!0;for(let K=0;K<D.length;K++){const ee=D[K],Be=le[K];if(typeof ee.min=="number"&&Be+I.maxSuffix[r+1][K]<ee.min){Y=!1;break}if(typeof ee.max=="number"&&Be+I.minSuffix[r+1][K]>ee.max){Y=!1;break}}if(!Y)continue}v.push({slots:F,orderIndex:r+1,roughScore:_,optimisticBound:_+$[r+1],atkTierAssigned:we,customTotals:le})}}if(p)break}if(v.length===0)return n?.({phase:"diagnostics",processedStates:c,beamSize:S.length,totalSlots:h.length,expandedSlots:r,detail:p?`Search state budget exhausted before completing slot ${q}. Try enabling deep fallback/exact mode or reduce hard filters.`:`No expansions produced at slot ${q}.`}),[];const L=l?l.minSuffix[r+1]:0,O=l?l.maxSuffix[r+1]:0;v.sort((N,j)=>{if(y){const C=X(y,N.atkTierAssigned,L,O),F=X(y,j.atkTierAssigned,L,O);if(C!==F)return F-C}return N.optimisticBound!==j.optimisticBound?j.optimisticBound-N.optimisticBound:j.roughScore-N.roughScore}),S=v.slice(0,Math.max(20,s.beamWidth)),n?.({phase:"beam-search",processedStates:c,beamSize:S.length,totalSlots:h.length,expandedSlots:r+1,detail:`branchCap=${B}${y?.preferredDirection?` | atkSpeedTarget=${s.weaponAttackSpeeds.join("/")}`:""}`})}let M=S,{candidates:b,rejectStats:g}=re({beam:S,catalog:t,constraints:s,signal:o});const w=g.thresholdFailureExample?` Example failure: ${g.thresholdFailureExample}.`:"";if(n?.({phase:"diagnostics",processedStates:c,beamSize:S.length,totalSlots:h.length,expandedSlots:h.length,detail:b.length>0?`Final eval: ${b.length} valid builds. Rejected duplicates=${g.duplicate}, SP-invalid=${g.spInvalid}, majorID=${g.majorIds}, hard=${g.hardConstraints}.`:`Final eval found 0 valid builds. Rejected SP-invalid=${g.spInvalid}, majorID=${g.majorIds}, duplicates=${g.duplicate}, hard=${g.hardConstraints} (speed=${g.hardAttackSpeed}, thresholds=${g.hardThresholds}, item=${g.hardItem}).${w}`}),b.length===0&&h.length>0&&(g.spInvalid>0||s.weaponAttackSpeeds.length>0&&g.hardAttackSpeed>0||g.hardThresholds>0)){const r=g.hardThresholds>0;n?.({phase:"diagnostics",processedStates:c,beamSize:S.length,totalSlots:h.length,expandedSlots:h.length,detail:r&&s.target.customNumericRanges?.length?"Retrying with threshold-aware rescue (advanced ID constraints + support-aware feasibility search).":g.hardAttackSpeed>0?"Retrying with feasibility-first beam search (support-aware rescue + attack-speed target reachability).":"Retrying with feasibility-first beam search (support-aware rescue for high-skill requirements)."});const q={...s,maxStates:Math.max(s.maxStates,r?Math.min(18e6,s.maxStates*5):s.weaponAttackSpeeds.length>0?Math.min(16e6,s.maxStates*4):Math.min(8e6,s.maxStates*2)),beamWidth:Math.max(s.beamWidth,r?3600:s.weaponAttackSpeeds.length>0?3200:1800)};r&&(q.weights=Se(s.target,s.weights));const A=ht({slotOrder:h,candidatePools:f,baseSlots:d,catalog:t,constraints:q,focusStats:u,attackSpeedCtx:y,onProgress:n,signal:o});if(A.beam.length>0){M=A.beam;const v=re({beam:A.beam,catalog:t,constraints:s,signal:o});b=v.candidates,g=v.rejectStats;const B=g.thresholdFailureExample?` Example failure: ${g.thresholdFailureExample}.`:"";n?.({phase:"diagnostics",processedStates:A.processedStates,beamSize:A.beam.length,totalSlots:h.length,expandedSlots:h.length,detail:b.length>0?`Feasibility-first eval: ${b.length} valid builds. Rejected duplicates=${g.duplicate}, SP-invalid=${g.spInvalid}, majorID=${g.majorIds}, hard=${g.hardConstraints}.`:`Feasibility-first eval still found 0 valid builds. Rejected SP-invalid=${g.spInvalid}, majorID=${g.majorIds}, duplicates=${g.duplicate}, hard=${g.hardConstraints} (speed=${g.hardAttackSpeed}, thresholds=${g.hardThresholds}, item=${g.hardItem}).${B}`})}}if(b.length===0&&g.hardThresholds>0&&!a){const r=s.target;if(typeof r.minLegacyBaseDps=="number"||typeof r.minLegacyEhp=="number"||typeof r.minDpsProxy=="number"||typeof r.minEhpProxy=="number"||typeof r.minMr=="number"||typeof r.minMs=="number"||typeof r.minSpeed=="number"||typeof r.minSkillPointTotal=="number"||typeof r.maxReqTotal=="number"||(r.customNumericRanges?.length??0)>0){n?.({phase:"diagnostics",processedStates:c,beamSize:M.length,totalSlots:h.length,expandedSlots:h.length,detail:"Retrying with threshold-biased beam search (weights tuned to target min/max)."});const A={...s,weights:Se(s.target,s.weights),beamWidth:Math.max(s.beamWidth,3600),maxStates:Math.max(s.maxStates,Math.min(18e6,s.maxStates*5))},v=De({catalog:t,baseWorkbench:i,constraints:A,onProgress:n,signal:o,alreadyThresholdRescue:!0});if(v.length>0)return n?.({phase:"diagnostics",processedStates:c,beamSize:v.length,totalSlots:h.length,expandedSlots:h.length,detail:`Threshold rescue: ${v.length} valid builds.`}),v.slice(0,Math.max(1,s.topN))}}if(b.length===0&&g.spInvalid>0&&g.hardConstraints===0){let r=!1;for(const q of ie){n?.({phase:"diagnostics",processedStates:c,beamSize:M.length,totalSlots:h.length,expandedSlots:h.length,detail:`Retrying final evaluation with tome-assisted SP feasibility (+${q[0]} per stat).`});const A=re({beam:M,catalog:t,constraints:s,skillpointAssist:q,signal:o});if(A.candidates.length>0){b=A.candidates,g=A.rejectStats,r=!0,n?.({phase:"diagnostics",processedStates:c,beamSize:M.length,totalSlots:h.length,expandedSlots:h.length,detail:`Tome-assisted final eval recovered ${b.length} valid builds (+${q[0]} per stat feasibility assist).`});break}g=A.rejectStats}r||n?.({phase:"diagnostics",processedStates:c,beamSize:M.length,totalSlots:h.length,expandedSlots:h.length,detail:`Tome-assisted final eval still found 0 valid builds after +${ie[ie.length-1][0]} per stat assist. Rejected SP-invalid=${g.spInvalid}, majorID=${g.majorIds}, duplicates=${g.duplicate}, hard=${g.hardConstraints} (speed=${g.hardAttackSpeed}, thresholds=${g.hardThresholds}, item=${g.hardItem}).${g.thresholdFailureExample?` Example failure: ${g.thresholdFailureExample}.`:""}`})}return b.slice(0,Math.max(1,s.topN))}const ae=new Map;self.onmessage=e=>{const t=e.data;if(t.type==="cancel"){ae.get(t.requestId)?.abort();return}const i=new AbortController;ae.set(t.requestId,i);try{const s=De({catalog:{...t.catalog,itemsById:new Map(t.catalog.itemsById),itemIdByName:new Map(t.catalog.itemIdByName),itemsByType:new Map(t.catalog.itemsByType),itemsByCategory:new Map(t.catalog.itemsByCategory)},baseWorkbench:t.baseWorkbench,constraints:t.constraints,signal:i.signal,onProgress:o=>{const a={type:"progress",requestId:t.requestId,progress:o};self.postMessage(a)}}),n={type:"result",requestId:t.requestId,candidates:s};self.postMessage(n)}catch(s){const n={type:"error",requestId:t.requestId,message:s instanceof Error?s.message:"Auto builder worker error"};self.postMessage(n)}finally{ae.delete(t.requestId)}}})();
